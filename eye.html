<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Designações Avançado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.js CDN -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .main-container {
            display: flex;
            flex-grow: 1;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        .coluna {
            flex: 1;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .coluna#coluna-pessoas {
             flex-basis: 30%; 
             max-width: 350px;
        }
        .coluna#coluna-detalhes {
            flex-basis: 70%;
        }

        .coluna h2, .coluna h3 {
            margin-top: 0;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        #lista-pessoas {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #lista-pessoas li {
            padding: 10px 12px;
            margin-bottom: 6px;
            background-color: #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 0.95em;
        }

        #lista-pessoas li:hover {
            background-color: #d3d9df;
        }
        #lista-pessoas li.active {
            background-color: #007bff;
            color: white;
            font-weight: 500;
        }

        /* Abas */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 15px;
        }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1em;
            margin-right: 5px;
            border-bottom: 3px solid transparent;
            color: #555;
        }
        .tab-button.active {
            border-bottom: 3px solid #007bff;
            font-weight: bold;
            color: #007bff;
        }
        .tab-content {
            display: none;
            flex-grow: 1; 
            overflow-y: auto; 
        }
        .tab-content.active {
            display: flex; 
            flex-direction: column;
        }

        /* Filtros */
        .filters-container {
            display: flex;
            flex-wrap: wrap; /* Permite que os filtros quebrem linha em telas menores */
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            align-items: center;
        }
        .filters-container label {
            font-size: 0.9em;
            margin-right: 5px;
        }
        .filters-container select, .filters-container input, .filters-container button {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ced4da;
            font-size: 0.9em;
        }
        .filters-container button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        .filters-container button#btn-limpar-filtros {
            background-color: #6c757d;
        }


        .designacao-card {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.03);
        }
        .designacao-card h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #333;
            font-size: 1.1em;
        }
        .designacao-card p {
            margin: 4px 0;
            font-size: 0.9em;
            color: #555;
        }

        /* Estilos para Estatísticas em Cards */
        #estatisticas-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Colunas responsivas para os cards */
            gap: 15px;
            padding-top: 10px;
        }

        .stat-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
        }

        .stat-card h4 { /* Título dentro do card de estatística */
            margin-top: 0;
            margin-bottom: 15px;
            color: #0056b3; 
            font-size: 1.15em;
            border-bottom: 1px solid #eef;
            padding-bottom: 10px;
        }

        .stat-card .stat-value { /* Valor numérico principal da estatística */
            font-size: 2em; 
            font-weight: 600;
            color: #007bff; 
            display: block; 
            margin-bottom: 8px;
            text-align: center;
        }
        .stat-card .stat-label { /* Rótulo descritivo para o valor */
            font-size: 0.9em;
            color: #555;
            text-align: center;
            margin-bottom: 15px;
        }

        .stat-card p, .stat-card ul {
            font-size: 0.95em;
            color: #333;
            margin-bottom: 8px;
        }
        .stat-card ul {
            padding-left: 20px;
            list-style-type: "– "; /* Um traço simples para a lista */
        }
        .stat-card li {
            margin-bottom: 6px;
        }
        .stat-card li .stat-value-inline { /* Para valores dentro de listas */
            font-weight: bold;
            color: #28a745;
        }


        #verificacao-conjunta-container.stat-card label,
        #verificacao-conjunta-container.stat-card select,
        #verificacao-conjunta-container.stat-card button {
            display: block; 
            width: calc(100% - 16px); 
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        #verificacao-conjunta-container.stat-card button {
            width: auto; 
            padding: 10px 18px;
            background-color: #17a2b8;
            border-color: #17a2b8;
            color: white;
            cursor: pointer;
        }
        #resultado-verificacao-conjunta {
            margin-top: 12px;
            font-weight: 500;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        #resultado-verificacao-conjunta.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        #resultado-verificacao-conjunta.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        #resultado-verificacao-conjunta.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}


        #designacoesPorElementoChartContainer.stat-card {
            min-height: 300px; 
        }
        #designacoesPorElementoChartContainer.stat-card canvas{
            width: 100% !important; /* Força o canvas a ocupar a largura do card */
            max-height: 320px;
        }
        
        #estatisticas-content:empty::before,
        #estatisticas-content:has(> p:only-child)::before {
            content: "Nenhuma designação para calcular estatísticas com os filtros atuais.";
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
            color: #777;
            font-size: 1.1em;
        }
         #estatisticas-content > p:only-child {
            display: none; /* Esconde o <p> se a mensagem ::before for mostrada */
        }


        /* FAB (Floating Action Button) */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
        .fab {
            background-color: #007bff;
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
        }
        .fab:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        .fab-options {
            display: none;
            position: absolute;
            bottom: 70px;
            right: 0;
            flex-direction: column;
            gap: 10px;
        }
        .fab-options.show {
            display: flex;
        }
        .fab-option {
            background-color: #17a2b8; 
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }
        .fab-option:hover {
            background-color: #138496;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: #fff;
            margin: 8% auto;
            padding: 25px;
            border: 1px solid #bbb;
            width: 90%;
            max-width: 550px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #888;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 30px;
            font-weight: bold;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-content h3 {
            margin-top: 0;
            color: #0056b3;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .modal-content form div {
            margin-bottom: 18px;
        }
        .modal-content label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 0.95em;
        }
        .modal-content input[type="text"],
        .modal-content select
        {
            width: calc(100% - 24px);
            padding: 10px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
        }
        .modal-content button[type="submit"] {
            background-color: #28a745;
            color: white;
            padding: 12px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s ease;
        }
        .modal-content button[type="submit"]:hover {
            background-color: #218838;
        }
        #coluna-detalhes-content { 
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #777;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div id="coluna-pessoas" class="coluna">
            <h2>Pessoas</h2>
            <ul id="lista-pessoas"></ul>
        </div>
        <div id="coluna-detalhes" class="coluna">
            <div id="coluna-detalhes-content">
                 <p>Selecione uma pessoa para ver os detalhes.</p>
            </div>
        </div>
    </div>

    <div class="fab-container">
        <button id="fab-main" class="fab">+</button>
        <div id="fab-options" class="fab-options">
            <button id="btn-criar-pessoa-fab" class="fab-option">Criar Pessoa</button>
            <button id="btn-criar-elemento-fab" class="fab-option">Criar Elemento</button>
            <button id="btn-criar-designacao-fab" class="fab-option">Criar Designação</button>
        </div>
    </div>

    <div id="modal-pessoa" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-pessoa">×</span><h3>Criar Nova Pessoa</h3><form id="form-criar-pessoa"><div><label for="nome-pessoa">Nome:</label><input type="text" id="nome-pessoa" required></div><button type="submit">Criar Pessoa</button></form></div></div>
    <div id="modal-elemento" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-elemento">×</span><h3>Criar Novo Elemento</h3><form id="form-criar-elemento"><div><label for="nome-elemento-modal">Nome do Elemento:</label><input type="text" id="nome-elemento-modal" required></div><div><label for="tipo-elemento">Tipo:</label><select id="tipo-elemento"><option value="reuniao">Reunião</option><option value="pregacao">Pregação</option></select></div><div><label for="genero-elemento">Gênero:</label><select id="genero-elemento"><option value="semana">Semana</option><option value="fim de semana">Fim de Semana</option><option value="tecnico">Técnico</option></select></div><button type="submit">Criar Elemento</button></form></div></div>
    <div id="modal-designacao" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-designacao">×</span><h3>Criar Nova Designação</h3><form id="form-criar-designacao"><div><label for="select-elemento-designacao">Elemento:</label><select id="select-elemento-designacao" required><option value="">-- Selecione um Elemento --</option></select></div><div><label for="select-pessoaA">Pessoa A:</label><select id="select-pessoaA"><option value="">-- Nenhuma --</option></select></div><div><label for="select-pessoaB">Pessoa B:</label><select id="select-pessoaB"><option value="">-- Nenhuma --</option></select></div><div><label for="select-pessoaC">Pessoa C:</label><select id="select-pessoaC"><option value="">-- Nenhuma --</option></select></div><div><label for="data-designacao">Data (DD/MM/AAAA):</label><input type="text" id="data-designacao" placeholder="DD/MM/AAAA" required pattern="\d{2}/\d{2}/\d{4}"></div><button type="submit">Criar Designação</button></form></div></div>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { 
            getFirestore, collection, getDocs, addDoc, query, where, doc, getDoc, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // SUBSTITUA PELA SUA CONFIGURAÇÃO REAL DO FIREBASE
        const firebaseConfig = {
          apiKey: "AIzaSyAk3dHqtGWtnPq_B09rRzUj6WC5hxdd9io",
  authDomain: "theeye-c3ace.firebaseapp.com",
  projectId: "theeye-c3ace",
  storageBucket: "theeye-c3ace.firebasestorage.app",
  messagingSenderId: "742355525459",
  appId: "1:742355525459:web:fbe84a9594be4bedc28ba6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const listaPessoasUl = document.getElementById('lista-pessoas');
        const colunaDetalhesDiv = document.getElementById('coluna-detalhes');
        const colunaDetalhesContent = document.getElementById('coluna-detalhes-content');

        const fabMain = document.getElementById('fab-main');
        const fabOptions = document.getElementById('fab-options');
        const btnCriarPessoaFab = document.getElementById('btn-criar-pessoa-fab');
        const btnCriarElementoFab = document.getElementById('btn-criar-elemento-fab');
        const btnCriarDesignacaoFab = document.getElementById('btn-criar-designacao-fab');

        const modalPessoa = document.getElementById('modal-pessoa');
        const modalElemento = document.getElementById('modal-elemento');
        const modalDesignacao = document.getElementById('modal-designacao');
        const closeButtons = document.querySelectorAll('.close-button');

        const formCriarPessoa = document.getElementById('form-criar-pessoa');
        const nomePessoaInput = document.getElementById('nome-pessoa');

        const formCriarElemento = document.getElementById('form-criar-elemento');
        const nomeElementoModalInput = document.getElementById('nome-elemento-modal');
        const tipoElementoSelect = document.getElementById('tipo-elemento');
        const generoElementoSelect = document.getElementById('genero-elemento');

        const formCriarDesignacao = document.getElementById('form-criar-designacao');
        const selectElementoDesignacao = document.getElementById('select-elemento-designacao');
        const selectPessoaA = document.getElementById('select-pessoaA');
        const selectPessoaB = document.getElementById('select-pessoaB');
        const selectPessoaC = document.getElementById('select-pessoaC');
        const dataDesignacaoInput = document.getElementById('data-designacao');

        // Globais para dados e estado
        let todasPessoas = [];
        let todosElementos = [];
        let pessoaSelecionadaAtual = null;
        let designacoesDaPessoaAtual = []; 
        let designacoesFiltradas = [];     
        let designacoesChart = null; // Variável para manter a instância do gráfico

        // --- Estrutura HTML da Coluna Detalhes (Abas e Filtros) ---
        function criarEstruturaDetalhes() {
            colunaDetalhesContent.style.display = 'none'; // Esconde mensagem placeholder
            colunaDetalhesDiv.innerHTML = `
                <h3>Detalhes de: <span id="nome-pessoa-detalhe"></span></h3>
                <div class="tabs">
                    <button class="tab-button active" data-tab="historico">Histórico</button>
                    <button class="tab-button" data-tab="estatisticas">Estatísticas</button>
                </div>
                <div class="filters-container">
                    <label for="filtro-mes">Mês:</label>
                    <select id="filtro-mes"><option value="">Todos</option>${[...Array(12).keys()].map(i => `<option value="${String(i+1).padStart(2,'0')}">${new Date(0, i).toLocaleString('pt-BR', { month: 'long' })}</option>`).join('')}</select>
                    <label for="filtro-ano">Ano:</label><select id="filtro-ano"><option value="">Todos</option></select>
                    <label for="filtro-elemento">Elemento:</label><select id="filtro-elemento"><option value="">Todos</option></select>
                    <button id="btn-aplicar-filtros">Aplicar</button>
                    <button id="btn-limpar-filtros">Limpar</button>
                </div>
                <div id="historico-content" class="tab-content active"></div>
                <div id="estatisticas-content" class="tab-content"></div>`;

            // Adicionar event listeners para abas e filtros
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`${button.dataset.tab}-content`).classList.add('active');
                    if (button.dataset.tab === 'estatisticas') renderizarEstatisticas(); // Renderiza ao trocar para aba
                });
            });
            document.getElementById('btn-aplicar-filtros').addEventListener('click', aplicarEAtualizarFiltros);
            document.getElementById('btn-limpar-filtros').addEventListener('click', limparEAtualizarFiltros);
        }

        // --- Funções de Filtros ---
        function popularFiltros() {
            const filtroAnoSelect = document.getElementById('filtro-ano');
            const filtroElementoSelect = document.getElementById('filtro-elemento');
            if (!filtroAnoSelect || !filtroElementoSelect) return; // Elementos podem não existir se pessoa não selecionada

            const anos = [...new Set(designacoesDaPessoaAtual.map(d => d.ano))].sort((a,b) => b-a);
            const elementos = [...new Set(designacoesDaPessoaAtual.map(d => d.nome))].sort((a,b) => a.localeCompare(b)); // Ordena alfabeticamente

            filtroAnoSelect.innerHTML = '<option value="">Todos</option>' + anos.map(ano => `<option value="${ano}">${ano}</option>`).join('');
            filtroElementoSelect.innerHTML = '<option value="">Todos</option>' + elementos.map(el => `<option value="${el}">${el}</option>`).join('');
        }

        function aplicarEAtualizarFiltros() {
            const mes = document.getElementById('filtro-mes')?.value; // Adiciona ? para segurança se o elemento não existir
            const ano = document.getElementById('filtro-ano')?.value;
            const elemento = document.getElementById('filtro-elemento')?.value;

            if(mes === undefined || ano === undefined || elemento === undefined) { // Se os filtros não existem (ex: antes de selecionar pessoa)
                designacoesFiltradas = [...designacoesDaPessoaAtual];
            } else {
                 designacoesFiltradas = designacoesDaPessoaAtual.filter(d => {
                    const matchMes = !mes || d.mes === mes;
                    const matchAno = !ano || d.ano === ano;
                    const matchElemento = !elemento || d.nome === elemento;
                    return matchMes && matchAno && matchElemento;
                });
            }
            renderizarHistorico();
            if (document.getElementById('estatisticas-content')?.classList.contains('active')) {
                 renderizarEstatisticas(); 
            }
        }
        
        function limparEAtualizarFiltros() {
            const filtroMes = document.getElementById('filtro-mes');
            const filtroAno = document.getElementById('filtro-ano');
            const filtroElemento = document.getElementById('filtro-elemento');
            if (filtroMes) filtroMes.value = "";
            if (filtroAno) filtroAno.value = "";
            if (filtroElemento) filtroElemento.value = "";
            aplicarEAtualizarFiltros(); 
        }

        // --- Renderização ---
        function renderizarHistorico() {
            const historicoContent = document.getElementById('historico-content');
            if (!historicoContent) return;
            
            historicoContent.innerHTML = ''; // Limpa conteúdo antigo
            if (designacoesFiltradas.length === 0) {
                historicoContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Nenhuma designação encontrada com os filtros atuais.</p>';
                return;
            }

            // Ordenar da mais recente para a mais antiga
            const designacoesOrdenadas = [...designacoesFiltradas].sort((a, b) => {
                const valA = parseInt(a.ano) * 10000 + parseInt(a.mes) * 100 + parseInt(a.dia);
                const valB = parseInt(b.ano) * 10000 + parseInt(b.mes) * 100 + parseInt(b.dia);
                return valB - valA; // Mais recente primeiro
            });

            const ul = document.createElement('ul');
            ul.style.listStyleType = 'none'; 
            ul.style.paddingLeft = '0';    

            designacoesOrdenadas.forEach(desig => {
                const li = document.createElement('li');
                li.style.padding = '8px 0'; 
                li.style.borderBottom = '1px solid #eee'; 

                const nomeElemento = desig.nome || 'Elemento sem nome';
                const participantesNomesArray = [desig.pessoaA, desig.pessoaB, desig.pessoaC].filter(Boolean); 
                const participantesString = participantesNomesArray.join(' - ');
                const dataFormatada = `${String(desig.dia).padStart(2,'0')}/${String(desig.mes).padStart(2,'0')}/${desig.ano}`;
                
                let textoFinal = `${nomeElemento}`;
                if (participantesString) {
                    textoFinal += `: ${participantesString}`;
                }
                textoFinal += ` (${dataFormatada})`;
                
                li.textContent = textoFinal;
                ul.appendChild(li);
            });
            
            if (ul.childNodes.length > 0) {
                const ultimoItem = ul.lastChild;
                if (ultimoItem) {
                    ultimoItem.style.borderBottom = 'none'; 
                }
                historicoContent.appendChild(ul);
            } else if (designacoesFiltradas.length > 0) { 
                historicoContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Erro ao exibir histórico.</p>';
            }
        }
        
        function renderizarEstatisticas() {
            const statsContent = document.getElementById('estatisticas-content');
            if (!statsContent) return;
            statsContent.innerHTML = ''; 

            if (!pessoaSelecionadaAtual || designacoesFiltradas.length === 0) {
                // A mensagem é tratada pelo CSS agora
                return;
            }

            // 1. Total de Designações
            const totalDesignacoes = designacoesFiltradas.length;
            statsContent.innerHTML += `
                <div class="stat-card">
                    <h4>Total de Designações</h4>
                    <span class="stat-value">${totalDesignacoes}</span>
                    <span class="stat-label">(Com filtro aplicado)</span>
                </div>`;

            // 2. Elementos Mais Realizados
            const contagemElementos = designacoesFiltradas.reduce((acc, d) => {
                acc[d.nome] = (acc[d.nome] || 0) + 1; return acc;
            }, {});
            const elementosMaisFeitos = Object.entries(contagemElementos).sort(([,a], [,b]) => b - a).slice(0, 5);
            let elementosHtml = '<div class="stat-card"><h4>Elementos Mais Realizados</h4>';
            if (elementosMaisFeitos.length > 0) {
                elementosHtml += '<ul>';
                elementosMaisFeitos.forEach(([nome, count]) => {
                    elementosHtml += `<li>${nome}: <span class="stat-value-inline">${count}</span></li>`;
                });
                elementosHtml += '</ul>';
            } else { elementosHtml += '<p>Nenhum dado de elemento.</p>'; }
            elementosHtml += '</div>';
            statsContent.innerHTML += elementosHtml;

            // 3. Parceiros Mais Frequentes
            const contagemParceiros = designacoesFiltradas.reduce((acc, d) => {
                [d.pessoaA, d.pessoaB, d.pessoaC].filter(p => p && p !== pessoaSelecionadaAtual.nome)
                    .forEach(parceiro => acc[parceiro] = (acc[parceiro] || 0) + 1);
                return acc;
            }, {});
            const parceiroMaisFrequente = Object.entries(contagemParceiros).sort(([,a], [,b]) => b - a);
            let parceirosHtml = '<div class="stat-card"><h4>Parceiros Mais Frequentes</h4>';
            if (parceiroMaisFrequente.length > 0) {
                parceirosHtml += '<ul>';
                parceiroMaisFrequente.slice(0,3).forEach(([nome, count]) => { // Top 3 parceiros
                     parceirosHtml += `<li>${nome}: <span class="stat-value-inline">${count}</span></li>`;
                });
                parceirosHtml += '</ul>';
            } else { parceirosHtml += '<p>Nenhum parceiro frequente ou só fez designações sozinho(a).</p>'; }
            parceirosHtml += '</div>';
            statsContent.innerHTML += parceirosHtml;

            // 4. Verificação de Designação Conjunta
            statsContent.innerHTML += `
                <div class="stat-card" id="verificacao-conjunta-container">
                    <h4>Verificar Designação Conjunta</h4>
                    <label for="select-outra-pessoa">Com:</label>
                    <select id="select-outra-pessoa"><option value="">-- Selecione Pessoa --</option>
                        ${todasPessoas.filter(p => p.id !== pessoaSelecionadaAtual.id).map(p => `<option value="${p.nome}">${p.nome}</option>`).join('')}
                    </select>
                    <label for="select-elemento-verificacao">Elemento:</label>
                    <select id="select-elemento-verificacao"><option value="">-- Selecione Elemento --</option>
                        ${[...new Set(todosElementos.map(el => el.designacao))].sort().map(nomeEl => `<option value="${nomeEl}">${nomeEl}</option>`).join('')}
                    </select>
                    <button id="btn-verificar-conjunta">Verificar</button>
                    <div id="resultado-verificacao-conjunta"></div>
                </div>`;
            document.getElementById('btn-verificar-conjunta').addEventListener('click', verificarDesignacaoConjunta);
        
            // Gráfico
            statsContent.innerHTML += `<div class="stat-card" id="designacoesPorElementoChartContainer"><h4>Designações por Elemento</h4><canvas id="designacoesPorElementoChart"></canvas></div>`;
            if (designacoesChart) designacoesChart.destroy();
            const labels = Object.keys(contagemElementos);
            const dataCounts = Object.values(contagemElementos);
            if(labels.length > 0){
                const ctx = document.getElementById('designacoesPorElementoChart').getContext('2d');
                designacoesChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels: labels, datasets: [{ label: 'Nº de Designações', data: dataCounts, backgroundColor: 'rgba(0, 123, 255, 0.6)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            } else {
                 const chartContainer = document.getElementById('designacoesPorElementoChartContainer');
                 if(chartContainer) chartContainer.querySelector('canvas').outerHTML = "<p style='text-align:center; color:#777; margin-top:20px;'>Sem dados para exibir gráfico.</p>";
            }
        }
        
        function verificarDesignacaoConjunta() {
            const nomeOutraPessoa = document.getElementById('select-outra-pessoa').value;
            const nomeElemento = document.getElementById('select-elemento-verificacao').value;
            const resultadoDiv = document.getElementById('resultado-verificacao-conjunta');
            resultadoDiv.className = ''; // Limpa classes anteriores

            if (!nomeOutraPessoa || !nomeElemento) {
                resultadoDiv.textContent = "Selecione pessoa e elemento.";
                resultadoDiv.classList.add('info'); return;
            }
            // Usa designacoesDaPessoaAtual para esta verificação específica, não as filtradas
            const contagem = designacoesDaPessoaAtual.filter(d => d.nome === nomeElemento && d.participantes && d.participantes[nomeOutraPessoa]).length;
            if (contagem > 0) {
                resultadoDiv.textContent = `Sim, ${contagem} vez(es) juntos em "${nomeElemento}".`;
                resultadoDiv.classList.add('success');
            } else {
                resultadoDiv.textContent = `Não fizeram "${nomeElemento}" juntos.`;
                resultadoDiv.classList.add('error');
            }
        }

        // --- Funções Principais ---
        async function carregarPessoas() {
            try {
                const querySnapshot = await getDocs(collection(db, "pessoas"));
                todasPessoas = [];
                querySnapshot.forEach((docSnap) => todasPessoas.push({ id: docSnap.id, ...docSnap.data() }));
                
                // Ordenar todasPessoas alfabeticamente pelo nome
                todasPessoas.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' }));

                listaPessoasUl.innerHTML = ''; 
                todasPessoas.forEach(pessoa => {
                    const li = document.createElement('li');
                    li.textContent = pessoa.nome;
                    li.dataset.pessoaId = pessoa.id; 
                    li.addEventListener('click', () => {
                        document.querySelectorAll('#lista-pessoas li').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        pessoaSelecionadaAtual = pessoa;
                        carregarDesignacoesDaPessoa(pessoa.nome);
                    });
                    listaPessoasUl.appendChild(li);
                });
                popularDropdownsPessoasNosModais();
            } catch (error) { console.error("Erro ao carregar pessoas: ", error); alert("Falha ao carregar pessoas."); }
        }

        async function carregarDesignacoesDaPessoa(nomePessoa) {
            criarEstruturaDetalhes(); 
            const nomePessoaDetalhe = document.getElementById('nome-pessoa-detalhe');
            if(nomePessoaDetalhe) nomePessoaDetalhe.textContent = nomePessoa;
            
            const historicoContent = document.getElementById('historico-content');
            if(historicoContent) historicoContent.innerHTML = '<p style="text-align:center;color:#777;margin-top:20px;">Carregando designações...</p>';

            try {
                const q = query(collection(db, "designacoes"), where(`participantes.${nomePessoa}`, "==", true));
                const querySnapshot = await getDocs(q);
                designacoesDaPessoaAtual = [];
                querySnapshot.forEach((docSnap) => designacoesDaPessoaAtual.push({ id: docSnap.id, ...docSnap.data() }));
                popularFiltros(); 
                aplicarEAtualizarFiltros(); 
                if (document.getElementById('estatisticas-content')?.classList.contains('active')) renderizarEstatisticas();
            } catch (error) {
                console.error(`Erro ao carregar designações para ${nomePessoa}: `, error);
                if(historicoContent) historicoContent.innerHTML = `<p style="text-align:center;color:#777;margin-top:20px;">Erro ao carregar designações.</p>`;
            }
        }

        // --- Funções para Popups (Modals) ---
        function abrirModal(modalElement) { modalElement.style.display = 'block'; }
        function fecharModal(modalElement) { modalElement.style.display = 'none'; }

        fabMain.addEventListener('click', () => fabOptions.classList.toggle('show'));
        document.addEventListener('click', (event) => {
            if (!fabMain.contains(event.target) && !fabOptions.contains(event.target) && fabOptions.classList.contains('show')) {
                fabOptions.classList.remove('show');
            }
        });
        btnCriarPessoaFab.addEventListener('click', () => { abrirModal(modalPessoa); fabOptions.classList.remove('show'); });
        btnCriarElementoFab.addEventListener('click', () => { abrirModal(modalElemento); fabOptions.classList.remove('show'); });
        btnCriarDesignacaoFab.addEventListener('click', () => {
            popularDropdownsElementosNoModal(); popularDropdownsPessoasNosModais();   
            abrirModal(modalDesignacao); fabOptions.classList.remove('show');
        });
        closeButtons.forEach(button => button.addEventListener('click', () => fecharModal(document.getElementById(button.getAttribute('data-modal-id')))));
        window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) fecharModal(event.target); });

        // --- Funções de Formulário ---
        formCriarPessoa.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const nome = nomePessoaInput.value.trim();
            if (!nome) { alert("O nome da pessoa é obrigatório."); return; }
            const q = query(collection(db, "pessoas"), where("nome", "==", nome));
            const snap = await getDocs(q);
            if (!snap.empty) { alert("Uma pessoa com este nome já existe."); return; }
            try {
                await addDoc(collection(db, "pessoas"), { nome: nome, createdAt: serverTimestamp() });
                alert("Pessoa criada com sucesso!"); formCriarPessoa.reset(); fecharModal(modalPessoa); carregarPessoas();
            } catch (error) { console.error("Erro ao criar pessoa: ", error); alert("Falha ao criar pessoa."); }
        });
        formCriarElemento.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const designacaoNome = nomeElementoModalInput.value.trim();
            const tipo = tipoElementoSelect.value;
            const genero = generoElementoSelect.value;
            if (!designacaoNome) { alert("O nome do elemento é obrigatório."); return; }
            const q = query(collection(db, "elementos"), where("designacao", "==", designacaoNome));
            const snap = await getDocs(q);
            if (!snap.empty) { alert("Um elemento com esta designação já existe."); return; }
            try {
                await addDoc(collection(db, "elementos"), { designacao: designacaoNome, tipo: tipo, genero: genero, createdAt: serverTimestamp() });
                alert("Elemento criado com sucesso!"); formCriarElemento.reset(); fecharModal(modalElemento); 
                await carregarTodosElementosParaEstatisticas(); 
                popularDropdownsElementosNoModal(); 
            } catch (error) { console.error("Erro ao criar elemento: ", error); alert("Falha ao criar elemento."); }
        });
        formCriarDesignacao.addEventListener('submit', async (e) => { 
            e.preventDefault();
            const elementoId = selectElementoDesignacao.value;
            const pessoaAId = selectPessoaA.value; const pessoaBId = selectPessoaB.value; const pessoaCId = selectPessoaC.value;
            const dataStr = dataDesignacaoInput.value;
            if (!elementoId) { alert("Selecione um elemento."); return; }
            if (!dataStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) { alert("Formato de data inválido. Use DD/MM/AAAA."); return; }
            const [dia, mes, ano] = dataStr.split('/');
            if (isNaN(parseInt(dia)) || parseInt(dia,10) < 1 || parseInt(dia,10) > 31 || isNaN(parseInt(mes)) || parseInt(mes,10) < 1 || parseInt(mes,10) > 12 || isNaN(parseInt(ano)) || parseInt(ano,10) < 1900 ) {
                alert("Data inválida."); return;
            }
            const participantes = {}; let nomePessoaA = null, nomePessoaB = null, nomePessoaC = null;
            const pessoasSelecionadasNomes = [];
            if (pessoaAId) { const pA = todasPessoas.find(p => p.id === pessoaAId); if (pA) { participantes[pA.nome] = true; nomePessoaA = pA.nome; pessoasSelecionadasNomes.push(pA.nome); }}
            if (pessoaBId) { const pB = todasPessoas.find(p => p.id === pessoaBId); if (pB) { participantes[pB.nome] = true; nomePessoaB = pB.nome; pessoasSelecionadasNomes.push(pB.nome); }}
            if (pessoaCId) { const pC = todasPessoas.find(p => p.id === pessoaCId); if (pC) { participantes[pC.nome] = true; nomePessoaC = pC.nome; pessoasSelecionadasNomes.push(pC.nome); }}
            if (Object.keys(participantes).length === 0) { alert("Selecione pelo menos uma pessoa."); return; }
            if (new Set(pessoasSelecionadasNomes.filter(Boolean)).size !== pessoasSelecionadasNomes.filter(Boolean).length) { alert("Uma pessoa não pode ser selecionada em múltiplos campos (A, B, C)."); return; }
            let nomeElementoDesignado = "Elemento";
            const elemDocSnap = await getDoc(doc(db, "elementos", elementoId));
            if (elemDocSnap.exists()) { nomeElementoDesignado = elemDocSnap.data().designacao; }
            try {
                await addDoc(collection(db, "designacoes"), {
                    elementoId: elementoId, nome: nomeElementoDesignado, 
                    pessoaA: nomePessoaA, pessoaB: nomePessoaB, pessoaC: nomePessoaC,
                    dia: String(dia).padStart(2,'0'), mes: String(mes).padStart(2,'0'), ano: ano,
                    dataCompleta: `${ano}-${String(mes).padStart(2,'0')}-${String(dia).padStart(2,'0')}`,
                    participantes: participantes, createdAt: serverTimestamp()
                });
                alert("Designação criada com sucesso!"); formCriarDesignacao.reset(); fecharModal(modalDesignacao);
                if(pessoaSelecionadaAtual) carregarDesignacoesDaPessoa(pessoaSelecionadaAtual.nome);
            } catch (error) { console.error("Erro ao criar designação: ", error); alert("Falha ao criar designação."); }
        });

        // --- Funções Auxiliares para Dropdowns nos Modais ---
        function popularDropdownsPessoasNosModais() { 
            const selects = [selectPessoaA, selectPessoaB, selectPessoaC];
            selects.forEach(select => {
                const currentValue = select.value; select.innerHTML = '<option value="">-- Nenhuma --</option>';
                todasPessoas.forEach(pessoa => { 
                    const option = document.createElement('option'); option.value = pessoa.id; option.textContent = pessoa.nome; select.appendChild(option);
                });
                if (currentValue) select.value = currentValue;
            });
        }
        async function popularDropdownsElementosNoModal() { 
            try {
                if(todosElementos.length === 0) await carregarTodosElementosParaEstatisticas();
                selectElementoDesignacao.innerHTML = '<option value="">-- Selecione um Elemento --</option>';
                const elementosOrdenados = [...todosElementos].sort((a,b) => a.designacao.localeCompare(b.designacao, 'pt-BR', {sensitivity: 'base'}));
                elementosOrdenados.forEach(elemento => {
                    const option = document.createElement('option'); option.value = elemento.id; option.textContent = elemento.designacao; selectElementoDesignacao.appendChild(option);
                });
            } catch (error) { console.error("Erro ao carregar elementos para dropdown do modal: ", error); }
        }
        async function carregarTodosElementosParaEstatisticas() { 
            try {
                const querySnapshot = await getDocs(collection(db, "elementos"));
                todosElementos = [];
                querySnapshot.forEach((docSnap) => todosElementos.push({ id: docSnap.id, ...docSnap.data() }));
            } catch (error) { console.error("Erro ao carregar todos os elementos: ", error); }
        }
        function atualizarDropdownsPessoasDesignacaoModal() { 
            const selecionados = [selectPessoaA.value, selectPessoaB.value, selectPessoaC.value].filter(Boolean);
            [selectPessoaA, selectPessoaB, selectPessoaC].forEach(currentSelect => {
                const valorAtual = currentSelect.value;
                Array.from(currentSelect.options).forEach(option => {
                    option.disabled = (option.value && option.value !== valorAtual && selecionados.includes(option.value));
                });
            });
        }
        selectPessoaA.addEventListener('change', atualizarDropdownsPessoasDesignacaoModal);
        selectPessoaB.addEventListener('change', atualizarDropdownsPessoasDesignacaoModal);
        selectPessoaC.addEventListener('change', atualizarDropdownsPessoasDesignacaoModal);

        // --- Inicialização ---
        window.onload = () => {
            carregarPessoas();
            carregarTodosElementosParaEstatisticas(); 
            colunaDetalhesContent.style.display = 'flex'; 
            colunaDetalhesDiv.innerHTML = ''; 
            colunaDetalhesDiv.appendChild(colunaDetalhesContent); 
        };
    </script>
</body>
</html>
