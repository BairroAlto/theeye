<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Designações Avançado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .main-container {
            display: flex;
            flex-grow: 1;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        .coluna {
            flex: 1;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .coluna#coluna-pessoas {
             flex-basis: 30%;
             max-width: 350px;
        }
        .coluna#coluna-detalhes {
            flex-basis: 70%;
        }

        .coluna h2, .coluna h3 {
            margin-top: 0;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        #search-pessoa-container { margin-bottom: 10px; padding: 5px; border-radius: 6px; }
        #search-pessoa-input { width: calc(100% - 20px); padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95em; box-sizing: border-box; }
        #lista-pessoas { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #lista-pessoas li { padding: 10px 12px; margin-bottom: 6px; background-color: #e9ecef; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.95em; }
        #lista-pessoas li:hover { background-color: #d3d9df; }
        #lista-pessoas li.active { background-color: #007bff; color: white; font-weight: 500; }
        #lista-pessoas li.hidden-by-search { display: none; }

        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; font-size: 1em; margin-right: 5px; border-bottom: 3px solid transparent; color: #555; }
        .tab-button.active { border-bottom: 3px solid #007bff; font-weight: bold; color: #007bff; }
        /* Estilo para o botão de "Editar Designações" quando o modo está ativo */
        .tab-button#tab-btn-editar-modo.active-edit-mode {
            background-color: #ffe082; /* Um amarelo claro, por exemplo */
            color: #212529;
            font-weight: bold;
            border-bottom: 3px solid #ffc107 !important; /* !important para sobrescrever .active normal */
        }


        .tab-content {
            display: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        #coluna-detalhes .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        #coluna-detalhes #estatisticas-content.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            padding-top: 10px;
        }

        .filters-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; align-items: center; }
        .filters-container label { font-size: 0.9em; margin-right: 5px; }
        .filters-container select, .filters-container input, .filters-container button { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; font-size: 0.9em; }
        .filters-container button { background-color: #007bff; color: white; cursor: pointer; }
        .filters-container button#btn-limpar-filtros { background-color: #6c757d; }

        /* Estilos para o botão de toggle dos filtros da pessoa */
        .btn-toggle-filtros {
            display: none; /* Começa oculto, será mostrado apenas em mobile pela media query */
            width: 100%;
            padding: 10px 15px;
            background-color: #f0f2f5; /* Cor de fundo suave */
            color: #0056b3; /* Cor do texto principal */
            border: 1px solid #d1d9e0; /* Borda sutil */
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left; /* O alinhamento interno será controlado por flex */
            font-size: 0.95em;
            /* display: flex; Será ativado na media query */
            align-items: center;
        }

        .btn-toggle-filtros .fa-filter {
            margin-right: 8px;
            color: #007bff; /* Cor do ícone de filtro */
        }

        .btn-toggle-filtros .btn-toggle-text {
            flex-grow: 1; /* O texto ocupa o espaço disponível */
        }

        .btn-toggle-filtros .toggle-icon {
            margin-left: 10px; /* Espaço antes do ícone de chevron */
            transition: transform 0.3s ease; /* Animação para rotação do chevron */
        }

        .btn-toggle-filtros.active .toggle-icon {
            transform: rotate(180deg); /* Rotaciona o chevron quando ativo */
        }


        #historico-content ul { list-style-type: none; padding-left: 0; }
        #historico-content li { padding: 8px 10px; border-bottom: 1px solid #eee; transition: background-color 0.3s ease; /* For week color hover */ }
        #historico-content li.month-separator { padding: 15px 0 5px 0; font-weight: bold; font-size: 1.1em; color: #0056b3; background-color: transparent !important; } /* Ensure separator is not colored by week logic */
        #historico-content li.month-separator.first-month-separator { border-top: none; margin-top: 0; }
        #historico-content li.month-separator:not(.first-month-separator) { border-top: 2px solid #ddd; margin-top: 10px;}
        #historico-content li:last-child:not(.month-separator) { border-bottom: none; }
        /* Estilo para botões de edição nas linhas do histórico */
        #historico-content ul li button {
            background-color: #17a2b8; /* ciano informativo */
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #historico-content ul li button:hover {
            background-color: #138496;
        }
        #historico-content ul li button .fas { /* Ícone dentro do botão */
            margin-right: 4px;
        }


        #coluna-detalhes #estatisticas-content .stat-card { background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; }
        #coluna-detalhes #estatisticas-content .stat-card h4 { margin-top: 0; margin-bottom: 15px; color: #0056b3; font-size: 1.15em; border-bottom: 1px solid #eef; padding-bottom: 10px; }
        #coluna-detalhes #estatisticas-content .stat-card .stat-value { font-size: 2em; font-weight: 600; color: #007bff; display: block; margin-bottom: 8px; text-align: center; }
        #coluna-detalhes #estatisticas-content .stat-card .stat-label { font-size: 0.9em; color: #555; text-align: center; margin-bottom: 15px; }
        #coluna-detalhes #estatisticas-content .stat-card p, #coluna-detalhes #estatisticas-content .stat-card ul { font-size: 0.95em; color: #333; margin-bottom: 8px; }
        #coluna-detalhes #estatisticas-content .stat-card ul { padding-left: 20px; list-style-type: "– "; }
        #coluna-detalhes #estatisticas-content .stat-card li { margin-bottom: 6px; }
        #coluna-detalhes #estatisticas-content .stat-card li .stat-value-inline { font-weight: bold; color: #28a745; }
        #coluna-detalhes #verificacao-conjunta-container.stat-card label,
        #coluna-detalhes #verificacao-conjunta-container.stat-card select,
        #coluna-detalhes #verificacao-conjunta-container.stat-card button { display: block; width: calc(100% - 16px); margin-bottom: 12px; box-sizing: border-box; }
        #coluna-detalhes #verificacao-conjunta-container.stat-card button { width: auto; padding: 10px 18px; background-color: #17a2b8; border-color: #17a2b8; color: white; cursor: pointer; }
        #coluna-detalhes #resultado-verificacao-conjunta { margin-top: 12px; font-weight: 500; padding: 10px; border-radius: 5px; text-align: center; }
        #coluna-detalhes #resultado-verificacao-conjunta.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        #coluna-detalhes #resultado-verificacao-conjunta.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        #coluna-detalhes #resultado-verificacao-conjunta.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}
        #coluna-detalhes #designacoesPorElementoChartContainer.stat-card,
        #coluna-detalhes .stats-chart-container-pessoa.stat-card { /* Applied to new chart containers for person details */
             min-height: 300px;
        }
        #coluna-detalhes #designacoesPorElementoChartContainer.stat-card canvas,
        #coluna-detalhes .stats-chart-container-pessoa.stat-card canvas { /* Applied to new chart canvases */
            width: 100% !important; max-height: 320px;
        }
        #coluna-detalhes #estatisticas-content:empty::before,
        #coluna-detalhes #estatisticas-content:has(> p:only-child)::before { content: "Nenhuma designação para calcular estatísticas com os filtros atuais."; display: flex; align-items: center; justify-content: center; text-align: center; width: 100%; height: 100%; color: #777; font-size: 1.1em; }
        #coluna-detalhes #estatisticas-content > p:only-child { display: none; }


        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
        .fab-stats-button { /* Estilo genérico para botões no FAB que não são o principal */
            background-color: #17a2b8; /* Ciano padrão */
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
            margin-bottom: 10px; /* Espaço entre os botões FAB */
        }
        .fab-stats-button:hover {
            transform: translateY(-2px);
        }
        /* Específico para o botão de Ranking */
        #btn-ranking-popup {
            background-color: #ff9800; /* Laranja */
        }
        #btn-ranking-popup:hover {
            background-color: #e68a00; /* Laranja mais escuro */
        }
        /* Específico para o botão de Stats Globais (se precisar de cor diferente do padrão) */
        #btn-global-stats {
             background-color: #17a2b8; /* Mantém ciano ou muda se desejar */
        }
        #btn-global-stats:hover {
            background-color: #138496;
        }

        .fab { background-color: #007bff; color: white; border: none; width: 56px; height: 56px; border-radius: 50%; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background-color 0.2s ease; }
        .fab:hover { background-color: #0056b3; transform: translateY(-2px); }
        .fab-options { display: none; position: absolute; bottom: 70px; /* Ajustado para mais botões no FAB */ right: 0; flex-direction: column; gap: 10px; }
        .fab-options.show { display: flex; }
        .fab-option { background-color: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; font-size: 0.9em; white-space: nowrap; transition: background-color 0.2s ease; }
        .fab-option:hover { background-color: #138496; }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fff; margin: 8% auto; padding: 25px; border: 1px solid #bbb; width: 90%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-content.modal-gerenciar { max-width: 700px; }
        .close-button { color: #888; position: absolute; top: 10px; right: 15px; font-size: 30px; font-weight: bold; line-height: 1; }
        .close-button:hover, .close-button:focus { color: #333; text-decoration: none; cursor: pointer; }
        .modal-content h3 { margin-top: 0; color: #0056b3; font-size: 1.5em; margin-bottom: 20px; }
        .modal-content form div { margin-bottom: 18px; }
        .modal-content label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95em; }
        .modal-content input[type="text"], .modal-content select, .modal-content input[type="number"] { width: calc(100% - 24px); padding: 10px 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        .modal-content button[type="submit"] { background-color: #28a745; color: white; padding: 12px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        .modal-content button[type="submit"]:hover { background-color: #218838; }
        #coluna-detalhes-content { display: flex; align-items: center; justify-content: center; height: 100%; color: #777; font-size: 1.2em; }

        #lista-gerenciar-pessoas { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        #lista-gerenciar-pessoas li { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        #lista-gerenciar-pessoas li:last-child { border-bottom: none; }
        #lista-gerenciar-pessoas .pessoa-nome { flex-grow: 1; }
        #lista-gerenciar-pessoas .pessoa-status-visivel.oculta { font-style: italic; color: #888; margin-left: 10px; font-size: 0.9em; }
        #lista-gerenciar-pessoas .pessoa-actions button { margin-left: 8px; padding: 5px 10px; font-size: 0.85em; cursor: pointer; border: 1px solid transparent; border-radius: 4px; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-toggle-visibilidade { background-color: #ffc107; color: #333; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-toggle-visibilidade.mostrar { background-color: #28a745; color: white; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-editar-pessoa { background-color: #17a2b8; color: white; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-remover-pessoa { background-color: #dc3545; color: white; }

        /* Estilos para o Modal de Estatísticas Globais Melhorado */
        .modal-global-stats-content {
            max-width: 95%; /* Aumentado para acomodar mais conteúdo */
            width: 1100px;
            background-color: #f4f6f8;
            display: flex; /* Para abas e conteúdo */
            flex-direction: column; /* Para abas e conteúdo */
            min-height: 80vh; /* Altura mínima */
        }
        .modal-global-stats-content .global-stats-header {
            text-align: center;
            color: #004a99;
            font-size: 1.7em;
            margin-bottom: 15px; /* Reduzido para dar espaço às abas */
            border-bottom: 2px solid #0056b3;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-global-stats-tabs { /* Container para os botões das abas */
            display: flex;
            border-bottom: 1px solid #ccc;
            margin-bottom: 20px; /* Espaço antes do conteúdo da aba */
            background-color: #fff;
            padding: 0 10px;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }
        .global-stats-tab-button { /* Estilo para cada botão de aba */
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.05em; /* Aumentado */
            margin-right: 8px;
            border-bottom: 3px solid transparent;
            color: #555;
            transition: color 0.2s ease, border-bottom-color 0.2s ease;
        }
        .global-stats-tab-button:hover {
            color: #007bff;
        }
        .global-stats-tab-button.active {
            border-bottom: 3px solid #007bff;
            font-weight: bold;
            color: #007bff;
        }
        .global-stats-tab-content { /* Conteúdo de cada aba */
            display: none; /* Escondido por padrão */
            padding: 10px;
            flex-grow: 1; /* Para ocupar o espaço restante */
            overflow-y: auto; /* Scroll se necessário */
        }
        .global-stats-tab-content.active {
            display: block; /* Mostra o conteúdo da aba ativa */
        }
        .stats-header-icon { margin-right: 12px; font-size: 0.9em; }
        .stats-card-section {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            transition: box-shadow 0.3s ease;
        }
        .stats-card-section:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stats-card-section h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #343a40;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 12px;
            font-size: 1.25em;
            display: flex;
            align-items: center;
        }
        .stats-icon { margin-right: 10px; color: #007bff; font-size: 1.05em; width: 20px; text-align: center; }
        .stats-filters {
            background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;
            border: 1px solid #e9ecef; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;
        }
        .stats-filters label { font-weight: 500; color: #495057; margin-right: 5px; }
        .stats-filters select, .stats-filters button, .stats-filters input[type="number"] { padding: 9px 12px; font-size: 0.9em; border-radius: 5px; border: 1px solid #ced4da; }
        .stats-filters select { min-width: 120px; }
        .stats-apply-button {
            background-color: #007bff; color: white; border: none; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .stats-apply-button:hover { background-color: #0056b3; transform: translateY(-1px); }
        .stats-apply-button:active { transform: translateY(0px); }
        .stats-apply-button:disabled { background-color: #adb5bd; color: #6c757d; cursor: not-allowed; transform: none; }
        .stats-btn-icon { font-size: 0.95em; }
        .stats-results-container { padding-top: 15px; border-top: 1px solid #f1f1f1; margin-top: 20px; min-height: 60px; position: relative; }
        .agrupado-subheader { font-size: 1.05em; color: #495057; margin-top: 10px; margin-bottom: 10px; font-weight: 500; }
        .stats-result-list { list-style-type: none; padding-left: 0; max-height: 250px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; background-color: #fff; }
        .stats-result-list li {
            padding: 10px 15px; border-bottom: 1px solid #f1f3f5; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease;
        }
        .stats-result-list li:hover { background-color: #e9f5ff; }
        .stats-result-list li:last-child { border-bottom: none; }
        .stats-result-list .count, .stats-result-list .value { font-weight: bold; color: #0056b3; margin-left: 10px; white-space: nowrap; }
        .stats-result-list li.clickable { cursor: pointer; }
        .stats-result-list li.clickable:hover { background-color: #d1ecf1; }

        .stats-result-text { font-size: 0.95em; line-height: 1.7; }
        .stats-result-text p { margin: 10px 0; padding: 8px 0; border-bottom: 1px dashed #e0e0e0; }
        .stats-result-text p:last-child { border-bottom: none; }
        .stats-result-text strong { color: #212529; }
        .stats-result-text .acima-media { color: #28a745; font-weight: bold; }
        .stats-result-text .abaixo-media { color: #dc3545; font-weight: bold; }
        .stats-result-text .na-media { color: #ffc107; font-weight: bold; }
        .stats-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stats-kpi-card { background-color: #fff; padding: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; }
        .stats-kpi-card .kpi-value { font-size: 1.8em; font-weight: 600; color: #007bff; display: block; margin-bottom: 5px; }
        .stats-kpi-card .kpi-label { font-size: 0.9em; color: #555; }
        .stats-chart-container { min-height: 300px; margin-bottom: 20px; background-color: #fff; padding:15px; border-radius:6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        .mostrar-todos-link {
            display: inline-block; text-align: right; font-size: 0.85em; margin-top: 12px;
            color: #007bff; cursor: pointer; text-decoration: none; font-weight: 500; padding: 5px 0;
        }
        .mostrar-todos-link:hover { text-decoration: underline; color: #0056b3; }
        .loading-spinner {
            border: 4px solid #e9ecef; border-top: 4px solid #007bff; border-radius: 50%;
            width: 36px; height: 36px; animation: spin 0.8s linear infinite; margin: 25px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats-result-list:empty::before,
        .stats-result-text:empty::before {
            content: "Nenhum dado para exibir com os filtros atuais. Ajuste os filtros e tente novamente.";
            display: block; text-align: center; padding: 25px 15px; color: #6c757d;
            font-style: italic; font-size: 0.95em; background-color: #f8f9fa;
            border: 1px dashed #ced4da; border-radius: 4px;
        }
        /* Estilos para comparação de pessoas */
        #gs-pessoas-comparison-area { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 15px; }
        .pessoa-comparison-card { flex: 0 0 300px; /* Não encolhe, base de 300px */ background-color: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pessoa-comparison-card h5 { margin-top: 0; color: #0056b3; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .pessoa-comparison-card ul { list-style-type: none; padding: 0; }
        .pessoa-comparison-card li { font-size: 0.9em; margin-bottom: 6px; }
        .pessoa-comparison-card .stat-value { font-weight: bold; color: #333; }

        /* Custom Multi-select for "Comparar Desempenho de Pessoas" */
        .custom-multiselect-container {
            position: relative;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            min-height: 38px; /* Approx height of a select input */
            width: 250px; /* Match original select width or adjust as needed */
            box-sizing: border-box;
            margin-bottom: 10px; /* Spacing */
        }

        .selected-pessoas-area {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            flex-grow: 1; /* Allow tags to take up space */
        }

        .pessoa-tag {
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .pessoa-tag .remove-tag-btn {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            background: none;
            border: none;
            color: white;
            padding: 0 2px;
        }
        .pessoa-tag .remove-tag-btn:hover {
            opacity: 0.8;
        }

        #gs-pessoas-search-input-custom {
            border: none;
            outline: none;
            padding: 6px;
            font-size: 0.9em;
            flex-grow: 1; /* Allow input to take remaining space */
            min-width: 100px; /* Minimum width for the input field */
            box-sizing: border-box;
        }
        .custom-multiselect-container:focus-within { /* Style when container or input has focus */
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }


        #gs-pessoas-dropdown-custom {
            position: absolute;
            top: 100%; /* Position below the container */
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ced4da;
            border-top: none; /* Avoid double border */
            border-radius: 0 0 5px 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1050; /* Ensure it's above other content in modal */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; /* Hidden by default */
        }

        #gs-pessoas-dropdown-custom ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #gs-pessoas-dropdown-custom li {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
        }

        #gs-pessoas-dropdown-custom li:hover {
            background-color: #e9ecef;
        }
        #gs-pessoas-dropdown-custom li.disabled { /* For already selected items in dropdown */
            color: #adb5bd;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }

        /* Estilos para o Modal de Ranking */
        .ranking-list-container {
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            background-color: #fdfdfd;
        }

        #lista-ranking-designacoes {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #lista-ranking-designacoes li {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        #lista-ranking-designacoes li:last-child {
            border-bottom: none;
        }

        #lista-ranking-designacoes .designacao-nome {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }
        #lista-ranking-designacoes .designacao-participantes {
            color: #0056b3;
            font-style: italic;
            margin-left: 10px;
            text-align: right;
            min-width: 150px; /* Para evitar quebra de linha fácil */
        }
        #lista-ranking-designacoes .designacao-participantes.ninguem {
            color: #888;
        }


        /* Separadores no Ranking */
        .ranking-section-separator {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 86, 179, 0), rgba(0, 86, 179, 0.75), rgba(0, 86, 179, 0));
            margin: 12px 0;
        }
        .ranking-paragraph-separator { /* Se usar como <li> */
            height: 10px; /* Apenas um espaço, sem linha visível */
            border-bottom: none !important; /* Garante que não haja borda de li */
            background-color: transparent !important; /* Garante que não haja cor de fundo de li */
            padding: 5px 0 !important;
        }
         /* Garante que o HR não tenha padding de LI se for um elemento HR dentro da UL */
        #lista-ranking-designacoes hr.ranking-section-separator {
            padding: 0;
            border-bottom: none; /* Se for um HR, não precisa de border-bottom */
        }


        /* Botões de reordenar no Ranking */
        .reorder-buttons button {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 3px 6px;
            margin-left: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.8em;
        }
        .reorder-buttons button:hover {
            background-color: #e9ecef;
            border-color: #bbb;
        }
        .reorder-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Styles for the new sub-menu in "Análises Anteriores" tab */
        .gs-old-submenu-tabs {
            display: flex;
            border-bottom: 1px solid #dfe3e8; /* Lighter border for sub-tabs */
            margin-bottom: 15px; /* Space before the content of the sub-tab */
            background-color: #f0f2f5; /* Slightly different background for the sub-tab bar */
            padding: 6px 6px 0 6px;
            border-radius: 5px 5px 0 0; /* Rounded top corners */
        }

        .gs-old-submenu-button {
            padding: 9px 14px; /* Adjust padding as needed */
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 0.9em; /* Slightly smaller font for sub-tabs */
            margin-right: 4px;
            border-bottom: 3px solid transparent;
            color: #555e69;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease, border-bottom-color 0.2s ease;
        }

        .gs-old-submenu-button:hover {
            background-color: #e9ecef;
            color: #0056b3;
        }

        .gs-old-submenu-button.active {
            border-bottom: 3px solid #007bff;
            font-weight: 600; /* Bolder for active sub-tab */
            color: #007bff;
            background-color: #ffffff; /* Make active sub-tab's background match content area */
        }

        /* Control visibility of the sections within gs-old-content */
        #gs-old-content > .stats-card-section {
            display: none; /* Hide all sections by default */
        }

        #gs-old-content > .stats-card-section.active-submenu-section {
            display: block; /* Show only the active section */
        }

.participante-editavel {
    color: #333; /* Define a cor do texto para um preto suave */
    font-style: normal; /* Remove o itálico que é herdado do contêiner */
    cursor: pointer;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: currentColor; /* A linha pontilhada será da mesma cor do texto (#333) */
    transition: background-color 0.2s ease;
    padding: 2px 4px;
    border-radius: 3px;
}

.participante-editavel:hover {
    background-color: #e9ecef; /* Fundo cinza claro no hover, sem alterar a cor do texto */
}

/* Adicione esta regra de estilo ao seu bloco <style> */
#coluna-pessoas h2 {
    cursor: pointer;
    user-select: none; /* Impede que o texto seja selecionado ao clicar */
}


.sidebar-toggle-button, .sidebar-overlay {
    display: none;
}


.btn-toggle-filtros {
    display: none;
}

/* Mas se entrarmos em um contexto onde ele precisa aparecer (JS fará isso), ele se torna visível */
/* Esta regra é mais uma garantia de consistência */
#coluna-detalhes .btn-toggle-filtros {
     /* display: none; */ /* O JS vai controlar isso agora */
}

/* O wrapper no desktop não precisa da lógica de grid, mas o JS vai setar display:grid/none */
.filtros-wrapper-mobile {
    /* Não precisa de regras específicas de display aqui, o JS controla */
}

/* Media Query: Aplica estes estilos APENAS em telas com largura máxima de 768px (móveis e tablets pequenos) */
@media (max-width: 768px) {
    /* O contêiner principal se ajusta */
    .main-container {
        flex-direction: column;
    }

    /* O botão hamburger (três traços) */
    .sidebar-toggle-button {
        display: flex; /* Torna o botão visível */
        flex-direction: column;
        justify-content: space-around;
        width: 30px;
        height: 24px;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 1011; /* Acima do overlay e do conteúdo, mas abaixo do menu */
        position: fixed; /* Fica fixo na tela */
        top: 15px;
        left: 15px;
    }
    .sidebar-toggle-button span {
        width: 30px;
        height: 3px;
        background-color: #333; /* Cor dos traços */
        border-radius: 5px;
    }

    /* O fundo escurecido (overlay) */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1009;
        opacity: 0; /* Começa invisível */
        visibility: hidden; /* Começa inacessível */
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }

    /* A coluna das pessoas (a barra lateral) */
    #coluna-pessoas {
        position: fixed; /* Fica por cima do conteúdo */
        left: 0;
        top: 0;
        height: 100%;
        width: 80%; /* Ocupa 80% da tela */
        max-width: 300px; /* Mas não mais que 300px */
        z-index: 1010; /* Fica acima do overlay */
        transform: translateX(-100%); /* Começa escondida para a esquerda */
        transition: transform 0.3s ease-in-out;
        box-shadow: 4px 0px 15px rgba(0,0,0,0.2);
    }
    
    /* A coluna de detalhes ocupa a tela inteira */
    #coluna-detalhes {
        width: 100%;
        flex-basis: 100%;
        padding-top: 60px; /* Espaço para o botão hamburger não ficar por cima do título */
    }

    /* --- ESTADOS QUANDO O MENU ESTÁ ABERTO --- */
    
    /* Quando o body tem a classe 'sidebar-visible', o menu aparece */
    body.sidebar-visible #coluna-pessoas {
        transform: translateX(0); /* Desliza para a posição visível */
    }

    /* E o overlay também aparece */
    body.sidebar-visible .sidebar-overlay {
        display: block; /* Garante que está no fluxo para ser clicável */
        opacity: 1;
        visibility: visible;
    }
}


@media (max-width: 768px) {
    /* Mostra o botão no mobile */
    #btn-toggle-filtros-pessoa.btn-toggle-filtros {
        display: flex;
    }

    /* O wrapper no mobile usa GRID para a animação de altura */
    .filtros-wrapper-mobile {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.35s ease-out;
    }
    
    .filtros-wrapper-mobile.filtros-visiveis {
        grid-template-rows: 1fr;
    }
    
    /* Precisamos garantir que o overflow e min-height só se apliquem no mobile
       para não interferir com a animação de opacidade */
    #coluna-detalhes #filtros-pessoa-container {
        overflow: hidden;
        min-height: 0;
    }
}

    </style>
</head>
<body>
    <div class="main-container">

        <button id="sidebar-toggle-button" class="sidebar-toggle-button">
    <span></span>
    <span></span>
    <span></span>
</button>

<div id="sidebar-overlay" class="sidebar-overlay"></div>

        <div id="coluna-pessoas" class="coluna">
            <h2>Pessoas</h2>
            <div id="search-pessoa-container"><input type="text" id="search-pessoa-input" placeholder="Pesquisar pessoa..."></div>
            <ul id="lista-pessoas"></ul>
        </div>
        <div id="coluna-detalhes" class="coluna"><div id="coluna-detalhes-content"><p>Selecione uma pessoa para ver os detalhes.</p></div></div>
    </div>

    <div class="fab-container">
        <button id="btn-ranking-popup" class="fab-stats-button" title="Ranking da Reunião">
            <i class="fas fa-list-ol"></i>
        </button>
        <button id="btn-global-stats" class="fab-stats-button" title="Estatísticas Globais">📊</button>
        <button id="fab-main" class="fab">+</button>
        <div id="fab-options" class="fab-options">
            <button id="btn-gerenciar-pessoas-fab" class="fab-option">⚙️ Gerenciar Pessoas</button>
            <button id="btn-criar-pessoa-fab" class="fab-option">👤 Criar Pessoa</button>
            <button id="btn-criar-elemento-fab" class="fab-option">📄 Criar Elemento</button>
            <button id="btn-criar-designacao-fab" class="fab-option">📌 Criar Designação</button>
            <a href="add.html" class="fab-option" style="text-decoration: none;">📋 Adicionar Escala</a>
        </div>
    </div>

    <div id="modal-pessoa" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-pessoa">×</span><h3 id="modal-pessoa-titulo">Criar Nova Pessoa</h3><form id="form-criar-pessoa"><input type="hidden" id="pessoa-id-edit"><div><label for="nome-pessoa">Nome:</label><input type="text" id="nome-pessoa" required></div><div><label for="idioma-pessoa">Idioma:</label><select id="idioma-pessoa"><option value="Português">Português</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select></div><div><label for="genero-pessoa">Gênero:</label><select id="genero-pessoa"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select></div><div><label for="cargo-pessoa">Cargo:</label><select id="cargo-pessoa"><option value="Publicador">Publicador</option><option value="Servo Ministerial">Servo Ministerial</option><option value="Ancião">Ancião</option></select></div><div><label for="pregacao-pessoa">Pregação:</label><select id="pregacao-pessoa"><option value="">Nenhum</option><option value="Pioneiro Auxiliar">Pioneiro Auxiliar</option><option value="Pioneiro Regular">Pioneiro Regular</option></select></div><button type="submit" id="btn-submit-pessoa">Criar Pessoa</button></form></div></div>
    <div id="modal-gerenciar-pessoas" class="modal"><div class="modal-content modal-gerenciar"><span class="close-button" data-modal-id="modal-gerenciar-pessoas">×</span><h3>Gerenciar Pessoas</h3><p><small>Aqui você pode editar, remover ou ocultar pessoas da lista principal do site.</small></p><ul id="lista-gerenciar-pessoas"></ul></div></div>
    <div id="modal-elemento" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-elemento">×</span><h3>Criar Novo Elemento</h3><form id="form-criar-elemento"><div><label for="nome-elemento-modal">Nome do Elemento:</label><input type="text" id="nome-elemento-modal" required></div><div><label for="tipo-elemento">Tipo:</label><select id="tipo-elemento"><option value="reuniao">Reunião</option><option value="pregacao">Pregação</option></select></div><div><label for="genero-elemento">Gênero (Reunião):</label><select id="genero-elemento"><option value="semana">Semana</option><option value="fim de semana">Fim de Semana</option><option value="tecnico">Técnico</option></select></div><button type="submit">Criar Elemento</button></form></div></div>
    <div id="modal-designacao" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-designacao">×</span><h3>Criar Nova Designação</h3><form id="form-criar-designacao"><div><label for="select-elemento-designacao">Elemento:</label><select id="select-elemento-designacao" required><option value="">-- Selecione um Elemento --</option></select></div><div><label for="select-pessoaA">Pessoa A:</label><select id="select-pessoaA"><option value="">-- Nenhuma --</option></select></div><div><label for="select-pessoaB">Pessoa B:</label><select id="select-pessoaB"><option value="">-- Nenhuma --</option></select></div><div><label for="select-pessoaC">Pessoa C:</label><select id="select-pessoaC"><option value="">-- Nenhuma --</option></select></div><div><label for="data-designacao">Data (DD/MM/AAAA):</label><input type="text" id="data-designacao" placeholder="DD/MM/AAAA" required pattern="\d{2}/\d{2}/\d{4}"></div><button type="submit">Criar Designação</button></form></div></div>

    <!-- MODAL EDITAR DESIGNAÇÃO -->
    <div id="modal-editar-designacao" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="modal-editar-designacao">×</span>
            <h3>Editar Designação</h3>
            <form id="form-editar-designacao">
                <input type="hidden" id="designacao-id-edit">
                <div>
                    <label for="data-designacao-edit">Data (DD/MM/AAAA):</label>
                    <input type="text" id="data-designacao-edit" placeholder="DD/MM/AAAA" required pattern="\d{2}/\d{2}/\d{4}">
                </div>
                <div>
                    <label for="select-elemento-designacao-edit">Elemento:</label>
                    <select id="select-elemento-designacao-edit" required>
                        <option value="">-- Selecione um Elemento --</option>
                    </select>
                </div>
                <div>
                    <label for="select-pessoaA-edit">Pessoa A:</label>
                    <select id="select-pessoaA-edit">
                        <option value="">-- Nenhuma --</option>
                    </select>
                </div>
                <div>
                    <label for="select-pessoaB-edit">Pessoa B:</label>
                    <select id="select-pessoaB-edit">
                        <option value="">-- Nenhuma --</option>
                    </select>
                </div>
                <div>
                    <label for="select-pessoaC-edit">Pessoa C:</label>
                    <select id="select-pessoaC-edit">
                        <option value="">-- Nenhuma --</option>
                    </select>
                </div>
                <div id="campos-orador-publico-edit" style="display:none;">
                    <div>
                        <label for="tema-orador-edit">Tema:</label>
                        <input type="text" id="tema-orador-edit">
                    </div>
                    <div>
                        <label for="congregacao-orador-edit">Congregação:</label>
                        <input type="text" id="congregacao-orador-edit">
                    </div>
                </div>
                <button type="submit">Salvar Alterações</button>
            </form>
        </div>
    </div>


    <!-- MODAL DE ESTATÍSTICAS GLOBAIS - ATUALIZADO -->
    <div id="modal-global-stats" class="modal">
        <div class="modal-content modal-global-stats-content">
            <span class="close-button" data-modal-id="modal-global-stats">×</span>
            <h3 class="global-stats-header"><i class="fas fa-chart-pie stats-header-icon"></i> Estatísticas Globais Avançadas</h3>

            <div class="modal-global-stats-tabs">
                <button class="global-stats-tab-button active" data-tab-target="gs-total-content">Visão Geral</button>
                <button class="global-stats-tab-button" data-tab-target="gs-old-content">Análises Anteriores</button>
                <button class="global-stats-tab-button" data-tab-target="gs-pessoas-content">Pessoas</button>
                <button class="global-stats-tab-button" data-tab-target="gs-designacoes-content">Designações</button>
            </div>

            <!-- Conteúdo da Aba: Visão Geral (Nova) -->
            <div id="gs-total-content" class="global-stats-tab-content active">
                <h4><i class="fas fa-tachometer-alt stats-icon"></i> Métricas Chave</h4>
                <div class="stats-kpi-grid">
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-designacoes" class="kpi-value">-</span>
                        <span class="kpi-label">Total de Designações</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-masc" class="kpi-value">-</span>
                        <span class="kpi-label">Participações (Masculino)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-fem" class="kpi-value">-</span>
                        <span class="kpi-label">Participações (Feminino)</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-pt" class="kpi-value">-</span>
                        <span class="kpi-label">Participações (Português)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-it" class="kpi-value">-</span>
                        <span class="kpi-label">Participações (Italiano)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-outro-idioma" class="kpi-value">-</span>
                        <span class="kpi-label">Participações (Outro Idioma)</span>
                    </div>
                </div>
                <div class="stats-filters">
                     <label for="gs-total-filtro-ano">Ano:</label>
                    <select id="gs-total-filtro-ano"><option value="">Todos</option></select>
                    <label for="gs-total-filtro-mes">Mês:</label>
                    <select id="gs-total-filtro-mes"><option value="">Todos</option></select>
                    <button id="btn-gs-total-aplicar-filtros" class="stats-apply-button">
                        <i class="fas fa-sync-alt stats-btn-icon"></i> Atualizar Métricas e Gráficos
                    </button>
                </div>

                <h4><i class="fas fa-tasks stats-icon"></i> Lista de Tipos de Designação (Elementos)</h4>
                <div class="stats-filters">
                    <label for="gs-total-filtro-elemento-tipo">Filtrar por Tipo de Reunião:</label>
                    <select id="gs-total-filtro-elemento-tipo">
                        <option value="">Todos</option>
                        <option value="semana">Semana</option>
                        <option value="fim de semana">Fim de Semana</option>
                        <option value="tecnico">Técnico</option>
                    </select>
                    <button id="btn-gs-total-aplicar-filtro-elemento" class="stats-apply-button">
                        <i class="fas fa-filter stats-btn-icon"></i> Filtrar Lista
                    </button>
                </div>
                <div class="stats-results-container">
                    <div class="loading-spinner" id="gs-total-elementos-loading" style="display:none;"></div>
                    <p>Total de elementos encontrados: <span id="gs-total-elementos-count">0</span></p>
                    <ul id="gs-total-elementos-list" class="stats-result-list"></ul>
                </div>

                <h4><i class="fas fa-chart-line stats-icon"></i> Gráficos de Tendência (Filtrado por Ano/Mês acima)</h4>
                <div class="stats-chart-container">
                    <canvas id="gs-total-chart-designacoes-mes"></canvas>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="stats-chart-container" style="flex:1; min-width: 300px;">
                        <canvas id="gs-total-chart-designacoes-genero-mes"></canvas>
                    </div>
                    <div class="stats-chart-container" style="flex:1; min-width: 300px;">
                        <canvas id="gs-total-chart-designacoes-idioma-mes"></canvas>
                    </div>
                </div>

                <h4><i class="fas fa-calculator stats-icon"></i> Médias Mensais (Filtrado por Ano/Mês acima)</h4>
                 <div class="stats-kpi-grid">
                    <div class="stats-kpi-card">
                        <span id="gs-total-media-designacoes" class="kpi-value">-</span>
                        <span class="kpi-label">Média Total/Mês</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-masc" class="kpi-value">-</span>
                        <span class="kpi-label">Média Masc./Mês</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-fem" class="kpi-value">-</span>
                        <span class="kpi-label">Média Fem./Mês</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-pt" class="kpi-value">-</span>
                        <span class="kpi-label">Média Port./Mês</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-it" class="kpi-value">-</span>
                        <span class="kpi-label">Média Ital./Mês</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-outro" class="kpi-value">-</span>
                        <span class="kpi-label">Média Outro Idioma/Mês</span>
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba: Análises Anteriores (o que já existia, now with submenu) -->
            <div id="gs-old-content" class="global-stats-tab-content">
                <div class="gs-old-submenu-tabs">
                    <button class="gs-old-submenu-button active" data-submenu-target="gs-old-sec-top-pessoas">Top Pessoas</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-old-sec-todas-designacoes">Todas Designações</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-old-sec-desempenho-individual">Desempenho Individual</button>
                </div>

                <div class="stats-card-section active-submenu-section" id="gs-old-sec-top-pessoas">
                    <h4><i class="fas fa-users stats-icon"></i> Pessoas com Mais Designações</h4>
                    <div class="filters-container stats-filters">
                        <label for="gs-top-pessoas-mes">Mês:</label>
                        <select id="gs-top-pessoas-mes"><option value="">Todos</option></select>
                        <label for="gs-top-pessoas-ano">Ano:</label>
                        <select id="gs-top-pessoas-ano"><option value="">Todos</option></select>
                        <label for="gs-top-pessoas-elemento">Elemento:</label>
                        <select id="gs-top-pessoas-elemento"><option value="">Todos Elementos</option></select>
                        <button id="btn-gs-top-pessoas-aplicar" class="stats-apply-button">
                            <i class="fas fa-search stats-btn-icon"></i> Ver Top
                        </button>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-top-pessoas-loading" style="display:none;"></div>
                        <ul id="gs-top-pessoas-list" class="stats-result-list"></ul>
                        <a href="#" id="gs-top-pessoas-mostrar-todos" class="mostrar-todos-link" style="display:none;">Mostrar lista completa</a>
                    </div>
                </div>
                <div class="stats-card-section" id="gs-old-sec-todas-designacoes">
                    <h4><i class="fas fa-list-alt stats-icon"></i> Todas as Designações</h4>
                    <div class="filters-container stats-filters">
                        <label for="gs-todas-desig-mes">Mês:</label>
                        <select id="gs-todas-desig-mes"><option value="">Todos</option></select>
                        <label for="gs-todas-desig-ano">Ano:</label>
                        <select id="gs-todas-desig-ano"><option value="">Todos</option></select>
                        <label for="gs-todas-desig-elemento">Elemento:</label>
                        <select id="gs-todas-desig-elemento"><option value="">Todos</option></select>
                        <button id="btn-gs-todas-desig-aplicar" class="stats-apply-button">
                            <i class="fas fa-list-ol stats-btn-icon"></i> Listar Detalhado
                        </button>
                        <button id="btn-gs-todas-desig-agrupar" class="stats-apply-button">
                            <i class="fas fa-layer-group stats-btn-icon"></i> Agrupar por Elemento
                        </button>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-todas-desig-loading" style="display:none;"></div>
                        <ul id="gs-todas-desig-list" class="stats-result-list"></ul>
                        <div id="gs-todas-desig-agrupado-container" style="display:none;">
                            <h5 class="agrupado-subheader">Top Elementos (Agrupado)</h5>
                            <ul id="gs-todas-desig-agrupado-list" class="stats-result-list"></ul>
                            <a href="#" id="gs-todas-desig-agrupado-mostrar-todos" class="mostrar-todos-link" style="display:none;">Mostrar lista completa de elementos</a>
                        </div>
                    </div>
                </div>
                <div class="stats-card-section" id="gs-old-sec-desempenho-individual">
                    <h4><i class="fas fa-user-chart stats-icon"></i> Desempenho Individual vs. Média</h4>
                    <div class="filters-container stats-filters">
                        <label for="gs-pessoa-esp-select">Pessoa:</label>
                        <select id="gs-pessoa-esp-select"><option value="">-- Selecione --</option></select>
                        <label for="gs-pessoa-esp-elemento-filtro">Elemento:</label>
                        <select id="gs-pessoa-esp-elemento-filtro"><option value="">-- Todos Elementos --</option></select>
                        <label for="gs-pessoa-esp-ano-filtro">Ano:</label>
                        <select id="gs-pessoa-esp-ano-filtro"><option value="">Todos</option></select>
                        <label for="gs-pessoa-esp-mes-filtro">Mês:</label>
                        <select id="gs-pessoa-esp-mes-filtro"><option value="">Todos</option></select>
                        <button id="btn-gs-pessoa-esp-aplicar" class="stats-apply-button">
                             <i class="fas fa-analytics stats-btn-icon"></i> Analisar
                        </button>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-pessoa-esp-loading" style="display:none;"></div>
                        <div id="gs-pessoa-esp-results" class="stats-result-text"></div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba: Pessoas -->
            <div id="gs-pessoas-content" class="global-stats-tab-content">
                <h4><i class="fas fa-users-cog stats-icon"></i> Comparar Desempenho de Pessoas</h4>
                <div class="stats-filters">
                    <!-- CUSTOM MULTI-SELECT IMPLEMENTATION -->
                    <label for="gs-pessoas-search-input-custom" style="display: block; margin-bottom: 5px;">Selecionar Pessoas:</label>
                    <div id="gs-pessoas-custom-multiselect" class="custom-multiselect-container">
                        <div class="selected-pessoas-area">
                            <!-- Selected person tags will go here -->
                        </div>
                        <input type="text" id="gs-pessoas-search-input-custom" placeholder="Pesquisar e adicionar...">
                        <div id="gs-pessoas-dropdown-custom" class="custom-multiselect-dropdown">
                            <!-- Filtered people list will appear here -->
                        </div>
                    </div>
                    <select id="gs-pessoas-select-multi" multiple style="display: none; height: 1px; width: 1px; opacity: 0; position: absolute;"></select> <!-- Original select, now hidden -->
                    <!-- END OF CUSTOM MULTI-SELECT -->

                    <label for="gs-pessoas-filtro-ano">Ano:</label>
                    <select id="gs-pessoas-filtro-ano"><option value="">Todos</option></select>
                    <label for="gs-pessoas-filtro-mes">Mês:</label>
                    <select id="gs-pessoas-filtro-mes"><option value="">Todos</option></select>
                    <label for="gs-pessoas-filtro-semana">Semana (Nº):</label>
                    <input type="number" id="gs-pessoas-filtro-semana" placeholder="1-53" min="1" max="53" style="width: 80px;">
                    <label for="gs-pessoas-filtro-genero">Gênero (Designação):</label>
                    <select id="gs-pessoas-filtro-genero"><option value="">Todos</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select>
                     <label for="gs-pessoas-filtro-idioma">Idioma (Designação):</label>
                    <select id="gs-pessoas-filtro-idioma"><option value="">Todos</option><option value="Português">Português</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select>
                    <button id="btn-gs-pessoas-comparar" class="stats-apply-button">
                        <i class="fas fa-balance-scale stats-btn-icon"></i> Comparar Selecionadas
                    </button>
                </div>
                <div class="stats-results-container">
                    <div class="loading-spinner" id="gs-pessoas-loading" style="display:none;"></div>
                    <div id="gs-pessoas-comparison-area">
                        <!-- Cards de comparação serão inseridos aqui -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo da Aba: Designações -->
            <div id="gs-designacoes-content" class="global-stats-tab-content">
                <h4><i class="fas fa-clipboard-list stats-icon"></i> Explorar Tipos de Designação (Elementos)</h4>
                 <div class="stats-filters">
                    <label for="gs-designacoes-filtro-dia">Dia:</label>
                    <input type="number" id="gs-designacoes-filtro-dia" placeholder="1-31" min="1" max="31" style="width:70px">
                    <label for="gs-designacoes-filtro-mes">Mês:</label>
                    <select id="gs-designacoes-filtro-mes"><option value="">Todos</option></select>
                    <label for="gs-designacoes-filtro-ano">Ano:</label>
                    <select id="gs-designacoes-filtro-ano"><option value="">Todos</option></select>
                    <label for="gs-designacoes-filtro-semana">Semana (Nº):</label>
                    <input type="number" id="gs-designacoes-filtro-semana" placeholder="1-53" min="1" max="53" style="width: 80px;">
                    <label for="gs-designacoes-filtro-genero">Gênero (Participante):</label>
                    <select id="gs-designacoes-filtro-genero"><option value="">Todos</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select>
                     <label for="gs-designacoes-filtro-idioma">Idioma (Participante):</label>
                    <select id="gs-designacoes-filtro-idioma"><option value="">Todos</option><option value="Português">Português</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select>
                    <button id="btn-gs-designacoes-aplicar-filtros" class="stats-apply-button" title="Aplicar filtros à lista de tipos de designação e suas instâncias">
                        <i class="fas fa-filter stats-btn-icon"></i> Aplicar Filtros
                    </button>
                </div>
                <div class="stats-results-container">
                    <p>Clique num tipo de designação para ver as instâncias (com filtros aplicados).</p>
                    <div class="loading-spinner" id="gs-designacoes-tipos-loading" style="display:none;"></div>
                    <ul id="gs-designacoes-tipos-list" class="stats-result-list">
                        <!-- Lista de todos os elementos (tipos de designação) -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para exibir instâncias de uma designação (elemento) -->
    <div id="modal-instancias-designacao" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <span class="close-button" data-modal-id="modal-instancias-designacao">×</span>
            <h3 id="modal-instancias-titulo">Instâncias de Designação</h3>
            <div class="stats-results-container" style="border-top: none; margin-top: 0;">
                 <ul id="modal-instancias-list" class="stats-result-list" style="max-height: 50vh;"></ul>
            </div>
        </div>
    </div>

    <!-- MODAL DE RANKING DA REUNIÃO -->
    <div id="modal-ranking" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" data-modal-id="modal-ranking">×</span>
            <h3><i class="fas fa-list-ol"></i> Ranking da Reunião/Semana</h3>

            <div class="filters-container stats-filters" id="ranking-filters-container">
                <label for="ranking-filtro-mes">Mês:</label>
                <select id="ranking-filtro-mes"></select>
                <label for="ranking-filtro-ano">Ano:</label>
                <select id="ranking-filtro-ano"></select>
                <label for="ranking-filtro-semana">Semana (ISO):</label>
                <select id="ranking-filtro-semana"></select>
                <button id="btn-ranking-aplicar-filtros" class="stats-apply-button">
                    <i class="fas fa-sync-alt stats-btn-icon"></i> Ver Ranking
                </button>
            </div>

            <div class="ranking-list-container">
                <p><small>Use os botões <i class="fas fa-arrow-up"></i>/<i class="fas fa-arrow-down"></i> para reordenar os itens apenas para esta visualização.</small></p>
                <ul id="lista-ranking-designacoes">
                    <!-- Designações serão listadas aqui -->
                </ul>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import {
            getFirestore, collection, getDocs, addDoc, query, where, doc, getDoc,
            serverTimestamp, updateDoc, deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // CUIDADO: Expor API Key no cliente não é o ideal para produção crítica.
        // Considere usar Firebase Functions para proteger suas credenciais ou configurar regras de segurança robustas.
        const firebaseConfig = {
            apiKey: "AIzaSyAk3dHqtGWtnPq_B09rRzUj6WC5hxdd9io", // Substitua pela sua API Key real
            authDomain: "theeye-c3ace.firebaseapp.com",
            projectId: "theeye-c3ace",
            storageBucket: "theeye-c3ace.firebasestorage.app",
            messagingSenderId: "742355525459",
            appId: "1:742355525459:web:fbe84a9594be4bedc28ba6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements (seleção extensiva)
        const listaPessoasUl = document.getElementById('lista-pessoas');
        const searchPessoaInput = document.getElementById('search-pessoa-input');
        const colunaDetalhesDiv = document.getElementById('coluna-detalhes');
        const colunaDetalhesContent = document.getElementById('coluna-detalhes-content');
        const fabMain = document.getElementById('fab-main');
        const fabOptions = document.getElementById('fab-options');
        const btnCriarPessoaFab = document.getElementById('btn-criar-pessoa-fab');
        const btnCriarElementoFab = document.getElementById('btn-criar-elemento-fab');
        const btnCriarDesignacaoFab = document.getElementById('btn-criar-designacao-fab');
        const btnGerenciarPessoasFab = document.getElementById('btn-gerenciar-pessoas-fab');
        const modalPessoa = document.getElementById('modal-pessoa');
        const modalElemento = document.getElementById('modal-elemento');
        const modalDesignacao = document.getElementById('modal-designacao');
        const modalGerenciarPessoas = document.getElementById('modal-gerenciar-pessoas');
        const modalInstanciasDesignacao = document.getElementById('modal-instancias-designacao');
        const modalInstanciasTitulo = document.getElementById('modal-instancias-titulo');
        const modalInstanciasListUl = document.getElementById('modal-instancias-list');
        const listaGerenciarPessoasUl = document.getElementById('lista-gerenciar-pessoas');
        const modalPessoaTitulo = document.getElementById('modal-pessoa-titulo');
        const pessoaIdEditInput = document.getElementById('pessoa-id-edit');
        const btnSubmitPessoa = document.getElementById('btn-submit-pessoa');
        const closeButtons = document.querySelectorAll('.close-button');
        const formCriarPessoa = document.getElementById('form-criar-pessoa');
        const nomePessoaInput = document.getElementById('nome-pessoa');
        const idiomaPessoaSelect = document.getElementById('idioma-pessoa');
        const generoPessoaSelect = document.getElementById('genero-pessoa');
        const cargoPessoaSelect = document.getElementById('cargo-pessoa');
        const pregacaoPessoaSelect = document.getElementById('pregacao-pessoa');
        const formCriarElemento = document.getElementById('form-criar-elemento');
        const nomeElementoModalInput = document.getElementById('nome-elemento-modal');
        const tipoElementoSelect = document.getElementById('tipo-elemento');
        const generoElementoSelect = document.getElementById('genero-elemento');
        const formCriarDesignacao = document.getElementById('form-criar-designacao');
        const selectElementoDesignacao = document.getElementById('select-elemento-designacao');
        const selectPessoaA = document.getElementById('select-pessoaA');
        const selectPessoaB = document.getElementById('select-pessoaB');
        const selectPessoaC = document.getElementById('select-pessoaC');
        const dataDesignacaoInput = document.getElementById('data-designacao');

        // --- MODAL EDITAR DESIGNAÇÃO ELEMENTOS ---
        const modalEditarDesignacao = document.getElementById('modal-editar-designacao');
        const formEditarDesignacao = document.getElementById('form-editar-designacao');
        const designacaoIdEditInput = document.getElementById('designacao-id-edit');
        const dataDesignacaoEditInput = document.getElementById('data-designacao-edit');
        const selectElementoDesignacaoEdit = document.getElementById('select-elemento-designacao-edit');
        const selectPessoaAEdit = document.getElementById('select-pessoaA-edit');
        const selectPessoaBEdit = document.getElementById('select-pessoaB-edit');
        const selectPessoaCEdit = document.getElementById('select-pessoaC-edit');
        const camposOradorPublicoEditDiv = document.getElementById('campos-orador-publico-edit');
        const temaOradorEditInput = document.getElementById('tema-orador-edit');
        const congregacaoOradorEditInput = document.getElementById('congregacao-orador-edit');

        // Elementos do Modal de Estatísticas Globais
        const btnGlobalStats = document.getElementById('btn-global-stats');
        const modalGlobalStats = document.getElementById('modal-global-stats');
        const globalStatsTabButtons = document.querySelectorAll('.global-stats-tab-button');
        const globalStatsTabContents = document.querySelectorAll('.global-stats-tab-content');

        // Elementos da Aba "Análises Anteriores" (gs-old-content)
        const gsTopPessoasMesSelect = document.getElementById('gs-top-pessoas-mes');
        const gsTopPessoasAnoSelect = document.getElementById('gs-top-pessoas-ano');
        const gsTopPessoasElementoSelect = document.getElementById('gs-top-pessoas-elemento'); //NOVO
        const btnGsTopPessoasAplicar = document.getElementById('btn-gs-top-pessoas-aplicar');
        const gsTopPessoasListUl = document.getElementById('gs-top-pessoas-list');
        const gsTopPessoasMostrarTodosLink = document.getElementById('gs-top-pessoas-mostrar-todos');
        const gsTodasDesigMesSelect = document.getElementById('gs-todas-desig-mes');
        const gsTodasDesigAnoSelect = document.getElementById('gs-todas-desig-ano');
        const gsTodasDesigElementoSelect = document.getElementById('gs-todas-desig-elemento');
        const btnGsTodasDesigAplicar = document.getElementById('btn-gs-todas-desig-aplicar');
        const btnGsTodasDesigAgrupar = document.getElementById('btn-gs-todas-desig-agrupar');
        const gsTodasDesigListUl = document.getElementById('gs-todas-desig-list');
        const gsTodasDesigAgrupadoContainerDiv = document.getElementById('gs-todas-desig-agrupado-container');
        const gsTodasDesigAgrupadoListUl = document.getElementById('gs-todas-desig-agrupado-list');
        const gsTodasDesigAgrupadoMostrarTodosLink = document.getElementById('gs-todas-desig-agrupado-mostrar-todos');
        const gsPessoaEspSelect = document.getElementById('gs-pessoa-esp-select');
        const gsPessoaEspElementoFiltroSelect = document.getElementById('gs-pessoa-esp-elemento-filtro');
        const gsPessoaEspAnoFiltroSelect = document.getElementById('gs-pessoa-esp-ano-filtro');
        const gsPessoaEspMesFiltroSelect = document.getElementById('gs-pessoa-esp-mes-filtro');
        const btnGsPessoaEspAplicar = document.getElementById('btn-gs-pessoa-esp-aplicar');
        const gsPessoaEspResultsDiv = document.getElementById('gs-pessoa-esp-results');

        // Elementos da Aba "Total" (gs-total-content)
        const gsTotalNumDesignacoesSpan = document.getElementById('gs-total-num-designacoes');
        const gsTotalNumDesigMascSpan = document.getElementById('gs-total-num-desig-masc');
        const gsTotalNumDesigFemSpan = document.getElementById('gs-total-num-desig-fem');
        const gsTotalNumDesigPtSpan = document.getElementById('gs-total-num-desig-pt');
        const gsTotalNumDesigItSpan = document.getElementById('gs-total-num-desig-it');
        const gsTotalNumDesigOutroIdiomaSpan = document.getElementById('gs-total-num-desig-outro-idioma');
        const gsTotalFiltroAnoSelect = document.getElementById('gs-total-filtro-ano');
        const gsTotalFiltroMesSelect = document.getElementById('gs-total-filtro-mes');
        const btnGsTotalAplicarFiltros = document.getElementById('btn-gs-total-aplicar-filtros');
        const gsTotalFiltroElementoTipoSelect = document.getElementById('gs-total-filtro-elemento-tipo');
        const btnGsTotalAplicarFiltroElemento = document.getElementById('btn-gs-total-aplicar-filtro-elemento');
        const gsTotalElementosCountSpan = document.getElementById('gs-total-elementos-count');
        const gsTotalElementosListUl = document.getElementById('gs-total-elementos-list');
        const gsTotalElementosLoading = document.getElementById('gs-total-elementos-loading');
        const gsTotalMediaDesignacoesSpan = document.getElementById('gs-total-media-designacoes');
        const gsTotalMediaDesigMascSpan = document.getElementById('gs-total-media-desig-masc');
        const gsTotalMediaDesigFemSpan = document.getElementById('gs-total-media-desig-fem');
        const gsTotalMediaDesigPtSpan = document.getElementById('gs-total-media-desig-pt');
        const gsTotalMediaDesigItSpan = document.getElementById('gs-total-media-desig-it');
        const gsTotalMediaDesigOutroSpan = document.getElementById('gs-total-media-desig-outro');

        // Elementos da Aba "Pessoas" (gs-pessoas-content)
        const gsPessoasSelectMulti = document.getElementById('gs-pessoas-select-multi'); // Original hidden select
        const gsPessoasFiltroAnoSelect = document.getElementById('gs-pessoas-filtro-ano');
        const gsPessoasFiltroMesSelect = document.getElementById('gs-pessoas-filtro-mes');
        const gsPessoasFiltroSemanaInput = document.getElementById('gs-pessoas-filtro-semana');
        const gsPessoasFiltroGeneroSelect = document.getElementById('gs-pessoas-filtro-genero');
        const gsPessoasFiltroIdiomaSelect = document.getElementById('gs-pessoas-filtro-idioma');
        const btnGsPessoasComparar = document.getElementById('btn-gs-pessoas-comparar');
        const gsPessoasLoading = document.getElementById('gs-pessoas-loading');
        const gsPessoasComparisonAreaDiv = document.getElementById('gs-pessoas-comparison-area');
        const gsPessoasCustomMultiselectDiv = document.getElementById('gs-pessoas-custom-multiselect');
        const gsPessoasSearchInputCustom = document.getElementById('gs-pessoas-search-input-custom');
        const gsPessoasDropdownCustomDiv = document.getElementById('gs-pessoas-dropdown-custom');
        const gsSelectedPessoasAreaDiv = document.querySelector('#gs-pessoas-custom-multiselect .selected-pessoas-area');


        // Elementos da Aba "Designações" (gs-designacoes-content)
        const gsDesignacoesFiltroDiaInput = document.getElementById('gs-designacoes-filtro-dia');
        const gsDesignacoesFiltroMesSelect = document.getElementById('gs-designacoes-filtro-mes');
        const gsDesignacoesFiltroAnoSelect = document.getElementById('gs-designacoes-filtro-ano');
        const gsDesignacoesFiltroSemanaInput = document.getElementById('gs-designacoes-filtro-semana');
        const gsDesignacoesFiltroGeneroSelect = document.getElementById('gs-designacoes-filtro-genero');
        const gsDesignacoesFiltroIdiomaSelect = document.getElementById('gs-designacoes-filtro-idioma');
        const btnGsDesignacoesAplicarFiltros = document.getElementById('btn-gs-designacoes-aplicar-filtros');
        const gsDesignacoesTiposLoading = document.getElementById('gs-designacoes-tipos-loading');
        const gsDesignacoesTiposListUl = document.getElementById('gs-designacoes-tipos-list');

        // --- ELEMENTOS DOM PARA O MODAL DE RANKING ---
        const btnRankingPopup = document.getElementById('btn-ranking-popup');
        const modalRanking = document.getElementById('modal-ranking');
        const rankingFiltroMesSelect = document.getElementById('ranking-filtro-mes');
        const rankingFiltroAnoSelect = document.getElementById('ranking-filtro-ano');
        const rankingFiltroSemanaSelect = document.getElementById('ranking-filtro-semana');
        const btnRankingAplicarFiltros = document.getElementById('btn-ranking-aplicar-filtros');
        const listaRankingDesignacoesUl = document.getElementById('lista-ranking-designacoes');

        // --- LÓGICA PARA CONTROLAR A BARRA LATERAL MÓVEL ---
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const colunaPessoas = document.getElementById('coluna-pessoas'); // Já deve estar declarado, mas garantimos

        if (sidebarToggleButton && sidebarOverlay && colunaPessoas) {
            // Abre/Fecha o menu ao clicar no botão hamburger
            sidebarToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-visible');
            });

            // Fecha o menu ao clicar no overlay (fundo escuro)
            sidebarOverlay.addEventListener('click', () => {
                document.body.classList.remove('sidebar-visible');
            });
        }

        // Globais
        let todasPessoas = [];
        let todosElementos = [];
        let pessoaSelecionadaAtual = null;
        let designacoesDaPessoaAtual = [];
        let designacoesFiltradas = [];

        // Charts para a coluna de detalhes da pessoa
        let designacoesChart = null;
        let designacoesPorMesChart = null;
        let designacoesPorSemanaChart = null;
        let designacoesPorAnoChart = null;

        let todasDesignacoesGlobais = [];
        let todasDesignacoesGlobaisCarregadas = false;

        // Para estatísticas globais - aba "Análises Anteriores"
        let topPessoasDadosCompletos = [];
        let topElementosAgrupadosDadosCompletos = [];
        let gsTopPessoasMostrandoApenasTop5 = true;
        let gsTopElementosAgrupadosMostrandoApenasTop5 = true;


        // Chart instances for Global Stats "Total" Tab
        let gsTotalChartDesignacoesMes = null;
        let gsTotalChartDesignacoesGeneroMes = null;
        let gsTotalChartDesignacoesIdiomaMes = null;

        // Estado para "Mostrar mais/menos" nas estatísticas da pessoa
        let mostrandoTodosElementosPessoa = false;
        let mostrandoTodosParceirosPessoa = false;

        // Estado para o modo de edição e designação atual para edição
        let editModeActive = false;
        let designacaoAtualParaEdicao = null;

        // Helper para custom multiselect
        let availablePessoasForCustomSelect = [];

        // --- ESTADO PARA O RANKING ---
        let ordemAtualElementosRanking = [];
        const ORDEM_PADRAO_ELEMENTOS_RANKING = [
            "Presidente Semana", "Oração Inicial Semana", "Tesouros", "Pérolas",
            "---SEP---", // Separador visual
            "Leitura da Bíblia", "Iniciar Conversas", "Cultivar o Interesse", "Fazer Discípulos", "Explicar Crenças", "Discurso", // "Discurso" genérico aqui
            "---SEP---",
            "Viver como Cristãos", "Estudo Bíblico", "Leitor do Estudo Bíblico", "Oração Final Semana",
            "---SEP---",
            "Presidente Fim de Semana", "Oração Inicial Fim de Semana", "Orador Público",
            "---PARAGRAPH_SEP---", // Separador de parágrafo (apenas espaço)
            "Dirigente Sentinela", "Leitor da Sentinela", "Oração Final Fim de Semana",
            "---SEP---",
            "Áudio/Vídeo", "Zoom", "Micro Palco", "Micro 2", "Indicador"
        ];


        // --- FUNÇÃO HELPER PARA LOADING ---
        function setSectionLoadingState(sectionIdPrefix, isLoading, specificButtonId = null) {
            const loadingSpinner = document.getElementById(`${sectionIdPrefix}-loading`);
            let applyButton = specificButtonId ? document.getElementById(specificButtonId) : null;

            if (!applyButton && sectionIdPrefix) {
                const sectionElement = document.getElementById(`${sectionIdPrefix}-list`)?.closest('.stats-card-section, .global-stats-tab-content') ||
                                     document.getElementById(`${sectionIdPrefix}-results`)?.closest('.stats-card-section, .global-stats-tab-content') ||
                                     document.getElementById(sectionIdPrefix)?.closest('.stats-card-section, .global-stats-tab-content');
                if (sectionElement) {
                    applyButton = sectionElement.querySelector('.stats-apply-button');
                }
            }
            // Also handle ranking filter specific loading spinner
            const rankingFiltersContainer = document.getElementById('ranking-filters-container');
            if (sectionIdPrefix === 'ranking-filtros' && rankingFiltersContainer) { // Custom handling for ranking modal
                rankingFiltersContainer.style.opacity = isLoading ? "0.5" : "1";
                rankingFiltersContainer.querySelectorAll('select, button').forEach(el => el.disabled = isLoading);
            }


            const resultList = document.getElementById(`${sectionIdPrefix}-list`) || document.getElementById(`${sectionIdPrefix}-tipos-list`);
            const resultText = document.getElementById(`${sectionIdPrefix}-results`);
            const resultArea = document.getElementById(`${sectionIdPrefix}-comparison-area`);
            const agrupadoContainer = document.getElementById(`gs-todas-desig-agrupado-container`);

            if (loadingSpinner) loadingSpinner.style.display = isLoading ? 'block' : 'none';

            const sectionToDisableButtons = (resultList || resultText || resultArea || loadingSpinner)?.closest('.stats-card-section, .global-stats-tab-content');
            if (sectionToDisableButtons) {
                sectionToDisableButtons.querySelectorAll('.stats-apply-button, .stats-filters select, .stats-filters input').forEach(interactiveEl => {
                    interactiveEl.disabled = isLoading;
                });
            } else if (applyButton) {
                 applyButton.disabled = isLoading;
            }

            if (isLoading) {
                if (resultList) resultList.innerHTML = '';
                if (resultText) resultText.innerHTML = '';
                if (resultArea) resultArea.innerHTML = '';
                if (agrupadoContainer && sectionIdPrefix === 'gs-todas-desig') {
                    agrupadoContainer.style.display = 'none';
                    const agrupadoList = document.getElementById('gs-todas-desig-agrupado-list');
                    if (agrupadoList) agrupadoList.innerHTML = '';
                }
                const mostrarTodosLink = document.getElementById(`${sectionIdPrefix}-mostrar-todos`) ||
                                         (sectionIdPrefix === 'gs-todas-desig' ? document.getElementById(`gs-todas-desig-agrupado-mostrar-todos`) : null);
                if(mostrarTodosLink) mostrarTodosLink.style.display = 'none';
            }
        }

        // --- FUNÇÃO HELPER: CALCULAR NÚMERO DA SEMANA (ISO 8601) ---
        function getISOWeek(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                console.warn("getISOWeek recebeu data inválida:", date);
                return null;
            }
            const dt = new Date(date.valueOf());
            dt.setDate(dt.getDate() + 4 - (dt.getDay() || 7)); // Ajusta para quinta-feira da semana
            const yearStart = new Date(dt.getFullYear(), 0, 1);
            // Calcula o número da semana
            const weekNumber = Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
            return weekNumber;
        }

        // --- Barra de Pesquisa Pessoas ---
        if (searchPessoaInput) {
            searchPessoaInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const pessoasLi = listaPessoasUl.getElementsByTagName('li');
                Array.from(pessoasLi).forEach(li => {
                    const nomePessoa = li.textContent.toLowerCase();
                    li.classList.toggle('hidden-by-search', !nomePessoa.includes(searchTerm));
                });
            });
        } else { console.warn("Elemento searchPessoaInput não encontrado."); }

        async function carregarTodosElementosParaEstatisticas() {
            console.log("carregarTodosElementosParaEstatisticas: Iniciando");
            try {
                const querySnapshot = await getDocs(collection(db, "elementos"));
                todosElementos = [];
                querySnapshot.forEach((docSnap) => todosElementos.push({ id: docSnap.id, ...docSnap.data() }));
                todosElementos.sort((a, b) => (a.designacao || a.nome || '').localeCompare(b.designacao || b.nome || '', 'pt-BR', { sensitivity: 'base' }));
                console.log(`carregarTodosElementosParaEstatisticas: ${todosElementos.length} elementos carregados.`);

                if (selectElementoDesignacao) {
                    selectElementoDesignacao.innerHTML = '<option value="">-- Selecione um Elemento --</option>';
                    todosElementos.forEach(el => {
                        const option = document.createElement('option');
                        option.value = el.designacao || el.nome;
                        option.textContent = el.designacao || el.nome;
                        selectElementoDesignacao.appendChild(option);
                    });
                }

                if (todasDesignacoesGlobaisCarregadas) {
                    popularFiltrosStatsGlobais();
                }
                if (gsDesignacoesTiposListUl) popularListaElementosAbaDesignacoes();

            } catch (error) {
                console.error("Erro ao carregar elementos: ", error);
                alert("Falha ao carregar elementos.");
            }
        }

        function popularDropdownsPessoasNosModais() {
            console.log("popularDropdownsPessoasNosModais: Iniciando");
            const pessoasVisiveis = todasPessoas.filter(p => p.estaVisivel !== false);
            const optionsHtml = pessoasVisiveis.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');

            if (selectPessoaA) selectPessoaA.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            if (selectPessoaB) selectPessoaB.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            if (selectPessoaC) selectPessoaC.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;

            if (gsPessoaEspSelect) {
                 const currentVal = gsPessoaEspSelect.value;
                gsPessoaEspSelect.innerHTML = '<option value="">-- Selecione --</option>' + todasPessoas.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                if (Array.from(gsPessoaEspSelect.options).some(opt => opt.value === currentVal)) gsPessoaEspSelect.value = currentVal; else gsPessoaEspSelect.value = "";
            }
            if (gsPessoasSelectMulti) { // Populates the hidden original select for the custom component
                const currentSelectedIds = Array.from(gsPessoasSelectMulti.selectedOptions).map(opt => opt.value);
                gsPessoasSelectMulti.innerHTML = todasPessoas
                    .filter(p => p.estaVisivel !== false)
                    .map(p => `<option value="${p.id}">${p.nome}</option>`)
                    .join('');
                currentSelectedIds.forEach(id => {
                     const opt = Array.from(gsPessoasSelectMulti.options).find(o => o.value === id);
                     if (opt) opt.selected = true;
                });
            }


            const selectOutraPessoaDetalhes = document.getElementById('select-outra-pessoa');
            if (selectOutraPessoaDetalhes && pessoaSelecionadaAtual) {
                 const pessoasDisponiveisParaConjunta = todasPessoas
                    .filter(p => p.id !== pessoaSelecionadaAtual.id && p.estaVisivel !== false)
                    .map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                selectOutraPessoaDetalhes.innerHTML = `<option value="">-- Selecione Pessoa --</option>${pessoasDisponiveisParaConjunta}`;
            }
            console.log("popularDropdownsPessoasNosModais: Dropdowns populados.");
        }

        async function carregarPessoas() {
            console.log("carregarPessoas: Iniciando");
            try {
                const querySnapshot = await getDocs(collection(db, "pessoas"));
                todasPessoas = [];
                querySnapshot.forEach((docSnap) => todasPessoas.push({ id: docSnap.id, ...docSnap.data() }));
                todasPessoas.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' }));

                if (listaPessoasUl) listaPessoasUl.innerHTML = '';
                else { console.error("ERRO CRÍTICO: listaPessoasUl não encontrado em carregarPessoas."); return; }

                if (searchPessoaInput) searchPessoaInput.value = '';
                const pessoasVisiveis = todasPessoas.filter(p => p.estaVisivel !== false);
                console.log(`carregarPessoas: Encontradas ${todasPessoas.length} pessoas, ${pessoasVisiveis.length} visíveis.`);

                pessoasVisiveis.forEach(pessoa => {
                    const li = document.createElement('li');
                    li.textContent = pessoa.nome;
                    li.dataset.pessoaId = pessoa.id;
                    li.addEventListener('click', () => {
                        console.log("Pessoa da lista clicada:", pessoa.nome, pessoa.id);
                        document.querySelectorAll('#lista-pessoas li').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        pessoaSelecionadaAtual = pessoa;
                        // ...
                        mostrandoTodosParceirosPessoa = false;
                        editModeActive = false;
                        carregarDesignacoesDaPessoa(pessoa.id);

                        // ADICIONE ESTA LINHA AQUI:
                        document.body.classList.remove('sidebar-visible'); // Fecha o menu após a seleção
                    });
                    listaPessoasUl.appendChild(li);
                });
                popularDropdownsPessoasNosModais();
                if (todasDesignacoesGlobaisCarregadas) {
                    popularFiltrosStatsGlobais();
                }
            } catch (error) { console.error("Erro ao carregar pessoas: ", error); alert("Falha ao carregar pessoas."); }
        }

        async function carregarDesignacoesDaPessoa(pessoaId) {
            console.log("carregarDesignacoesDaPessoa para ID:", pessoaId);
            pessoaSelecionadaAtual = todasPessoas.find(p => p.id === pessoaId);
            if (!pessoaSelecionadaAtual) {
                console.error("Não foi possível encontrar a pessoa selecionada para carregar designações.");
                if(colunaDetalhesDiv && colunaDetalhesContent) {
                    colunaDetalhesDiv.innerHTML = '';
                    colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                    colunaDetalhesContent.style.display = 'flex';
                }
                return;
            }
            const nomePessoa = pessoaSelecionadaAtual.nome;

            criarEstruturaDetalhes(); // This will also reset editModeActive visually
            const historicoContent = document.getElementById('historico-content');
            if (historicoContent) historicoContent.innerHTML = '<p style="text-align:center;color:#777;margin-top:20px;">Carregando designações...</p>';
            else { console.error("Elemento #historico-content não encontrado após criarEstruturaDetalhes."); return; }

            try {
                const q = query(collection(db, "designacoes"), where(`participantes.${nomePessoa}`, "==", true));
                const querySnapshot = await getDocs(q);
                designacoesDaPessoaAtual = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (!data.semanaISO && data.data) {
                        try {
                            const [dia, mes, ano] = data.data.split('/');
                            const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                            if (!isNaN(dateObj.getTime())) {
                                 data.semanaISO = getISOWeek(dateObj);
                            } else {
                                console.warn("Data inválida para designação (carregarDesignacoesDaPessoa), não foi possível calcular semanaISO:", data.data, docSnap.id);
                                data.semanaISO = null;
                            }
                        } catch (e) {
                            console.warn("Erro ao converter data para semanaISO (carregarDesignacoesDaPessoa):", data.data, docSnap.id, e);
                            data.semanaISO = null;
                        }
                    }
                    designacoesDaPessoaAtual.push({ id: docSnap.id, ...data });
                });
                console.log(`carregarDesignacoesDaPessoa: ${designacoesDaPessoaAtual.length} designações encontradas para ${nomePessoa}`);
                popularFiltros();
                aplicarEAtualizarFiltros();
            } catch (error) {
                console.error(`Erro ao carregar designações para ${nomePessoa}: `, error);
                if (historicoContent) historicoContent.innerHTML = `<p style="text-align:center;color:#777;margin-top:20px;">Erro ao carregar designações.</p>`;
            }
        }

        function criarEstruturaDetalhes() {
            if (!colunaDetalhesDiv || !colunaDetalhesContent) {
                console.error("ERRO CRÍTICO: colunaDetalhesDiv ou colunaDetalhesContent não encontrado em criarEstruturaDetalhes.");
                return;
            }
            console.log("criarEstruturaDetalhes - Pessoa selecionada:", pessoaSelecionadaAtual?.nome);
            if (!pessoaSelecionadaAtual) {
                colunaDetalhesDiv.innerHTML = '';
                colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                colunaDetalhesContent.style.display = 'flex';
                console.log("criarEstruturaDetalhes: Nenhuma pessoa selecionada, mostrando placeholder.");
                return;
            }
            colunaDetalhesContent.style.display = 'none';

            colunaDetalhesDiv.innerHTML = `
                <h3>Detalhes de: <span id="nome-pessoa-detalhe">${pessoaSelecionadaAtual.nome}</span></h3>
                <div class="tabs">
                    <button class="tab-button active" data-tab="historico">Linha</button>
                    <button class="tab-button" data-tab="arquivo">Arquivo</button>
                    <button class="tab-button" data-tab="estatisticas">Estatísticas</button>
                    <button class="tab-button" id="tab-btn-editar-modo" data-tab="editar-modo">Editar</button>
                </div>

                <button id="btn-toggle-filtros-pessoa" class="btn-toggle-filtros">
                    <i class="fas fa-filter"></i>
                    <span class="btn-toggle-text">Mostrar Filtros</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </button>

                <div class="filtros-wrapper-mobile">
                    <div class="filters-container" id="filtros-pessoa-container">
                        <label for="filtro-mes">Mês:</label>
                        <select id="filtro-mes"><option value="">Todos</option>${[...Array(12).keys()].map(i => `<option value="${String(i + 1).padStart(2, '0')}">${new Date(0, i).toLocaleString('pt-BR', { month: 'long' })}</option>`).join('')}</select>
                        <label for="filtro-ano">Ano:</label><select id="filtro-ano"><option value="">Todos</option></select>
                        <label for="filtro-semana">Semana:</label><select id="filtro-semana"><option value="">Todas</option></select>
                        <label for="filtro-elemento">Elemento:</label><select id="filtro-elemento"><option value="">Todos</option></select>
                        <button id="btn-aplicar-filtros">Aplicar</button>
                        <button id="btn-limpar-filtros">Limpar</button>
                    </div>
                </div>

                <div id="historico-content" class="tab-content active"></div>
                <div id="arquivo-content" class="tab-content">
                    <div class="gs-old-submenu-tabs" style="margin-bottom: 0;">
                        <button class="gs-old-submenu-button active" data-filtro="semana">Semana</button>
                        <button class="gs-old-submenu-button" data-filtro="fim de semana">Fim de Semana</button>
                        <button class="gs-old-submenu-button" data-filtro="tecnico">Técnicas</button>
                        <button class="gs-old-submenu-button" data-filtro="pregacao">Pregação</button>
                    </div>
                    <div id="arquivo-resultados-container" style="overflow-y: auto; flex-grow: 1;">
                        <ul id="arquivo-resultados-lista" style="list-style-type: none; padding: 0;"></ul>
                    </div>
                </div>
                <div id="estatisticas-content" class="tab-content"></div>`;
            console.log("criarEstruturaDetalhes: Estrutura da segunda coluna criada com a aba Arquivo.");

            const tabBtnEditarModo = document.getElementById('tab-btn-editar-modo');

            document.querySelectorAll('#coluna-detalhes .tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;
                    if (targetTabId === 'editar-modo') {
                        editModeActive = !editModeActive;
                        tabBtnEditarModo.classList.toggle('active-edit-mode', editModeActive);
                        tabBtnEditarModo.textContent = editModeActive ? "Modo Edição Ativado" : "Editar";
                        if (document.getElementById('historico-content')?.classList.contains('active')) {
                            renderizarHistorico();
                        }
                        return;
                    } 
                    
                    document.querySelectorAll('#coluna-detalhes .tab-button:not(#tab-btn-editar-modo)').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    const historicoContentDiv = document.getElementById('historico-content');
                    const arquivoContentDiv = document.getElementById('arquivo-content');
                    const estatisticasContentDiv = document.getElementById('estatisticas-content');

                    historicoContentDiv.classList.toggle('active', targetTabId === 'historico');
                    arquivoContentDiv.classList.toggle('active', targetTabId === 'arquivo');
                    estatisticasContentDiv.classList.toggle('active', targetTabId === 'estatisticas');

                    if (targetTabId === 'historico') renderizarHistorico();
                    else if (targetTabId === 'arquivo') setupArquivoTab();
                    else if (targetTabId === 'estatisticas') renderizarEstatisticas();
                });
            });

            editModeActive = false;
            if (tabBtnEditarModo) {
                tabBtnEditarModo.classList.remove('active-edit-mode');
                tabBtnEditarModo.textContent = "Editar";
            }

            const btnAplicar = document.getElementById('btn-aplicar-filtros');
            const btnLimpar = document.getElementById('btn-limpar-filtros');
            if(btnAplicar) btnAplicar.addEventListener('click', aplicarEAtualizarFiltros);
            if(btnLimpar) {
                btnLimpar.addEventListener('click', () => {
                    editModeActive = false;
                    if (tabBtnEditarModo) {
                        tabBtnEditarModo.classList.remove('active-edit-mode');
                        tabBtnEditarModo.textContent = "Editar";
                    }
                    limparEAtualizarFiltros();
                });
            }

            const btnToggleFiltrosPessoa = document.getElementById('btn-toggle-filtros-pessoa');
            const filtrosWrapperMobile = document.querySelector('.filtros-wrapper-mobile'); 

            if (btnToggleFiltrosPessoa && filtrosWrapperMobile) {
                const btnTextElement = btnToggleFiltrosPessoa.querySelector('.btn-toggle-text');
                
                btnToggleFiltrosPessoa.addEventListener('click', () => {
                    const isMobile = window.innerWidth <= 768;
                    filtrosWrapperMobile.classList.toggle('filtros-visiveis');
                    btnToggleFiltrosPessoa.classList.toggle('active');
                    const isNowVisible = filtrosWrapperMobile.classList.contains('filtros-visiveis');
                    if (btnTextElement) {
                        btnTextElement.textContent = isNowVisible ? "Ocultar Filtros" : "Mostrar Filtros";
                    }
                    if (!isMobile) {
                        filtrosWrapperMobile.style.display = isNowVisible ? 'grid' : 'none';
                    }
                });
                
                function adjustFilterDisplayOnLoadOrResize() {
                    const isMobile = window.innerWidth <= 768;
                    filtrosWrapperMobile.style.display = '';
                    if (!isMobile) {
                        btnToggleFiltrosPessoa.style.display = 'flex';
                        const isVisible = filtrosWrapperMobile.classList.contains('filtros-visiveis');
                        filtrosWrapperMobile.style.display = isVisible ? 'block' : 'none';
                    } else {
                        btnToggleFiltrosPessoa.style.display = 'flex';
                    }
                }
                adjustFilterDisplayOnLoadOrResize();
                window.addEventListener('resize', adjustFilterDisplayOnLoadOrResize);
            }
        }
        
        function setupArquivoTab() {
            const submenuButtons = document.querySelectorAll('#arquivo-content .gs-old-submenu-button');
            
            submenuButtons.forEach(button => {
                button.addEventListener('click', () => {
                    submenuButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filtro = button.dataset.filtro;
                    renderizarArquivo(filtro);
                });
            });

            const filtroInicial = document.querySelector('#arquivo-content .gs-old-submenu-button.active')?.dataset.filtro || 'semana';
            renderizarArquivo(filtroInicial);
        }

       function renderizarArquivo(filtroGenero) {
    console.log(`Renderizando arquivo com filtro: ${filtroGenero}`);
    const listaResultadosUl = document.getElementById('arquivo-resultados-lista');
    if (!listaResultadosUl) {
        console.error("Elemento #arquivo-resultados-lista não encontrado.");
        return;
    }

    listaResultadosUl.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Filtrando designações...</p>';

    // Filtra as designações da pessoa atual
    const designacoesFiltradas = designacoesDaPessoaAtual.filter(desig => {
        const elemento = todosElementos.find(el => (el.designacao || el.nome) === desig.nome);
        if (!elemento) return false;

        // O filtro "Pregação" é um 'tipo', enquanto os outros são 'generoReuniao'
        if (filtroGenero === 'pregacao') {
            return elemento.tipo === 'pregacao';
        }
        // Para os outros filtros, verificamos o generoReuniao
        return elemento.generoReuniao === filtroGenero;
    });

    // Ordena por data, da mais recente para a mais antiga
    const designacoesOrdenadas = [...designacoesFiltradas].sort((a, b) => {
        const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
        const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
        return dateB - dateA;
    });

    listaResultadosUl.innerHTML = ''; // Limpa a lista para os novos resultados

    if (designacoesOrdenadas.length === 0) {
        listaResultadosUl.innerHTML = '<li style="text-align:center; color:#777; margin-top:20px; padding: 10px;">Nenhuma designação encontrada para este filtro.</li>';
        return;
    }
    
    // Reutiliza a lógica de separador de mês do histórico para consistência
    let mesAnoAtualSeparador = null;
    let primeiroSeparadorAdicionado = false;

    designacoesOrdenadas.forEach(desig => {
        const dataFormatada = `${String(desig.dia).padStart(2, '0')}/${String(desig.mes).padStart(2, '0')}/${desig.ano}`;
        const nomeMesAnoSeparador = `${new Date(desig.ano, desig.mes - 1).toLocaleString('pt-BR', { month: 'long' })} de ${desig.ano}`;

        if (mesAnoAtualSeparador !== nomeMesAnoSeparador) {
            mesAnoAtualSeparador = nomeMesAnoSeparador;
            const separadorLi = document.createElement('li');
            separadorLi.className = 'month-separator';
            if (!primeiroSeparadorAdicionado) {
                separadorLi.classList.add('first-month-separator');
                primeiroSeparadorAdicionado = true;
            }
            // LINHA MODIFICADA: Adicionada a tag <strong> para o negrito
            separadorLi.innerHTML = `<strong>${nomeMesAnoSeparador.charAt(0).toUpperCase() + nomeMesAnoSeparador.slice(1)}</strong>`;
            listaResultadosUl.appendChild(separadorLi);
        }
        
        const li = document.createElement('li');
        // Adiciona um padding e borda para se assemelhar aos itens do histórico
        li.style.padding = "8px 10px";
        li.style.borderBottom = "1px solid #eee";

        const participantesString = [desig.pessoaA, desig.pessoaB, desig.pessoaC].filter(Boolean).join(' - ');
        li.textContent = `${dataFormatada} | ${desig.nome}: ${participantesString}`;
        listaResultadosUl.appendChild(li);
    });
}

        function popularFiltros() {
            console.log("popularFiltros: Iniciando");
            const filtroAnoSelect = document.getElementById('filtro-ano');
            const filtroElementoSelect = document.getElementById('filtro-elemento');
            const filtroSemanaSelect = document.getElementById('filtro-semana');

            if (!filtroAnoSelect || !filtroElementoSelect || !filtroSemanaSelect) {
                console.warn("popularFiltros: Elementos de filtro não encontrados.");
                return;
            }

            const anos = [...new Set(designacoesDaPessoaAtual.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));
            const elementos = [...new Set(designacoesDaPessoaAtual.map(d => d.nome))].sort((a, b) => a.localeCompare(b));

            const semanasUnicasComDatas = designacoesDaPessoaAtual
                .filter(d => (d.semana && typeof d.semana === 'string') || d.semanaISO)
                .map(d => ({
                    valorSemana: d.semana || `Semana ISO ${d.semanaISO} (${d.ano})`,
                    textoSemana: d.semana || `Semana ISO ${d.semanaISO} (${d.ano})`,
                    ano: parseInt(d.ano),
                    mes: parseInt(d.mes),
                    dia: parseInt(d.dia)
                }))
                .reduce((acc, current) => {
                    if (!acc.find(item => item.valorSemana === current.valorSemana)) {
                        acc.push(current);
                    }
                    return acc;
                }, [])
                .sort((a, b) => {
                    const dateA = new Date(a.ano, a.mes - 1, a.dia);
                    const dateB = new Date(b.ano, b.mes - 1, b.dia);
                    return dateA - dateB;
                });

            const semanasOptions = semanasUnicasComDatas.map(item => `<option value="${item.valorSemana}">${item.textoSemana}</option>`).join('');

            filtroAnoSelect.innerHTML = '<option value="">Todos</option>' + anos.map(ano => `<option value="${ano}">${ano}</option>`).join('');
            if (anos.length > 0) {
                filtroAnoSelect.value = anos[0];
            } else {
                filtroAnoSelect.value = "";
            }

            filtroElementoSelect.innerHTML = '<option value="">Todos</option>' + elementos.map(el => `<option value="${el}">${el}</option>`).join('');
            filtroSemanaSelect.innerHTML = '<option value="">Todas</option>' + semanasOptions;

            console.log("popularFiltros: Filtros de detalhes populados.");
        }

        function aplicarEAtualizarFiltros() {
            console.log("aplicarEAtualizarFiltros: Aplicando filtros.");
            const mesEl = document.getElementById('filtro-mes');
            const anoEl = document.getElementById('filtro-ano');
            const elemEl = document.getElementById('filtro-elemento');
            const semanaEl = document.getElementById('filtro-semana');

            const mes = mesEl ? mesEl.value : "";
            const ano = anoEl ? anoEl.value : "";
            const elemento = elemEl ? elemEl.value : "";
            const semana = semanaEl ? semanaEl.value : "";

            designacoesFiltradas = designacoesDaPessoaAtual.filter(d => {
                const matchMes = !mes || d.mes === mes;
                const matchAno = !ano || d.ano === ano;
                const matchElemento = !elemento || d.nome === elemento;
                const matchSemana = !semana || (d.semana === semana) || (!d.semana && d.semanaISO && `Semana ISO ${d.semanaISO} (${d.ano})` === semana);
                return matchMes && matchAno && matchElemento && matchSemana;
            });

            const activeTabButton = document.querySelector('#coluna-detalhes .tab-button.active:not(#tab-btn-editar-modo)');
            if (activeTabButton?.dataset.tab === 'historico') renderizarHistorico();
            else if (activeTabButton?.dataset.tab === 'estatisticas') renderizarEstatisticas();
            else if (document.getElementById('historico-content')?.classList.contains('active')) renderizarHistorico();
        }

        function limparEAtualizarFiltros() {
            console.log("limparEAtualizarFiltros: Limpando filtros.");
            const filtroMes = document.getElementById('filtro-mes');
            const filtroAno = document.getElementById('filtro-ano');
            const filtroElemento = document.getElementById('filtro-elemento');
            const filtroSemana = document.getElementById('filtro-semana');
            if (filtroMes) filtroMes.value = "";
            if (filtroAno) filtroAno.value = "";
            if (filtroElemento) filtroElemento.value = "";
            if (filtroSemana) filtroSemana.value = "";
            aplicarEAtualizarFiltros();
        }

        function renderizarHistorico() {
            console.log("renderizarHistorico: Iniciando. Modo Edição:", editModeActive);
            const historicoContent = document.getElementById('historico-content');
            if (!historicoContent) { console.error("renderizarHistorico: #historico-content não encontrado."); return; }
            historicoContent.innerHTML = '';
            if (designacoesFiltradas.length === 0) {
                historicoContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Nenhuma designação encontrada com os filtros atuais.</p>';
                return;
            }
            const designacoesOrdenadas = [...designacoesFiltradas].sort((a, b) => {
                const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
                const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });

            const ul = document.createElement('ul');
            let currentMonthYearForColor = null;
            let currentWeekForColor = null;
            let colorIndex = 0;
            const weekColors = ['#f8f9fa', '#e9ecef'];

            let mesAnoAtualSeparador = null;
            let primeiroSeparadorAdicionado = false;

            designacoesOrdenadas.forEach((desig) => {
                const dataFormatada = `${String(desig.dia).padStart(2, '0')}/${String(desig.mes).padStart(2, '0')}/${desig.ano}`;
                const mesDaDesignacao = parseInt(desig.mes);
                const anoDaDesignacao = parseInt(desig.ano);
                const nomeMesAnoSeparador = `${new Date(anoDaDesignacao, mesDaDesignacao - 1).toLocaleString('pt-BR', { month: 'long' })} de ${anoDaDesignacao}`;

                if (mesAnoAtualSeparador !== nomeMesAnoSeparador) {
                    mesAnoAtualSeparador = nomeMesAnoSeparador;
                    const separadorLi = document.createElement('li');
                    separadorLi.classList.add('month-separator');
                    if (!primeiroSeparadorAdicionado) {
                        separadorLi.classList.add('first-month-separator');
                        primeiroSeparadorAdicionado = true;
                    }
                    separadorLi.textContent = nomeMesAnoSeparador.charAt(0).toUpperCase() + nomeMesAnoSeparador.slice(1);
                    ul.appendChild(separadorLi);
                    currentMonthYearForColor = `${desig.mes}/${desig.ano}`;
                    currentWeekForColor = null;
                    colorIndex = 0;
                }

                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';

                const weekIdentifier = desig.semana || (desig.semanaISO ? `ISO-${desig.semanaISO}-${desig.ano}` : `UnknownWeek-${desig.data}`);

                if (currentMonthYearForColor !== `${desig.mes}/${desig.ano}`) {
                    currentMonthYearForColor = `${desig.mes}/${desig.ano}`;
                    currentWeekForColor = weekIdentifier;
                    colorIndex = 0;
                } else if (currentWeekForColor !== weekIdentifier) {
                    currentWeekForColor = weekIdentifier;
                    colorIndex = (colorIndex + 1) % weekColors.length;
                }
                li.style.backgroundColor = weekColors[colorIndex];

                const nomeElementoDesig = desig.nome;
                const elementoCorrespondente = todosElementos.find(el => (el.designacao || el.nome) === nomeElementoDesig);

                let emojiPrefixo = "";
                if (elementoCorrespondente && elementoCorrespondente.tipo === 'reuniao') {
                    switch (elementoCorrespondente.generoReuniao) {
                        case 'tecnico': emojiPrefixo = "⚙️ "; break;
                        case 'semana': emojiPrefixo = "💎 "; break;
                        case 'fim de semana': emojiPrefixo = "💬 "; break;
                        default: emojiPrefixo = ""; break;
                    }
                }

                const nomeElementoDisplay = desig.nome || 'Elemento sem nome';
                const participantesNomesArray = [desig.pessoaA, desig.pessoaB, desig.pessoaC].filter(Boolean);
                const participantesString = participantesNomesArray.join(' - ');

                let textoFinal = `${dataFormatada} | ${emojiPrefixo}${nomeElementoDisplay}`;
                if (participantesString) {
                    textoFinal += `: ${participantesString}`;
                }
                if (desig.nome === "Orador Público" && (desig.tema || desig.congregacao)) {
                    textoFinal += ` (`;
                    if (desig.tema) textoFinal += `Tema: ${desig.tema}`;
                    if (desig.tema && desig.congregacao) textoFinal += `; `;
                    if (desig.congregacao) textoFinal += `Cong: ${desig.congregacao}`;
                    textoFinal += `)`;
                }

                const textSpan = document.createElement('span');
                textSpan.textContent = textoFinal;
                li.appendChild(textSpan);

                if (editModeActive) {
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                    editBtn.dataset.designacaoId = desig.id;
                    editBtn.addEventListener('click', () => abrirModalEdicaoDesignacao(desig.id));
                    li.appendChild(editBtn);
                }
                ul.appendChild(li);
            });

            if (ul.childNodes.length > 0) {
                 const ultimoItemDeDesignacaoReal = Array.from(ul.childNodes).filter(node => !node.classList.contains('month-separator')).pop();
                if (ultimoItemDeDesignacaoReal) {
                    ultimoItemDeDesignacaoReal.style.borderBottom = 'none';
                }
                historicoContent.appendChild(ul);
            } else if (designacoesFiltradas.length > 0) {
                historicoContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Erro ao exibir histórico.</p>';
            }
            console.log("renderizarHistorico: Histórico renderizado.");
        }

        async function abrirModalEdicaoDesignacao(designacaoId) {
            designacaoAtualParaEdicao = designacoesDaPessoaAtual.find(d => d.id === designacaoId);
            if (!designacaoAtualParaEdicao) {
                alert("Erro: Designação não encontrada para edição.");
                return;
            }

            formEditarDesignacao.reset();
            designacaoIdEditInput.value = designacaoId;
            dataDesignacaoEditInput.value = designacaoAtualParaEdicao.data;

            selectElementoDesignacaoEdit.innerHTML = '<option value="">-- Selecione um Elemento --</option>';
            todosElementos.forEach(el => {
                const option = document.createElement('option');
                const elNome = el.designacao || el.nome;
                option.value = elNome;
                option.textContent = elNome;
                option.selected = elNome === designacaoAtualParaEdicao.nome;
                selectElementoDesignacaoEdit.appendChild(option);
            });

            const pessoasVisiveis = todasPessoas.filter(p => p.estaVisivel !== false);
            const optionsHtml = pessoasVisiveis.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');

            selectPessoaAEdit.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            selectPessoaBEdit.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            selectPessoaCEdit.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;

            if (designacaoAtualParaEdicao.pessoaA) selectPessoaAEdit.value = designacaoAtualParaEdicao.pessoaA;
            if (designacaoAtualParaEdicao.pessoaB) selectPessoaBEdit.value = designacaoAtualParaEdicao.pessoaB;
            if (designacaoAtualParaEdicao.pessoaC) selectPessoaCEdit.value = designacaoAtualParaEdicao.pessoaC;

            const toggleOradorFieldsEdit = () => {
                if (selectElementoDesignacaoEdit.value === "Orador Público") {
                    camposOradorPublicoEditDiv.style.display = 'block';
                } else {
                    camposOradorPublicoEditDiv.style.display = 'none';
                }
            };

            selectElementoDesignacaoEdit.onchange = toggleOradorFieldsEdit;
            toggleOradorFieldsEdit();

            if (designacaoAtualParaEdicao.nome === "Orador Público") {
                temaOradorEditInput.value = designacaoAtualParaEdicao.tema || '';
                congregacaoOradorEditInput.value = designacaoAtualParaEdicao.congregacao || '';
            } else {
                temaOradorEditInput.value = '';
                congregacaoOradorEditInput.value = '';
            }
            abrirModal(modalEditarDesignacao);
        }

        if (formEditarDesignacao) {
            formEditarDesignacao.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = designacaoIdEditInput.value;
                const dataStr = dataDesignacaoEditInput.value;
                const nomeElemento = selectElementoDesignacaoEdit.value;
                const pA = selectPessoaAEdit.value;
                const pB = selectPessoaBEdit.value;
                const pC = selectPessoaCEdit.value;

                if (!id) { alert("Erro: ID da designação não encontrado."); return; }
                if (!nomeElemento) { alert("Selecione um elemento."); return; }
                if (!pA && !pB && !pC && nomeElemento !== "Orador Público") {
                     alert("Selecione pelo menos uma pessoa para designações que não sejam 'Orador Público'.");
                     return;
                }
                if (!dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) { alert("Formato de data inválido. Use DD/MM/AAAA."); return; }

                const [dia, mes, ano] = dataStr.split('/');
                const participantes = {};
                if (pA) participantes[pA] = true;
                if (pB) participantes[pB] = true;
                if (pC) participantes[pC] = true;

                const pessoasSelecionadasNomes = [pA, pB, pC].filter(pNome => pNome !== "");
                if (new Set(pessoasSelecionadasNomes).size !== pessoasSelecionadasNomes.length) {
                    alert("Pessoas duplicadas selecionadas. Cada pessoa deve ser única."); return;
                }

                const elementoOriginalObj = todosElementos.find(el => (el.designacao || el.nome) === nomeElemento);
                if (!elementoOriginalObj) {
                    alert("Elemento selecionado não encontrado na base de dados de elementos.");
                    return;
                }

                const updateData = {
                    nome: nomeElemento,
                    elementoId: elementoOriginalObj.id,
                    pessoaA: pA || null,
                    pessoaB: pB || null,
                    pessoaC: pC || null,
                    participantes: participantes,
                    data: dataStr,
                    dia: dia.padStart(2, '0'),
                    mes: mes.padStart(2, '0'),
                    ano: ano,
                    ultimaModificacao: serverTimestamp()
                };
                
                if (designacaoAtualParaEdicao && designacaoAtualParaEdicao.semana) {
                     if (designacaoAtualParaEdicao.data !== dataStr) {
                        console.warn("Data alterada, a string 'semana' descritiva pode não corresponder mais se não for recalculada.");
                        updateData.semana = designacaoAtualParaEdicao.semana;
                    } else {
                         updateData.semana = designacaoAtualParaEdicao.semana;
                    }
                }

                try {
                    const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                    if (!isNaN(dateObj.getTime())) {
                        updateData.semanaISO = getISOWeek(dateObj);
                    } else {
                        console.warn("Data inválida ao editar designação, semanaISO não será atualizada:", dataStr);
                        updateData.semanaISO = designacaoAtualParaEdicao?.semanaISO || null;
                    }
                } catch(err) {
                     console.warn("Erro ao calcular semanaISO na edição da designação:", err);
                     updateData.semanaISO = designacaoAtualParaEdicao?.semanaISO || null;
                }

                if (nomeElemento === "Orador Público") {
                    updateData.tema = temaOradorEditInput.value.trim() || null;
                    updateData.congregacao = congregacaoOradorEditInput.value.trim() || null;
                } else {
                    updateData.tema = null;
                    updateData.congregacao = null;
                }

                try {
                    const designacaoRef = doc(db, "designacoes", id);
                    await updateDoc(designacaoRef, updateData);
                    alert("Designação atualizada com sucesso!");
                    fecharModal(modalEditarDesignacao);
                    await carregarDesignacoesDaPessoa(pessoaSelecionadaAtual.id);
                    todasDesignacoesGlobaisCarregadas = false;

                } catch (error) {
                    console.error("Erro ao atualizar designação: ", error);
                    alert("Erro ao atualizar designação: " + error.message);
                }
            });
        }

        function renderizarEstatisticas() {
            console.log("renderizarEstatisticas: Iniciando");
            const statsContent = document.getElementById('estatisticas-content');
            if (!statsContent) { console.error("renderizarEstatisticas: #estatisticas-content não encontrado."); return; }

            if (!pessoaSelecionadaAtual || designacoesFiltradas.length === 0) {
                console.log("renderizarEstatisticas: Sem dados para estatísticas.");
                statsContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Nenhuma designação para calcular estatísticas com os filtros atuais.</p>';
                return;
            }

            let allCardsHtml = '';

            const totalDesignacoes = designacoesFiltradas.length;
            allCardsHtml += `<div class="stat-card"><h4>Total de Designações</h4><span class="stat-value">${totalDesignacoes}</span><span class="stat-label">(Com filtro aplicado)</span></div>`;

            const contagemElementos = designacoesFiltradas.reduce((acc, d) => { acc[d.nome] = (acc[d.nome] || 0) + 1; return acc; }, {});
            const todosElementosRealizadosOriginal = Object.entries(contagemElementos).sort(([, a], [, b]) => b - a || (a.nome || '').localeCompare(b.nome || ''));

            allCardsHtml += `<div class="stat-card">
                                <h4>Elementos Mais Realizados</h4>
                                <ul id="lista-elementos-pessoa"></ul>
                                <a href="#" id="link-mostrar-todos-elementos-pessoa" class="mostrar-todos-link" style="display:none;">Mostrar mais</a>
                             </div>`;

            const contagemParceiros = designacoesFiltradas.reduce((acc, d) => {
                [d.pessoaA, d.pessoaB, d.pessoaC].filter(p => p && p !== pessoaSelecionadaAtual.nome).forEach(parceiro => acc[parceiro] = (acc[parceiro] || 0) + 1);
                return acc;
            }, {});
            const todosParceirosFrequentesOriginal = Object.entries(contagemParceiros).sort(([, a], [, b]) => b - a || (a[0] || '').localeCompare(b[0] || ''));

            allCardsHtml += `<div class="stat-card">
                                <h4>Parceiros Mais Frequentes</h4>
                                <ul id="lista-parceiros-pessoa"></ul>
                                <a href="#" id="link-mostrar-todos-parceiros-pessoa" class="mostrar-todos-link" style="display:none;">Mostrar mais</a>
                             </div>`;

            const pessoasDisponiveisParaConjunta = todasPessoas
                .filter(p => pessoaSelecionadaAtual && p.id !== pessoaSelecionadaAtual.id && p.estaVisivel !== false)
                .map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
            const elementosDisponiveisParaConjunta = [...new Set(todosElementos.map(el => el.designacao || el.nome))]
                .sort()
                .map(nomeEl => `<option value="${nomeEl}">${nomeEl}</option>`).join('');
            allCardsHtml += `<div class="stat-card" id="verificacao-conjunta-container">
                                <h4>Verificar Designação Conjunta</h4>
                                <label for="select-outra-pessoa">Com:</label>
                                <select id="select-outra-pessoa"><option value="">-- Selecione Pessoa --</option>${pessoasDisponiveisParaConjunta}</select>
                                <label for="select-elemento-verificacao">Elemento:</label>
                                <select id="select-elemento-verificacao"><option value="">-- Selecione Elemento --</option>${elementosDisponiveisParaConjunta}</select>
                                <button id="btn-verificar-conjunta">Verificar</button>
                                <div id="resultado-verificacao-conjunta"></div>
                             </div>`;

            let mediaGlobalDesignacoes = 0;
            let comparacaoStr = "Não foi possível calcular a média global (dados globais de designações ou pessoas não carregados).";
            const countPessoaAtual = designacoesFiltradas.length;

            const filtroMesVal = document.getElementById('filtro-mes')?.value || "";
            const filtroAnoVal = document.getElementById('filtro-ano')?.value || "";
            const filtroElementoVal = document.getElementById('filtro-elemento')?.value || "";
            const filtroSemanaVal = document.getElementById('filtro-semana')?.value || "";

            if (todasDesignacoesGlobaisCarregadas && todasPessoas.length > 0) {
                const designacoesParaMedia = todasDesignacoesGlobais.filter(d => {
                    const matchMes = !filtroMesVal || d.mes === filtroMesVal;
                    const matchAno = !filtroAnoVal || d.ano === filtroAnoVal;
                    const matchElemento = !filtroElementoVal || d.nome === filtroElementoVal;
                    const matchSemana = !filtroSemanaVal || (d.semana === filtroSemanaVal) || (!d.semana && d.semanaISO && `Semana ISO ${d.semanaISO} (${d.ano})` === filtroSemanaVal);
                    return matchMes && matchAno && matchElemento && matchSemana;
                });

                const participacoesContagemGlobal = {};
                designacoesParaMedia.forEach(desig => {
                    Object.keys(desig.participantes || {}).forEach(nomeP => {
                        if (desig.participantes[nomeP]) {
                            participacoesContagemGlobal[nomeP] = (participacoesContagemGlobal[nomeP] || 0) + 1;
                        }
                    });
                });

                const totalParticipacoesGlobal = Object.values(participacoesContagemGlobal).reduce((sum, val) => sum + val, 0);
                const numPessoasComParticipacaoGlobal = Object.keys(participacoesContagemGlobal).length;

                if (numPessoasComParticipacaoGlobal > 0) {
                    mediaGlobalDesignacoes = totalParticipacoesGlobal / numPessoasComParticipacaoGlobal;
                    const diferenca = countPessoaAtual - mediaGlobalDesignacoes;
                    let statusMedia = "";
                    if (diferenca > 0.01) statusMedia = `<strong style="color:green;">acima da média</strong> por ${diferenca.toFixed(1)}`;
                    else if (diferenca < -0.01) statusMedia = `<strong style="color:red;">abaixo da média</strong> por ${Math.abs(diferenca).toFixed(1)}`;
                    else statusMedia = `<strong style="color:orange;">na média</strong>`;

                    comparacaoStr = `Esta pessoa tem <strong>${countPessoaAtual}</strong> designações (com filtros atuais).<br>
                                     A média entre <strong>${numPessoasComParticipacaoGlobal}</strong> pessoas participantes (com os mesmos filtros) é <strong>${mediaGlobalDesignacoes.toFixed(1)}</strong> designações.<br>
                                     Status: ${statusMedia}.`;
                } else {
                    comparacaoStr = "Nenhuma designação encontrada globalmente para calcular a média com os filtros atuais.";
                }
            }
            allCardsHtml += `
                <div class="stat-card">
                    <h4>Média de Participações (vs Global)</h4>
                    <p style="font-size:0.9em; line-height:1.5;">${comparacaoStr}</p>
                </div>`;

            allCardsHtml += `<div class="stat-card" id="designacoesPorElementoChartContainer"><h4>Designações por Elemento</h4><canvas id="designacoesPorElementoChart"></canvas></div>`;
            
            const desigPorMes = {};
            const desigPorSemana = {}; 
            const desigPorAno = {};

            designacoesFiltradas.forEach(d => {
                const mesAnoKey = `${d.ano}-${String(d.mes).padStart(2, '0')}`;
                desigPorMes[mesAnoKey] = (desigPorMes[mesAnoKey] || 0) + 1;
                const semanaLabel = d.semana || (d.semanaISO ? `ISO ${d.semanaISO} (${d.ano})` : "Semana Desconhecida");
                if (semanaLabel !== "Semana Desconhecida") {
                    desigPorSemana[semanaLabel] = (desigPorSemana[semanaLabel] || 0) + 1;
                }
                desigPorAno[d.ano.toString()] = (desigPorAno[d.ano.toString()] || 0) + 1;
            });

            allCardsHtml += `
                <div class="stat-card stats-chart-container-pessoa"><h4>Designações por Mês</h4><canvas id="chartDesigPorMes"></canvas></div>
                <div class="stat-card stats-chart-container-pessoa"><h4>Designações por Semana</h4><canvas id="chartDesigPorSemana"></canvas></div>
                <div class="stat-card stats-chart-container-pessoa"><h4>Designações por Ano</h4><canvas id="chartDesigPorAno"></canvas></div>
            `;

            statsContent.innerHTML = allCardsHtml;

            function renderListaElementosPessoaInterna() {
                const listaUl = document.getElementById('lista-elementos-pessoa');
                const link = document.getElementById('link-mostrar-todos-elementos-pessoa');
                if (!listaUl || !link) {
                    return;
                }
                listaUl.innerHTML = '';
                const dadosParaRenderizar = mostrandoTodosElementosPessoa ? todosElementosRealizadosOriginal : todosElementosRealizadosOriginal.slice(0, 5);
                if (dadosParaRenderizar.length > 0) {
                    dadosParaRenderizar.forEach(([nome, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `${nome}: <span class="stat-value-inline">${count}</span>`;
                        listaUl.appendChild(li);
                    });
                } else {
                    listaUl.innerHTML = '<li>Nenhum dado de elemento.</li>';
                }
                if (todosElementosRealizadosOriginal.length > 5) {
                    link.style.display = 'inline-block';
                    link.textContent = mostrandoTodosElementosPessoa ? 'Mostrar menos' : `Mostrar todos (${todosElementosRealizadosOriginal.length})`;
                } else {
                    link.style.display = 'none';
                }
            }
            renderListaElementosPessoaInterna();
            const linkElementos = document.getElementById('link-mostrar-todos-elementos-pessoa');
            if (linkElementos) {
                linkElementos.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrandoTodosElementosPessoa = !mostrandoTodosElementosPessoa;
                    renderListaElementosPessoaInterna();
                });
            }

            function renderListaParceirosPessoaInterna() {
                const listaUl = document.getElementById('lista-parceiros-pessoa');
                const link = document.getElementById('link-mostrar-todos-parceiros-pessoa');
                if (!listaUl || !link) {
                    return;
                }
                listaUl.innerHTML = '';
                const dadosParaRenderizar = mostrandoTodosParceirosPessoa ? todosParceirosFrequentesOriginal : todosParceirosFrequentesOriginal.slice(0, 3);
                if (dadosParaRenderizar.length > 0) {
                    dadosParaRenderizar.forEach(([nome, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `${nome}: <span class="stat-value-inline">${count}</span>`;
                        listaUl.appendChild(li);
                    });
                } else {
                    listaUl.innerHTML = '<li>Nenhum parceiro frequente ou só fez designações sozinho(a).</li>';
                }
                if (todosParceirosFrequentesOriginal.length > 3) {
                    link.style.display = 'inline-block';
                    link.textContent = mostrandoTodosParceirosPessoa ? 'Mostrar menos' : `Mostrar todos (${todosParceirosFrequentesOriginal.length})`;
                } else {
                    link.style.display = 'none';
                }
            }
            renderListaParceirosPessoaInterna();
            const linkParceiros = document.getElementById('link-mostrar-todos-parceiros-pessoa');
            if(linkParceiros) {
                linkParceiros.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrandoTodosParceirosPessoa = !mostrandoTodosParceirosPessoa;
                    renderListaParceirosPessoaInterna();
                });
            }

            const btnVerificar = document.getElementById('btn-verificar-conjunta');
            if (btnVerificar) btnVerificar.addEventListener('click', verificarDesignacaoConjunta);

            if (designacoesChart && typeof designacoesChart.destroy === 'function') designacoesChart.destroy();
            const labelsElementosChart = Object.keys(contagemElementos);
            const dataCountsElementosChart = Object.values(contagemElementos);
            if (labelsElementosChart.length > 0) {
                designacoesChart = renderChart(designacoesChart, 'designacoesPorElementoChart', 'bar',
                    { labels: labelsElementosChart, datasets: [{ label: 'Nº de Designações', data: dataCountsElementosChart, backgroundColor: 'rgba(0, 123, 255, 0.6)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 }] }
                );
            } else {
                const chartContainer = document.getElementById('designacoesPorElementoChartContainer');
                if (chartContainer) { const canvas = chartContainer.querySelector('canvas'); if (canvas) canvas.outerHTML = "<p style='text-align:center; color:#777; margin-top:20px;'>Sem dados para exibir gráfico de elementos.</p>"; }
            }

            const labelsMes = Object.keys(desigPorMes).sort();
            if (labelsMes.length > 0) {
                designacoesPorMesChart = renderChart(designacoesPorMesChart, 'chartDesigPorMes', 'line', {
                    labels: labelsMes.map(l => { const [y,m] = l.split('-'); return `${m}/${y}`;}),
                    datasets: [{ label: 'Nº Designações', data: labelsMes.map(k => desigPorMes[k]), backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.1 }]
                });
            } else { const el = document.getElementById('chartDesigPorMes'); if(el) el.outerHTML = "<p style='text-align:center; color:#777;'>Sem dados para gráfico mensal.</p>"; }
            
             const labelsSemana = Object.keys(desigPorSemana).sort((a, b) => {
                const parseWeekString = (weekStr) => {
                    if (weekStr.startsWith("ISO")) {
                        const isoParts = weekStr.match(/ISO\s*(\d+)\s*\((\d{4})\)/);
                        if (isoParts) return new Date(parseInt(isoParts[2]), 0, (parseInt(isoParts[1]) -1) * 7 + 1);
                        return new Date(0);
                    }
                    const descParts = weekStr.match(/^([a-zA-ZçÇãõÃÕáéíóúÁÉÍÓÚ]+)\s+(\d{4})\s*\|\s*(\d{1,2})/i);
                     const monthMap = { 'janeiro':0,'fevereiro':1,'março':2,'abril':3,'maio':4,'junho':5,'julho':6,'agosto':7,'setembro':8,'outubro':9,'novembro':10,'dezembro':11};
                    if (descParts) {
                        const monthNum = monthMap[descParts[1].toLowerCase()];
                        if (monthNum !== undefined) return new Date(parseInt(descParts[2]), monthNum, parseInt(descParts[3]));
                    }
                    return new Date(0);
                };
                return parseWeekString(a) - parseWeekString(b);
            });

            if (labelsSemana.length > 0) {
                 designacoesPorSemanaChart = renderChart(designacoesPorSemanaChart, 'chartDesigPorSemana', 'bar', {
                    labels: labelsSemana,
                    datasets: [{ label: 'Nº Designações', data: labelsSemana.map(k => desigPorSemana[k]), backgroundColor: 'rgba(153, 102, 255, 0.2)', borderColor: 'rgba(153, 102, 255, 1)'}]
                }, { scales: { x: { ticks: { autoSkip: labelsSemana.length > 15, maxRotation: labelsSemana.length > 10 ? 90 : 0, minRotation: labelsSemana.length > 10 ? 45 : 0 } } } });
            } else { const el = document.getElementById('chartDesigPorSemana'); if(el) el.outerHTML = "<p style='text-align:center; color:#777;'>Sem dados para gráfico semanal.</p>"; }

            const labelsAno = Object.keys(desigPorAno).sort();
            if (labelsAno.length > 0) {
                designacoesPorAnoChart = renderChart(designacoesPorAnoChart, 'chartDesigPorAno', 'bar', {
                    labels: labelsAno,
                    datasets: [{ label: 'Nº Designações', data: labelsAno.map(k => desigPorAno[k]), backgroundColor: 'rgba(255, 159, 64, 0.6)', borderColor: 'rgba(255, 159, 64, 1)' }]
                });
            } else { const el = document.getElementById('chartDesigPorAno'); if(el) el.outerHTML = "<p style='text-align:center; color:#777;'>Sem dados para gráfico anual.</p>"; }

            console.log("renderizarEstatisticas: Estatísticas renderizadas com HTML único e listeners reatribuídos.");
        }

        function verificarDesignacaoConjunta() {
            const selectOutraPessoaEl = document.getElementById('select-outra-pessoa');
            const selectElementoVerificacao = document.getElementById('select-elemento-verificacao');
            const resultadoDiv = document.getElementById('resultado-verificacao-conjunta');

            if (!selectOutraPessoaEl || !selectElementoVerificacao || !resultadoDiv) return;
            if (!pessoaSelecionadaAtual) {
                resultadoDiv.textContent = "Erro: Pessoa principal não selecionada.";
                resultadoDiv.className = 'resultado-verificacao-conjunta error';
                return;
            }

            const idOutraPessoa = selectOutraPessoaEl.value;
            const nomeOutraPessoa = selectOutraPessoaEl.options[selectOutraPessoaEl.selectedIndex]?.text;
            const nomeElemento = selectElementoVerificacao.value;

            resultadoDiv.textContent = "";
            resultadoDiv.className = 'resultado-verificacao-conjunta';

            if (!idOutraPessoa) { resultadoDiv.textContent = "Selecione a outra pessoa."; resultadoDiv.classList.add('info'); return; }
            if (!nomeElemento) { resultadoDiv.textContent = "Selecione o elemento."; resultadoDiv.classList.add('info'); return; }

            const designacoesComAmbos = designacoesFiltradas.filter(d =>
                d.nome === nomeElemento &&
                (
                    (d.pessoaA === pessoaSelecionadaAtual.nome && (d.pessoaB === nomeOutraPessoa || d.pessoaC === nomeOutraPessoa)) ||
                    (d.pessoaB === pessoaSelecionadaAtual.nome && (d.pessoaA === nomeOutraPessoa || d.pessoaC === nomeOutraPessoa)) ||
                    (d.pessoaC === pessoaSelecionadaAtual.nome && (d.pessoaA === nomeOutraPessoa || d.pessoaB === nomeOutraPessoa)) ||
                    (d.pessoaA === nomeOutraPessoa && (d.pessoaB === pessoaSelecionadaAtual.nome || d.pessoaC === pessoaSelecionadaAtual.nome)) ||
                    (d.pessoaB === nomeOutraPessoa && (d.pessoaA === pessoaSelecionadaAtual.nome || d.pessoaC === pessoaSelecionadaAtual.nome)) ||
                    (d.pessoaC === nomeOutraPessoa && (d.pessoaA === pessoaSelecionadaAtual.nome || d.pessoaB === pessoaSelecionadaAtual.nome))
                )
            );

            if (designacoesComAmbos.length > 0) {
                resultadoDiv.textContent = `Sim, fizeram "${nomeElemento}" juntos ${designacoesComAmbos.length} vez(es) neste período.`;
                resultadoDiv.classList.add('success');
            } else {
                resultadoDiv.textContent = `Não, não fizeram "${nomeElemento}" juntos neste período.`;
                resultadoDiv.classList.add('error');
            }
        }

        // --- Modais e FAB ---
        function abrirModal(modalElement) {
            if (modalElement) modalElement.style.display = 'block';
            else console.error("abrirModal: Tentativa de abrir modal nulo.");
        }
        function fecharModal(modalElement) {
            if (modalElement) modalElement.style.display = 'none';
            else console.error("fecharModal: Tentativa de fechar modal nulo.");
        }

        if (fabMain) {
            fabMain.addEventListener('click', (event) => {
                event.stopPropagation();
                fabOptions.classList.toggle('show');
            });
        } else { console.warn("Elemento fabMain não encontrado."); }

        document.addEventListener('click', (event) => {
            if (fabOptions && fabOptions.classList.contains('show')) {
                if (!fabMain.contains(event.target) && !fabOptions.contains(event.target)) {
                    fabOptions.classList.remove('show');
                }
            }
        });

        if (btnCriarPessoaFab) {
             btnCriarPessoaFab.addEventListener('click', () => {
                formCriarPessoa.reset();
                pessoaIdEditInput.value = '';
                modalPessoaTitulo.textContent = 'Criar Nova Pessoa';
                btnSubmitPessoa.textContent = 'Criar Pessoa';
                abrirModal(modalPessoa);
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnCriarPessoaFab não encontrado.");}

        if (btnCriarElementoFab) {
            btnCriarElementoFab.addEventListener('click', () => {
                formCriarElemento.reset();
                abrirModal(modalElemento);
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnCriarElementoFab não encontrado.");}

        if (btnCriarDesignacaoFab) {
             btnCriarDesignacaoFab.addEventListener('click', async () => {
                formCriarDesignacao.reset();
                popularDropdownsPessoasNosModais();
                abrirModal(modalDesignacao);
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnCriarDesignacaoFab não encontrado.");}

        if (btnGerenciarPessoasFab) {
            btnGerenciarPessoasFab.addEventListener('click', () => {
                abrirModalGerenciarPessoas();
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnGerenciarPessoasFab não encontrado.");}

        if(closeButtons.length > 0) {
            closeButtons.forEach(button => button.addEventListener('click', () => {
                const modalId = button.getAttribute('data-modal-id');
                if (modalId) {
                    const modalToClose = document.getElementById(modalId);
                    if (modalToClose) fecharModal(modalToClose);
                } else {
                    const parentModal = button.closest('.modal');
                    if (parentModal) fecharModal(parentModal);
                }
            }));
        } else { console.warn("Nenhum elemento '.close-button' encontrado."); }

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                if (event.target.style.display === 'block') {
                    fecharModal(event.target);
                }
            }
        });

        // --- Formulários ---
        if (formCriarPessoa) {
            formCriarPessoa.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = nomePessoaInput.value.trim();
                const idioma = idiomaPessoaSelect.value;
                const genero = generoPessoaSelect.value;
                const cargo = cargoPessoaSelect.value;
                const pregacao = pregacaoPessoaSelect.value;
                const editId = pessoaIdEditInput.value;
                if (!nome) { alert("O nome da pessoa é obrigatório."); return; }

                const pessoaData = { nome, idioma, genero, cargo, pregacao, ultimaModificacao: serverTimestamp() };
                try {
                    if (editId) {
                        const docRef = doc(db, "pessoas", editId);
                        await updateDoc(docRef, pessoaData);
                        alert("Pessoa atualizada com sucesso!");
                    } else {
                        pessoaData.estaVisivel = true;
                        await addDoc(collection(db, "pessoas"), pessoaData);
                        alert("Pessoa criada com sucesso!");
                    }
                    formCriarPessoa.reset();
                    fecharModal(modalPessoa);
                    await carregarPessoas();
                    if (editId && pessoaSelecionadaAtual && pessoaSelecionadaAtual.id === editId) {
                        const pessoaAtualizada = todasPessoas.find(p => p.id === editId);
                        if (pessoaAtualizada) {
                            pessoaSelecionadaAtual = pessoaAtualizada;
                            carregarDesignacoesDaPessoa(pessoaAtualizada.id);
                        } else {
                             colunaDetalhesDiv.innerHTML = '';
                             colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                             colunaDetalhesContent.style.display = 'flex';
                        }
                    }
                } catch (error) { console.error("Erro ao salvar pessoa: ", error); alert("Erro: " + error.message); }
            });
        }

        if (formCriarElemento) {
            formCriarElemento.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nomeElemento = nomeElementoModalInput.value.trim();
                const tipo = tipoElementoSelect.value;
                const generoReuniao = generoElementoSelect.value;
                if (!nomeElemento) { alert("O nome do elemento é obrigatório."); return; }
                const elementoData = {
                    designacao: nomeElemento,
                    tipo: tipo,
                    generoReuniao: tipo === 'reuniao' ? generoReuniao : null,
                    criadoEm: serverTimestamp()
                };
                try {
                    await addDoc(collection(db, "elementos"), elementoData);
                    alert("Elemento criado com sucesso!");
                    formCriarElemento.reset();
                    fecharModal(modalElemento);
                    await carregarTodosElementosParaEstatisticas();
                } catch (error) { console.error("Erro ao criar elemento: ", error); alert("Erro: " + error.message); }
            });
        }

        if (formCriarDesignacao) {
            formCriarDesignacao.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nomeElemento = selectElementoDesignacao.value;
                const pA = selectPessoaA.value;
                const pB = selectPessoaB.value;
                const pC = selectPessoaC.value;
                const dataStr = dataDesignacaoInput.value;

                if (!nomeElemento) { alert("Selecione um elemento."); return; }
                 if (!pA && !pB && !pC && nomeElemento !== "Orador Público") {
                     alert("Selecione pelo menos uma pessoa para designações que não sejam 'Orador Público'.");
                     return;
                }
                if (!dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) { alert("Formato de data inválido. Use DD/MM/AAAA."); return; }

                const [dia, mes, ano] = dataStr.split('/');
                const participantes = {};
                if (pA) participantes[pA] = true;
                if (pB) participantes[pB] = true;
                if (pC) participantes[pC] = true;

                const pessoasSelecionadasNomes = [pA, pB, pC].filter(pNome => pNome !== "");
                if (new Set(pessoasSelecionadasNomes).size !== pessoasSelecionadasNomes.length) {
                    alert("Pessoas duplicadas selecionadas. Cada pessoa deve ser única."); return;
                }
                const elementoOriginalObj = todosElementos.find(el => (el.designacao || el.nome) === nomeElemento);
                if (!elementoOriginalObj) {
                    alert("Elemento selecionado não encontrado na base de dados de elementos.");
                    return;
                }

                const designacaoData = {
                    nome: nomeElemento,
                    elementoId: elementoOriginalObj.id,
                    pessoaA: pA || null, pessoaB: pB || null, pessoaC: pC || null,
                    participantes: participantes, data: dataStr, dia: dia.padStart(2, '0'),
                    mes: mes.padStart(2, '0'), ano: ano, criadoEm: serverTimestamp()
                };
                try {
                    const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                     if (!isNaN(dateObj.getTime())) {
                        designacaoData.semanaISO = getISOWeek(dateObj);
                     } else {
                        console.warn("Data inválida ao criar designação, semanaISO não será definida:", dataStr);
                        designacaoData.semanaISO = null;
                     }
                } catch(error) {
                     console.warn("Erro ao calcular semanaISO na criação da designação:", error);
                     designacaoData.semanaISO = null;
                }

                try {
                    await addDoc(collection(db, "designacoes"), designacaoData);
                    alert("Designação criada com sucesso!");
                    formCriarDesignacao.reset();
                    fecharModal(modalDesignacao);
                    if (pessoaSelecionadaAtual && (pessoaSelecionadaAtual.nome === pA || pessoaSelecionadaAtual.nome === pB || pessoaSelecionadaAtual.nome === pC)) {
                        await carregarDesignacoesDaPessoa(pessoaSelecionadaAtual.id);
                    }
                    if (todasDesignacoesGlobaisCarregadas) todasDesignacoesGlobaisCarregadas = false;
                } catch (error) { console.error("Erro ao criar designação: ", error); alert("Erro: " + error.message); }
            });
        }

        // --- Gerenciar Pessoas ---
        async function abrirModalGerenciarPessoas() {
            if (!modalGerenciarPessoas) return;
            abrirModal(modalGerenciarPessoas);
            renderListaGerenciarPessoas();
        }

        function renderListaGerenciarPessoas() {
            if (!listaGerenciarPessoasUl) return;
            listaGerenciarPessoasUl.innerHTML = '';
            todasPessoas.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(pessoa => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="pessoa-nome">${pessoa.nome}</span>
                    <span class="pessoa-status-visivel ${pessoa.estaVisivel === false ? 'oculta' : ''}">
                        ${pessoa.estaVisivel === false ? '(Oculta)' : ''}
                    </span>
                    <div class="pessoa-actions">
                        <button class="btn-toggle-visibilidade ${pessoa.estaVisivel === false ? 'mostrar' : ''}" data-id="${pessoa.id}" data-visivel="${pessoa.estaVisivel !== false}">
                            ${pessoa.estaVisivel === false ? 'Mostrar' : 'Ocultar'}
                        </button>
                        <button class="btn-editar-pessoa" data-id="${pessoa.id}">Editar</button>
                        <button class="btn-remover-pessoa" data-id="${pessoa.id}">Remover</button>
                    </div>
                `;
                listaGerenciarPessoasUl.appendChild(li);
            });
            listaGerenciarPessoasUl.querySelectorAll('.btn-toggle-visibilidade').forEach(btn => btn.addEventListener('click', async (e) => {
                await toggleVisibilidadePessoa(e.target.dataset.id, !(e.target.dataset.visivel === 'true'));
            }));
            listaGerenciarPessoasUl.querySelectorAll('.btn-editar-pessoa').forEach(btn => btn.addEventListener('click', (e) => editarPessoa(e.target.dataset.id)));
            listaGerenciarPessoasUl.querySelectorAll('.btn-remover-pessoa').forEach(btn => btn.addEventListener('click', async (e) => {
                 if (confirm("Tem certeza? Removerá a pessoa de futuras seleções, mas não de designações passadas.")) await removerPessoa(e.target.dataset.id);
            }));
        }

        async function toggleVisibilidadePessoa(pessoaId, novoEstadoVisibilidade) {
            try {
                await updateDoc(doc(db, "pessoas", pessoaId), { estaVisivel: novoEstadoVisibilidade });
                await carregarPessoas();
                renderListaGerenciarPessoas();
            } catch (error) { console.error("Erro ao alterar visibilidade: ", error); alert("Erro."); }
        }

        function resetarColunaDetalhes() {
            console.log("Resetando a coluna de detalhes para a visão inicial.");
            const pessoasAtivas = document.querySelectorAll('#lista-pessoas li.active');
            pessoasAtivas.forEach(li => {
                li.classList.remove('active');
            });
            pessoaSelecionadaAtual = null;
            if (colunaDetalhesDiv && colunaDetalhesContent) {
                colunaDetalhesDiv.innerHTML = '';
                colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                colunaDetalhesContent.style.display = 'flex';
            }
        }

        const tituloPessoasH2 = document.querySelector('#coluna-pessoas h2');
        if (tituloPessoasH2) {
            tituloPessoasH2.addEventListener('click', resetarColunaDetalhes);
        }

        function editarPessoa(pessoaId) {
            const pessoa = todasPessoas.find(p => p.id === pessoaId);
            if (!pessoa) { alert("Pessoa não encontrada."); return; }
            formCriarPessoa.reset();
            pessoaIdEditInput.value = pessoa.id;
            nomePessoaInput.value = pessoa.nome;
            idiomaPessoaSelect.value = pessoa.idioma || 'Português';
            generoPessoaSelect.value = pessoa.genero || 'Masculino';
            cargoPessoaSelect.value = pessoa.cargo || 'Publicador';
            pregacaoPessoaSelect.value = pessoa.pregacao || '';
            modalPessoaTitulo.textContent = 'Editar Pessoa';
            btnSubmitPessoa.textContent = 'Salvar Alterações';
            fecharModal(modalGerenciarPessoas);
            abrirModal(modalPessoa);
        }

        async function removerPessoa(pessoaId) {
            try {
                await deleteDoc(doc(db, "pessoas", pessoaId));
                alert("Pessoa removida.");
                await carregarPessoas();
                renderListaGerenciarPessoas();
                 if (pessoaSelecionadaAtual && pessoaSelecionadaAtual.id === pessoaId) {
                    pessoaSelecionadaAtual = null;
                    colunaDetalhesDiv.innerHTML = '';
                    colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                    colunaDetalhesContent.style.display = 'flex';
                }
            } catch (error) { console.error("Erro ao remover pessoa: ", error); alert("Erro."); }
        }

        function initGsPessoasCustomMultiselect() {
            if (!gsPessoasSelectMulti || !gsPessoasSearchInputCustom || !gsPessoasDropdownCustomDiv || !gsSelectedPessoasAreaDiv) {
                console.warn("Elementos do custom multi-select de pessoas não encontrados.");
                return;
            }
            if (gsPessoasSelectMulti.options.length === 0 && todasPessoas.length > 0) {
                popularDropdownsPessoasNosModais();
            }

            availablePessoasForCustomSelect = Array.from(gsPessoasSelectMulti.options).map(opt => ({
                id: opt.value,
                nome: opt.textContent
            }));

            gsPessoasSearchInputCustom.removeEventListener('input', handleGsPessoasSearch);
            gsPessoasSearchInputCustom.addEventListener('input', handleGsPessoasSearch);

            gsPessoasSearchInputCustom.removeEventListener('focus', openDropdownAndRender);
            gsPessoasSearchInputCustom.addEventListener('focus', openDropdownAndRender);
            
            updateSelectedPessoasTagsDisplay();
        }

        function openDropdownAndRender() {
            renderGsPessoasDropdown(gsPessoasSearchInputCustom.value);
            gsPessoasDropdownCustomDiv.style.display = 'block';
        }

        function handleGsPessoasSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            renderGsPessoasDropdown(searchTerm);
            gsPessoasDropdownCustomDiv.style.display = 'block';
        }

        function renderGsPessoasDropdown(searchTerm = "") {
            if (!gsPessoasDropdownCustomDiv) return;
            const selectedPessoaIds = Array.from(gsPessoasSelectMulti.selectedOptions).map(opt => opt.value);
            const filteredPessoas = availablePessoasForCustomSelect.filter(pessoa =>
                pessoa.nome.toLowerCase().includes(searchTerm)
            );
            gsPessoasDropdownCustomDiv.innerHTML = '';
            const ul = document.createElement('ul');
            if (filteredPessoas.length === 0) {
                const li = document.createElement('li');
                li.textContent = searchTerm ? 'Nenhuma pessoa encontrada.' : 'Nenhuma pessoa disponível.';
                li.style.color = '#777';
                ul.appendChild(li);
            } else {
                 filteredPessoas.forEach(pessoa => {
                    const li = document.createElement('li');
                    li.textContent = pessoa.nome;
                    li.dataset.pessoaId = pessoa.id;
                    if (selectedPessoaIds.includes(pessoa.id)) {
                        li.classList.add('disabled');
                    } else {
                        li.addEventListener('click', () => selectPessoaForComparison(pessoa));
                    }
                    ul.appendChild(li);
                });
            }
            gsPessoasDropdownCustomDiv.appendChild(ul);
        }

        function selectPessoaForComparison(pessoa) {
            if (!gsPessoasSelectMulti) return;
            const option = Array.from(gsPessoasSelectMulti.options).find(opt => opt.value === pessoa.id);
            if (option) {
                option.selected = true;
            }
            updateSelectedPessoasTagsDisplay();
            gsPessoasSearchInputCustom.value = '';
            gsPessoasDropdownCustomDiv.style.display = 'none';
            gsPessoasSearchInputCustom.focus();
        }

        function removePessoaFromComparison(pessoaId) {
            if (!gsPessoasSelectMulti) return;
            const option = Array.from(gsPessoasSelectMulti.options).find(opt => opt.value === pessoaId);
            if (option) {
                option.selected = false;
            }
            updateSelectedPessoasTagsDisplay();
        }

        function updateSelectedPessoasTagsDisplay() {
            if (!gsSelectedPessoasAreaDiv || !gsPessoasSelectMulti) return;
            gsSelectedPessoasAreaDiv.innerHTML = '';
            const selectedOptions = Array.from(gsPessoasSelectMulti.selectedOptions);
            selectedOptions.forEach(option => {
                const tagDiv = document.createElement('div');
                tagDiv.className = 'pessoa-tag';
                tagDiv.textContent = option.textContent;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-tag-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.type = 'button';
                removeBtn.title = `Remover ${option.textContent}`;
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removePessoaFromComparison(option.value);
                });
                tagDiv.appendChild(removeBtn);
                gsSelectedPessoasAreaDiv.appendChild(tagDiv);
            });
        }

        function setupGsOldSubmenu() {
            const gsOldContentDiv = document.getElementById('gs-old-content');
            if (!gsOldContentDiv) {
                console.warn("Div gs-old-content não encontrada para configurar submenu.");
                return;
            }
            const submenuButtons = gsOldContentDiv.querySelectorAll('.gs-old-submenu-button');
            const submenuSections = gsOldContentDiv.querySelectorAll('#gs-old-content > .stats-card-section');
            submenuButtons.forEach(button => {
                button.addEventListener('click', () => {
                    submenuButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const targetSectionId = button.dataset.submenuTarget;
                    submenuSections.forEach(section => {
                        section.classList.remove('active-submenu-section');
                        if (section.id === targetSectionId) {
                            section.classList.add('active-submenu-section');
                        }
                    });
                });
            });
            
            let activeSubmenuButton = gsOldContentDiv.querySelector('.gs-old-submenu-button.active');
            if (!activeSubmenuButton && submenuButtons.length > 0) {
                submenuButtons[0].classList.add('active');
                activeSubmenuButton = submenuButtons[0];
            }
            
            submenuSections.forEach(section => section.classList.remove('active-submenu-section'));
            
            if (activeSubmenuButton) {
                const targetId = activeSubmenuButton.dataset.submenuTarget;
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active-submenu-section');
                }
            }
        }

        globalStatsTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                globalStatsTabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetContentId = button.dataset.tabTarget;
                globalStatsTabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === targetContentId) {
                        content.classList.add('active');
                    }
                });
                if (targetContentId === 'gs-total-content') {
                    atualizarAbaTotalGlobalStats();
                } else if (targetContentId === 'gs-pessoas-content') {
                     initGsPessoasCustomMultiselect();
                } else if (targetContentId === 'gs-designacoes-content') {
                    popularListaElementosAbaDesignacoes();
                } else if (targetContentId === 'gs-old-content') {
                    setupGsOldSubmenu();
                }
            });
        });

        document.addEventListener('click', (e) => {
            if (gsPessoasCustomMultiselectDiv && !gsPessoasCustomMultiselectDiv.contains(e.target) && gsPessoasDropdownCustomDiv) {
                gsPessoasDropdownCustomDiv.style.display = 'none';
            }
        });

        async function carregarTodasDesignacoesParaStatsGlobais() {
            if (todasDesignacoesGlobaisCarregadas) {
                console.log("carregarTodasDesignacoesParaStatsGlobais: Já carregadas.");
                return;
            }
            console.log("carregarTodasDesignacoesParaStatsGlobais: Iniciando.");
            try {
                const querySnapshot = await getDocs(collection(db, "designacoes"));
                todasDesignacoesGlobais = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (!data.semanaISO && data.data) {
                        try {
                            const [dia, mes, ano] = data.data.split('/');
                            const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                             if (!isNaN(dateObj.getTime())) {
                                data.semanaISO = getISOWeek(dateObj);
                            } else {
                                data.semanaISO = null;
                            }
                        } catch (e) {
                            data.semanaISO = null;
                        }
                    }
                    todasDesignacoesGlobais.push({ id: docSnap.id, ...data });
                });
                todasDesignacoesGlobaisCarregadas = true;
                console.log(`carregarTodasDesignacoesParaStatsGlobais: ${todasDesignacoesGlobais.length} designações.`);
            } catch (error) {
                console.error("Erro ao carregar todas as designações globais: ", error);
                alert("Falha ao carregar dados para estatísticas globais.");
                todasDesignacoesGlobaisCarregadas = false;
            }
        }

        function popularFiltrosStatsGlobais() {
            if (!todasDesignacoesGlobaisCarregadas || todasDesignacoesGlobais.length === 0) return;
            if (todosElementos.length === 0 && !document.getElementById('gs-total-filtro-elemento-tipo')) { }
            if (todasPessoas.length === 0 && !document.getElementById('gs-pessoa-esp-select')) { }

            const mesesUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.mes).filter(Boolean))].sort((a,b) => parseInt(a) - parseInt(b));
            const anosUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));
            const elementosNomes = todosElementos.length > 0 ? [...new Set(todosElementos.map(el => el.designacao || el.nome))].sort((a,b) => a.localeCompare(b)) : [];

            const getNomeMes = (numMes) => {
                if (!numMes) return "";
                try {
                    return new Date(2000, parseInt(numMes) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                } catch(e) { return "";}
            }

            [gsTopPessoasMesSelect, gsTodasDesigMesSelect, gsPessoaEspMesFiltroSelect, gsTotalFiltroMesSelect, gsPessoasFiltroMesSelect, gsDesignacoesFiltroMesSelect].forEach(select => {
                if (!select) return;
                const currentVal = select.value;
                select.innerHTML = '<option value="">Todos</option>';
                mesesUnicos.forEach(mes => select.appendChild(new Option(getNomeMes(mes).replace(/^\w/, c => c.toUpperCase()), String(mes).padStart(2,'0'))));
                if (Array.from(select.options).some(opt => opt.value === currentVal)) select.value = currentVal; else select.value = "";
            });

            [gsTopPessoasAnoSelect, gsTodasDesigAnoSelect, gsPessoaEspAnoFiltroSelect, gsTotalFiltroAnoSelect, gsPessoasFiltroAnoSelect, gsDesignacoesFiltroAnoSelect].forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Todos</option>';
                anosUnicos.forEach(ano => select.appendChild(new Option(ano, ano)));
                if (anosUnicos.length > 0) {
                    select.value = anosUnicos[0];
                } else {
                    select.value = "";
                }
            });

            [gsTodasDesigElementoSelect, gsPessoaEspElementoFiltroSelect, gsTopPessoasElementoSelect].forEach(select => {
                if (!select) return;
                const currentVal = select.value;
                select.innerHTML = '<option value="">Todos Elementos</option>';
                elementosNomes.forEach(nomeEl => select.appendChild(new Option(nomeEl, nomeEl)));
                if (Array.from(select.options).some(opt => opt.value === currentVal)) select.value = currentVal; else select.value = "";
            });

            console.log("Filtros do modal de estatísticas globais populados/atualizados.");
        }

        function getPessoaById(id) {
            return todasPessoas.find(p => p.id === id);
        }

        function getElementoByNome(nome) {
            return todosElementos.find(el => (el.designacao || el.nome) === nome);
        }

        async function atualizarAbaTotalGlobalStats() {
            if (!todasDesignacoesGlobaisCarregadas) {
                await carregarTodasDesignacoesParaStatsGlobais();
                if (!todasDesignacoesGlobaisCarregadas) {
                     gsTotalNumDesignacoesSpan.textContent = "-";
                    return;
                }
            }
             setSectionLoadingState('gs-total-elementos', true);

            const anoFiltro = gsTotalFiltroAnoSelect.value;
            const mesFiltro = gsTotalFiltroMesSelect.value;

            const designacoesFiltradas = todasDesignacoesGlobais.filter(d => {
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                return matchAno && matchMes;
            });

            gsTotalNumDesignacoesSpan.textContent = designacoesFiltradas.length;
            let countMasc = 0, countFem = 0, countPt = 0, countIt = 0, countOutroIdioma = 0;

            designacoesFiltradas.forEach(desig => {
                Object.keys(desig.participantes || {}).forEach(nomeParticipante => {
                    const pessoa = todasPessoas.find(p => p.nome === nomeParticipante);
                    if (pessoa) {
                        if (pessoa.genero === 'Masculino') countMasc++;
                        if (pessoa.genero === 'Feminino') countFem++;
                        if (pessoa.idioma === 'Português') countPt++;
                        else if (pessoa.idioma === 'Italiano') countIt++;
                        else if (pessoa.idioma === 'Outro') countOutroIdioma++;
                    }
                });
            });
            gsTotalNumDesigMascSpan.textContent = countMasc;
            gsTotalNumDesigFemSpan.textContent = countFem;
            gsTotalNumDesigPtSpan.textContent = countPt;
            gsTotalNumDesigItSpan.textContent = countIt;
            gsTotalNumDesigOutroIdiomaSpan.textContent = countOutroIdioma;

            renderListaTiposDesignacaoTotal();

            const dadosGraficoTotal = {};
            const dadosGraficoGenero = { Masculino: {}, Feminino: {} };
            const dadosGraficoIdioma = { Português: {}, Italiano: {}, Outro: {} };

            designacoesFiltradas.forEach(d => {
                const chaveMesAno = `${d.ano}-${String(d.mes).padStart(2,'0')}`;
                dadosGraficoTotal[chaveMesAno] = (dadosGraficoTotal[chaveMesAno] || 0) + 1;

                Object.keys(d.participantes || {}).forEach(nomeParticipante => {
                     const pessoa = todasPessoas.find(p => p.nome === nomeParticipante);
                     if(pessoa){
                        if (pessoa.genero === 'Masculino') {
                            dadosGraficoGenero.Masculino[chaveMesAno] = (dadosGraficoGenero.Masculino[chaveMesAno] || 0) + 1;
                        } else if (pessoa.genero === 'Feminino') {
                            dadosGraficoGenero.Feminino[chaveMesAno] = (dadosGraficoGenero.Feminino[chaveMesAno] || 0) + 1;
                        }
                        if (pessoa.idioma === 'Português') {
                            dadosGraficoIdioma.Português[chaveMesAno] = (dadosGraficoIdioma.Português[chaveMesAno] || 0) + 1;
                        } else if (pessoa.idioma === 'Italiano') {
                            dadosGraficoIdioma.Italiano[chaveMesAno] = (dadosGraficoIdioma.Italiano[chaveMesAno] || 0) + 1;
                        } else if (pessoa.idioma === 'Outro') {
                             dadosGraficoIdioma.Outro[chaveMesAno] = (dadosGraficoIdioma.Outro[chaveMesAno] || 0) + 1;
                        }
                     }
                });
            });

            const sortedLabels = Object.keys(dadosGraficoTotal).sort();

            gsTotalChartDesignacoesMes = renderChart(gsTotalChartDesignacoesMes, 'gs-total-chart-designacoes-mes', 'line',
                { labels: sortedLabels, datasets: [{ label: 'Total Designações/Mês', data: sortedLabels.map(l => dadosGraficoTotal[l] || 0), tension: 0.1, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)'}] }
            );
            gsTotalChartDesignacoesGeneroMes = renderChart(gsTotalChartDesignacoesGeneroMes, 'gs-total-chart-designacoes-genero-mes', 'bar',
                { labels: sortedLabels, datasets: [
                    { label: 'Masculino', data: sortedLabels.map(l => dadosGraficoGenero.Masculino[l] || 0), backgroundColor: '#007bff' },
                    { label: 'Feminino', data: sortedLabels.map(l => dadosGraficoGenero.Feminino[l] || 0), backgroundColor: '#fd7e14' }
                ]}, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } } } }
            );
             gsTotalChartDesignacoesIdiomaMes = renderChart(gsTotalChartDesignacoesIdiomaMes, 'gs-total-chart-designacoes-idioma-mes', 'bar',
                { labels: sortedLabels, datasets: [
                    { label: 'Português', data: sortedLabels.map(l => dadosGraficoIdioma.Português[l] || 0), backgroundColor: '#28a745' },
                    { label: 'Italiano', data: sortedLabels.map(l => dadosGraficoIdioma.Italiano[l] || 0), backgroundColor: '#ffc107' },
                    { label: 'Outro', data: sortedLabels.map(l => dadosGraficoIdioma.Outro[l] || 0), backgroundColor: '#6c757d' }
                ]}, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } } } }
            );

            const numMesesConsiderados = sortedLabels.length || 1;
            gsTotalMediaDesignacoesSpan.textContent = (designacoesFiltradas.length / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigMascSpan.textContent = (countMasc / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigFemSpan.textContent = (countFem / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigPtSpan.textContent = (countPt / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigItSpan.textContent = (countIt / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigOutroSpan.textContent = (countOutroIdioma / numMesesConsiderados).toFixed(1);

            setSectionLoadingState('gs-total-elementos', false);
        }

        function renderListaTiposDesignacaoTotal() {
             if (!gsTotalFiltroElementoTipoSelect || !gsTotalElementosListUl || !gsTotalElementosCountSpan || !gsTotalElementosLoading) {
                console.warn("Elementos da lista de tipos de designação na aba Total não encontrados.");
                return;
            }
            setSectionLoadingState('gs-total-elementos', true);
            const tipoReuniaoFiltro = gsTotalFiltroElementoTipoSelect.value;
            const anoFiltroGlobal = gsTotalFiltroAnoSelect.value;
            const mesFiltroGlobal = gsTotalFiltroMesSelect.value;

            const elementosFiltradosPorTipo = todosElementos.filter(el => {
                if (tipoReuniaoFiltro && el.tipo === 'reuniao') {
                    return el.generoReuniao === tipoReuniaoFiltro;
                }
                if (tipoReuniaoFiltro && el.tipo !== 'reuniao') return false;
                return true;
            });

            gsTotalElementosListUl.innerHTML = '';
            let countElementosExibidos = 0;

            if (elementosFiltradosPorTipo.length > 0) {
                 elementosFiltradosPorTipo.forEach(el => {
                    const nomeEl = el.designacao || el.nome;
                    const countDesigElemento = todasDesignacoesGlobais.filter(d => {
                        const matchAno = !anoFiltroGlobal || d.ano === anoFiltroGlobal;
                        const matchMes = !mesFiltroGlobal || String(d.mes).padStart(2,'0') === String(mesFiltroGlobal).padStart(2,'0');
                        return d.nome === nomeEl && matchAno && matchMes;
                    }).length;
                    if (countDesigElemento > 0 || !tipoReuniaoFiltro) {
                        const li = document.createElement('li');
                        li.classList.add('clickable');
                        li.innerHTML = `${nomeEl} <span class="count">${countDesigElemento} ocorrências</span>`;
                        li.addEventListener('click', () => abrirModalInstancias(nomeEl));
                        gsTotalElementosListUl.appendChild(li);
                        countElementosExibidos++;
                    }
                });
            }
            gsTotalElementosCountSpan.textContent = countElementosExibidos;

            setSectionLoadingState('gs-total-elementos', false);
        }

        async function compararPessoasSelecionadas() {
            setSectionLoadingState('gs-pessoas', true, 'btn-gs-pessoas-comparar');
            if (!gsPessoasSelectMulti || !gsPessoasComparisonAreaDiv) {
                 setSectionLoadingState('gs-pessoas', false, 'btn-gs-pessoas-comparar');
                return;
            }

            const idsPessoasSelecionadas = Array.from(gsPessoasSelectMulti.selectedOptions).map(opt => opt.value);
            if (idsPessoasSelecionadas.length === 0) {
                gsPessoasComparisonAreaDiv.innerHTML = '<p style="text-align:center; color:#777;">Selecione pelo menos uma pessoa para comparar.</p>';
                setSectionLoadingState('gs-pessoas', false, 'btn-gs-pessoas-comparar');
                return;
            }

            const anoFiltro = gsPessoasFiltroAnoSelect.value;
            const mesFiltro = gsPessoasFiltroMesSelect.value;
            const semanaFiltro = gsPessoasFiltroSemanaInput.value;
            const generoFiltro = gsPessoasFiltroGeneroSelect.value;
            const idiomaFiltro = gsPessoasFiltroIdiomaSelect.value;

            gsPessoasComparisonAreaDiv.innerHTML = '';

            for (const pessoaId of idsPessoasSelecionadas) {
                const pessoaObj = getPessoaById(pessoaId);
                if (!pessoaObj) continue;

                if (generoFiltro && pessoaObj.genero !== generoFiltro) continue;
                if (idiomaFiltro && pessoaObj.idioma !== idiomaFiltro) continue;

                let designacoesDaPessoaFiltradas = todasDesignacoesGlobais.filter(d => {
                    if (!d.participantes || !d.participantes[pessoaObj.nome]) return false;
                    const matchAno = !anoFiltro || d.ano === anoFiltro;
                    const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                    let matchSemana = true;
                    if (semanaFiltro) {
                         matchSemana = d.semanaISO === parseInt(semanaFiltro);
                    }
                    return matchAno && matchMes && matchSemana;
                });

                const card = document.createElement('div');
                card.className = 'pessoa-comparison-card';
                let cardHTML = `<h5>${pessoaObj.nome} <small>(${pessoaObj.genero}, ${pessoaObj.idioma})</small></h5><ul>`;
                cardHTML += `<li>Total Designações (filt.): <span class="stat-value">${designacoesDaPessoaFiltradas.length}</span></li>`;
                const contagemElementosPessoa = designacoesDaPessoaFiltradas.reduce((acc, d) => {
                    acc[d.nome] = (acc[d.nome] || 0) + 1;
                    return acc;
                }, {});
                const top3Elementos = Object.entries(contagemElementosPessoa).sort((a,b) => b[1]-a[1]).slice(0,3);
                cardHTML += `<li>Top Elementos:</li><ul>`;
                if (top3Elementos.length > 0) {
                    top3Elementos.forEach(([elNome, count]) => cardHTML += `<li>${elNome}: ${count}</li>`);
                } else {
                    cardHTML += `<li>Nenhum com filtros atuais</li>`;
                }
                cardHTML += `</ul></ul>`;
                card.innerHTML = cardHTML;
                gsPessoasComparisonAreaDiv.appendChild(card);
            }
            if(gsPessoasComparisonAreaDiv.innerHTML === '') {
                 gsPessoasComparisonAreaDiv.innerHTML = '<p style="text-align:center; color:#777;">Nenhuma pessoa corresponde aos filtros de Gênero/Idioma ou não têm designações nos outros filtros.</p>';
            }

            setSectionLoadingState('gs-pessoas', false, 'btn-gs-pessoas-comparar');
        }

        function popularListaElementosAbaDesignacoes() {
            if (!todosElementos || !gsDesignacoesTiposListUl) {
                if(gsDesignacoesTiposListUl) gsDesignacoesTiposListUl.innerHTML = '<li>Nenhum elemento cadastrado ou lista não encontrada.</li>';
                return;
            }
             setSectionLoadingState('gs-designacoes-tipos', true, 'btn-gs-designacoes-aplicar-filtros');
            gsDesignacoesTiposListUl.innerHTML = '';
            if (todosElementos.length === 0) {
                setSectionLoadingState('gs-designacoes-tipos', false, 'btn-gs-designacoes-aplicar-filtros');
                return;
            }
            todosElementos.forEach(el => {
                const nomeEl = el.designacao || el.nome;
                const li = document.createElement('li');
                li.textContent = nomeEl;
                li.classList.add('clickable');
                li.dataset.elementoNome = nomeEl;
                li.addEventListener('click', () => {
                    abrirModalInstancias(nomeEl, true);
                });
                gsDesignacoesTiposListUl.appendChild(li);
            });
             setSectionLoadingState('gs-designacoes-tipos', false, 'btn-gs-designacoes-aplicar-filtros');
        }

        function abrirModalInstancias(nomeElemento, aplicarFiltrosDaAbaDesignacoes = false) {
            if (!modalInstanciasDesignacao || !modalInstanciasTitulo || !modalInstanciasListUl) return;

            modalInstanciasTitulo.textContent = `Instâncias de: ${nomeElemento}`;
            modalInstanciasListUl.innerHTML = '<div class="loading-spinner" style="display:block;"></div>';
            abrirModal(modalInstanciasDesignacao);

            let instanciasFiltradas = todasDesignacoesGlobais.filter(d => d.nome === nomeElemento);

            if (aplicarFiltrosDaAbaDesignacoes) {
                const diaFiltro = gsDesignacoesFiltroDiaInput.value;
                const mesFiltro = gsDesignacoesFiltroMesSelect.value;
                const anoFiltro = gsDesignacoesFiltroAnoSelect.value;
                const semanaFiltro = gsDesignacoesFiltroSemanaInput.value;
                const generoFiltroParticipante = gsDesignacoesFiltroGeneroSelect.value;
                const idiomaFiltroParticipante = gsDesignacoesFiltroIdiomaSelect.value;

                instanciasFiltradas = instanciasFiltradas.filter(d => {
                    const matchDia = !diaFiltro || d.dia === String(diaFiltro).padStart(2, '0');
                    const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                    const matchAno = !anoFiltro || d.ano === anoFiltro;
                    let matchSemana = true;
                    if (semanaFiltro) {
                         matchSemana = d.semanaISO === parseInt(semanaFiltro);
                    }
                    
                    let atendeFiltroParticipante = true;
                    if (generoFiltroParticipante || idiomaFiltroParticipante) {
                        atendeFiltroParticipante = false;
                        if (d.participantes) {
                            for (const nomeP of Object.keys(d.participantes)) {
                                if (d.participantes[nomeP]) {
                                    const pessoa = todasPessoas.find(p => p.nome === nomeP);
                                    if (pessoa) {
                                        const matchGeneroEsteP = !generoFiltroParticipante || pessoa.genero === generoFiltroParticipante;
                                        const matchIdiomaEsteP = !idiomaFiltroParticipante || pessoa.idioma === idiomaFiltroParticipante;
                                        if(matchGeneroEsteP && matchIdiomaEsteP) {
                                            atendeFiltroParticipante = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return matchDia && matchMes && matchAno && matchSemana && atendeFiltroParticipante;
                });
            }

            instanciasFiltradas.sort((a, b) => {
                const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
                const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });

            modalInstanciasListUl.innerHTML = '';
            if (instanciasFiltradas.length === 0) {
                modalInstanciasListUl.innerHTML = '<li>Nenhuma instância encontrada com os filtros atuais.</li>';
            } else {
                instanciasFiltradas.forEach(d => {
                    const li = document.createElement('li');
                    const participantesStr = [d.pessoaA, d.pessoaB, d.pessoaC].filter(Boolean).join(', ') || 'N/A';
                    let textoDesig = `${d.data} - Participantes: ${participantesStr}`;
                    if (d.nome === "Orador Público" && (d.tema || d.congregacao)) {
                        textoDesig += ` (`;
                        if (d.tema) textoDesig += `Tema: ${d.tema}`;
                        if (d.tema && d.congregacao) textoDesig += `; `;
                        if (d.congregacao) textoDesig += `Cong: ${d.congregacao}`;
                        textoDesig += `)`;
                    }
                    li.textContent = textoDesig;
                    modalInstanciasListUl.appendChild(li);
                });
            }
        }

        async function calcularTopPessoas() {
            setSectionLoadingState('gs-top-pessoas', true, 'btn-gs-top-pessoas-aplicar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
            if (!gsTopPessoasListUl) { 
                 setSectionLoadingState('gs-top-pessoas', false, 'btn-gs-top-pessoas-aplicar');
                return;
            }

            const mesFiltro = gsTopPessoasMesSelect.value;
            const anoFiltro = gsTopPessoasAnoSelect.value;
            const elementoFiltro = gsTopPessoasElementoSelect.value; 

            let designacoesFiltradasGlobal = todasDesignacoesGlobais.filter(d => {
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchElemento = !elementoFiltro || d.nome === elementoFiltro; 
                return matchMes && matchAno && matchElemento; 
            });

            const contagemPessoas = {};
            designacoesFiltradasGlobal.forEach(d => {
                Object.keys(d.participantes || {}).forEach(nomePessoa => {
                    if (nomePessoa && d.participantes[nomePessoa]) {
                        contagemPessoas[nomePessoa] = (contagemPessoas[nomePessoa] || 0) + 1;
                    }
                });
            });

            topPessoasDadosCompletos = Object.entries(contagemPessoas)
                .map(([nome, count]) => ({ nome, count }))
                .sort((a, b) => b.count - a.count || a.nome.localeCompare(b.nome));

            gsTopPessoasMostrandoApenasTop5 = true;
            renderTopPessoasList();
            setSectionLoadingState('gs-top-pessoas', false, 'btn-gs-top-pessoas-aplicar');
        }

        function renderTopPessoasList() {
            if (!gsTopPessoasListUl || !gsTopPessoasMostrarTodosLink) return;
            gsTopPessoasListUl.innerHTML = '';

            const dadosParaRenderizar = gsTopPessoasMostrandoApenasTop5 ? topPessoasDadosCompletos.slice(0, 5) : topPessoasDadosCompletos;

            if (dadosParaRenderizar.length === 0) {
            } else {
                dadosParaRenderizar.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `${item.nome} <span class="count">${item.count}</span>`;
                    gsTopPessoasListUl.appendChild(li);
                });
            }

            gsTopPessoasMostrarTodosLink.style.display = topPessoasDadosCompletos.length > 5 ? 'inline-block' : 'none';
            gsTopPessoasMostrarTodosLink.textContent = gsTopPessoasMostrandoApenasTop5 ? `Mostrar lista completa (${topPessoasDadosCompletos.length})` : 'Mostrar apenas Top 5';
        }

        async function exibirTodasDesignacoes() {
            setSectionLoadingState('gs-todas-desig', true, 'btn-gs-todas-desig-aplicar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
            if (!gsTodasDesigListUl) {
                 setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-aplicar');
                return;
            }

            const mesFiltro = gsTodasDesigMesSelect.value;
            const anoFiltro = gsTodasDesigAnoSelect.value;
            const elementoFiltro = gsTodasDesigElementoSelect.value;

            let designacoesFiltradasGlobal = todasDesignacoesGlobais.filter(d => {
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchElemento = !elementoFiltro || d.nome === elementoFiltro;
                return matchMes && matchAno && matchElemento;
            }).sort((a, b) => {
                const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
                const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });

            gsTodasDesigListUl.innerHTML = '';
            if (gsTodasDesigAgrupadoContainerDiv) gsTodasDesigAgrupadoContainerDiv.style.display = 'none';

            if (designacoesFiltradasGlobal.length > 0) {
                designacoesFiltradasGlobal.forEach(d => {
                    const li = document.createElement('li');
                    const participantesStr = [d.pessoaA, d.pessoaB, d.pessoaC].filter(Boolean).join(', ');
                    let textoDesig = `${d.data} - ${d.nome}: ${participantesStr || 'N/A'}`;
                     if (d.nome === "Orador Público" && (d.tema || d.congregacao)) {
                        textoDesig += ` (`;
                        if (d.tema) textoDesig += `Tema: ${d.tema}`;
                        if (d.tema && d.congregacao) textoDesig += `; `;
                        if (d.congregacao) textoDesig += `Cong: ${d.congregacao}`;
                        textoDesig += `)`;
                    }
                    li.textContent = textoDesig;
                    gsTodasDesigListUl.appendChild(li);
                });
            }
            setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-aplicar');
        }

        async function agruparDesignacoesPorElemento() {
            setSectionLoadingState('gs-todas-desig', true, 'btn-gs-todas-desig-agrupar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
             if (!gsTodasDesigAgrupadoListUl || !gsTodasDesigAgrupadoContainerDiv) {
                 setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-agrupar');
                return;
            }

            const mesFiltro = gsTodasDesigMesSelect.value;
            const anoFiltro = gsTodasDesigAnoSelect.value;
            const elementoFiltro = gsTodasDesigElementoSelect.value;

            let designacoesParaAgrupar = todasDesignacoesGlobais.filter(d => {
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchElemento = !elementoFiltro || d.nome === elementoFiltro;
                return matchMes && matchAno && matchElemento;
            });

            const contagemElementos = designacoesParaAgrupar.reduce((acc, d) => {
                 acc[d.nome] = (acc[d.nome] || 0) + 1; return acc;
            }, {});

            topElementosAgrupadosDadosCompletos = Object.entries(contagemElementos)
                .map(([nome, count]) => ({ nome, count }))
                .sort((a, b) => b.count - a.count || a.nome.localeCompare(b.nome));

            if (gsTodasDesigListUl) gsTodasDesigListUl.innerHTML = '';
            gsTodasDesigAgrupadoContainerDiv.style.display = 'block';
            gsTopElementosAgrupadosMostrandoApenasTop5 = true;
            renderTopElementosAgrupadosList();
            setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-agrupar');
        }

        function renderTopElementosAgrupadosList() {
            if (!gsTodasDesigAgrupadoListUl || !gsTodasDesigAgrupadoMostrarTodosLink) return;
            gsTodasDesigAgrupadoListUl.innerHTML = '';

            const dadosParaRenderizar = gsTopElementosAgrupadosMostrandoApenasTop5 ? topElementosAgrupadosDadosCompletos.slice(0, 5) : topElementosAgrupadosDadosCompletos;

            if (dadosParaRenderizar.length > 0) {
                dadosParaRenderizar.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `${item.nome} <span class="count">${item.count}</span>`;
                    gsTodasDesigAgrupadoListUl.appendChild(li);
                });
            }
            gsTodasDesigAgrupadoMostrarTodosLink.style.display = topElementosAgrupadosDadosCompletos.length > 5 ? 'inline-block' : 'none';
            gsTodasDesigAgrupadoMostrarTodosLink.textContent = gsTopElementosAgrupadosMostrandoApenasTop5 ? `Mostrar lista completa (${topElementosAgrupadosDadosCompletos.length})` : 'Mostrar apenas Top 5';
        }

        async function analisarDesempenhoPessoa() {
            setSectionLoadingState('gs-pessoa-esp', true, 'btn-gs-pessoa-esp-aplicar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
            if (todasPessoas.length === 0) await carregarPessoas();
            if (!gsPessoaEspResultsDiv || !gsPessoaEspSelect) {
                 setSectionLoadingState('gs-pessoa-esp', false, 'btn-gs-pessoa-esp-aplicar');
                return;
            }

            const pessoaIdSelecionada = gsPessoaEspSelect.value;
            const pessoaObj = getPessoaById(pessoaIdSelecionada);
            const nomePessoaSelecionada = pessoaObj ? pessoaObj.nome : null;

            const elementoFiltro = gsPessoaEspElementoFiltroSelect.value;
            const anoFiltro = gsPessoaEspAnoFiltroSelect.value;
            const mesFiltro = gsPessoaEspMesFiltroSelect.value;

            if (!nomePessoaSelecionada) {
                gsPessoaEspResultsDiv.innerHTML = "<p>Por favor, selecione uma pessoa para analisar.</p>";
                setSectionLoadingState('gs-pessoa-esp', false, 'btn-gs-pessoa-esp-aplicar');
                return;
            }

            let designacoesFiltradas = todasDesignacoesGlobais.filter(d => {
                const matchElemento = !elementoFiltro || d.nome === elementoFiltro;
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                return matchElemento && matchAno && matchMes;
            });

            const designacoesDaPessoa = designacoesFiltradas.filter(d => d.participantes && d.participantes[nomePessoaSelecionada]);
            const totalDesigPessoa = designacoesDaPessoa.length;
            let mediaGeral = 0;

            if (todasPessoas.length > 1) {
                const outrasPessoasVisiveis = todasPessoas.filter(p => p.nome !== nomePessoaSelecionada && p.estaVisivel !== false);
                let somaDesigOutrasPessoas = 0;
                let countPessoasComDesig = 0;
                outrasPessoasVisiveis.forEach(outraPessoa => {
                    const desigDestaOutra = designacoesFiltradas.filter(d => d.participantes && d.participantes[outraPessoa.nome]).length;
                    if (desigDestaOutra > 0) { somaDesigOutrasPessoas += desigDestaOutra; countPessoasComDesig++; }
                });
                if (countPessoasComDesig > 0) mediaGeral = somaDesigOutrasPessoas / countPessoasComDesig;
            }

            let htmlResultado = `<p><strong>${nomePessoaSelecionada}</strong> teve <strong>${totalDesigPessoa}</strong> designações no período.</p>`;
            if (mediaGeral > 0) {
                 htmlResultado += `<p>Média para outras pessoas: <strong>${mediaGeral.toFixed(1)}</strong>.</p>`;
                if (totalDesigPessoa > mediaGeral) htmlResultado += `<p>Desempenho: <span class="acima-media">Acima da média</span>.</p>`;
                else if (totalDesigPessoa < mediaGeral) htmlResultado += `<p>Desempenho: <span class="abaixo-media">Abaixo da média</span>.</p>`;
                else htmlResultado += `<p>Desempenho: <span class="na-media">Na média</span>.</p>`;
            } 

            const desigPessoaPorElemento = designacoesDaPessoa.reduce((acc, d) => { acc[d.nome] = (acc[d.nome] || 0) + 1; return acc; }, {});
            const sortedDesigPessoaPorElemento = Object.entries(desigPessoaPorElemento).sort((a,b) => b[1] - a[1]);
            if(sortedDesigPessoaPorElemento.length > 0){
                htmlResultado += `<p><strong>Detalhes por elemento para ${nomePessoaSelecionada}:</strong></p><ul>`;
                sortedDesigPessoaPorElemento.forEach(([elNome, count]) => htmlResultado += `<li>${elNome}: ${count}</li>`);
                htmlResultado += `</ul>`;
            } else {
                htmlResultado += `<p>Nenhum detalhe por elemento para ${nomePessoaSelecionada} com os filtros atuais.</p>`;
            }
            gsPessoaEspResultsDiv.innerHTML = htmlResultado;
            setSectionLoadingState('gs-pessoa-esp', false, 'btn-gs-pessoa-esp-aplicar');
        }

        function renderChart(chartInstance, canvasId, type, data, options = {}) {
            const canvasEl = document.getElementById(canvasId);
            if (!canvasEl) { console.error(`Canvas ${canvasId} não encontrado.`); return null; }
            const ctx = canvasEl.getContext('2d');
            if (chartInstance && typeof chartInstance.destroy === 'function') {
                chartInstance.destroy();
            }
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            };
            const finalOptions = {...defaultOptions, ...options};
            try {
                return new Chart(ctx, { type, data, options: finalOptions });
            } catch (e) {
                console.error("Erro ao renderizar gráfico:", canvasId, e);
                if(canvasEl.parentElement) canvasEl.parentElement.innerHTML = `<p style="text-align:center; color: red;">Erro ao gerar gráfico.</p>`;
                return null;
            }
        }

        if (btnGlobalStats) {
            btnGlobalStats.addEventListener('click', async () => {
                console.log("Botão de Estatísticas Globais clicado.");
                abrirModal(modalGlobalStats);

                document.querySelectorAll('#modal-global-stats .loading-spinner').forEach(s => s.style.display = 'block');
                document.querySelectorAll('#modal-global-stats .stats-apply-button, #modal-global-stats .stats-filters select, #modal-global-stats .stats-filters input').forEach(b => b.disabled = true);

                if (todosElementos.length === 0) await carregarTodosElementosParaEstatisticas();
                if (todasPessoas.length === 0) await carregarPessoas(); 
                if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();

                popularFiltrosStatsGlobais();
                popularDropdownsPessoasNosModais(); 

                const activeTab = document.querySelector('#modal-global-stats .global-stats-tab-button.active');
                if (activeTab) {
                    const activeTabTargetId = activeTab.dataset.tabTarget;
                    if (activeTabTargetId === 'gs-total-content') {
                         await atualizarAbaTotalGlobalStats();
                    } else if (activeTabTargetId === 'gs-pessoas-content') {
                         initGsPessoasCustomMultiselect();
                    } else if (activeTabTargetId === 'gs-designacoes-content') {
                        popularListaElementosAbaDesignacoes();
                    } else if (activeTabTargetId === 'gs-old-content') {
                        setupGsOldSubmenu();
                    }
                } else {
                    const firstTabButton = document.querySelector('#modal-global-stats .global-stats-tab-button');
                    if(firstTabButton) {
                        firstTabButton.click();
                    }
                }

                document.querySelectorAll('#modal-global-stats .loading-spinner').forEach(s => s.style.display = 'none');
                document.querySelectorAll('#modal-global-stats .stats-apply-button, #modal-global-stats .stats-filters select, #modal-global-stats .stats-filters input').forEach(b => b.disabled = false);

                if(gsTopPessoasListUl) gsTopPessoasListUl.innerHTML = '';
                if(gsTopPessoasMostrarTodosLink) gsTopPessoasMostrarTodosLink.style.display = 'none';
                if(gsTodasDesigListUl) gsTodasDesigListUl.innerHTML = '';
                if(gsTodasDesigAgrupadoContainerDiv) gsTodasDesigAgrupadoContainerDiv.style.display = 'none';
                if(gsTodasDesigAgrupadoListUl) gsTodasDesigAgrupadoListUl.innerHTML = '';
                if(gsTodasDesigAgrupadoMostrarTodosLink) gsTodasDesigAgrupadoMostrarTodosLink.style.display = 'none';
                if(gsPessoaEspResultsDiv) gsPessoaEspResultsDiv.innerHTML = '';
                if(gsPessoasComparisonAreaDiv) gsPessoasComparisonAreaDiv.innerHTML = ''; 

                const currentActiveMainTab = document.querySelector('#modal-global-stats .global-stats-tab-button.active');
                if (currentActiveMainTab && currentActiveMainTab.dataset.tabTarget === 'gs-old-content') {
                    setupGsOldSubmenu();
                }
            });
        } else { console.warn("Botão btnGlobalStats não encontrado."); }

        if(btnGsTotalAplicarFiltros) btnGsTotalAplicarFiltros.addEventListener('click', atualizarAbaTotalGlobalStats);
        if(btnGsTotalAplicarFiltroElemento) btnGsTotalAplicarFiltroElemento.addEventListener('click', renderListaTiposDesignacaoTotal);
        if(btnGsPessoasComparar) btnGsPessoasComparar.addEventListener('click', compararPessoasSelecionadas);
        if(btnGsDesignacoesAplicarFiltros) {
             btnGsDesignacoesAplicarFiltros.addEventListener('click', () => {
                popularListaElementosAbaDesignacoes();
            });
        }

        if (btnGsTopPessoasAplicar) btnGsTopPessoasAplicar.addEventListener('click', calcularTopPessoas);
        if (gsTopPessoasMostrarTodosLink) {
            gsTopPessoasMostrarTodosLink.addEventListener('click', (e) => {
                e.preventDefault();
                gsTopPessoasMostrandoApenasTop5 = !gsTopPessoasMostrandoApenasTop5;
                renderTopPessoasList();
            });
        }
        if (btnGsTodasDesigAplicar) btnGsTodasDesigAplicar.addEventListener('click', exibirTodasDesignacoes);
        if (btnGsTodasDesigAgrupar) btnGsTodasDesigAgrupar.addEventListener('click', agruparDesignacoesPorElemento);
        if (gsTodasDesigAgrupadoMostrarTodosLink) {
            gsTodasDesigAgrupadoMostrarTodosLink.addEventListener('click', (e) => {
                e.preventDefault();
                gsTopElementosAgrupadosMostrandoApenasTop5 = !gsTopElementosAgrupadosMostrandoApenasTop5;
                renderTopElementosAgrupadosList();
            });
        }
        if (btnGsPessoaEspAplicar) btnGsPessoaEspAplicar.addEventListener('click', analisarDesempenhoPessoa);

        function getNomeMesRanking(numMes) {
            if (!numMes || isNaN(parseInt(numMes))) return "";
            try {
                return new Date(2000, parseInt(numMes) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
            } catch (e) {
                console.error("Erro em getNomeMesRanking:", e);
                return "";
            }
        }

        async function abrirModalRanking() {
            if (!modalRanking) {
                console.error("Modal de Ranking não encontrado.");
                return;
            }
            const rankingFiltersContainer = document.getElementById('ranking-filters-container');
            if (rankingFiltersContainer) rankingFiltersContainer.style.opacity = "0.5";

            if (!todasDesignacoesGlobaisCarregadas) {
                console.log("Modal Ranking: Carregando todas as designações globais...");
                await carregarTodasDesignacoesParaStatsGlobais();
                if (!todasDesignacoesGlobaisCarregadas) {
                    alert("Não foi possível carregar os dados das designações para o ranking. Tente novamente.");
                    if (rankingFiltersContainer) rankingFiltersContainer.style.opacity = "1";
                    return;
                }
            }
            if (todosElementos.length === 0) {
                console.log("Modal Ranking: Carregando todos os elementos...");
                await carregarTodosElementosParaEstatisticas();
            }

            if (rankingFiltersContainer) rankingFiltersContainer.style.opacity = "1";

            popularFiltrosRankingPopup();
            setDefaultRankingFilters();
            ordemAtualElementosRanking = [...ORDEM_PADRAO_ELEMENTOS_RANKING];
            renderRankingList();
            abrirModal(modalRanking);
        }

     function popularFiltrosRankingPopup() {
            if (!rankingFiltroMesSelect || !rankingFiltroAnoSelect || !rankingFiltroSemanaSelect) {
                console.error("Elementos de filtro do modal de ranking não encontrados.");
                return;
            }
            if (!todasDesignacoesGlobaisCarregadas || todasDesignacoesGlobais.length === 0) {
                console.warn("Modal Ranking: Dados de designações globais não disponíveis para popular filtros.");
                 rankingFiltroMesSelect.innerHTML = '<option value="">Todos</option>';
                 rankingFiltroAnoSelect.innerHTML = '<option value="">Todos</option>';
                 rankingFiltroSemanaSelect.innerHTML = '<option value="">Todas</option>';
                return;
            }

            const mesesUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.mes).filter(Boolean))].sort((a, b) => parseInt(a) - parseInt(b));
            const anosUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));

            const monthMap = { 'janeiro': 1, 'fevereiro': 2, 'março': 3, 'abril': 4, 'maio': 5, 'junho': 6, 'julho': 7, 'agosto': 8, 'setembro': 9, 'outubro': 10, 'novembro': 11, 'dezembro': 12 };

            const semanasCompletas = todasDesignacoesGlobais
                .filter(d => d.semana && typeof d.semana === 'string')
                .map(d => {
                    const parts = d.semana.match(/^([a-zA-ZçÇãõÃÕáéíóúÁÉÍÓÚ]+)\s+(\d{4})\s*\|\s*(\d{1,2})\s*-\s*(\d{1,2})$/i);
                    if (parts) {
                        const monthName = parts[1].toLowerCase();
                        const year = parseInt(parts[2]);
                        const startDay = parseInt(parts[3]);
                        const monthNumber = monthMap[monthName];

                        if (monthNumber && year && startDay) {
                            try {
                                const sortDate = new Date(year, monthNumber - 1, startDay);
                                 if (!isNaN(sortDate.getTime())) {
                                    return { year, month: monthNumber, startDay, originalString: d.semana, sortDate };
                                }
                            } catch (e) {
                                return null;
                            }
                        }
                    }
                    return null;
                })
                .filter(item => item !== null);

            const uniqueSemanas = semanasCompletas.reduce((acc, current) => {
                if (!acc.find(item => item.originalString === current.originalString)) {
                    acc.push(current);
                }
                return acc;
            }, []);

            uniqueSemanas.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                if (a.month !== b.month) return b.month - b.month;
                return b.startDay - b.startDay;
            });

            const currentMesVal = rankingFiltroMesSelect.value;
            rankingFiltroMesSelect.innerHTML = '<option value="">Todos</option>';
            mesesUnicos.forEach(mes => rankingFiltroMesSelect.appendChild(new Option(getNomeMesRanking(mes).replace(/^\w/, c => c.toUpperCase()), String(mes).padStart(2,'0'))));
            rankingFiltroMesSelect.value = currentMesVal;

            const currentAnoVal = rankingFiltroAnoSelect.value;
            rankingFiltroAnoSelect.innerHTML = '<option value="">Todos</option>';
            anosUnicos.forEach(ano => rankingFiltroAnoSelect.appendChild(new Option(ano, ano)));
            rankingFiltroAnoSelect.value = currentAnoVal;

            const currentSemanaVal = rankingFiltroSemanaSelect.value;
            rankingFiltroSemanaSelect.innerHTML = '<option value="">Todas</option>';
            let currentYearForOptgroup = null;
            let optgroup = null;

            uniqueSemanas.forEach(item => {
                if (item.year !== currentYearForOptgroup) {
                    currentYearForOptgroup = item.year;
                    optgroup = document.createElement('optgroup');
                    optgroup.label = `${item.year}`;
                    rankingFiltroSemanaSelect.appendChild(optgroup);
                }
                const option = document.createElement('option');
                option.value = item.originalString;
                option.textContent = item.originalString;
                if (optgroup) {
                    optgroup.appendChild(option);
                } else {
                    rankingFiltroSemanaSelect.appendChild(option);
                }
            });
            if (Array.from(rankingFiltroSemanaSelect.options).some(opt => opt.value === currentSemanaVal)) {
                 rankingFiltroSemanaSelect.value = currentSemanaVal;
            } else {
                rankingFiltroSemanaSelect.value = "";
            }
        }

        function setDefaultRankingFilters() {
             if (!rankingFiltroAnoSelect || !rankingFiltroMesSelect || !rankingFiltroSemanaSelect) return;
            if (todasDesignacoesGlobais.length === 0) {
                 rankingFiltroAnoSelect.value = "";
                 rankingFiltroMesSelect.value = "";
                 rankingFiltroSemanaSelect.value = "";
                return;
            }

            let maisRecente = null;
            todasDesignacoesGlobais.forEach(d => {
                if (d.data && d.ano && d.mes && d.dia) {
                    try {
                        const [day, month, year] = d.data.split('/');
                        const dataAtual = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        if (!isNaN(dataAtual.getTime())) {
                            if (!maisRecente || dataAtual > maisRecente.dataObj) {
                                maisRecente = { ...d, dataObj: dataAtual };
                            }
                        }
                    } catch (e) { }
                }
            });

            if (maisRecente) {
                rankingFiltroAnoSelect.value = maisRecente.ano || "";
                rankingFiltroMesSelect.value = String(maisRecente.mes).padStart(2,'0') || "";
                if (maisRecente.semana && typeof maisRecente.semana === 'string') {
                    const semanaOptionExists = Array.from(rankingFiltroSemanaSelect.options).some(opt => opt.value === maisRecente.semana);
                    if (semanaOptionExists) {
                        rankingFiltroSemanaSelect.value = maisRecente.semana;
                    } else {
                         rankingFiltroSemanaSelect.value = "";
                    }
                } else {
                    rankingFiltroSemanaSelect.value = "";
                }
            } else {
                rankingFiltroAnoSelect.value = "";
                rankingFiltroMesSelect.value = "";
                rankingFiltroSemanaSelect.value = "";
            }
        }

        function renderRankingList() {
            if (!listaRankingDesignacoesUl) return;
            listaRankingDesignacoesUl.innerHTML = '<div class="loading-spinner" style="margin: 10px auto; display: block;"></div>';

            const mesFiltro = rankingFiltroMesSelect ? rankingFiltroMesSelect.value : "";
            const anoFiltro = rankingFiltroAnoSelect ? rankingFiltroAnoSelect.value : "";
            const semanaFiltroValor = rankingFiltroSemanaSelect ? rankingFiltroSemanaSelect.value : "";

            const designacoesDaSemanaSelecionada = todasDesignacoesGlobais.filter(d => {
                if (semanaFiltroValor) {
                    return d.semana === semanaFiltroValor;
                }
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2, '0') === String(mesFiltro).padStart(2, '0');
                return matchAno && matchMes;
            });

            listaRankingDesignacoesUl.innerHTML = '';

            if (designacoesDaSemanaSelecionada.length === 0) {
                const msg = (anoFiltro || mesFiltro || semanaFiltroValor) 
                    ? 'Nenhuma designação encontrada para os filtros selecionados.' 
                    : 'Selecione filtros para ver o ranking.';
                listaRankingDesignacoesUl.innerHTML = `<li>${msg}</li>`;
                return;
            }

            const designacoesAgrupadasPorNome = designacoesDaSemanaSelecionada.reduce((acc, desig) => {
                const nomeElementoBase = desig.nome && desig.nome.startsWith("Discurso") ? "Discurso" : desig.nome;
                if (!nomeElementoBase) return acc;
                if (!acc[nomeElementoBase]) {
                    acc[nomeElementoBase] = [];
                }
                acc[nomeElementoBase].push(desig);
                return acc;
            }, {});

            ordemAtualElementosRanking.forEach((nomeElemento, index) => {
                if (nomeElemento.startsWith("---")) {
                    const separator = document.createElement(nomeElemento === "---SEP---" ? 'hr' : 'li');
                    separator.className = nomeElemento === "---SEP---" ? 'ranking-section-separator' : 'ranking-paragraph-separator';
                    listaRankingDesignacoesUl.appendChild(separator);
                    return;
                }

                const designacoesParaEsteElemento = designacoesAgrupadasPorNome[nomeElemento] || [];
                
                if (designacoesParaEsteElemento.length > 0) {
                    designacoesParaEsteElemento.forEach((designacaoEspecifica, itemIndex) => {
                        const li = document.createElement('li');
                        li.dataset.elementoNome = nomeElemento;

                        const nomeSpan = document.createElement('span');
                        nomeSpan.className = 'designacao-nome';
                        nomeSpan.textContent = (itemIndex === 0) ? nomeElemento : '';

                        const participantesContainer = document.createElement('span');
                        participantesContainer.className = 'designacao-participantes';
                        
                        const participantesNomes = [designacaoEspecifica.pessoaA, designacaoEspecifica.pessoaB, designacaoEspecifica.pessoaC].filter(Boolean);

                        if (participantesNomes.length > 0) {
                            participantesNomes.forEach((nome, idx) => {
                                let posicao = '';
                                if (designacaoEspecifica.pessoaA === nome) posicao = 'pessoaA';
                                else if (designacaoEspecifica.pessoaB === nome) posicao = 'pessoaB';
                                else if (designacaoEspecifica.pessoaC === nome) posicao = 'pessoaC';

                                if (posicao) {
                                    const nomeEditavelSpan = document.createElement('span');
                                    nomeEditavelSpan.className = 'participante-editavel';
                                    nomeEditavelSpan.textContent = nome;
                                    nomeEditavelSpan.dataset.designacaoId = designacaoEspecifica.id;
                                    nomeEditavelSpan.dataset.originalNome = nome;
                                    nomeEditavelSpan.dataset.posicao = posicao;
                                    nomeEditavelSpan.onclick = iniciarEdicaoParticipante;
                                    
                                    participantesContainer.appendChild(nomeEditavelSpan);

                                    if (idx < participantesNomes.length - 1) {
                                        participantesContainer.append(' & ');
                                    }
                                }
                            });
                        } else {
                            participantesContainer.textContent = "Ninguém designado";
                            participantesContainer.classList.add('ninguem');
                        }

                        const reorderDiv = document.createElement('div');
                        reorderDiv.className = 'reorder-buttons';
                        
                        if (itemIndex === 0) {
                            const btnUp = document.createElement('button');
                            btnUp.innerHTML = '<i class="fas fa-arrow-up"></i>';
                            btnUp.disabled = index === 0 || ordemAtualElementosRanking[index - 1].startsWith("---");
                            btnUp.onclick = () => moverElementoRanking(index, 'up');

                            const btnDown = document.createElement('button');
                            btnDown.innerHTML = '<i class="fas fa-arrow-down"></i>';
                            const nextElementIsSeparator = (index + 1 < ordemAtualElementosRanking.length) && ordemAtualElementosRanking[index + 1].startsWith("---");
                            btnDown.disabled = index === ordemAtualElementosRanking.length - 1 || nextElementIsSeparator;
                            btnDown.onclick = () => moverElementoRanking(index, 'down');
                            reorderDiv.appendChild(btnUp);
                            reorderDiv.appendChild(btnDown);
                        }

                        li.appendChild(nomeSpan);
                        li.appendChild(participantesContainer);
                        li.appendChild(reorderDiv);
                        listaRankingDesignacoesUl.appendChild(li);
                    });
                }
            });
        }

        function iniciarEdicaoParticipante(event) {
            const spanElement = event.target;
            const { designacaoId, originalNome, posicao } = spanElement.dataset;

            const select = document.createElement('select');
            
            const cancelOption = new Option("— Cancelar Edição —", "");
            select.appendChild(cancelOption);

            todasPessoas
                .filter(p => p.estaVisivel !== false)
                .forEach(pessoa => {
                    const option = new Option(pessoa.nome, pessoa.nome);
                    if (pessoa.nome === originalNome) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

            const reverterParaSpan = () => {
                select.replaceWith(spanElement);
            };
            
            select.onchange = () => {
                const novoNome = select.value;
                if (novoNome && novoNome !== originalNome) {
                    atualizarParticipanteDaDesignacao(designacaoId, posicao, novoNome, originalNome);
                } else {
                    reverterParaSpan();
                }
            };

            select.onblur = reverterParaSpan;

            spanElement.replaceWith(select);
            select.focus();
        }

        async function atualizarParticipanteDaDesignacao(designacaoId, posicao, novoNome, nomeAntigo) {
            console.log(`Atualizando designação ${designacaoId}: Trocando ${nomeAntigo} por ${novoNome} na posição ${posicao}.`);

            const designacaoRef = doc(db, "designacoes", designacaoId);

            try {
                const docSnap = await getDoc(designacaoRef);
                if (!docSnap.exists()) {
                    throw new Error("Documento da designação não foi encontrado!");
                }

                const designacaoAtual = docSnap.data();
                const participantesAtuais = { ...designacaoAtual.participantes };

                delete participantesAtuais[nomeAntigo];
                participantesAtuais[novoNome] = true;

                const updateData = {
                    [posicao]: novoNome,
                    participantes: participantesAtuais,
                    ultimaModificacao: serverTimestamp()
                };

                await updateDoc(designacaoRef, updateData);

                const index = todasDesignacoesGlobais.findIndex(d => d.id === designacaoId);
                if (index > -1) {
                    todasDesignacoesGlobais[index][posicao] = novoNome;
                    todasDesignacoesGlobais[index].participantes = participantesAtuais;
                }
                
                renderRankingList();
                
                alert(`Designação atualizada com sucesso!`);

            } catch (error) {
                console.error("Erro ao atualizar participante da designação:", error);
                alert("Falha ao atualizar a designação. Verifique o console para mais detalhes.");
                renderRankingList();
            }
        }

        if (btnRankingPopup) {
            btnRankingPopup.addEventListener('click', abrirModalRanking);
        }

        if (btnRankingAplicarFiltros) {
            btnRankingAplicarFiltros.addEventListener('click', renderRankingList);
        }

        window.onload = async () => {
            console.log("Window onload: Iniciando aplicação.");
            if (!listaPessoasUl || !colunaDetalhesDiv || !colunaDetalhesContent || !modalGlobalStats) {
                console.error("ERRO CRÍTICO: Elementos DOM essenciais não encontrados. A aplicação pode não funcionar.");
                alert("Erro crítico ao carregar. Verifique o console.");
                return;
            }

            await carregarPessoas();
            await carregarTodosElementosParaEstatisticas();
            popularDropdownsPessoasNosModais(); 

            if (colunaDetalhesDiv && colunaDetalhesContent) {
                colunaDetalhesDiv.innerHTML = ''; 
                colunaDetalhesDiv.appendChild(colunaDetalhesContent); 
                colunaDetalhesContent.style.display = 'flex'; 
            }
            
            const primeiraAbaBtnGlobal = document.querySelector('.modal-global-stats-tabs .global-stats-tab-button');
            if (primeiraAbaBtnGlobal && !document.querySelector('.modal-global-stats-tabs .global-stats-tab-button.active')) {
                primeiraAbaBtnGlobal.classList.add('active');
                const targetContentId = primeiraAbaBtnGlobal.dataset.tabTarget;
                const targetContent = document.getElementById(targetContentId);
                if (targetContent) targetContent.classList.add('active');
                
                if (targetContentId === 'gs-total-content') await carregarTodasDesignacoesParaStatsGlobais().then(atualizarAbaTotalGlobalStats);
                else if (targetContentId === 'gs-pessoas-content') initGsPessoasCustomMultiselect();
                else if (targetContentId === 'gs-designacoes-content') popularListaElementosAbaDesignacoes();
                else if (targetContentId === 'gs-old-content') { 
                    setupGsOldSubmenu();
                }
            } else {
                const activeMainTab = document.querySelector('.modal-global-stats-tabs .global-stats-tab-button.active');
                if (activeMainTab && activeMainTab.dataset.tabTarget === 'gs-old-content') {
                    setupGsOldSubmenu();
                }
            }

            if (btnRankingPopup) {
                btnRankingPopup.addEventListener('click', abrirModalRanking);
            }
            if (btnRankingAplicarFiltros) {
                btnRankingAplicarFiltros.addEventListener('click', renderRankingList);
            }
            
            console.log("Inicialização concluída.");
        };

        function moverElementoRanking(currentIndex, direction) {
            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;

            if (newIndex < 0 || newIndex >= ordemAtualElementosRanking.length) return;
            if (ordemAtualElementosRanking[newIndex].startsWith("---")) {
                 if (direction === 'up' && newIndex > 0 && ordemAtualElementosRanking[newIndex-1] && !ordemAtualElementosRanking[newIndex-1].startsWith("---")) {
                    [ordemAtualElementosRanking[currentIndex], ordemAtualElementosRanking[newIndex-1]] = [ordemAtualElementosRanking[newIndex-1], ordemAtualElementosRanking[currentIndex]];
                 } else if (direction === 'down' && newIndex < ordemAtualElementosRanking.length - 1 && ordemAtualElementosRanking[newIndex+1] && !ordemAtualElementosRanking[newIndex+1].startsWith("---")) {
                     [ordemAtualElementosRanking[currentIndex], ordemAtualElementosRanking[newIndex+1]] = [ordemAtualElementosRanking[newIndex+1], ordemAtualElementosRanking[currentIndex]];
                 } else {
                    return;
                 }
            } else {
                 [ordemAtualElementosRanking[currentIndex], ordemAtualElementosRanking[newIndex]] = [ordemAtualElementosRanking[newIndex], ordemAtualElementosRanking[currentIndex]];
            }
            renderRankingList();
        }
    </script>
</body>
</html>
