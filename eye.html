<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Designa√ß√µes Avan√ßado</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #1c1e21;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .main-container {
            display: flex;
            flex-grow: 1;
            padding: 10px;
            gap: 10px;
            overflow: hidden;
        }

        .coluna {
            flex: 1;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .coluna#coluna-pessoas {
             flex-basis: 30%;
             max-width: 350px;
        }
        .coluna#coluna-detalhes {
            flex-basis: 70%;
        }

        .coluna h2, .coluna h3 {
            margin-top: 0;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        #search-pessoa-container { margin-bottom: 10px; padding: 5px; border-radius: 6px; }
        #search-pessoa-input { width: calc(100% - 20px); padding: 10px; border: 1px solid #ced4da; border-radius: 5px; font-size: 0.95em; box-sizing: border-box; }
        #lista-pessoas { list-style-type: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        #lista-pessoas li { padding: 10px 12px; margin-bottom: 6px; background-color: #e9ecef; border-radius: 6px; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; font-size: 0.95em; }
        #lista-pessoas li:hover { background-color: #d3d9df; }
        #lista-pessoas li.active { background-color: #007bff; color: white; font-weight: 500; }
        #lista-pessoas li.hidden-by-search { display: none; }

        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab-button { padding: 10px 15px; cursor: pointer; border: none; background-color: transparent; font-size: 1em; margin-right: 5px; border-bottom: 3px solid transparent; color: #555; }
        .tab-button.active { border-bottom: 3px solid #007bff; font-weight: bold; color: #007bff; }
        /* Estilo para o bot√£o de "Editar Designa√ß√µes" quando o modo est√° ativo */
        .tab-button#tab-btn-editar-modo.active-edit-mode {
            background-color: #ffe082; /* Um amarelo claro, por exemplo */
            color: #212529;
            font-weight: bold;
            border-bottom: 3px solid #ffc107 !important; /* !important para sobrescrever .active normal */
        }


        .tab-content {
            display: none;
            flex-grow: 1;
            overflow-y: auto;
        }
        #coluna-detalhes .tab-content.active {
            display: flex;
            flex-direction: column;
        }
        #coluna-detalhes #estatisticas-content.active {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            padding-top: 10px;
        }

        .filters-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 6px; align-items: center; }
        .filters-container label { font-size: 0.9em; margin-right: 5px; }
        .filters-container select, .filters-container input, .filters-container button { padding: 8px; border-radius: 4px; border: 1px solid #ced4da; font-size: 0.9em; }
        .filters-container button { background-color: #007bff; color: white; cursor: pointer; }
        .filters-container button#btn-limpar-filtros { background-color: #6c757d; }

        /* Estilos para o bot√£o de toggle dos filtros da pessoa */
        .btn-toggle-filtros {
            display: none; /* Come√ßa oculto, ser√° mostrado apenas em mobile pela media query */
            width: 100%;
            padding: 10px 15px;
            background-color: #f0f2f5; /* Cor de fundo suave */
            color: #0056b3; /* Cor do texto principal */
            border: 1px solid #d1d9e0; /* Borda sutil */
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            text-align: left; /* O alinhamento interno ser√° controlado por flex */
            font-size: 0.95em;
            /* display: flex; Ser√° ativado na media query */
            align-items: center;
        }

        .btn-toggle-filtros .fa-filter {
            margin-right: 8px;
            color: #007bff; /* Cor do √≠cone de filtro */
        }

        .btn-toggle-filtros .btn-toggle-text {
            flex-grow: 1; /* O texto ocupa o espa√ßo dispon√≠vel */
        }

        .btn-toggle-filtros .toggle-icon {
            margin-left: 10px; /* Espa√ßo antes do √≠cone de chevron */
            transition: transform 0.3s ease; /* Anima√ß√£o para rota√ß√£o do chevron */
        }

        .btn-toggle-filtros.active .toggle-icon {
            transform: rotate(180deg); /* Rotaciona o chevron quando ativo */
        }


        #historico-content ul { list-style-type: none; padding-left: 0; }
        #historico-content li { padding: 8px 10px; border-bottom: 1px solid #eee; transition: background-color 0.3s ease; /* For week color hover */ }
        #historico-content li.month-separator { padding: 15px 0 5px 0; font-weight: bold; font-size: 1.1em; color: #0056b3; background-color: transparent !important; } /* Ensure separator is not colored by week logic */
        #historico-content li.month-separator.first-month-separator { border-top: none; margin-top: 0; }
        #historico-content li.month-separator:not(.first-month-separator) { border-top: 2px solid #ddd; margin-top: 10px;}
        #historico-content li:last-child:not(.month-separator) { border-bottom: none; }
        /* Estilo para bot√µes de edi√ß√£o nas linhas do hist√≥rico */
        #historico-content ul li button {
            background-color: #17a2b8; /* ciano informativo */
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8em;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        #historico-content ul li button:hover {
            background-color: #138496;
        }
        #historico-content ul li button .fas { /* √çcone dentro do bot√£o */
            margin-right: 4px;
        }


        #coluna-detalhes #estatisticas-content .stat-card { background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; box-shadow: 0 3px 8px rgba(0,0,0,0.06); display: flex; flex-direction: column; }
        #coluna-detalhes #estatisticas-content .stat-card h4 { margin-top: 0; margin-bottom: 15px; color: #0056b3; font-size: 1.15em; border-bottom: 1px solid #eef; padding-bottom: 10px; }
        #coluna-detalhes #estatisticas-content .stat-card .stat-value { font-size: 2em; font-weight: 600; color: #007bff; display: block; margin-bottom: 8px; text-align: center; }
        #coluna-detalhes #estatisticas-content .stat-card .stat-label { font-size: 0.9em; color: #555; text-align: center; margin-bottom: 15px; }
        #coluna-detalhes #estatisticas-content .stat-card p, #coluna-detalhes #estatisticas-content .stat-card ul { font-size: 0.95em; color: #333; margin-bottom: 8px; }
        #coluna-detalhes #estatisticas-content .stat-card ul { padding-left: 20px; list-style-type: "‚Äì "; }
        #coluna-detalhes #estatisticas-content .stat-card li { margin-bottom: 6px; }
        #coluna-detalhes #estatisticas-content .stat-card li .stat-value-inline { font-weight: bold; color: #28a745; }
        #coluna-detalhes #verificacao-conjunta-container.stat-card label,
        #coluna-detalhes #verificacao-conjunta-container.stat-card select,
        #coluna-detalhes #verificacao-conjunta-container.stat-card button { display: block; width: calc(100% - 16px); margin-bottom: 12px; box-sizing: border-box; }
        #coluna-detalhes #verificacao-conjunta-container.stat-card button { width: auto; padding: 10px 18px; background-color: #17a2b8; border-color: #17a2b8; color: white; cursor: pointer; }
        #coluna-detalhes #resultado-verificacao-conjunta { margin-top: 12px; font-weight: 500; padding: 10px; border-radius: 5px; text-align: center; }
        #coluna-detalhes #resultado-verificacao-conjunta.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;}
        #coluna-detalhes #resultado-verificacao-conjunta.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;}
        #coluna-detalhes #resultado-verificacao-conjunta.info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;}
        #coluna-detalhes #designacoesPorElementoChartContainer.stat-card,
        #coluna-detalhes .stats-chart-container-pessoa.stat-card { /* Applied to new chart containers for person details */
             min-height: 300px;
        }
        #coluna-detalhes #designacoesPorElementoChartContainer.stat-card canvas,
        #coluna-detalhes .stats-chart-container-pessoa.stat-card canvas { /* Applied to new chart canvases */
            width: 100% !important; max-height: 320px;
        }
        #coluna-detalhes #estatisticas-content:empty::before,
        #coluna-detalhes #estatisticas-content:has(> p:only-child)::before { content: "Nenhuma designa√ß√£o para calcular estat√≠sticas com os filtros atuais."; display: flex; align-items: center; justify-content: center; text-align: center; width: 100%; height: 100%; color: #777; font-size: 1.1em; }
        #coluna-detalhes #estatisticas-content > p:only-child { display: none; }


        .fab-container { position: fixed; bottom: 30px; right: 30px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
        .fab-stats-button { /* Estilo gen√©rico para bot√µes no FAB que n√£o s√£o o principal */
            background-color: #17a2b8; /* Ciano padr√£o */
            color: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.12);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background-color 0.2s ease;
            margin-bottom: 10px; /* Espa√ßo entre os bot√µes FAB */
        }
        .fab-stats-button:hover {
            transform: translateY(-2px);
        }
        /* Espec√≠fico para o bot√£o de Ranking */
        #btn-ranking-popup {
            background-color: #ff9800; /* Laranja */
        }
        #btn-ranking-popup:hover {
            background-color: #e68a00; /* Laranja mais escuro */
        }
        /* Espec√≠fico para o bot√£o de Stats Globais (se precisar de cor diferente do padr√£o) */
        #btn-global-stats {
             background-color: #17a2b8; /* Mant√©m ciano ou muda se desejar */
        }
        #btn-global-stats:hover {
            background-color: #138496;
        }

        .fab { background-color: #007bff; color: white; border: none; width: 56px; height: 56px; border-radius: 50%; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, background-color 0.2s ease; }
        .fab:hover { background-color: #0056b3; transform: translateY(-2px); }
        .fab-options { display: none; position: absolute; bottom: 70px; /* Ajustado para mais bot√µes no FAB */ right: 0; flex-direction: column; gap: 10px; }
        .fab-options.show { display: flex; }
        .fab-option { background-color: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; font-size: 0.9em; white-space: nowrap; transition: background-color 0.2s ease; }
        .fab-option:hover { background-color: #138496; }

        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fff; margin: 8% auto; padding: 25px; border: 1px solid #bbb; width: 90%; max-width: 550px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-content.modal-gerenciar { max-width: 700px; }
        .close-button { color: #888; position: absolute; top: 10px; right: 15px; font-size: 30px; font-weight: bold; line-height: 1; }
        .close-button:hover, .close-button:focus { color: #333; text-decoration: none; cursor: pointer; }
        .modal-content h3 { margin-top: 0; color: #0056b3; font-size: 1.5em; margin-bottom: 20px; }
        .modal-content form div { margin-bottom: 18px; }
        .modal-content label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95em; }
        .modal-content input[type="text"], .modal-content select, .modal-content input[type="number"] { width: calc(100% - 24px); padding: 10px 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        .modal-content button[type="submit"] { background-color: #28a745; color: white; padding: 12px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background-color 0.2s ease; }
        .modal-content button[type="submit"]:hover { background-color: #218838; }
        #coluna-detalhes-content { display: flex; align-items: center; justify-content: center; height: 100%; color: #777; font-size: 1.2em; }

        #lista-gerenciar-pessoas { list-style-type: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; }
        #lista-gerenciar-pessoas li { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; }
        #lista-gerenciar-pessoas li:last-child { border-bottom: none; }
        #lista-gerenciar-pessoas .pessoa-nome { flex-grow: 1; }
        #lista-gerenciar-pessoas .pessoa-status-visivel.oculta { font-style: italic; color: #888; margin-left: 10px; font-size: 0.9em; }
        #lista-gerenciar-pessoas .pessoa-actions button { margin-left: 8px; padding: 5px 10px; font-size: 0.85em; cursor: pointer; border: 1px solid transparent; border-radius: 4px; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-toggle-visibilidade { background-color: #ffc107; color: #333; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-toggle-visibilidade.mostrar { background-color: #28a745; color: white; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-editar-pessoa { background-color: #17a2b8; color: white; }
        #lista-gerenciar-pessoas .pessoa-actions .btn-remover-pessoa { background-color: #dc3545; color: white; }

        /* Estilos para o Modal de Estat√≠sticas Globais Melhorado */
        .modal-global-stats-content {
            max-width: 95%; /* Aumentado para acomodar mais conte√∫do */
            width: 1100px;
            background-color: #f4f6f8;
            display: flex; /* Para abas e conte√∫do */
            flex-direction: column; /* Para abas e conte√∫do */
            min-height: 80vh; /* Altura m√≠nima */
        }
        .modal-global-stats-content .global-stats-header {
            text-align: center;
            color: #004a99;
            font-size: 1.7em;
            margin-bottom: 15px; /* Reduzido para dar espa√ßo √†s abas */
            border-bottom: 2px solid #0056b3;
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
   .modal-global-stats-tabs { /* Container para os bot√µes das abas */
    display: flex;
    border-bottom: 1px solid #ccc;
    margin-bottom: 20px;
    background-color: #fff;
    padding: 0 10px;
    border-top-left-radius: 6px;
    border-top-right-radius: 6px;
    /* REMOVA AS LINHAS flex-wrap, overflow-x, e white-space daqui */
}

/* DEIXE ESTA REGRA ASSIM (vers√£o desktop) */
.global-stats-tab-button {
    /* As duas propriedades mais importantes para o alinhamento em barra */
    flex-grow: 1;
    flex-basis: 0;

    /* Estilos de apar√™ncia */
    text-align: center;

}
        .global-stats-tab-button:hover {
            color: #007bff;
        }
        .global-stats-tab-button.active {
            border-bottom: 3px solid #007bff;
            font-weight: bold;
            color: #007bff;
        }
        .global-stats-tab-content { /* Conte√∫do de cada aba */
            display: none; /* Escondido por padr√£o */
            padding: 10px;
            flex-grow: 1; /* Para ocupar o espa√ßo restante */
            overflow-y: auto; /* Scroll se necess√°rio */
        }
        .global-stats-tab-content.active {
            display: block; /* Mostra o conte√∫do da aba ativa */
        }
        .stats-header-icon { margin-right: 12px; font-size: 0.9em; }
        .stats-card-section {
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            transition: box-shadow 0.3s ease;
        }
        .stats-card-section:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .stats-card-section h4 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #343a40;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 12px;
            font-size: 1.25em;
            display: flex;
            align-items: center;
        }
        .stats-icon { margin-right: 10px; color: #007bff; font-size: 1.05em; width: 20px; text-align: center; }
        .stats-filters {
            background-color: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;
            border: 1px solid #e9ecef; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;
        }
        .stats-filters label { font-weight: 500; color: #495057; margin-right: 5px; }
        .stats-filters select, .stats-filters button, .stats-filters input[type="number"] { padding: 9px 12px; font-size: 0.9em; border-radius: 5px; border: 1px solid #ced4da; }
        .stats-filters select { min-width: 120px; }
        .stats-apply-button {
            background-color: #007bff; color: white; border: none; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .stats-apply-button:hover { background-color: #0056b3; transform: translateY(-1px); }
        .stats-apply-button:active { transform: translateY(0px); }
        .stats-apply-button:disabled { background-color: #adb5bd; color: #6c757d; cursor: not-allowed; transform: none; }
        .stats-btn-icon { font-size: 0.95em; }
        .stats-results-container { padding-top: 15px; border-top: 1px solid #f1f1f1; margin-top: 20px; min-height: 60px; position: relative; }
        .agrupado-subheader { font-size: 1.05em; color: #495057; margin-top: 10px; margin-bottom: 10px; font-weight: 500; }
        .stats-result-list { list-style-type: none; padding-left: 0; max-height: 250px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 4px; background-color: #fff; }
        .stats-result-list li {
            padding: 10px 15px; border-bottom: 1px solid #f1f3f5; font-size: 0.9em;
            display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease;
        }
        .stats-result-list li:hover { background-color: #e9f5ff; }
        .stats-result-list li:last-child { border-bottom: none; }
        .stats-result-list .count, .stats-result-list .value { font-weight: bold; color: #0056b3; margin-left: 10px; white-space: nowrap; }
        .stats-result-list li.clickable { cursor: pointer; }
        .stats-result-list li.clickable:hover { background-color: #d1ecf1; }

        .stats-result-text { font-size: 0.95em; line-height: 1.7; }
        .stats-result-text p { margin: 10px 0; padding: 8px 0; border-bottom: 1px dashed #e0e0e0; }
        .stats-result-text p:last-child { border-bottom: none; }
        .stats-result-text strong { color: #212529; }
        .stats-result-text .acima-media { color: #28a745; font-weight: bold; }
        .stats-result-text .abaixo-media { color: #dc3545; font-weight: bold; }
        .stats-result-text .na-media { color: #ffc107; font-weight: bold; }
        .stats-kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stats-kpi-card { background-color: #fff; padding: 15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); text-align: center; }
        .stats-kpi-card .kpi-value { font-size: 1.8em; font-weight: 600; color: #007bff; display: block; margin-bottom: 5px; }
        .stats-kpi-card .kpi-label { font-size: 0.9em; color: #555; }
        .stats-chart-container { min-height: 300px; margin-bottom: 20px; background-color: #fff; padding:15px; border-radius:6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        .mostrar-todos-link {
            display: inline-block; text-align: right; font-size: 0.85em; margin-top: 12px;
            color: #007bff; cursor: pointer; text-decoration: none; font-weight: 500; padding: 5px 0;
        }
        .mostrar-todos-link:hover { text-decoration: underline; color: #0056b3; }
        .loading-spinner {
            border: 4px solid #e9ecef; border-top: 4px solid #007bff; border-radius: 50%;
            width: 36px; height: 36px; animation: spin 0.8s linear infinite; margin: 25px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stats-result-list:empty::before,
        .stats-result-text:empty::before {
            content: "Nenhum dado para exibir com os filtros atuais. Ajuste os filtros e tente novamente.";
            display: block; text-align: center; padding: 25px 15px; color: #6c757d;
            font-style: italic; font-size: 0.95em; background-color: #f8f9fa;
            border: 1px dashed #ced4da; border-radius: 4px;
        }
        /* Estilos para compara√ß√£o de pessoas */
        #gs-pessoas-comparison-area { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 15px; }
        .pessoa-comparison-card { flex: 0 0 300px; /* N√£o encolhe, base de 300px */ background-color: #fff; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pessoa-comparison-card h5 { margin-top: 0; color: #0056b3; border-bottom: 1px solid #eee; padding-bottom: 8px;}
        .pessoa-comparison-card ul { list-style-type: none; padding: 0; }
        .pessoa-comparison-card li { font-size: 0.9em; margin-bottom: 6px; }
        .pessoa-comparison-card .stat-value { font-weight: bold; color: #333; }

        /* Custom Multi-select for "Comparar Desempenho de Pessoas" */
        .custom-multiselect-container {
            position: relative;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 5px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            min-height: 38px; /* Approx height of a select input */
            width: 250px; /* Match original select width or adjust as needed */
            box-sizing: border-box;
            margin-bottom: 10px; /* Spacing */
        }

    .selected-items-area { /* Nome gen√©rico */
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            flex-grow: 1;
        }

        .item-tag { /* Nome gen√©rico */
            background-color: #007bff;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .item-tag .remove-tag-btn { /* Nome gen√©rico */
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            background: none;
            border: none;
            color: white;
            padding: 0 2px;
        }
        .item-tag .remove-tag-btn:hover {
            opacity: 0.8;
        }

        #gs-pessoas-search-input-custom {
            border: none;
            outline: none;
            padding: 6px;
            font-size: 0.9em;
            flex-grow: 1; /* Allow input to take remaining space */
            min-width: 100px; /* Minimum width for the input field */
            box-sizing: border-box;
        }
        .custom-multiselect-container:focus-within { /* Style when container or input has focus */
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }


        #gs-pessoas-dropdown-custom {
            position: absolute;
            top: 100%; /* Position below the container */
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ced4da;
            border-top: none; /* Avoid double border */
            border-radius: 0 0 5px 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1050; /* Ensure it's above other content in modal */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none; /* Hidden by default */
        }

        #gs-pessoas-dropdown-custom ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #gs-pessoas-dropdown-custom li {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9em;
        }

        #gs-pessoas-dropdown-custom li:hover {
            background-color: #e9ecef;
        }
        #gs-pessoas-dropdown-custom li.disabled { /* For already selected items in dropdown */
            color: #adb5bd;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }

        /* Estilos para o Modal de Ranking */
        .ranking-list-container {
            margin-top: 20px;
            border: 1px solid #eee;
            border-radius: 6px;
            padding: 15px;
            background-color: #fdfdfd;
        }

        #lista-ranking-designacoes {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #lista-ranking-designacoes li {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }
        #lista-ranking-designacoes li:last-child {
            border-bottom: none;
        }

        #lista-ranking-designacoes .designacao-nome {
            font-weight: 500;
            color: #333;
            flex-grow: 1;
        }
        #lista-ranking-designacoes .designacao-participantes {
            color: #0056b3;
            font-style: italic;
            margin-left: 10px;
            text-align: right;
            min-width: 150px; /* Para evitar quebra de linha f√°cil */
        }
        #lista-ranking-designacoes .designacao-participantes.ninguem {
            color: #888;
        }


        /* Separadores no Ranking */
        .ranking-section-separator {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 86, 179, 0), rgba(0, 86, 179, 0.75), rgba(0, 86, 179, 0));
            margin: 12px 0;
        }
        .ranking-paragraph-separator { /* Se usar como <li> */
            height: 10px; /* Apenas um espa√ßo, sem linha vis√≠vel */
            border-bottom: none !important; /* Garante que n√£o haja borda de li */
            background-color: transparent !important; /* Garante que n√£o haja cor de fundo de li */
            padding: 5px 0 !important;
        }
         /* Garante que o HR n√£o tenha padding de LI se for um elemento HR dentro da UL */
        #lista-ranking-designacoes hr.ranking-section-separator {
            padding: 0;
            border-bottom: none; /* Se for um HR, n√£o precisa de border-bottom */
        }


        /* Bot√µes de reordenar no Ranking */
        .reorder-buttons button {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            padding: 3px 6px;
            margin-left: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.8em;
        }
        .reorder-buttons button:hover {
            background-color: #e9ecef;
            border-color: #bbb;
        }
        .reorder-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Styles for the new sub-menu in "An√°lises Anteriores" tab */
        .gs-old-submenu-tabs {
            display: flex;
            border-bottom: 1px solid #dfe3e8; /* Lighter border for sub-tabs */
            margin-bottom: 15px; /* Space before the content of the sub-tab */
            background-color: #f0f2f5; /* Slightly different background for the sub-tab bar */
            padding: 6px 6px 0 6px;
            border-radius: 5px 5px 0 0; /* Rounded top corners */
        }

        .gs-old-submenu-button {
            padding: 9px 14px; /* Adjust padding as needed */
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 0.9em; /* Slightly smaller font for sub-tabs */
            margin-right: 4px;
            border-bottom: 3px solid transparent;
            color: #555e69;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            transition: background-color 0.2s ease, color 0.2s ease, border-bottom-color 0.2s ease;
        }

        .gs-old-submenu-button:hover {
            background-color: #e9ecef;
            color: #0056b3;
        }

        .gs-old-submenu-button.active {
            border-bottom: 3px solid #007bff;
            font-weight: 600; /* Bolder for active sub-tab */
            color: #007bff;
            background-color: #ffffff; /* Make active sub-tab's background match content area */
        }

        /* Control visibility of the sections within gs-old-content */
     #gs-old-content > .stats-card-section,
#gs-pessoas-content > .stats-card-section,
#gs-discursos-content > .stats-card-section { /* <-- ADICIONE ESTA LINHA */
    display: none; /* Hide all sections by default */
}

#gs-old-content > .stats-card-section.active-submenu-section,
#gs-pessoas-content > .stats-card-section.active-submenu-section,
#gs-discursos-content > .stats-card-section.active-submenu-section { /* <-- E ESTA LINHA */
    display: block; /* Show only the active section */
}

.participante-editavel {
    color: #333; /* Define a cor do texto para um preto suave */
    font-style: normal; /* Remove o it√°lico que √© herdado do cont√™iner */
    cursor: pointer;
    text-decoration: underline;
    text-decoration-style: dotted;
    text-decoration-color: currentColor; /* A linha pontilhada ser√° da mesma cor do texto (#333) */
    transition: background-color 0.2s ease;
    padding: 2px 4px;
    border-radius: 3px;
}

.participante-editavel:hover {
    background-color: #e9ecef; /* Fundo cinza claro no hover, sem alterar a cor do texto */
}

/* Adicione esta regra de estilo ao seu bloco <style> */
#coluna-pessoas h2 {
    cursor: pointer;
    user-select: none; /* Impede que o texto seja selecionado ao clicar */
}


.sidebar-toggle-button, .sidebar-overlay {
    display: none;
}


.btn-toggle-filtros {
    display: none;
}

/* Mas se entrarmos em um contexto onde ele precisa aparecer (JS far√° isso), ele se torna vis√≠vel */
/* Esta regra √© mais uma garantia de consist√™ncia */
#coluna-detalhes .btn-toggle-filtros {
     /* display: none; */ /* O JS vai controlar isso agora */
}

/* O wrapper no desktop n√£o precisa da l√≥gica de grid, mas o JS vai setar display:grid/none */
.filtros-wrapper-mobile {
    /* N√£o precisa de regras espec√≠ficas de display aqui, o JS controla */
}

/* Media Query: Aplica estes estilos APENAS em telas com largura m√°xima de 768px (m√≥veis e tablets pequenos) */
@media (max-width: 768px) {
    /* O cont√™iner principal se ajusta */
    .main-container {
        flex-direction: column;
    }

    /* O bot√£o hamburger (tr√™s tra√ßos) */
    .sidebar-toggle-button {
        display: flex; /* Torna o bot√£o vis√≠vel */
        flex-direction: column;
        justify-content: space-around;
        width: 30px;
        height: 24px;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0;
        z-index: 1011; /* Acima do overlay e do conte√∫do, mas abaixo do menu */
        position: fixed; /* Fica fixo na tela */
        top: 15px;
        left: 15px;
    }
    .sidebar-toggle-button span {
        width: 30px;
        height: 3px;
        background-color: #333; /* Cor dos tra√ßos */
        border-radius: 5px;
    }

    /* O fundo escurecido (overlay) */
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1009;
        opacity: 0; /* Come√ßa invis√≠vel */
        visibility: hidden; /* Come√ßa inacess√≠vel */
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
    }

    /* A coluna das pessoas (a barra lateral) */
    #coluna-pessoas {
        position: fixed; /* Fica por cima do conte√∫do */
        left: 0;
        top: 0;
        height: 100%;
        width: 80%; /* Ocupa 80% da tela */
        max-width: 300px; /* Mas n√£o mais que 300px */
        z-index: 1010; /* Fica acima do overlay */
        transform: translateX(-100%); /* Come√ßa escondida para a esquerda */
        transition: transform 0.3s ease-in-out;
        box-shadow: 4px 0px 15px rgba(0,0,0,0.2);
    }
    
    /* A coluna de detalhes ocupa a tela inteira */
    #coluna-detalhes {
        width: 100%;
        flex-basis: 100%;
        padding-top: 60px; /* Espa√ßo para o bot√£o hamburger n√£o ficar por cima do t√≠tulo */
    }

    /* --- ESTADOS QUANDO O MENU EST√Å ABERTO --- */
    
    /* Quando o body tem a classe 'sidebar-visible', o menu aparece */
    body.sidebar-visible #coluna-pessoas {
        transform: translateX(0); /* Desliza para a posi√ß√£o vis√≠vel */
    }

    /* E o overlay tamb√©m aparece */
    body.sidebar-visible .sidebar-overlay {
        display: block; /* Garante que est√° no fluxo para ser clic√°vel */
        opacity: 1;
        visibility: visible;
    }
}


@media (max-width: 768px) {
    /* Mostra o bot√£o no mobile */
    #btn-toggle-filtros-pessoa.btn-toggle-filtros {
        display: flex;
    }

    /* O wrapper no mobile usa GRID para a anima√ß√£o de altura */
    .filtros-wrapper-mobile {
        display: grid;
        grid-template-rows: 0fr;
        transition: grid-template-rows 0.35s ease-out;
    }
    
    .filtros-wrapper-mobile.filtros-visiveis {
        grid-template-rows: 1fr;
    }
    
    /* Precisamos garantir que o overflow e min-height s√≥ se apliquem no mobile
       para n√£o interferir com a anima√ß√£o de opacidade */
    #coluna-detalhes #filtros-pessoa-container {
        overflow: hidden;
        min-height: 0;
    }
}

   #coluna-detalhes #estatisticas-content .stat-card {
            position: relative; /* Necess√°rio para o posicionamento absoluto do bot√£o */
        }

        .btn-expand-chart {
            position: absolute;
            top: 18px;
            right: 15px;
            background-color: #f0f2f5;
            border: 1px solid #d1d9e0;
            color: #555;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            transition: background-color 0.2s, color 0.2s;
            z-index: 10;
        }
        .btn-expand-chart:hover {
            background-color: #007bff;
            color: white;
        }


        @media (max-width: 768px) {
    /* Make the modal itself take up more of the screen */
    .modal-global-stats-content {
        width: 98%;
        max-width: 98%;
        height: 90vh; /* Use viewport height */
        margin: 5vh auto;
        padding: 15px;
    }

    /* Reduce title size and padding */
    .modal-global-stats-content .global-stats-header {
        font-size: 1.25em;
        padding-bottom: 10px;
        margin-bottom: 10px;
    }

    /* Make the tab bar horizontally scrollable if needed */
  .modal-global-stats-tabs {
        flex-wrap: wrap;     /* Permite a quebra de linha */
        overflow-x: visible; /* Remove a barra de rolagem */
        white-space: normal;
    }

 .global-stats-tab-button {
        flex-grow: 1;       /* ESTA √â A CHAVE: faz os bot√µes crescerem para preencher a linha */
        text-align: center;
        
        /* Removemos as propriedades antigas da solu√ß√£o de rolagem */
        display: block;  /* Ou remova a linha 'display' completamente */
        flex-shrink: 1; 
        
        /* As propriedades antigas como 'display: inline-block' e 'flex-shrink: 0' n√£o s√£o mais necess√°rias aqui */
    }
    
    .global-stats-tab-content {
        padding: 5px; /* Reduce padding on content area */
    }

    /* --- Key change for filter responsiveness --- */
    .stats-filters {
        flex-direction: column !important; /* Force all filter groups to stack */
        gap: 15px;
    }

    .stats-filters > div {
        flex-direction: column; /* Stack filters within groups */
        width: 100%;
        gap: 8px;
        align-items: stretch !important; /* Ensure full width */
    }

    .stats-filters > div > div {
        width: 100%;
        min-width: 100%;
    }

    /* Ensure labels are visible and inputs are full-width */
    .stats-filters label {
        margin-bottom: 4px;
        font-weight: 500;
    }
    .stats-filters select, 
    .stats-filters input, 
    .stats-filters button,
    .custom-multiselect-container {
        width: 100%;
        box-sizing: border-box;
    }

    .stats-apply-button {
        padding: 12px;
        margin-top: 5px;
    }
    
    /* Adjust KPI grid for smaller screens */
    .stats-kpi-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 10px;
    }

    .stats-kpi-card .kpi-value {
        font-size: 1.6em;
    }
    
    /* Ensure charts and their containers stack vertically */
    .stats-chart-container {
        min-height: 250px; /* Reduce minimum height */
    }
    
    #gs-total-content div[style*="flex-wrap: wrap"] {
        flex-direction: column;
    }
    
    /* Adjust comparison cards area */
    #gs-pessoas-comparison-area {
        gap: 10px;
    }
    .pessoa-comparison-card {
        flex-basis: 85%; /* Make cards wider on mobile */
        max-width: 300px;
    }

    .stats-card-section {
        padding: 15px;
    }

    .stats-card-section h4 {
        font-size: 1.1em;
    }
}


  .checkbox-multiselect-container {
            position: relative;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
            cursor: pointer;
        }
        .checkbox-multiselect-container:focus-within {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .dropdown-display {
            padding: 9px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #495057;
        }

        .dropdown-display::after { /* Adiciona a seta para baixo */
            content: '‚ñº';
            font-size: 0.6em;
            color: #888;
        }

        .dropdown-options {
            display: none; /* Come√ßa oculto */
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ced4da;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1051; /* Acima de outro conte√∫do do modal */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .dropdown-options.visible {
            display: block;
        }

        .dropdown-options ul {
            list-style: none;
            padding: 5px 0;
            margin: 0;
        }

        .dropdown-item {
            padding: 8px 12px;
            display: flex;
            align-items: center;
        }
        .dropdown-item:hover {
            background-color: #f0f2f5;
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .dropdown-item label {
            font-weight: normal;
            font-size: 1em;
            margin: 0;
            width: 100%;
        }

        .dropdown-actions {
            padding: 5px 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .dropdown-actions button {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 0.85em;
            padding: 4px;
        }
        .dropdown-actions button:hover {
            text-decoration: underline;
        }
        


         .chart-wrapper {
            position: relative; /* Essencial para o posicionamento do canvas */
            flex-grow: 1;      /* Faz com que o contentor ocupe o espa√ßo vertical dispon√≠vel no card */
            min-height: 250px; /* Garante uma altura m√≠nima para o gr√°fico */
        }

        /* Ajusta o canvas para preencher o novo contentor */
        .chart-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }

        /* Remove a altura m√°xima antiga do canvas, que j√° n√£o √© necess√°ria */
        .coluna #designacoesPorElementoChartContainer.stat-card canvas,
        .coluna .stats-chart-container-pessoa.stat-card canvas {
            max-height: none; 
        }

        #gs-discursos-content > .stats-card-section {
    display: none; /* Esconde todas as se√ß√µes de Discursos por padr√£o */
}

#gs-discursos-content > .stats-card-section.active-submenu-section {
    display: block; /* Mostra APENAS a se√ß√£o da sub-aba ativa */
}

    </style>
</head>


<body>
    <div class="main-container">

        <button id="sidebar-toggle-button" class="sidebar-toggle-button">
    <span></span>
    <span></span>
    <span></span>
</button>

<div id="sidebar-overlay" class="sidebar-overlay"></div>

        <div id="coluna-pessoas" class="coluna">
            <h2>Pessoas</h2>
            <div id="search-pessoa-container"><input type="text" id="search-pessoa-input" placeholder="Pesquisar pessoa..."></div>
            <ul id="lista-pessoas"></ul>
        </div>
        <div id="coluna-detalhes" class="coluna"><div id="coluna-detalhes-content"><p>Selecione uma pessoa para ver os detalhes.</p></div></div>
    </div>

  <div class="fab-container">
        <button id="btn-ranking-popup" class="fab-stats-button" title="Ranking da Reuni√£o">
            <i class="fas fa-list-ol"></i>
        </button>
        <button id="btn-global-stats" class="fab-stats-button" title="Estat√≠sticas Globais">üìä</button>
        <button id="fab-main" class="fab">+</button>
        <div id="fab-options" class="fab-options">
            <button id="btn-gerenciar-pessoas-fab" class="fab-option">‚öôÔ∏è Gerenciar Pessoas</button>
            <button id="btn-criar-pessoa-fab" class="fab-option">üë§ Criar Pessoa</button>
            <button id="btn-criar-elemento-fab" class="fab-option">üìÑ Criar Elemento</button>
            <button id="btn-criar-designacao-fab" class="fab-option">üìå Criar Designa√ß√£o</button>
            <a href="add.html" class="fab-option" style="text-decoration: none;">üìã Adicionar Escala</a>
            <a href="addpregacao.html" class="fab-option" style="text-decoration: none;">üó∫Ô∏è Adicionar Prega√ß√£o</a>
        </div>
    </div>

    <div id="modal-pessoa" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-pessoa">√ó</span><h3 id="modal-pessoa-titulo">Criar Nova Pessoa</h3><form id="form-criar-pessoa"><input type="hidden" id="pessoa-id-edit"><div><label for="nome-pessoa">Nome:</label><input type="text" id="nome-pessoa" required></div><div><label for="idioma-pessoa">Idioma:</label><select id="idioma-pessoa"><option value="Portugu√™s">Portugu√™s</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select></div><div><label for="genero-pessoa">G√™nero:</label><select id="genero-pessoa"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select></div><div><label for="cargo-pessoa">Cargo:</label><select id="cargo-pessoa"><option value="Publicador">Publicador</option><option value="Servo Ministerial">Servo Ministerial</option><option value="Anci√£o">Anci√£o</option></select></div><div><label for="pregacao-pessoa">Prega√ß√£o:</label><select id="pregacao-pessoa"><option value="">Nenhum</option><option value="Pioneiro Auxiliar">Pioneiro Auxiliar</option><option value="Pioneiro Regular">Pioneiro Regular</option></select></div><button type="submit" id="btn-submit-pessoa">Criar Pessoa</button></form></div></div>
    <div id="modal-gerenciar-pessoas" class="modal"><div class="modal-content modal-gerenciar"><span class="close-button" data-modal-id="modal-gerenciar-pessoas">√ó</span><h3>Gerenciar Pessoas</h3><p><small>Aqui voc√™ pode editar, remover ou ocultar pessoas da lista principal do site.</small></p><ul id="lista-gerenciar-pessoas"></ul></div></div>
    <div id="modal-elemento" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-elemento">√ó</span><h3>Criar Novo Elemento</h3><form id="form-criar-elemento"><div><label for="nome-elemento-modal">Nome do Elemento:</label><input type="text" id="nome-elemento-modal" required></div><div> <label for="emoji-elemento-modal">Emoji:</label> <input type="text" id="emoji-elemento-modal"> </div><div><label for="tipo-elemento">Tipo:</label><select id="tipo-elemento"><option value="reuniao">Reuni√£o</option><option value="pregacao">Prega√ß√£o</option></select></div><div><label for="genero-elemento">G√™nero (Reuni√£o):</label><select id="genero-elemento"><option value="semana">Semana</option><option value="fim de semana">Fim de Semana</option><option value="tecnico">T√©cnico</option></select></div><button type="submit">Criar Elemento</button></form></div></div>
    <div id="modal-designacao" class="modal"><div class="modal-content"><span class="close-button" data-modal-id="modal-designacao">√ó</span><h3>Criar Nova Designa√ß√£o</h3><form id="form-criar-designacao"><div><label for="select-elemento-designacao">Elemento:</label><select id="select-elemento-designacao" required><option value="">-- Selecione um Elemento --</option></select></div><div><label for="select-pessoaA">Pessoa A:</label><select id="select-pessoaA"><option value="">-- Nenhuma --</option></select></div><div><label for="select-pessoaB">Pessoa B:</label><select id="select-pessoaB"><option value="">-- Nenhuma --</option></select></div><div><label for="select-pessoaC">Pessoa C:</label><select id="select-pessoaC"><option value="">-- Nenhuma --</option></select></div><div><label for="data-designacao">Data (DD/MM/AAAA):</label><input type="text" id="data-designacao" placeholder="DD/MM/AAAA" required pattern="\d{2}/\d{2}/\d{4}"></div><button type="submit">Criar Designa√ß√£o</button></form></div></div>

    <!-- MODAL EDITAR DESIGNA√á√ÉO -->
    <div id="modal-editar-designacao" class="modal">
        <div class="modal-content">
            <span class="close-button" data-modal-id="modal-editar-designacao">√ó</span>
            <h3>Editar Designa√ß√£o</h3>
            <form id="form-editar-designacao">
                <input type="hidden" id="designacao-id-edit">
                <div>
                    <label for="data-designacao-edit">Data (DD/MM/AAAA):</label>
                    <input type="text" id="data-designacao-edit" placeholder="DD/MM/AAAA" required pattern="\d{2}/\d{2}/\d{4}">
                </div>
                <div>
                    <label for="select-elemento-designacao-edit">Elemento:</label>
                    <select id="select-elemento-designacao-edit" required>
                        <option value="">-- Selecione um Elemento --</option>
                    </select>
                </div>
                <div>
                    <label for="select-pessoaA-edit">Pessoa A:</label>
                    <select id="select-pessoaA-edit">
                        <option value="">-- Nenhuma --</option>
                    </select>
                </div>
                <div>
                    <label for="select-pessoaB-edit">Pessoa B:</label>
                    <select id="select-pessoaB-edit">
                        <option value="">-- Nenhuma --</option>
                    </select>
                </div>
                <div>
                    <label for="select-pessoaC-edit">Pessoa C:</label>
                    <select id="select-pessoaC-edit">
                        <option value="">-- Nenhuma --</option>
                    </select>
                </div>
                <div id="campos-orador-publico-edit" style="display:none;">
                    <div>
                        <label for="tema-orador-edit">Tema:</label>
                        <input type="text" id="tema-orador-edit">
                    </div>
                    <div>
                        <label for="congregacao-orador-edit">Congrega√ß√£o:</label>
                        <input type="text" id="congregacao-orador-edit">
                    </div>
                </div>
                <button type="submit">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>


    <!-- MODAL DE ESTAT√çSTICAS GLOBAIS - ATUALIZADO -->
    <div id="modal-global-stats" class="modal">
        <div class="modal-content modal-global-stats-content">
            <span class="close-button" data-modal-id="modal-global-stats">√ó</span>
            <h3 class="global-stats-header"><i class="fas fa-chart-pie stats-header-icon"></i> Estat√≠sticas Globais</h3>

            <div class="modal-global-stats-tabs">
                <button class="global-stats-tab-button active" data-tab-target="gs-total-content">Geral</button>
                <button class="global-stats-tab-button" data-tab-target="gs-old-content">Top</button>
                <button class="global-stats-tab-button" data-tab-target="gs-pessoas-content">Pessoas</button>
                <button class="global-stats-tab-button" data-tab-target="gs-designacoes-content">Designa√ß√µes</button>
                <button class="global-stats-tab-button" data-tab-target="gs-discursos-content">Discursos</button>
            </div>

            <!-- Conte√∫do da Aba: Vis√£o Geral -->
            <div id="gs-total-content" class="global-stats-tab-content active">
                <div class="stats-filters" style="flex-direction: column; align-items: stretch; gap: 12px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div style="flex: 1; min-width: 120px;">
                            <label for="gs-total-filtro-ano">Ano:</label>
                            <select id="gs-total-filtro-ano" style="width: 100%;"><option value="">Todos</option></select>
                        </div>
                        <div style="flex: 1; min-width: 120px;">
                            <label for="gs-total-filtro-mes">M√™s:</label>
                            <select id="gs-total-filtro-mes" style="width: 100%;"><option value="">Todos</option></select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label for="gs-total-filtro-tipo-elemento">Tipo (Elemento):</label>
                            <select id="gs-total-filtro-tipo-elemento" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="reuniao" selected>Reuni√£o</option>
                                <option value="pregacao">Prega√ß√£o</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label for="gs-total-filtro-genero-reuniao">G√™nero da Reuni√£o:</label>
                            <select id="gs-total-filtro-genero-reuniao" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="semana">Semana</option>
                                <option value="fim de semana">Fim de Semana</option>
                                <option value="tecnico">T√©cnico</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label for="gs-total-filtro-genero-participante">G√™nero (Participante):</label>
                            <select id="gs-total-filtro-genero-participante" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label for="gs-total-filtro-idioma-participante">Idioma (Participante):</label>
                            <select id="gs-total-filtro-idioma-participante" style="width: 100%;">
                                <option value="">Todos</option>
                                <option value="Portugu√™s">Portugu√™s</option>
                                <option value="Italiano">Italiano</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                        <div style="align-self: flex-end;">
                            <button id="btn-gs-total-aplicar-filtros" class="stats-apply-button">
                                <i class="fas fa-filter stats-btn-icon"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>
                <h4><i class="fas fa-tachometer-alt stats-icon"></i> M√©tricas Chave</h4>
                <div class="stats-kpi-grid">
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-designacoes" class="kpi-value">-</span>
                        <span class="kpi-label">Total de Designa√ß√µes</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-masc" class="kpi-value">-</span>
                        <span class="kpi-label">Participa√ß√µes (Masculino)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-fem" class="kpi-value">-</span>
                        <span class="kpi-label">Participa√ß√µes (Feminino)</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-pt" class="kpi-value">-</span>
                        <span class="kpi-label">Participa√ß√µes (Portugu√™s)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-it" class="kpi-value">-</span>
                        <span class="kpi-label">Participa√ß√µes (Italiano)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-num-desig-outro-idioma" class="kpi-value">-</span>
                        <span class="kpi-label">Participa√ß√µes (Outro Idioma)</span>
                    </div>
                </div>
                <h4><i class="fas fa-calculator stats-icon"></i> M√©dias Mensais</h4>
                 <div class="stats-kpi-grid">
                    <div class="stats-kpi-card">
                        <span id="gs-total-media-designacoes" class="kpi-value">-</span>
                        <span class="kpi-label">M√©dia Total/M√™s</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-masc" class="kpi-value">-</span>
                        <span class="kpi-label">M√©dia Masc./M√™s</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-fem" class="kpi-value">-</span>
                        <span class="kpi-label">M√©dia Fem./M√™s</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-pt" class="kpi-value">-</span>
                        <span class="kpi-label">M√©dia Port./M√™s</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-it" class="kpi-value">-</span>
                        <span class="kpi-label">M√©dia Ital./M√™s</span>
                    </div>
                     <div class="stats-kpi-card">
                        <span id="gs-total-media-desig-outro" class="kpi-value">-</span>
                        <span class="kpi-label">M√©dia Outro Idioma/M√™s</span>
                    </div>
                </div>
                
                <h4><i class="fas fa-percentage stats-icon"></i> An√°lise Percentual</h4>
                <div class="stats-kpi-grid">
                    <div class="stats-kpi-card">
                        <span id="gs-total-perc-filtradas" class="kpi-value">-</span>
                        <span class="kpi-label">% Designa√ß√µes (Filtro vs Total)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-perc-masc" class="kpi-value">-</span>
                        <span class="kpi-label">% Participa√ß√µes (Masculino)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-perc-fem" class="kpi-value">-</span>
                        <span class="kpi-label">% Participa√ß√µes (Feminino)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-perc-pt" class="kpi-value">-</span>
                        <span class="kpi-label">% Participa√ß√µes (Portugu√™s)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-perc-it" class="kpi-value">-</span>
                        <span class="kpi-label">% Participa√ß√µes (Italiano)</span>
                    </div>
                    <div class="stats-kpi-card">
                        <span id="gs-total-perc-outro" class="kpi-value">-</span>
                        <span class="kpi-label">% Participa√ß√µes (Outro Idioma)</span>
                    </div>
                </div>

                <h4><i class="fas fa-chart-line stats-icon"></i> Gr√°ficos de Tend√™ncia</h4>
                <div class="stats-chart-container">
                    <canvas id="gs-total-chart-designacoes-mes"></canvas>
                </div>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div class="stats-chart-container" style="flex:1; min-width: 300px;">
                        <canvas id="gs-total-chart-designacoes-genero-mes"></canvas>
                    </div>
                    <div class="stats-chart-container" style="flex:1; min-width: 300px;">
                        <canvas id="gs-total-chart-designacoes-idioma-mes"></canvas>
                    </div>
                </div>
            </div>

            <!-- Conte√∫do da Aba: Top -->
           <div id="gs-old-content" class="global-stats-tab-content">
                <div class="gs-old-submenu-tabs">
                    <button class="gs-old-submenu-button active" data-submenu-target="gs-old-sec-top-pessoas">Top Pessoas</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-old-sec-todas-designacoes">Top Designa√ß√µes</button>
                </div>

                <!-- Se√ß√£o "Top Pessoas" -->
                <div class="stats-card-section active-submenu-section" id="gs-old-sec-top-pessoas">
                    <h4><i class="fas fa-users stats-icon"></i> Pessoas com Mais Designa√ß√µes</h4>
                    <div class="filters-container stats-filters" style="display: flex; flex-direction: column; align-items: stretch; gap: 12px;">
                        <!-- Primeira linha de filtros -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-top-pessoas-ano">Ano:</label>
                                <select id="gs-top-pessoas-ano"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-top-pessoas-mes">M√™s:</label>
                                <select id="gs-top-pessoas-mes"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 2; min-width: 180px; display: flex; flex-direction: column; gap: 5px;">
                                <label>Elemento(s):</label>
                                <div id="gs-top-elementos-checkbox-multiselect" class="checkbox-multiselect-container" tabindex="0">
                                    <div class="dropdown-display">
                                        <span id="gs-top-elementos-display-text">Carregando...</span>
                                    </div>
                                    <div id="gs-top-elementos-options" class="dropdown-options">
                                        <div class="dropdown-actions">
                                            <button type="button" id="gs-top-elementos-select-all">Selecionar Todos</button>
                                            <button type="button" id="gs-top-elementos-deselect-all">Limpar Sele√ß√£o</button>
                                        </div>
                                        <ul id="gs-top-elementos-options-list"></ul>
                                    </div>
                                </div>
                                <select id="gs-top-pessoas-elemento-multi-hidden" multiple style="display: none;"></select>
                            </div>
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-top-pessoas-tipo">Tipo (Elemento):</label>
                                <select id="gs-top-pessoas-tipo">
                                    <option value="">Todos</option>
                                    <option value="reuniao">Reuni√£o</option>
                                    <option value="pregacao">Prega√ß√£o</option>
                                </select>
                            </div>
                        </div>
                        <!-- Segunda linha de filtros -->
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-top: 10px;">
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-top-pessoas-genero-participante">G√™nero (Participante):</label>
                                <select id="gs-top-pessoas-genero-participante">
                                    <option value="">Todos</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                </select>
                            </div>
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-top-pessoas-idioma-participante">Idioma (Participante):</label>
                                <select id="gs-top-pessoas-idioma-participante">
                                    <option value="">Todos</option>
                                    <option value="Portugu√™s">Portugu√™s</option>
                                    <option value="Italiano">Italiano</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            <div style="flex-grow: 1; display: flex; justify-content: flex-end;">
                                <button id="btn-gs-top-pessoas-aplicar" class="stats-apply-button">
                                    <i class="fas fa-search stats-btn-icon"></i> Ver Top
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-top-pessoas-loading" style="display:none;"></div>
                        <ul id="gs-top-pessoas-list" class="stats-result-list"></ul>
                        <a href="#" id="gs-top-pessoas-mostrar-todos" class="mostrar-todos-link" style="display:none;">Mostrar lista completa</a>
                    </div>
                </div>

                <!-- Se√ß√£o "Todas Designa√ß√µes" (agora corretamente separada) -->
                <div class="stats-card-section" id="gs-old-sec-todas-designacoes">
                    <h4><i class="fas fa-list-alt stats-icon"></i> Todas as Designa√ß√µes</h4>
                    <div class="filters-container stats-filters" style="display: flex; flex-direction: column; align-items: stretch; gap: 12px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-todas-desig-ano">Ano:</label>
                                <select id="gs-todas-desig-ano"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-todas-desig-mes">M√™s:</label>
                                <select id="gs-todas-desig-mes"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 2; min-width: 180px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-todas-desig-elemento">Elemento:</label>
                                <select id="gs-todas-desig-elemento"><option value="">Todos</option></select>
                            </div>
                             <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-todas-desig-tipo">Tipo:</label>
                                <select id="gs-todas-desig-tipo">
                                    <option value="">Todos</option>
                                    <option value="reuniao">Reuni√£o</option>
                                    <option value="pregacao">Prega√ß√£o</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                            <button id="btn-gs-todas-desig-aplicar" class="stats-apply-button">
                                <i class="fas fa-list-ol stats-btn-icon"></i> Listar Detalhado
                            </button>
                            <button id="btn-gs-todas-desig-agrupar" class="stats-apply-button">
                                <i class="fas fa-layer-group stats-btn-icon"></i> Agrupar por Elemento
                            </button>
                        </div>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-todas-desig-loading" style="display:none;"></div>
                        <ul id="gs-todas-desig-list" class="stats-result-list"></ul>
                        <div id="gs-todas-desig-agrupado-container" style="display:none;">
                            <h5 class="agrupado-subheader">Top Elementos (Agrupado)</h5>
                            <ul id="gs-todas-desig-agrupado-list" class="stats-result-list"></ul>
                            <a href="#" id="gs-todas-desig-agrupado-mostrar-todos" class="mostrar-todos-link" style="display:none;">Mostrar lista completa de elementos</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conte√∫do da Aba: Pessoas -->
            <div id="gs-pessoas-content" class="global-stats-tab-content">
                <div class="gs-old-submenu-tabs">
                    <button class="gs-old-submenu-button active" data-submenu-target="gs-pessoas-sec-individual">Individual</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-pessoas-sec-comparacao">Compara√ß√£o</button>
                </div>
                <div class="stats-card-section active-submenu-section" id="gs-pessoas-sec-individual">
                    <h4><i class="fas fa-user-chart stats-icon"></i> Desempenho Individual vs. M√©dia</h4>
                    <div class="filters-container stats-filters" style="display: flex; flex-direction: column; align-items: stretch; gap: 12px;">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-pessoa-esp-select">Pessoa:</label>
                            <select id="gs-pessoa-esp-select"><option value="">-- Selecione --</option></select>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                             <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoa-esp-ano-filtro">Ano:</label>
                                <select id="gs-pessoa-esp-ano-filtro"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoa-esp-mes-filtro">M√™s:</label>
                                <select id="gs-pessoa-esp-mes-filtro"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 2; min-width: 180px; display: flex; flex-direction: column; gap: 5px;">
                                <label>Elemento(s):</label>
                                <div id="gs-indiv-elementos-checkbox-multiselect" class="checkbox-multiselect-container" tabindex="0">
                                    <div class="dropdown-display">
                                        <span id="gs-indiv-elementos-display-text">Carregando...</span>
                                    </div>
                                    <div id="gs-indiv-elementos-options" class="dropdown-options">
                                        <div class="dropdown-actions">
                                            <button type="button" id="gs-indiv-elementos-select-all">Selecionar Todos</button>
                                            <button type="button" id="gs-indiv-elementos-deselect-all">Limpar Sele√ß√£o</button>
                                        </div>
                                        <ul id="gs-indiv-elementos-options-list"></ul>
                                    </div>
                                </div>
                                <select id="gs-indiv-elemento-multi-hidden" multiple style="display: none;"></select>
                            </div>
                            <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoa-esp-tipo-filtro">Tipo:</label>
                                <select id="gs-pessoa-esp-tipo-filtro">
                                    <option value="">Todos</option>
                                    <option value="reuniao">Reuni√£o</option>
                                    <option value="pregacao">Prega√ß√£o</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                            <button id="btn-gs-pessoa-esp-aplicar" class="stats-apply-button">
                                 <i class="fas fa-analytics stats-btn-icon"></i> Analisar
                            </button>
                        </div>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-pessoa-esp-loading" style="display:none;"></div>
                        <div id="gs-pessoa-esp-results" class="stats-result-text"></div>
                    </div>
                </div>
                <div class="stats-card-section" id="gs-pessoas-sec-comparacao">
                    <h4><i class="fas fa-users-cog stats-icon"></i> Comparar Desempenho de Pessoas</h4>
                    <div class="stats-filters" style="display: flex; flex-direction: column; align-items: stretch; gap: 12px;">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-pessoas-search-input-custom">Selecionar Pessoas:</label>
                            <div id="gs-pessoas-custom-multiselect" class="custom-multiselect-container">
                                <div class="selected-items-area">
                                </div>
                                <input type="text" id="gs-pessoas-search-input-custom" placeholder="Pesquisar e adicionar...">
                                <div id="gs-pessoas-dropdown-custom" class="custom-multiselect-dropdown">
                                </div>
                            </div>
                            <select id="gs-pessoas-select-multi" multiple style="display: none; height: 1px; width: 1px; opacity: 0; position: absolute;"></select>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoas-filtro-ano">Ano:</label>
                                <select id="gs-pessoas-filtro-ano"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoas-filtro-mes">M√™s:</label>
                                <select id="gs-pessoas-filtro-mes"><option value="">Todos</option></select>
                            </div>
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoas-filtro-semana">Semana (N¬∫):</label>
                                <input type="number" id="gs-pessoas-filtro-semana" placeholder="1-53" min="1" max="53" style="width: calc(100% - 24px);">
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoas-filtro-genero">G√™nero (Designa√ß√£o):</label>
                                <select id="gs-pessoas-filtro-genero"><option value="">Todos</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select>
                            </div>
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoas-filtro-idioma">Idioma (Designa√ß√£o):</label>
                                <select id="gs-pessoas-filtro-idioma"><option value="">Todos</option><option value="Portugu√™s">Portugu√™s</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select>
                            </div>
                            <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                                <label for="gs-pessoas-filtro-tipo">Tipo (Designa√ß√£o):</label>
                                 <select id="gs-pessoas-filtro-tipo">
                                    <option value="">Todos</option>
                                    <option value="reuniao">Reuni√£o</option>
                                    <option value="pregacao">Prega√ß√£o</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                            <button id="btn-gs-pessoas-comparar" class="stats-apply-button">
                                <i class="fas fa-balance-scale stats-btn-icon"></i> Comparar Selecionadas
                            </button>
                        </div>
                    </div>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-pessoas-loading" style="display:none;"></div>
                        <div id="gs-pessoas-comparison-area">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conte√∫do da Aba: Designa√ß√µes -->
            <div id="gs-designacoes-content" class="global-stats-tab-content">
                <h4><i class="fas fa-clipboard-list stats-icon"></i> Explorar Tipos de Designa√ß√£o (Elementos)</h4>
                 <div class="stats-filters" style="display: flex; flex-direction: column; align-items: stretch; gap: 12px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 80px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-dia">Dia:</label>
                            <input type="number" id="gs-designacoes-filtro-dia" placeholder="1-31" min="1" max="31">
                        </div>
                        <div style="flex: 2; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-mes">M√™s:</label>
                            <select id="gs-designacoes-filtro-mes"><option value="">Todos</option></select>
                        </div>
                        <div style="flex: 2; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-ano">Ano:</label>
                            <select id="gs-designacoes-filtro-ano"><option value="">Todos</option></select>
                        </div>
                        <div style="flex: 1; min-width: 100px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-semana">Semana (N¬∫):</label>
                            <input type="number" id="gs-designacoes-filtro-semana" placeholder="1-53" min="1" max="53">
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-genero">G√™nero (Participante):</label>
                            <select id="gs-designacoes-filtro-genero"><option value="">Todos</option><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select>
                        </div>
                        <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-idioma">Idioma (Participante):</label>
                            <select id="gs-designacoes-filtro-idioma"><option value="">Todos</option><option value="Portugu√™s">Portugu√™s</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select>
                        </div>
                        <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                            <label for="gs-designacoes-filtro-tipo">Tipo (Elemento):</label>
                            <select id="gs-designacoes-filtro-tipo">
                                <option value="">Todos</option>
                                <option value="reuniao">Reuni√£o</option>
                                <option value="pregacao">Prega√ß√£o</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 10px;">
                        <button id="btn-gs-designacoes-aplicar-filtros" class="stats-apply-button" title="Aplicar filtros √† lista de tipos de designa√ß√£o e suas inst√¢ncias">
                            <i class="fas fa-filter stats-btn-icon"></i> Aplicar Filtros
                        </button>
                    </div>
                </div>
                <div class="stats-results-container">
                    <p>Total de elementos encontrados: <span id="gs-designacoes-elementos-count">0</span></p>
                    <div class="loading-spinner" id="gs-designacoes-tipos-loading" style="display:none;"></div>
                    <ul id="gs-designacoes-tipos-list" class="stats-result-list">
                    </ul>
                </div>
            </div>

            <!-- Conte√∫do da Aba: Discursos -->
         <div id="gs-discursos-content" class="global-stats-tab-content">
                <!-- Filtros Partilhados para todas as sub-abas de Discursos -->
                <div id="gs-discursos-filtros-container">
                    <!-- O JavaScript vai gerar os filtros aqui -->
                </div>

                <!-- Sub-Abas -->
                <div class="gs-old-submenu-tabs">
                    <button class="gs-old-submenu-button active" data-submenu-target="gs-discursos-sec-recentes">Feito recentemente</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-discursos-sec-lista">Lista Discursos</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-discursos-sec-oradores">Oradores</button>
                    <button class="gs-old-submenu-button" data-submenu-target="gs-discursos-sec-nao-feitos">Menos Feitos</button>
                </div>

                <!-- Sec√ß√£o "Feito recentemente" -->
                <div class="stats-card-section active-submenu-section" id="gs-discursos-sec-recentes">
                    <h4><i class="fas fa-history stats-icon"></i> √öltimos 20 Discursos Realizados</h4>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-discursos-recentes-loading" style="display:none;"></div>
                        <ul id="gs-discursos-recentes-list" class="stats-result-list"></ul>
                    </div>
                </div>

                <!-- Sec√ß√£o "Lista Discursos" -->
                <div class="stats-card-section" id="gs-discursos-sec-lista">
                    <h4><i class="fas fa-list-ol stats-icon"></i> Lista de Discursos Realizados</h4>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-discursos-lista-loading" style="display:none;"></div>
                        <ul id="gs-discursos-lista-list" class="stats-result-list"></ul>
                    </div>
                </div>

                <!-- Sec√ß√£o "Oradores" -->
                <div class="stats-card-section" id="gs-discursos-sec-oradores">
                    <h4><i class="fas fa-users stats-icon"></i> Ranking de Oradores</h4>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-discursos-oradores-loading" style="display:none;"></div>
                        <ul id="gs-discursos-oradores-list" class="stats-result-list"></ul>
                    </div>
                </div>

                <!-- Sec√ß√£o "Menos Feitos" -->
                <div class="stats-card-section" id="gs-discursos-sec-nao-feitos">
                    <h4><i class="fas fa-search-minus stats-icon"></i> Discursos Ainda N√£o Realizados (no per√≠odo)</h4>
                    <div class="stats-results-container">
                        <div class="loading-spinner" id="gs-discursos-nao-feitos-loading" style="display:none;"></div>
                        <ul id="gs-discursos-nao-feitos-list" class="stats-result-list"></ul>
                    </div>
                </div>
            </div>



    <!-- Modal para exibir inst√¢ncias de uma designa√ß√£o (elemento) -->
    <div id="modal-instancias-designacao" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <span class="close-button" data-modal-id="modal-instancias-designacao">√ó</span>
            <h3 id="modal-instancias-titulo">Inst√¢ncias de Designa√ß√£o</h3>
            <div class="stats-results-container" style="border-top: none; margin-top: 0;">
                 <ul id="modal-instancias-list" class="stats-result-list" style="max-height: 50vh;"></ul>
            </div>
        </div>
    </div>

    <!-- MODAL DE RANKING DA REUNI√ÉO -->
    <div id="modal-ranking" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-button" data-modal-id="modal-ranking">√ó</span>
            <h3><i class="fas fa-list-ol"></i> Ranking da Reuni√£o/Semana</h3>

            <div class="filters-container stats-filters" id="ranking-filters-container">
                <label for="ranking-filtro-mes">M√™s:</label>
                <select id="ranking-filtro-mes"></select>
                <label for="ranking-filtro-ano">Ano:</label>
                <select id="ranking-filtro-ano"></select>
                <label for="ranking-filtro-semana">Semana (ISO):</label>
                <select id="ranking-filtro-semana"></select>
                <button id="btn-ranking-aplicar-filtros" class="stats-apply-button">
                    <i class="fas fa-sync-alt stats-btn-icon"></i> Ver Ranking
                </button>
            </div>

            <div class="ranking-list-container">
                <p><small>Use os bot√µes <i class="fas fa-arrow-up"></i>/<i class="fas fa-arrow-down"></i> para reordenar os itens apenas para esta visualiza√ß√£o.</small></p>
                <ul id="lista-ranking-designacoes">
                </ul>
            </div>
        </div>
    </div>

    <!-- MODAL PARA LISTAR INST√ÇNCIAS DE UM DISCURSO -->
    <div id="modal-discurso-instancias" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <span class="close-button" data-modal-id="modal-discurso-instancias">√ó</span>
            <h3 id="modal-discurso-instancias-titulo">Ocorr√™ncias do Discurso</h3>
            <div class="stats-results-container" style="border-top: none; margin-top: 0;">
                 <ul id="modal-discurso-instancias-list" class="stats-result-list" style="max-height: 60vh;"></ul>
            </div>
        </div>
    </div>

    <!-- MODAL PARA LISTAR DISCURSOS DE UM ORADOR -->
    <div id="modal-orador-discursos" class="modal">
        <div class="modal-content" style="max-width: 750px;">
            <span class="close-button" data-modal-id="modal-orador-discursos">√ó</span>
            <h3 id="modal-orador-discursos-titulo">Discursos Realizados</h3>
            <div class="stats-results-container" style="border-top: none; margin-top: 0;">
                 <ul id="modal-orador-discursos-list" class="stats-result-list" style="max-height: 60vh;"></ul>
            </div>
        </div>
    </div>


    <!-- Modal para expandir Gr√°fico -->
    <div id="modal-grafico-expandido" class="modal">
        <div class="modal-content" style="max-width: 90%; width: 800px;">
            <span class="close-button" data-modal-id="modal-grafico-expandido">√ó</span>
            <h3 id="modal-grafico-titulo">Gr√°fico Expandido</h3>
            <div class="stats-chart-container" style="height: 60vh;">
                <canvas id="canvas-grafico-expandido"></canvas>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase SDK imports
     import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import {
            getFirestore, collection, getDocs, addDoc, query, where, doc, getDoc,
            serverTimestamp, updateDoc, deleteDoc, FieldPath
        } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        // CUIDADO: Expor API Key no cliente n√£o √© o ideal para produ√ß√£o cr√≠tica.
        // Considere usar Firebase Functions para proteger suas credenciais ou configurar regras de seguran√ßa robustas.
        const firebaseConfig = {
            apiKey: "AIzaSyAk3dHqtGWtnPq_B09rRzUj6WC5hxdd9io", // Substitua pela sua API Key real
            authDomain: "theeye-c3ace.firebaseapp.com",
            projectId: "theeye-c3ace",
            storageBucket: "theeye-c3ace.firebasestorage.app",
            messagingSenderId: "742355525459",
            appId: "1:742355525459:web:fbe84a9594be4bedc28ba6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements (sele√ß√£o extensiva)
        const listaPessoasUl = document.getElementById('lista-pessoas');
        const searchPessoaInput = document.getElementById('search-pessoa-input');
        const colunaDetalhesDiv = document.getElementById('coluna-detalhes');
        const colunaDetalhesContent = document.getElementById('coluna-detalhes-content');
        const fabMain = document.getElementById('fab-main');
        const fabOptions = document.getElementById('fab-options');
        const btnCriarPessoaFab = document.getElementById('btn-criar-pessoa-fab');
        const btnCriarElementoFab = document.getElementById('btn-criar-elemento-fab');
        const btnCriarDesignacaoFab = document.getElementById('btn-criar-designacao-fab');
        const btnGerenciarPessoasFab = document.getElementById('btn-gerenciar-pessoas-fab');
        const modalPessoa = document.getElementById('modal-pessoa');
        const modalElemento = document.getElementById('modal-elemento');
        const modalDesignacao = document.getElementById('modal-designacao');
        const modalGerenciarPessoas = document.getElementById('modal-gerenciar-pessoas');
        const modalInstanciasDesignacao = document.getElementById('modal-instancias-designacao');
        const modalInstanciasTitulo = document.getElementById('modal-instancias-titulo');
        const modalInstanciasListUl = document.getElementById('modal-instancias-list');
        const listaGerenciarPessoasUl = document.getElementById('lista-gerenciar-pessoas');
        const modalPessoaTitulo = document.getElementById('modal-pessoa-titulo');
        const pessoaIdEditInput = document.getElementById('pessoa-id-edit');
        const btnSubmitPessoa = document.getElementById('btn-submit-pessoa');
        const modalDiscursoInstancias = document.getElementById('modal-discurso-instancias');
        const modalOradorDiscursos = document.getElementById('modal-orador-discursos');
        const closeButtons = document.querySelectorAll('.close-button');
        const formCriarPessoa = document.getElementById('form-criar-pessoa');
        const nomePessoaInput = document.getElementById('nome-pessoa');
        const idiomaPessoaSelect = document.getElementById('idioma-pessoa');
        const generoPessoaSelect = document.getElementById('genero-pessoa');
        const cargoPessoaSelect = document.getElementById('cargo-pessoa');
        const pregacaoPessoaSelect = document.getElementById('pregacao-pessoa');
        const formCriarElemento = document.getElementById('form-criar-elemento');
        const nomeElementoModalInput = document.getElementById('nome-elemento-modal');
        const tipoElementoSelect = document.getElementById('tipo-elemento');
        const generoElementoSelect = document.getElementById('genero-elemento');
        const formCriarDesignacao = document.getElementById('form-criar-designacao');
        const selectElementoDesignacao = document.getElementById('select-elemento-designacao');
        const selectPessoaA = document.getElementById('select-pessoaA');
        const selectPessoaB = document.getElementById('select-pessoaB');
        const selectPessoaC = document.getElementById('select-pessoaC');
        const dataDesignacaoInput = document.getElementById('data-designacao');
         const gsTopElementosCheckboxMultiselect = document.getElementById('gs-top-elementos-checkbox-multiselect');
        const gsTopElementosDisplayText = document.getElementById('gs-top-elementos-display-text');
        const gsTopElementosOptions = document.getElementById('gs-top-elementos-options');
        const gsTopElementosOptionsList = document.getElementById('gs-top-elementos-options-list');
        const gsTopPessoasElementoMultiHidden = document.getElementById('gs-top-pessoas-elemento-multi-hidden');
const gsIndivElementosCheckboxMultiselect = document.getElementById('gs-indiv-elementos-checkbox-multiselect');
        const gsIndivElementosDisplayText = document.getElementById('gs-indiv-elementos-display-text');
        const gsIndivElementosOptions = document.getElementById('gs-indiv-elementos-options');
        const gsIndivElementosOptionsList = document.getElementById('gs-indiv-elementos-options-list');
        const gsIndivElementoMultiHidden = document.getElementById('gs-indiv-elemento-multi-hidden');



        // --- MODAL EDITAR DESIGNA√á√ÉO ELEMENTOS ---
        const modalEditarDesignacao = document.getElementById('modal-editar-designacao');
        const formEditarDesignacao = document.getElementById('form-editar-designacao');
        const designacaoIdEditInput = document.getElementById('designacao-id-edit');
        const dataDesignacaoEditInput = document.getElementById('data-designacao-edit');
        const selectElementoDesignacaoEdit = document.getElementById('select-elemento-designacao-edit');
        const selectPessoaAEdit = document.getElementById('select-pessoaA-edit');
        const selectPessoaBEdit = document.getElementById('select-pessoaB-edit');
        const selectPessoaCEdit = document.getElementById('select-pessoaC-edit');
        const camposOradorPublicoEditDiv = document.getElementById('campos-orador-publico-edit');
        const temaOradorEditInput = document.getElementById('tema-orador-edit');
        const congregacaoOradorEditInput = document.getElementById('congregacao-orador-edit');

        // Elementos do Modal de Estat√≠sticas Globais
        const btnGlobalStats = document.getElementById('btn-global-stats');
        const modalGlobalStats = document.getElementById('modal-global-stats');
        const globalStatsTabButtons = document.querySelectorAll('.global-stats-tab-button');
        const globalStatsTabContents = document.querySelectorAll('.global-stats-tab-content');

        // Elementos da Aba "An√°lises Anteriores" (gs-old-content)
        const gsTopPessoasMesSelect = document.getElementById('gs-top-pessoas-mes');
        const gsTopPessoasAnoSelect = document.getElementById('gs-top-pessoas-ano');
        const gsTopPessoasElementoSelect = document.getElementById('gs-top-pessoas-elemento'); //NOVO
        const btnGsTopPessoasAplicar = document.getElementById('btn-gs-top-pessoas-aplicar');
        const gsTopPessoasGeneroParticipante = document.getElementById('gs-top-pessoas-genero-participante');
        const gsTopPessoasIdiomaParticipante = document.getElementById('gs-top-pessoas-idioma-participante');
        const gsTopPessoasListUl = document.getElementById('gs-top-pessoas-list');
        const gsTopPessoasMostrarTodosLink = document.getElementById('gs-top-pessoas-mostrar-todos');
        const gsTodasDesigMesSelect = document.getElementById('gs-todas-desig-mes');
        const gsTodasDesigAnoSelect = document.getElementById('gs-todas-desig-ano');
        const gsTodasDesigElementoSelect = document.getElementById('gs-todas-desig-elemento');
        const btnGsTodasDesigAplicar = document.getElementById('btn-gs-todas-desig-aplicar');
        const btnGsTodasDesigAgrupar = document.getElementById('btn-gs-todas-desig-agrupar');
        const gsTodasDesigListUl = document.getElementById('gs-todas-desig-list');
        const gsTodasDesigAgrupadoContainerDiv = document.getElementById('gs-todas-desig-agrupado-container');
        const gsTodasDesigAgrupadoListUl = document.getElementById('gs-todas-desig-agrupado-list');
        const gsTodasDesigAgrupadoMostrarTodosLink = document.getElementById('gs-todas-desig-agrupado-mostrar-todos');
        const gsPessoaEspSelect = document.getElementById('gs-pessoa-esp-select');
        const gsPessoaEspElementoFiltroSelect = document.getElementById('gs-pessoa-esp-elemento-filtro');
        const gsPessoaEspAnoFiltroSelect = document.getElementById('gs-pessoa-esp-ano-filtro');
        const gsPessoaEspMesFiltroSelect = document.getElementById('gs-pessoa-esp-mes-filtro');
        const btnGsPessoaEspAplicar = document.getElementById('btn-gs-pessoa-esp-aplicar');
        const gsPessoaEspResultsDiv = document.getElementById('gs-pessoa-esp-results');

        // Elementos da Aba "Total" (gs-total-content)
        const gsTotalNumDesignacoesSpan = document.getElementById('gs-total-num-designacoes');
        const gsTotalNumDesigMascSpan = document.getElementById('gs-total-num-desig-masc');
        const gsTotalNumDesigFemSpan = document.getElementById('gs-total-num-desig-fem');
        const gsTotalNumDesigPtSpan = document.getElementById('gs-total-num-desig-pt');
        const gsTotalNumDesigItSpan = document.getElementById('gs-total-num-desig-it');
        const gsTotalNumDesigOutroIdiomaSpan = document.getElementById('gs-total-num-desig-outro-idioma');
        const gsTotalFiltroAnoSelect = document.getElementById('gs-total-filtro-ano');
        const gsTotalFiltroMesSelect = document.getElementById('gs-total-filtro-mes');
        const btnGsTotalAplicarFiltros = document.getElementById('btn-gs-total-aplicar-filtros');
        const gsTotalFiltroElementoTipoSelect = document.getElementById('gs-total-filtro-elemento-tipo');
        const gsTotalMediaDesignacoesSpan = document.getElementById('gs-total-media-designacoes');
        const gsTotalMediaDesigMascSpan = document.getElementById('gs-total-media-desig-masc');
        const gsTotalMediaDesigFemSpan = document.getElementById('gs-total-media-desig-fem');
        const gsTotalMediaDesigPtSpan = document.getElementById('gs-total-media-desig-pt');
        const gsTotalMediaDesigItSpan = document.getElementById('gs-total-media-desig-it');
        const gsTotalMediaDesigOutroSpan = document.getElementById('gs-total-media-desig-outro');

        // Elementos da Aba "Pessoas" (gs-pessoas-content)
        const gsPessoasSelectMulti = document.getElementById('gs-pessoas-select-multi'); // Original hidden select
        const gsPessoasFiltroAnoSelect = document.getElementById('gs-pessoas-filtro-ano');
        const gsPessoasFiltroMesSelect = document.getElementById('gs-pessoas-filtro-mes');
        const gsPessoasFiltroSemanaInput = document.getElementById('gs-pessoas-filtro-semana');
        const gsPessoasFiltroGeneroSelect = document.getElementById('gs-pessoas-filtro-genero');
        const gsPessoasFiltroIdiomaSelect = document.getElementById('gs-pessoas-filtro-idioma');
        const btnGsPessoasComparar = document.getElementById('btn-gs-pessoas-comparar');
        const gsPessoasLoading = document.getElementById('gs-pessoas-loading');
        const gsPessoasComparisonAreaDiv = document.getElementById('gs-pessoas-comparison-area');
        const gsPessoasCustomMultiselectDiv = document.getElementById('gs-pessoas-custom-multiselect');
        const gsPessoasSearchInputCustom = document.getElementById('gs-pessoas-search-input-custom');
        const gsPessoasDropdownCustomDiv = document.getElementById('gs-pessoas-dropdown-custom');
const gsSelectedPessoasAreaDiv = document.querySelector('#gs-pessoas-custom-multiselect .selected-items-area');

        // Elementos da Aba "Designa√ß√µes" (gs-designacoes-content)
        const gsDesignacoesFiltroDiaInput = document.getElementById('gs-designacoes-filtro-dia');
        const gsDesignacoesFiltroMesSelect = document.getElementById('gs-designacoes-filtro-mes');
        const gsDesignacoesFiltroAnoSelect = document.getElementById('gs-designacoes-filtro-ano');
        const gsDesignacoesFiltroSemanaInput = document.getElementById('gs-designacoes-filtro-semana');
        const gsDesignacoesFiltroGeneroSelect = document.getElementById('gs-designacoes-filtro-genero');
        const gsDesignacoesFiltroIdiomaSelect = document.getElementById('gs-designacoes-filtro-idioma');
        const btnGsDesignacoesAplicarFiltros = document.getElementById('btn-gs-designacoes-aplicar-filtros');
        const gsDesignacoesTiposLoading = document.getElementById('gs-designacoes-tipos-loading');
        const gsDesignacoesTiposListUl = document.getElementById('gs-designacoes-tipos-list');
        const gsDesignacoesElementosCountSpan = document.getElementById('gs-designacoes-elementos-count');

        // --- ELEMENTOS DOM PARA O MODAL DE RANKING ---
        const btnRankingPopup = document.getElementById('btn-ranking-popup');
        const modalRanking = document.getElementById('modal-ranking');
        const rankingFiltroMesSelect = document.getElementById('ranking-filtro-mes');
        const rankingFiltroAnoSelect = document.getElementById('ranking-filtro-ano');
        const rankingFiltroSemanaSelect = document.getElementById('ranking-filtro-semana');
        const btnRankingAplicarFiltros = document.getElementById('btn-ranking-aplicar-filtros');
        const listaRankingDesignacoesUl = document.getElementById('lista-ranking-designacoes');

        // --- L√ìGICA PARA CONTROLAR A BARRA LATERAL M√ìVEL ---
        const sidebarToggleButton = document.getElementById('sidebar-toggle-button');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const colunaPessoas = document.getElementById('coluna-pessoas'); // J√° deve estar declarado, mas garantimos

        if (sidebarToggleButton && sidebarOverlay && colunaPessoas) {
            // Abre/Fecha o menu ao clicar no bot√£o hamburger
            sidebarToggleButton.addEventListener('click', () => {
                document.body.classList.toggle('sidebar-visible');
            });

            // Fecha o menu ao clicar no overlay (fundo escuro)
            sidebarOverlay.addEventListener('click', () => {
                document.body.classList.remove('sidebar-visible');
            });
        }

        // Globais
        let todasPessoas = [];
        let todosElementos = [];
        let pessoaSelecionadaAtual = null;
        let designacoesDaPessoaAtual = [];
        let designacoesFiltradas = [];

        // Charts para a coluna de detalhes da pessoa
        let designacoesChart = null;
        let designacoesPorMesChart = null;
        let designacoesPorSemanaChart = null;
        let designacoesPorAnoChart = null;
        let dirigentePorDiaChart = null;
        let chartDiscursosPorAno = null;
        let chartTemasPorMes = null;
        let todosDiscursos = [];

        let todasDesignacoesGlobais = [];
        let todasDesignacoesGlobaisCarregadas = false;

        // Para estat√≠sticas globais - aba "An√°lises Anteriores"
        let topPessoasDadosCompletos = [];
        let topElementosAgrupadosDadosCompletos = [];
        let gsTopPessoasMostrandoApenasTop5 = true;
        let gsTopElementosAgrupadosMostrandoApenasTop5 = true;


        // Chart instances for Global Stats "Total" Tab
        let gsTotalChartDesignacoesMes = null;
        let gsTotalChartDesignacoesGeneroMes = null;
        let gsTotalChartDesignacoesIdiomaMes = null;

        // Estado para "Mostrar mais/menos" nas estat√≠sticas da pessoa
        let mostrandoTodosElementosPessoa = false;
        let mostrandoTodosParceirosPessoa = false;
        let mostrandoTodosLocais = false;

        // Estado para o modo de edi√ß√£o e designa√ß√£o atual para edi√ß√£o
        let editModeActive = false;
        let designacaoAtualParaEdicao = null;

        // Helper para custom multiselect
        let availablePessoasForCustomSelect = [];
        let graficoExpandidoChart = null;

        // --- ESTADO PARA O RANKING ---
        let ordemAtualElementosRanking = [];
        const ORDEM_PADRAO_ELEMENTOS_RANKING = [
            "Presidente Semana", "Ora√ß√£o Inicial Semana", "Tesouros", "P√©rolas",
            "---SEP---", // Separador visual
            "Leitura da B√≠blia", "Iniciar Conversas", "Cultivar o Interesse", "Fazer Disc√≠pulos", "Explicar Cren√ßas", "Discurso", // "Discurso" gen√©rico aqui
            "---SEP---",
            "Viver como Crist√£os", "Estudo B√≠blico", "Leitor do Estudo B√≠blico", "Ora√ß√£o Final Semana",
            "---SEP---",
            "Presidente Fim de Semana", "Ora√ß√£o Inicial Fim de Semana", "Orador P√∫blico",
            "---PARAGRAPH_SEP---", // Separador de par√°grafo (apenas espa√ßo)
            "Dirigente Sentinela", "Leitor da Sentinela", "Ora√ß√£o Final Fim de Semana",
            "---SEP---",
            "√Åudio/V√≠deo", "Zoom", "Micro Palco", "Micro 2", "Indicador"
        ];










  function abrirModalDiscursoInstancias(tema, discursosFiltrados) {
    const modal = document.getElementById('modal-discurso-instancias');
    const titulo = document.getElementById('modal-discurso-instancias-titulo');
    const listUl = document.getElementById('modal-discurso-instancias-list');
    titulo.textContent = `Ocorr√™ncias de: ${tema}`;
    const instancias = discursosFiltrados.filter(d => d.tema && d.tema.trim() === tema);
    listUl.innerHTML = '';
    instancias.forEach(d => {
        const li = document.createElement('li');
        li.textContent = `(${d.data}) por ${d.pessoaA} (${d.congregacao || 'N/A'})`;
        listUl.appendChild(li);
    });
    abrirModal(modal);
}

function abrirModalOradorDiscursos(orador, discursosFiltrados) {
    const modal = document.getElementById('modal-orador-discursos');
    const titulo = document.getElementById('modal-orador-discursos-titulo');
    const listUl = document.getElementById('modal-orador-discursos-list');
    titulo.textContent = `Discursos de: ${orador}`;
    const instancias = discursosFiltrados.filter(d => d.pessoaA === orador);
    listUl.innerHTML = '';
    instancias.forEach(d => {
        const li = document.createElement('li');
        const discursoInfo = todosDiscursos.find(discurso => d.tema && discurso.nome.trim() === d.tema.trim());
        const numeroDisplay = discursoInfo ? `<strong>${discursoInfo.numero}</strong> - ` : '';
        li.innerHTML = `(${d.data}) ${numeroDisplay}${d.tema}`;
        listUl.appendChild(li);
    });
    abrirModal(modal);
}




function generateDiscursosFiltersHTML() {
    return `
        <div class="filters-container stats-filters" style="display: flex; flex-direction: column; align-items: stretch; gap: 12px;">
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                    <label for="gs-discursos-filtro-ano">Ano:</label>
                    <select id="gs-discursos-filtro-ano"><option value="">Todos</option></select>
                </div>
                <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                    <label for="gs-discursos-filtro-mes">M√™s:</label>
                    <select id="gs-discursos-filtro-mes"><option value="">Todos</option></select>
                </div>
                <div style="flex: 1; min-width: 150px; display: flex; flex-direction: column; gap: 5px;">
                    <label for="gs-discursos-filtro-idioma">Idioma (Orador):</label>
                    <select id="gs-discursos-filtro-idioma"><option value="">Todos</option><option value="Portugu√™s">Portugu√™s</option><option value="Italiano">Italiano</option><option value="Outro">Outro</option></select>
                </div>
                <div style="flex: 2; min-width: 180px; display: flex; flex-direction: column; gap: 5px;">
                    <label for="gs-discursos-filtro-congregacao">Congrega√ß√£o:</label>
                    <select id="gs-discursos-filtro-congregacao"><option value="">Todas</option></select>
                </div>
                <div style="flex: 1; min-width: 120px; display: flex; flex-direction: column; gap: 5px;">
                    <label for="gs-discursos-filtro-numero">N¬∫ Discurso:</label>
                    <select id="gs-discursos-filtro-numero"><option value="">Todos</option></select>
                </div>
                <div style="align-self: flex-end;">
                    <button id="btn-gs-discursos-aplicar" class="stats-apply-button">
                        <i class="fas fa-filter stats-btn-icon"></i> Aplicar
                    </button>
                </div>
            </div>
        </div>
    `;
}

function setupGsDiscursosSubmenu() {
    const discursosContentDiv = document.getElementById('gs-discursos-content');
    if (!discursosContentDiv) return;

    const submenuButtons = discursosContentDiv.querySelectorAll('.gs-old-submenu-button');
    submenuButtons.forEach(btn => {
        if (btn.dataset.listenerAttached === 'true') {
            return;
        }
        btn.addEventListener('click', () => {
            submenuButtons.forEach(b => b.classList.remove('active'));
            discursosContentDiv.querySelectorAll('.stats-card-section').forEach(sec => sec.classList.remove('active-submenu-section'));

            btn.classList.add('active');
            const targetSection = document.getElementById(btn.dataset.submenuTarget);
            if (targetSection) {
                targetSection.classList.add('active-submenu-section');
            }

            switch (btn.dataset.submenuTarget) {
                case 'gs-discursos-sec-recentes': renderDiscursosRecentes(); break;
                case 'gs-discursos-sec-lista': renderListaDiscursos(); break;
                case 'gs-discursos-sec-oradores': renderOradores(); break;
                case 'gs-discursos-sec-nao-feitos': renderDiscursosNaoFeitos(); break;
            }
        });
        btn.dataset.listenerAttached = 'true';
    });
}

function populateDiscursosFilters() {
    const anoSelect = document.getElementById(`gs-discursos-filtro-ano`);
    const mesSelect = document.getElementById(`gs-discursos-filtro-mes`);
    const congregacaoSelect = document.getElementById(`gs-discursos-filtro-congregacao`);
    const numeroSelect = document.getElementById(`gs-discursos-filtro-numero`);

    if (!anoSelect || !mesSelect || !congregacaoSelect || !numeroSelect) return;

    const discursosPublicos = todasDesignacoesGlobais.filter(d => d.nome === "Orador P√∫blico");
    const anosUnicos = [...new Set(discursosPublicos.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));
    const mesesUnicos = [...new Set(discursosPublicos.map(d => d.mes).filter(Boolean))].sort((a,b) => parseInt(a) - parseInt(b));
    const congregacoesUnicas = [...new Set(discursosPublicos.map(d => d.congregacao).filter(Boolean))].sort();

    anoSelect.innerHTML = '<option value="">Todos</option>' + anosUnicos.map(ano => `<option value="${ano}">${ano}</option>`).join('');
    mesSelect.innerHTML = '<option value="">Todos</option>' + mesesUnicos.map(mes => `<option value="${String(mes).padStart(2, '0')}">${new Date(0, mes-1).toLocaleString('pt-BR', {month: 'long'})}</option>`).join('');
    congregacaoSelect.innerHTML = '<option value="">Todas</option>' + congregacoesUnicas.map(c => `<option value="${c}">${c}</option>`).join('');
    numeroSelect.innerHTML = '<option value="">Todos</option>' + todosDiscursos.sort((a,b) => a.numero - b.numero).map(d => `<option value="${d.numero}">${d.numero}</option>`).join('');
}

function getFilteredDiscursos() {
    const anoFiltro = document.getElementById(`gs-discursos-filtro-ano`).value;
    const mesFiltro = document.getElementById(`gs-discursos-filtro-mes`).value;
    const idiomaFiltro = document.getElementById(`gs-discursos-filtro-idioma`).value;
    const congregacaoFiltro = document.getElementById(`gs-discursos-filtro-congregacao`).value;
    const numeroFiltro = document.getElementById(`gs-discursos-filtro-numero`).value;
    
    let temaDoNumeroFiltrado = null;
    if (numeroFiltro && todosDiscursos.length > 0) {
        const discurso = todosDiscursos.find(d => d.numero == numeroFiltro);
        if (discurso) temaDoNumeroFiltrado = discurso.nome;
    }

    return todasDesignacoesGlobais.filter(d => {
        if (d.nome !== "Orador P√∫blico") return false;
        const matchAno = !anoFiltro || d.ano === anoFiltro;
        const matchMes = !mesFiltro || String(d.mes).padStart(2, '0') === mesFiltro;
        const matchCongregacao = !congregacaoFiltro || d.congregacao === congregacaoFiltro;
        const matchNumero = !temaDoNumeroFiltrado || (d.tema && d.tema.trim() === temaDoNumeroFiltrado.trim());

        if (!matchAno || !matchMes || !matchCongregacao || !matchNumero) return false;

        if (idiomaFiltro) {
            const orador = todasPessoas.find(p => p.nome === d.pessoaA);
            return orador && orador.idioma === idiomaFiltro;
        }
        return true;
    });
}

function renderDiscursosRecentes() {
    const prefix = 'gs-discursos-recentes';
    setSectionLoadingState(prefix, true);
    const listUl = document.getElementById(`${prefix}-list`);
    const discursosFiltrados = getFilteredDiscursos();
    discursosFiltrados.sort((a, b) => new Date(b.ano, b.mes - 1, b.dia) - new Date(a.ano, a.mes - 1, a.dia));
    const ultimos20 = discursosFiltrados.slice(0, 20);
    listUl.innerHTML = '';
    if (ultimos20.length === 0) {
        setSectionLoadingState(prefix, false);
        return;
    }
    ultimos20.forEach(d => {
        const li = document.createElement('li');
        li.innerHTML = `(${d.data}) <strong>${d.tema || 'Tema n√£o registrado'}</strong> <span class="value">por ${d.pessoaA} (${d.congregacao || 'N/A'})</span>`;
        listUl.appendChild(li);
    });
    setSectionLoadingState(prefix, false);
}

function renderListaDiscursos() {
    const prefix = 'gs-discursos-lista';
    setSectionLoadingState(prefix, true);
    const listUl = document.getElementById(`${prefix}-list`);
    const discursosFiltrados = getFilteredDiscursos();
    const contagemTemas = discursosFiltrados.reduce((acc, d) => {
        if (d.tema) acc[d.tema.trim()] = (acc[d.tema.trim()] || 0) + 1;
        return acc;
    }, {});
    const temasCompletos = Object.entries(contagemTemas).map(([tema, count]) => {
        const discursoInfo = todosDiscursos.find(d => d.nome.trim() === tema);
        return { tema, count, numero: discursoInfo ? discursoInfo.numero : Infinity };
    }).sort((a, b) => a.numero - b.numero);
    listUl.innerHTML = '';
    if (temasCompletos.length === 0) {
        setSectionLoadingState(prefix, false);
        return;
    }
    temasCompletos.forEach(item => {
        const li = document.createElement('li');
        li.className = 'clickable';
        const numeroDisplay = item.numero === Infinity ? '?' : item.numero;
        li.innerHTML = `<strong>${numeroDisplay}</strong> - ${item.tema} <span class="count">${item.count}</span>`;
        li.onclick = () => abrirModalDiscursoInstancias(item.tema, discursosFiltrados);
        listUl.appendChild(li);
    });
    setSectionLoadingState(prefix, false);
}

function renderOradores() {
    const prefix = 'gs-discursos-oradores';
    setSectionLoadingState(prefix, true);
    const listUl = document.getElementById(`${prefix}-list`);
    const discursosFiltrados = getFilteredDiscursos();
    const contagemOradores = discursosFiltrados.reduce((acc, d) => {
        if (d.pessoaA) acc[d.pessoaA] = (acc[d.pessoaA] || 0) + 1;
        return acc;
    }, {});
    const oradoresOrdenados = Object.entries(contagemOradores).sort((a,b) => b[1] - a[1]);
    listUl.innerHTML = '';
    if (oradoresOrdenados.length === 0) {
        setSectionLoadingState(prefix, false);
        return;
    }
    oradoresOrdenados.forEach(([orador, count]) => {
        const li = document.createElement('li');
        li.className = 'clickable';
        li.innerHTML = `${orador} <span class="count">${count}</span>`;
        li.onclick = () => abrirModalOradorDiscursos(orador, discursosFiltrados);
        listUl.appendChild(li);
    });
    setSectionLoadingState(prefix, false);
}

function renderDiscursosNaoFeitos() {
    const prefix = 'gs-discursos-nao-feitos';
    setSectionLoadingState(prefix, true);
    const listUl = document.getElementById(`${prefix}-list`);
    const discursosFiltrados = getFilteredDiscursos();
    const temasFeitos = new Set(discursosFiltrados.map(d => d.tema.trim()));
    const discursosNaoFeitos = todosDiscursos
        .filter(d => !temasFeitos.has(d.nome.trim()))
        .sort((a, b) => a.numero - b.numero);
    listUl.innerHTML = '';
    if (discursosNaoFeitos.length === 0) {
        listUl.innerHTML = '<li>Todos os discursos da lista foram feitos no per√≠odo filtrado.</li>';
        setSectionLoadingState(prefix, false);
        return;
    }
    discursosNaoFeitos.forEach(d => {
        const li = document.createElement('li');
        li.innerHTML = `<strong>${d.numero}</strong> - ${d.nome}`;
        listUl.appendChild(li);
    });
    setSectionLoadingState(prefix, false);
}

// --- C√ìDIGO PRINCIPAL QUE ATIVA AS ABAS ---
globalStatsTabButtons.forEach(button => {
    button.addEventListener('click', () => {
        globalStatsTabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const targetContentId = button.dataset.tabTarget;
        globalStatsTabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === targetContentId) {
                content.classList.add('active');
            }
        });

        if (targetContentId === 'gs-total-content') {
            atualizarAbaTotalGlobalStats();
        } else if (targetContentId === 'gs-pessoas-content') {
            initGsPessoasCustomMultiselect();
            setupGsPessoasSubmenu();
        } else if (targetContentId === 'gs-designacoes-content') {
            popularListaElementosAbaDesignacoes();
        } else if (targetContentId === 'gs-old-content') {
            setupGsOldSubmenu();
        } else if (targetContentId === 'gs-discursos-content') {
            const discursosContentDiv = document.getElementById('gs-discursos-content');
            const filtrosContainer = document.getElementById('gs-discursos-filtros-container');
            
            if (!filtrosContainer.querySelector('.filters-container')) {
                filtrosContainer.innerHTML = generateDiscursosFiltersHTML(); 
                populateDiscursosFilters();
                
                document.getElementById('btn-gs-discursos-aplicar').addEventListener('click', () => {
                    const activeSubmenu = discursosContentDiv.querySelector('.gs-old-submenu-button.active');
                    if (activeSubmenu) {
                        activeSubmenu.click();
                    }
                });
            }
            
            setupGsDiscursosSubmenu();

            const activeSubmenu = discursosContentDiv.querySelector('.gs-old-submenu-button.active');
            const firstSubmenuButton = discursosContentDiv.querySelector('.gs-old-submenu-button');

            if (activeSubmenu) {
                activeSubmenu.click();
            } else if (firstSubmenuButton) {
                firstSubmenuButton.click();
            }
        }
    });
});














































        // --- FUN√á√ÉO HELPER PARA LOADING ---
        function setSectionLoadingState(sectionIdPrefix, isLoading, specificButtonId = null) {
            const loadingSpinner = document.getElementById(`${sectionIdPrefix}-loading`);
            let applyButton = specificButtonId ? document.getElementById(specificButtonId) : null;

            if (!applyButton && sectionIdPrefix) {
                const sectionElement = document.getElementById(`${sectionIdPrefix}-list`)?.closest('.stats-card-section, .global-stats-tab-content') ||
                                     document.getElementById(`${sectionIdPrefix}-results`)?.closest('.stats-card-section, .global-stats-tab-content') ||
                                     document.getElementById(sectionIdPrefix)?.closest('.stats-card-section, .global-stats-tab-content');
                if (sectionElement) {
                    applyButton = sectionElement.querySelector('.stats-apply-button');
                }
            }
            // Also handle ranking filter specific loading spinner
            const rankingFiltersContainer = document.getElementById('ranking-filters-container');
            if (sectionIdPrefix === 'ranking-filtros' && rankingFiltersContainer) { // Custom handling for ranking modal
                rankingFiltersContainer.style.opacity = isLoading ? "0.5" : "1";
                rankingFiltersContainer.querySelectorAll('select, button').forEach(el => el.disabled = isLoading);
            }


            const resultList = document.getElementById(`${sectionIdPrefix}-list`) || document.getElementById(`${sectionIdPrefix}-tipos-list`);
            const resultText = document.getElementById(`${sectionIdPrefix}-results`);
            const resultArea = document.getElementById(`${sectionIdPrefix}-comparison-area`);
            const agrupadoContainer = document.getElementById(`gs-todas-desig-agrupado-container`);

            if (loadingSpinner) loadingSpinner.style.display = isLoading ? 'block' : 'none';

            const sectionToDisableButtons = (resultList || resultText || resultArea || loadingSpinner)?.closest('.stats-card-section, .global-stats-tab-content');
            if (sectionToDisableButtons) {
                sectionToDisableButtons.querySelectorAll('.stats-apply-button, .stats-filters select, .stats-filters input').forEach(interactiveEl => {
                    interactiveEl.disabled = isLoading;
                });
            } else if (applyButton) {
                 applyButton.disabled = isLoading;
            }

            if (isLoading) {
                if (resultList) resultList.innerHTML = '';
                if (resultText) resultText.innerHTML = '';
                if (resultArea) resultArea.innerHTML = '';
                if (agrupadoContainer && sectionIdPrefix === 'gs-todas-desig') {
                    agrupadoContainer.style.display = 'none';
                    const agrupadoList = document.getElementById('gs-todas-desig-agrupado-list');
                    if (agrupadoList) agrupadoList.innerHTML = '';
                }
                const mostrarTodosLink = document.getElementById(`${sectionIdPrefix}-mostrar-todos`) ||
                                         (sectionIdPrefix === 'gs-todas-desig' ? document.getElementById(`gs-todas-desig-agrupado-mostrar-todos`) : null);
                if(mostrarTodosLink) mostrarTodosLink.style.display = 'none';
            }
        }

        // --- FUN√á√ÉO HELPER: CALCULAR N√öMERO DA SEMANA (ISO 8601) ---
        function getISOWeek(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                console.warn("getISOWeek recebeu data inv√°lida:", date);
                return null;
            }
            const dt = new Date(date.valueOf());
            dt.setDate(dt.getDate() + 4 - (dt.getDay() || 7)); // Ajusta para quinta-feira da semana
            const yearStart = new Date(dt.getFullYear(), 0, 1);
            // Calcula o n√∫mero da semana
            const weekNumber = Math.ceil((((dt - yearStart) / 86400000) + 1) / 7);
            return weekNumber;
        }

        // --- Barra de Pesquisa Pessoas ---
        if (searchPessoaInput) {
            searchPessoaInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const pessoasLi = listaPessoasUl.getElementsByTagName('li');
                Array.from(pessoasLi).forEach(li => {
                    const nomePessoa = li.textContent.toLowerCase();
                    li.classList.toggle('hidden-by-search', !nomePessoa.includes(searchTerm));
                });
            });
        } else { console.warn("Elemento searchPessoaInput n√£o encontrado."); }

        async function carregarTodosElementosParaEstatisticas() {
            console.log("carregarTodosElementosParaEstatisticas: Iniciando");
            try {
                const querySnapshot = await getDocs(collection(db, "elementos"));
                todosElementos = [];
                querySnapshot.forEach((docSnap) => todosElementos.push({ id: docSnap.id, ...docSnap.data() }));
                todosElementos.sort((a, b) => (a.designacao || a.nome || '').localeCompare(b.designacao || b.nome || '', 'pt-BR', { sensitivity: 'base' }));
                console.log(`carregarTodosElementosParaEstatisticas: ${todosElementos.length} elementos carregados.`);

                if (selectElementoDesignacao) {
                    selectElementoDesignacao.innerHTML = '<option value="">-- Selecione um Elemento --</option>';
                    todosElementos.forEach(el => {
                        const option = document.createElement('option');
                        option.value = el.designacao || el.nome;
                        option.textContent = el.designacao || el.nome;
                        selectElementoDesignacao.appendChild(option);
                    });
                }

                if (todasDesignacoesGlobaisCarregadas) {
                    popularFiltrosStatsGlobais();
                }
                if (gsDesignacoesTiposListUl) popularListaElementosAbaDesignacoes();

            } catch (error) {
                console.error("Erro ao carregar elementos: ", error);
                alert("Falha ao carregar elementos.");
            }
        }

        function popularDropdownsPessoasNosModais() {
            console.log("popularDropdownsPessoasNosModais: Iniciando");
            const pessoasVisiveis = todasPessoas.filter(p => p.estaVisivel !== false);
            const optionsHtml = pessoasVisiveis.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');

            if (selectPessoaA) selectPessoaA.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            if (selectPessoaB) selectPessoaB.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            if (selectPessoaC) selectPessoaC.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;

            if (gsPessoaEspSelect) {
                 const currentVal = gsPessoaEspSelect.value;
                gsPessoaEspSelect.innerHTML = '<option value="">-- Selecione --</option>' + todasPessoas.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                if (Array.from(gsPessoaEspSelect.options).some(opt => opt.value === currentVal)) gsPessoaEspSelect.value = currentVal; else gsPessoaEspSelect.value = "";
            }
            if (gsPessoasSelectMulti) { // Populates the hidden original select for the custom component
                const currentSelectedIds = Array.from(gsPessoasSelectMulti.selectedOptions).map(opt => opt.value);
                gsPessoasSelectMulti.innerHTML = todasPessoas
                    .filter(p => p.estaVisivel !== false)
                    .map(p => `<option value="${p.id}">${p.nome}</option>`)
                    .join('');
                currentSelectedIds.forEach(id => {
                     const opt = Array.from(gsPessoasSelectMulti.options).find(o => o.value === id);
                     if (opt) opt.selected = true;
                });
            }


            const selectOutraPessoaDetalhes = document.getElementById('select-outra-pessoa');
            if (selectOutraPessoaDetalhes && pessoaSelecionadaAtual) {
                 const pessoasDisponiveisParaConjunta = todasPessoas
                    .filter(p => p.id !== pessoaSelecionadaAtual.id && p.estaVisivel !== false)
                    .map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                selectOutraPessoaDetalhes.innerHTML = `<option value="">-- Selecione Pessoa --</option>${pessoasDisponiveisParaConjunta}`;
            }
            console.log("popularDropdownsPessoasNosModais: Dropdowns populados.");
        }







        
        async function carregarPessoas() {
            console.log("carregarPessoas: Iniciando");
            try {
                const querySnapshot = await getDocs(collection(db, "pessoas"));
                todasPessoas = [];
                querySnapshot.forEach((docSnap) => todasPessoas.push({ id: docSnap.id, ...docSnap.data() }));
                todasPessoas.sort((a, b) => a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity: 'base' }));

                if (listaPessoasUl) listaPessoasUl.innerHTML = '';
                else { console.error("ERRO CR√çTICO: listaPessoasUl n√£o encontrado em carregarPessoas."); return; }

                if (searchPessoaInput) searchPessoaInput.value = '';
                const pessoasVisiveis = todasPessoas.filter(p => p.estaVisivel !== false);
                console.log(`carregarPessoas: Encontradas ${todasPessoas.length} pessoas, ${pessoasVisiveis.length} vis√≠veis.`);

                pessoasVisiveis.forEach(pessoa => {
                    const li = document.createElement('li');
                    li.textContent = pessoa.nome;
                    li.dataset.pessoaId = pessoa.id;
                    li.addEventListener('click', () => {
                        console.log("Pessoa da lista clicada:", pessoa.nome, pessoa.id);
                        document.querySelectorAll('#lista-pessoas li').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        pessoaSelecionadaAtual = pessoa;
                        // ...
                        mostrandoTodosParceirosPessoa = false;
                        editModeActive = false;
                        carregarDesignacoesDaPessoa(pessoa.id);

                        // ADICIONE ESTA LINHA AQUI:
                        document.body.classList.remove('sidebar-visible'); // Fecha o menu ap√≥s a sele√ß√£o
                    });
                    listaPessoasUl.appendChild(li);
                });
                popularDropdownsPessoasNosModais();
                if (todasDesignacoesGlobaisCarregadas) {
                    popularFiltrosStatsGlobais();
                }
            } catch (error) { console.error("Erro ao carregar pessoas: ", error); alert("Falha ao carregar pessoas."); }
        }

 async function carregarDesignacoesDaPessoa(pessoaId) {
            console.log("carregarDesignacoesDaPessoa para ID:", pessoaId);
            pessoaSelecionadaAtual = todasPessoas.find(p => p.id === pessoaId);
            if (!pessoaSelecionadaAtual) {
                console.error("N√£o foi poss√≠vel encontrar a pessoa selecionada para carregar designa√ß√µes.");
                return;
            }
            const nomePessoa = pessoaSelecionadaAtual.nome;

            criarEstruturaDetalhes();
            const historicoContent = document.getElementById('historico-content');
            if (historicoContent) historicoContent.innerHTML = '<p style="text-align:center;color:#777;margin-top:20px;">Carregando designa√ß√µes...</p>';
            else { console.error("Elemento #historico-content n√£o encontrado."); return; }

            try {
                const q = query(collection(db, "designacoes"), where(new FieldPath('participantes', nomePessoa), "==", true));
                
                const querySnapshot = await getDocs(q);
                let designacoesBrutas = [];
                querySnapshot.forEach((docSnap) => {
                    designacoesBrutas.push({ id: docSnap.id, ...docSnap.data() });
                });

                // =========================================================
                //          ‚Üì‚Üì‚Üì FILTRO DE SEGURAN√áA ADICIONADO AQUI ‚Üì‚Üì‚Üì
                // =========================================================
                designacoesDaPessoaAtual = designacoesBrutas.filter(desig => {
                    const participantesVisiveis = [desig.pessoaA, desig.pessoaB, desig.pessoaC].filter(Boolean);
                    return participantesVisiveis.includes(nomePessoa);
                });
                // =========================================================

                // Processamento de 'semanaISO' agora √© feito nos dados j√° filtrados
                designacoesDaPessoaAtual.forEach(data => {
                    if (!data.semanaISO && data.data) {
                        try {
                            const [dia, mes, ano] = data.data.split('/');
                            const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                            if (!isNaN(dateObj.getTime())) {
                                 data.semanaISO = getISOWeek(dateObj);
                            }
                        } catch (e) {
                           // Ignora erros de parsing de data
                        }
                    }
                });

                console.log(`DADOS AP√ìS FILTRO CLIENT-SIDE para ${nomePessoa}:`, JSON.parse(JSON.stringify(designacoesDaPessoaAtual)));
                
                popularFiltros();
                aplicarEAtualizarFiltros();
            } catch (error) {
                console.error(`Erro ao carregar designa√ß√µes para ${nomePessoa}: `, error);
                if (historicoContent) historicoContent.innerHTML = `<p style="text-align:center;color:#777;margin-top:20px;">Erro ao carregar designa√ß√µes.</p>`;
            }
        }


        async function carregarListaDiscursos() {
            console.log("carregarListaDiscursos: Iniciando");
            try {
                const querySnapshot = await getDocs(collection(db, "listadiscursos"));
                todosDiscursos = [];
                querySnapshot.forEach((docSnap) => {
                    todosDiscursos.push({ id: docSnap.id, ...docSnap.data() });
                });
                console.log(`carregarListaDiscursos: ${todosDiscursos.length} discursos carregados.`);
            } catch (error) {
                console.error("Erro ao carregar lista de discursos: ", error);
            }
        }

    function criarEstruturaDetalhes() {
            if (!colunaDetalhesDiv || !colunaDetalhesContent) {
                console.error("ERRO CR√çTICO: colunaDetalhesDiv ou colunaDetalhesContent n√£o encontrado em criarEstruturaDetalhes.");
                return;
            }
            console.log("criarEstruturaDetalhes - Pessoa selecionada:", pessoaSelecionadaAtual?.nome);
            if (!pessoaSelecionadaAtual) {
                colunaDetalhesDiv.innerHTML = '';
                colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                colunaDetalhesContent.style.display = 'flex';
                console.log("criarEstruturaDetalhes: Nenhuma pessoa selecionada, mostrando placeholder.");
                return;
            }
            colunaDetalhesContent.style.display = 'none';

            // --- IN√çCIO DA ALTERA√á√ÉO ---
            // Adicionado o <select> para o filtro de "Tipo"
            colunaDetalhesDiv.innerHTML = `
                <h3>Detalhes de: <span id="nome-pessoa-detalhe">${pessoaSelecionadaAtual.nome}</span></h3>
                <div class="tabs">
                    <button class="tab-button active" data-tab="historico">Linha</button>
                    <button class="tab-button" data-tab="arquivo">Arquivo</button>
                    <button class="tab-button" data-tab="estatisticas">Estat√≠sticas</button>
                    <button class="tab-button" id="tab-btn-editar-modo" data-tab="editar-modo">Editar</button>
                </div>

                <button id="btn-toggle-filtros-pessoa" class="btn-toggle-filtros">
                    <i class="fas fa-filter"></i>
                    <span class="btn-toggle-text">Mostrar Filtros</span>
                    <i class="fas fa-chevron-down toggle-icon"></i>
                </button>

                <div class="filtros-wrapper-mobile">
                    <div class="filters-container" id="filtros-pessoa-container">
                        <label for="filtro-mes">M√™s:</label>
                        <select id="filtro-mes"><option value="">Todos</option>${[...Array(12).keys()].map(i => `<option value="${String(i + 1).padStart(2, '0')}">${new Date(0, i).toLocaleString('pt-BR', { month: 'long' })}</option>`).join('')}</select>
                        <label for="filtro-ano">Ano:</label><select id="filtro-ano"><option value="">Todos</option></select>
                        <label for="filtro-semana">Semana:</label><select id="filtro-semana"><option value="">Todas</option></select>
                        <label for="filtro-elemento">Elemento:</label><select id="filtro-elemento"><option value="">Todos</option></select>
                        <label for="filtro-tipo">Tipo:</label>
                        <select id="filtro-tipo">
                            <option value="">Todos</option>
                            <option value="reuniao">Reuni√£o</option>
                            <option value="pregacao">Prega√ß√£o</option>
                        </select>
                        <button id="btn-aplicar-filtros">Aplicar</button>
                        <button id="btn-limpar-filtros">Limpar</button>
                    </div>
                </div>

                <div id="historico-content" class="tab-content active"></div>
                <div id="arquivo-content" class="tab-content">
                    <div class="gs-old-submenu-tabs" style="margin-bottom: 0;">
                        <button class="gs-old-submenu-button active" data-filtro="semana">Semana</button>
                        <button class="gs-old-submenu-button" data-filtro="fim de semana">Fim de Semana</button>
                        <button class="gs-old-submenu-button" data-filtro="tecnico">T√©cnicas</button>
                        <button class="gs-old-submenu-button" data-filtro="pregacao">Prega√ß√£o</button>
                    </div>
                    <div id="arquivo-resultados-container" style="overflow-y: auto; flex-grow: 1;">
                        <ul id="arquivo-resultados-lista" style="list-style-type: none; padding: 0;"></ul>
                    </div>
                </div>
                <div id="estatisticas-content" class="tab-content"></div>`;
            // --- FIM DA ALTERA√á√ÉO ---

            console.log("criarEstruturaDetalhes: Estrutura da segunda coluna criada com a aba Arquivo.");

            const tabBtnEditarModo = document.getElementById('tab-btn-editar-modo');

            document.querySelectorAll('#coluna-detalhes .tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;
                    if (targetTabId === 'editar-modo') {
                        editModeActive = !editModeActive;
                        tabBtnEditarModo.classList.toggle('active-edit-mode', editModeActive);
                        tabBtnEditarModo.textContent = editModeActive ? "Modo Edi√ß√£o Ativado" : "Editar";
                        if (document.getElementById('historico-content')?.classList.contains('active')) {
                            renderizarHistorico();
                        }
                        return;
                    } 
                    
                    document.querySelectorAll('#coluna-detalhes .tab-button:not(#tab-btn-editar-modo)').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    const historicoContentDiv = document.getElementById('historico-content');
                    const arquivoContentDiv = document.getElementById('arquivo-content');
                    const estatisticasContentDiv = document.getElementById('estatisticas-content');

                    historicoContentDiv.classList.toggle('active', targetTabId === 'historico');
                    arquivoContentDiv.classList.toggle('active', targetTabId === 'arquivo');
                    estatisticasContentDiv.classList.toggle('active', targetTabId === 'estatisticas');

                    if (targetTabId === 'historico') renderizarHistorico();
                    else if (targetTabId === 'arquivo') setupArquivoTab();
                    else if (targetTabId === 'estatisticas') renderizarEstatisticas();
                });
            });

           editModeActive = false;
            if (tabBtnEditarModo) {
                tabBtnEditarModo.classList.remove('active-edit-mode');
                tabBtnEditarModo.textContent = "Editar";
            }

            const btnAplicar = document.getElementById('btn-aplicar-filtros');
            const btnLimpar = document.getElementById('btn-limpar-filtros');
            if(btnAplicar) btnAplicar.addEventListener('click', aplicarEAtualizarFiltros);
            if(btnLimpar) {
                btnLimpar.addEventListener('click', () => {
                    editModeActive = false;
                    if (tabBtnEditarModo) {
                        tabBtnEditarModo.classList.remove('active-edit-mode');
                        tabBtnEditarModo.textContent = "Editar";
                    }
                    limparEAtualizarFiltros();
                });
            }

           const btnToggleFiltrosPessoa = document.getElementById('btn-toggle-filtros-pessoa');
            const filtrosWrapperMobile = document.querySelector('.filtros-wrapper-mobile'); 

            if (btnToggleFiltrosPessoa && filtrosWrapperMobile) {
                const btnTextElement = btnToggleFiltrosPessoa.querySelector('.btn-toggle-text');
                
                btnToggleFiltrosPessoa.addEventListener('click', () => {
                    const isMobile = window.innerWidth <= 768;
                    filtrosWrapperMobile.classList.toggle('filtros-visiveis');
                    btnToggleFiltrosPessoa.classList.toggle('active');
                    const isNowVisible = filtrosWrapperMobile.classList.contains('filtros-visiveis');
                    if (btnTextElement) {
                        btnTextElement.textContent = isNowVisible ? "Ocultar Filtros" : "Mostrar Filtros";
                    }
                    if (!isMobile) {
                        filtrosWrapperMobile.style.display = isNowVisible ? 'grid' : 'none';
                    }
                });
                
             function adjustFilterDisplayOnLoadOrResize() {
                    const isMobile = window.innerWidth <= 768;
                    filtrosWrapperMobile.style.display = '';
                    if (!isMobile) {
                        btnToggleFiltrosPessoa.style.display = 'flex';
                        const isVisible = filtrosWrapperMobile.classList.contains('filtros-visiveis');
                        filtrosWrapperMobile.style.display = isVisible ? 'block' : 'none';
                    } else {
                        btnToggleFiltrosPessoa.style.display = 'flex';
                    }
                }
                adjustFilterDisplayOnLoadOrResize();
                window.addEventListener('resize', adjustFilterDisplayOnLoadOrResize);
            }
        }
        
        function setupArquivoTab() {
            const submenuButtons = document.querySelectorAll('#arquivo-content .gs-old-submenu-button');
            
            submenuButtons.forEach(button => {
                button.addEventListener('click', () => {
                    submenuButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filtro = button.dataset.filtro;
                    renderizarArquivo(filtro);
                });
            });

            const filtroInicial = document.querySelector('#arquivo-content .gs-old-submenu-button.active')?.dataset.filtro || 'semana';
            renderizarArquivo(filtroInicial);
        }

    function renderizarArquivo(filtroGenero) {
    console.log(`Renderizando arquivo com filtro: ${filtroGenero}`);
    const listaResultadosUl = document.getElementById('arquivo-resultados-lista');
    if (!listaResultadosUl) {
        console.error("Elemento #arquivo-resultados-lista n√£o encontrado.");
        return;
    }

    listaResultadosUl.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Filtrando designa√ß√µes...</p>';

    // Filtra as designa√ß√µes da pessoa atual
  const designacoesDoArquivo = designacoesFiltradas.filter(desig => {
        const elemento = todosElementos.find(el => (el.designacao || el.nome) === desig.nome);
        if (!elemento) return false;

        if (filtroGenero === 'pregacao') {
            return elemento.tipo === 'pregacao';
        }
        return elemento.generoReuniao === filtroGenero;
    });

    // Ordena por data, da mais recente para a mais antiga
    const designacoesOrdenadas = [...designacoesDoArquivo].sort((a, b) => {
        const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
        const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
        return dateB - dateA;
    });

    listaResultadosUl.innerHTML = ''; // Limpa a lista para os novos resultados

    if (designacoesOrdenadas.length === 0) {
        listaResultadosUl.innerHTML = '<li style="text-align:center; color:#777; margin-top:20px; padding: 10px;">Nenhuma designa√ß√£o encontrada para este filtro.</li>';
        return;
    }
    
    // Reutiliza a l√≥gica de separador de m√™s do hist√≥rico para consist√™ncia
    let mesAnoAtualSeparador = null;
    let primeiroSeparadorAdicionado = false;

    designacoesOrdenadas.forEach(desig => {
        const dataFormatada = `${String(desig.dia).padStart(2, '0')}/${String(desig.mes).padStart(2, '0')}/${desig.ano}`;
        const nomeMesAnoSeparador = `${new Date(desig.ano, desig.mes - 1).toLocaleString('pt-BR', { month: 'long' })} de ${desig.ano}`;

        if (mesAnoAtualSeparador !== nomeMesAnoSeparador) {
            mesAnoAtualSeparador = nomeMesAnoSeparador;
            const separadorLi = document.createElement('li');
            separadorLi.className = 'month-separator';
            if (!primeiroSeparadorAdicionado) {
                separadorLi.classList.add('first-month-separator');
                primeiroSeparadorAdicionado = true;
            }
            // LINHA MODIFICADA: Adicionada a tag <strong> para o negrito
            separadorLi.innerHTML = `<strong>${nomeMesAnoSeparador.charAt(0).toUpperCase() + nomeMesAnoSeparador.slice(1)}</strong>`;
            listaResultadosUl.appendChild(separadorLi);
        }
        
        const li = document.createElement('li');
        // Adiciona um padding e borda para se assemelhar aos itens do hist√≥rico
        li.style.padding = "8px 10px";
        li.style.borderBottom = "1px solid #eee";

        const participantesString = [desig.pessoaA, desig.pessoaB, desig.pessoaC].filter(Boolean).join(' - ');
        
         let emojiPrefixo = ""; // Define um valor padr√£o
    const elementoCorrespondente = todosElementos.find(el => (el.designacao || el.nome) === desig.nome);
    if (elementoCorrespondente && elementoCorrespondente.emoji) {
        emojiPrefixo = elementoCorrespondente.emoji + " "; // Adiciona o emoji e um espa√ßo
    }

        // --- LINHA MODIFICADA ---
        // Alterado de .textContent para .innerHTML para permitir a estiliza√ß√£o com a tag <span>
        li.innerHTML = `${dataFormatada} | ${emojiPrefixo}${desig.nome}: <span style="color: #0056b3; font-weight: 500;">${participantesString}</span>`;
        
        listaResultadosUl.appendChild(li);
    });
}

       function popularFiltros() {
            console.log("popularFiltros: Iniciando");
            const filtroAnoSelect = document.getElementById('filtro-ano');
            const filtroElementoSelect = document.getElementById('filtro-elemento');
            const filtroSemanaSelect = document.getElementById('filtro-semana');
            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const filtroTipoSelect = document.getElementById('filtro-tipo');
            // --- FIM DA ALTERA√á√ÉO ---

            if (!filtroAnoSelect || !filtroElementoSelect || !filtroSemanaSelect || !filtroTipoSelect) {
                console.warn("popularFiltros: Elementos de filtro n√£o encontrados.");
                return;
            }

            const anos = [...new Set(designacoesDaPessoaAtual.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));
            const elementos = [...new Set(designacoesDaPessoaAtual.map(d => d.nome))].sort((a, b) => a.localeCompare(b));

            const semanasUnicasComDatas = designacoesDaPessoaAtual
                .filter(d => (d.semana && typeof d.semana === 'string') || d.semanaISO)
                .map(d => ({
                    valorSemana: d.semana || `Semana ISO ${d.semanaISO} (${d.ano})`,
                    textoSemana: d.semana || `Semana ISO ${d.semanaISO} (${d.ano})`,
                    ano: parseInt(d.ano),
                    mes: parseInt(d.mes),
                    dia: parseInt(d.dia)
                }))
                .reduce((acc, current) => {
                    if (!acc.find(item => item.valorSemana === current.valorSemana)) {
                        acc.push(current);
                    }
                    return acc;
                }, [])
                .sort((a, b) => {
                    const dateA = new Date(a.ano, a.mes - 1, a.dia);
                    const dateB = new Date(b.ano, b.mes - 1, b.dia);
                    return dateA - dateB;
                });

            const semanasOptions = semanasUnicasComDatas.map(item => `<option value="${item.valorSemana}">${item.textoSemana}</option>`).join('');

            filtroAnoSelect.innerHTML = '<option value="">Todos</option>' + anos.map(ano => `<option value="${ano}">${ano}</option>`).join('');
            if (anos.length > 0) {
                filtroAnoSelect.value = anos[0];
            } else {
                filtroAnoSelect.value = "";
            }

            filtroElementoSelect.innerHTML = '<option value="">Todos</option>' + elementos.map(el => `<option value="${el}">${el}</option>`).join('');
            filtroSemanaSelect.innerHTML = '<option value="">Todas</option>' + semanasOptions;

            // --- IN√çCIO DA ALTERA√á√ÉO ---
            // Define o valor padr√£o do novo filtro para "Reuni√£o"
            if (filtroTipoSelect) {
                filtroTipoSelect.value = "reuniao";
            }
            // --- FIM DA ALTERA√á√ÉO ---

            console.log("popularFiltros: Filtros de detalhes populados.");
        }





        function aplicarEAtualizarFiltros() {
            console.log("aplicarEAtualizarFiltros: Aplicando filtros.");
            const mesEl = document.getElementById('filtro-mes');
            const anoEl = document.getElementById('filtro-ano');
            const elemEl = document.getElementById('filtro-elemento');
            const semanaEl = document.getElementById('filtro-semana');
            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const tipoEl = document.getElementById('filtro-tipo');
            // --- FIM DA ALTERA√á√ÉO ---

            const mes = mesEl ? mesEl.value : "";
            const ano = anoEl ? anoEl.value : "";
            const elemento = elemEl ? elemEl.value : "";
            const semana = semanaEl ? semanaEl.value : "";
            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const tipo = tipoEl ? tipoEl.value : "";
            // --- FIM DA ALTERA√á√ÉO ---

            designacoesFiltradas = designacoesDaPessoaAtual.filter(d => {
                const matchMes = !mes || d.mes === mes;
                const matchAno = !ano || d.ano === ano;
                const matchElemento = !elemento || d.nome === elemento;
                const matchSemana = !semana || (d.semana === semana) || (!d.semana && d.semanaISO && `Semana ISO ${d.semanaISO} (${d.ano})` === semana);
                
                // --- IN√çCIO DA ALTERA√á√ÉO ---
                // L√≥gica para o filtro de tipo
                const elementoCorrespondente = todosElementos.find(el => (el.designacao || el.nome) === d.nome);
                const matchTipo = !tipo || (elementoCorrespondente && elementoCorrespondente.tipo === tipo);
                // --- FIM DA ALTERA√á√ÉO ---

                return matchMes && matchAno && matchElemento && matchSemana && matchTipo;
            });

          const activeTabButton = document.querySelector('#coluna-detalhes .tab-button.active:not(#tab-btn-editar-modo)');
            if (activeTabButton?.dataset.tab === 'historico') {
                renderizarHistorico();
            } else if (activeTabButton?.dataset.tab === 'estatisticas') {
                renderizarEstatisticas();
            } 
            else if (activeTabButton?.dataset.tab === 'arquivo') {
                const activeSubmenuButton = document.querySelector('#arquivo-content .gs-old-submenu-button.active');
                if (activeSubmenuButton) {
                    const filtro = activeSubmenuButton.dataset.filtro;
                    renderizarArquivo(filtro);
                }
            }
        }


        function limparEAtualizarFiltros() {
            console.log("limparEAtualizarFiltros: Limpando filtros.");
            const filtroMes = document.getElementById('filtro-mes');
            const filtroAno = document.getElementById('filtro-ano');
            const filtroElemento = document.getElementById('filtro-elemento');
            const filtroSemana = document.getElementById('filtro-semana');
            const filtroTipo = document.getElementById('filtro-tipo');

            if (filtroMes) filtroMes.value = "";
            if (filtroAno) filtroAno.value = "";
            if (filtroElemento) filtroElemento.value = "";
            if (filtroSemana) filtroSemana.value = "";
            if (filtroTipo) filtroTipo.value = "";
            
            aplicarEAtualizarFiltros();
        }

        function renderizarHistorico() {
            console.log("renderizarHistorico: Iniciando. Modo Edi√ß√£o:", editModeActive);
            const historicoContent = document.getElementById('historico-content');
            if (!historicoContent) { console.error("renderizarHistorico: #historico-content n√£o encontrado."); return; }
            historicoContent.innerHTML = '';
            if (designacoesFiltradas.length === 0) {
                historicoContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Nenhuma designa√ß√£o encontrada com os filtros atuais.</p>';
                return;
            }
            const designacoesOrdenadas = [...designacoesFiltradas].sort((a, b) => {
                const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
                const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });

            const ul = document.createElement('ul');
            let currentMonthYearForColor = null;
            let currentWeekForColor = null;
            let colorIndex = 0;
            const weekColors = ['#f8f9fa', '#e9ecef'];

            let mesAnoAtualSeparador = null;
            let primeiroSeparadorAdicionado = false;

            designacoesOrdenadas.forEach((desig) => {
                const dataFormatada = `${String(desig.dia).padStart(2, '0')}/${String(desig.mes).padStart(2, '0')}/${desig.ano}`;
                const mesDaDesignacao = parseInt(desig.mes);
                const anoDaDesignacao = parseInt(desig.ano);
                const nomeMesAnoSeparador = `${new Date(anoDaDesignacao, mesDaDesignacao - 1).toLocaleString('pt-BR', { month: 'long' })} de ${anoDaDesignacao}`;

                if (mesAnoAtualSeparador !== nomeMesAnoSeparador) {
                    mesAnoAtualSeparador = nomeMesAnoSeparador;
                    const separadorLi = document.createElement('li');
                    separadorLi.classList.add('month-separator');
                    if (!primeiroSeparadorAdicionado) {
                        separadorLi.classList.add('first-month-separator');
                        primeiroSeparadorAdicionado = true;
                    }
                    separadorLi.textContent = nomeMesAnoSeparador.charAt(0).toUpperCase() + nomeMesAnoSeparador.slice(1);
                    ul.appendChild(separadorLi);
                    currentMonthYearForColor = `${desig.mes}/${desig.ano}`;
                    currentWeekForColor = null;
                    colorIndex = 0;
                }

                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';

                const weekIdentifier = desig.semana || (desig.semanaISO ? `ISO-${desig.semanaISO}-${desig.ano}` : `UnknownWeek-${desig.data}`);

                if (currentMonthYearForColor !== `${desig.mes}/${desig.ano}`) {
                    currentMonthYearForColor = `${desig.mes}/${desig.ano}`;
                    currentWeekForColor = weekIdentifier;
                    colorIndex = 0;
                } else if (currentWeekForColor !== weekIdentifier) {
                    currentWeekForColor = weekIdentifier;
                    colorIndex = (colorIndex + 1) % weekColors.length;
                }
                li.style.backgroundColor = weekColors[colorIndex];

                const nomeElementoDesig = desig.nome;
                const elementoCorrespondente = todosElementos.find(el => (el.designacao || el.nome) === nomeElementoDesig);

              let emojiPrefixo = "";
if (elementoCorrespondente && elementoCorrespondente.tipo === 'reuniao') {
    switch (elementoCorrespondente.generoReuniao) {
        case 'tecnico': emojiPrefixo = "‚öôÔ∏è "; break;
        case 'semana': emojiPrefixo = "üíé "; break;
        case 'fim de semana': emojiPrefixo = "üí¨ "; break;
        default: emojiPrefixo = ""; break;
    }
} 
// --- BLOCO ADICIONADO ---
else if (elementoCorrespondente && elementoCorrespondente.tipo === 'pregacao') {
    emojiPrefixo = "üì£ ";
}

                const nomeElementoDisplay = desig.nome || 'Elemento sem nome';
                const participantesNomesArray = [desig.pessoaA, desig.pessoaB, desig.pessoaC].filter(Boolean);
                const participantesString = participantesNomesArray.join(' - ');

                let textoFinal = `${dataFormatada} | ${emojiPrefixo}${nomeElementoDisplay}`;
                if (participantesString) {
                    textoFinal += `: ${participantesString}`;
                }
                if (desig.nome === "Orador P√∫blico" && (desig.tema || desig.congregacao)) {
                    textoFinal += ` (`;
                    if (desig.tema) textoFinal += `Tema: ${desig.tema}`;
                    if (desig.tema && desig.congregacao) textoFinal += `; `;
                    if (desig.congregacao) textoFinal += `Cong: ${desig.congregacao}`;
                    textoFinal += `)`;
                }

                const textSpan = document.createElement('span');
                textSpan.textContent = textoFinal;
                li.appendChild(textSpan);

                if (editModeActive) {
                    const editBtn = document.createElement('button');
                    editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                    editBtn.dataset.designacaoId = desig.id;
                    editBtn.addEventListener('click', () => abrirModalEdicaoDesignacao(desig.id));
                    li.appendChild(editBtn);
                }
                ul.appendChild(li);
            });

            if (ul.childNodes.length > 0) {
                 const ultimoItemDeDesignacaoReal = Array.from(ul.childNodes).filter(node => !node.classList.contains('month-separator')).pop();
                if (ultimoItemDeDesignacaoReal) {
                    ultimoItemDeDesignacaoReal.style.borderBottom = 'none';
                }
                historicoContent.appendChild(ul);
            } else if (designacoesFiltradas.length > 0) {
                historicoContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Erro ao exibir hist√≥rico.</p>';
            }
            console.log("renderizarHistorico: Hist√≥rico renderizado.");
        }

        async function abrirModalEdicaoDesignacao(designacaoId) {
            designacaoAtualParaEdicao = designacoesDaPessoaAtual.find(d => d.id === designacaoId);
            if (!designacaoAtualParaEdicao) {
                alert("Erro: Designa√ß√£o n√£o encontrada para edi√ß√£o.");
                return;
            }

            formEditarDesignacao.reset();
            designacaoIdEditInput.value = designacaoId;
            dataDesignacaoEditInput.value = designacaoAtualParaEdicao.data;

            selectElementoDesignacaoEdit.innerHTML = '<option value="">-- Selecione um Elemento --</option>';
            todosElementos.forEach(el => {
                const option = document.createElement('option');
                const elNome = el.designacao || el.nome;
                option.value = elNome;
                option.textContent = elNome;
                option.selected = elNome === designacaoAtualParaEdicao.nome;
                selectElementoDesignacaoEdit.appendChild(option);
            });

            const pessoasVisiveis = todasPessoas.filter(p => p.estaVisivel !== false);
            const optionsHtml = pessoasVisiveis.map(p => `<option value="${p.nome}">${p.nome}</option>`).join('');

            selectPessoaAEdit.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            selectPessoaBEdit.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;
            selectPessoaCEdit.innerHTML = '<option value="">-- Nenhuma --</option>' + optionsHtml;

            if (designacaoAtualParaEdicao.pessoaA) selectPessoaAEdit.value = designacaoAtualParaEdicao.pessoaA;
            if (designacaoAtualParaEdicao.pessoaB) selectPessoaBEdit.value = designacaoAtualParaEdicao.pessoaB;
            if (designacaoAtualParaEdicao.pessoaC) selectPessoaCEdit.value = designacaoAtualParaEdicao.pessoaC;

            const toggleOradorFieldsEdit = () => {
                if (selectElementoDesignacaoEdit.value === "Orador P√∫blico") {
                    camposOradorPublicoEditDiv.style.display = 'block';
                } else {
                    camposOradorPublicoEditDiv.style.display = 'none';
                }
            };

            selectElementoDesignacaoEdit.onchange = toggleOradorFieldsEdit;
            toggleOradorFieldsEdit();

            if (designacaoAtualParaEdicao.nome === "Orador P√∫blico") {
                temaOradorEditInput.value = designacaoAtualParaEdicao.tema || '';
                congregacaoOradorEditInput.value = designacaoAtualParaEdicao.congregacao || '';
            } else {
                temaOradorEditInput.value = '';
                congregacaoOradorEditInput.value = '';
            }
            abrirModal(modalEditarDesignacao);
        }

        if (formEditarDesignacao) {
            formEditarDesignacao.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = designacaoIdEditInput.value;
                const dataStr = dataDesignacaoEditInput.value;
                const nomeElemento = selectElementoDesignacaoEdit.value;
                const pA = selectPessoaAEdit.value;
                const pB = selectPessoaBEdit.value;
                const pC = selectPessoaCEdit.value;

                if (!id) { alert("Erro: ID da designa√ß√£o n√£o encontrado."); return; }
                if (!nomeElemento) { alert("Selecione um elemento."); return; }
                if (!pA && !pB && !pC && nomeElemento !== "Orador P√∫blico") {
                     alert("Selecione pelo menos uma pessoa para designa√ß√µes que n√£o sejam 'Orador P√∫blico'.");
                     return;
                }
                if (!dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) { alert("Formato de data inv√°lido. Use DD/MM/AAAA."); return; }

                const [dia, mes, ano] = dataStr.split('/');
                const participantes = {};
                if (pA) participantes[pA] = true;
                if (pB) participantes[pB] = true;
                if (pC) participantes[pC] = true;

                const pessoasSelecionadasNomes = [pA, pB, pC].filter(pNome => pNome !== "");
                if (new Set(pessoasSelecionadasNomes).size !== pessoasSelecionadasNomes.length) {
                    alert("Pessoas duplicadas selecionadas. Cada pessoa deve ser √∫nica."); return;
                }

                const elementoOriginalObj = todosElementos.find(el => (el.designacao || el.nome) === nomeElemento);
                if (!elementoOriginalObj) {
                    alert("Elemento selecionado n√£o encontrado na base de dados de elementos.");
                    return;
                }

                const updateData = {
                    nome: nomeElemento,
                    elementoId: elementoOriginalObj.id,
                    pessoaA: pA || null,
                    pessoaB: pB || null,
                    pessoaC: pC || null,
                    participantes: participantes,
                    data: dataStr,
                    dia: dia.padStart(2, '0'),
                    mes: mes.padStart(2, '0'),
                    ano: ano,
                    ultimaModificacao: serverTimestamp()
                };
                
                if (designacaoAtualParaEdicao && designacaoAtualParaEdicao.semana) {
                     if (designacaoAtualParaEdicao.data !== dataStr) {
                        console.warn("Data alterada, a string 'semana' descritiva pode n√£o corresponder mais se n√£o for recalculada.");
                        updateData.semana = designacaoAtualParaEdicao.semana;
                    } else {
                         updateData.semana = designacaoAtualParaEdicao.semana;
                    }
                }

                try {
                    const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                    if (!isNaN(dateObj.getTime())) {
                        updateData.semanaISO = getISOWeek(dateObj);
                    } else {
                        console.warn("Data inv√°lida ao editar designa√ß√£o, semanaISO n√£o ser√° atualizada:", dataStr);
                        updateData.semanaISO = designacaoAtualParaEdicao?.semanaISO || null;
                    }
                } catch(err) {
                     console.warn("Erro ao calcular semanaISO na edi√ß√£o da designa√ß√£o:", err);
                     updateData.semanaISO = designacaoAtualParaEdicao?.semanaISO || null;
                }

                if (nomeElemento === "Orador P√∫blico") {
                    updateData.tema = temaOradorEditInput.value.trim() || null;
                    updateData.congregacao = congregacaoOradorEditInput.value.trim() || null;
                } else {
                    updateData.tema = null;
                    updateData.congregacao = null;
                }

                try {
                    const designacaoRef = doc(db, "designacoes", id);
                    await updateDoc(designacaoRef, updateData);
                    alert("Designa√ß√£o atualizada com sucesso!");
                    fecharModal(modalEditarDesignacao);
                    await carregarDesignacoesDaPessoa(pessoaSelecionadaAtual.id);
                    todasDesignacoesGlobaisCarregadas = false;

                } catch (error) {
                    console.error("Erro ao atualizar designa√ß√£o: ", error);
                    alert("Erro ao atualizar designa√ß√£o: " + error.message);
                }
            });
        }

 function renderizarEstatisticas() {
            console.log("renderizarEstatisticas: Iniciando");
            const statsContent = document.getElementById('estatisticas-content');
            if (!statsContent) { console.error("renderizarEstatisticas: #estatisticas-content n√£o encontrado."); return; }

            if (!pessoaSelecionadaAtual || designacoesFiltradas.length === 0) {
                console.log("renderizarEstatisticas: Sem dados para estat√≠sticas.");
                statsContent.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Nenhuma designa√ß√£o para calcular estat√≠sticas com os filtros atuais.</p>';
                return;
            }

            const tipoFiltro = document.getElementById('filtro-tipo')?.value;
            let cardsPregacaoHtml = '';
            let contagemDirigentePorDia = {};
            let todosLocaisUnicosOriginal = [];
            
            if (tipoFiltro === 'pregacao') {
                const designacoesDirigente = designacoesFiltradas.filter(d => d.nome === 'Dirigente Sa√≠da');
                const diasDaSemanaOrdem = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
                
                designacoesDirigente.forEach(d => {
                    try {
                        const [dia, mes, ano] = d.data.split('/');
                        const dataObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                        const diaDaSemana = dataObj.toLocaleString('pt-BR', { weekday: 'long' });
                        const diaDaSemanaCapitalizado = diaDaSemana.charAt(0).toUpperCase() + diaDaSemana.slice(1);
                        contagemDirigentePorDia[diaDaSemanaCapitalizado] = (contagemDirigentePorDia[diaDaSemanaCapitalizado] || 0) + 1;
                    } catch (e) {
                        console.warn("Data inv√°lida ao calcular dia da semana:", d.data);
                    }
                });

                contagemDirigentePorDia = Object.entries(contagemDirigentePorDia)
                    .sort(([diaA], [diaB]) => diasDaSemanaOrdem.indexOf(diaA) - diasDaSemanaOrdem.indexOf(diaB))
                    .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});

                const contagemLocais = designacoesFiltradas.reduce((acc, d) => {
                    if (d.local && d.local.trim() !== '') {
                        acc[d.local] = (acc[d.local] || 0) + 1;
                    }
                    return acc;
                }, {});
                todosLocaisUnicosOriginal = Object.entries(contagemLocais).sort(([, a], [, b]) => b - a || (a[0] || '').localeCompare(b[0] || ''));

                let listaDirigenteHtml = Object.keys(contagemDirigentePorDia).length > 0
                    ? `<ul>${Object.entries(contagemDirigentePorDia).map(([dia, count]) => `<li>${dia}: <span class="stat-value-inline">${count}</span></li>`).join('')}</ul>`
                    : '<p>Nenhuma designa√ß√£o de "Dirigente Sa√≠da" encontrada.</p>';
                cardsPregacaoHtml += `<div class="stat-card"><h4>Dirigente/Semana</h4>${listaDirigenteHtml}</div>`;

                if (Object.keys(contagemDirigentePorDia).length > 0) {
                    cardsPregacaoHtml += `<div class="stat-card stats-chart-container-pessoa">
                                            <h4>Gr√°fico Dirigente/Semana</h4>
                                            <button class="btn-expand-chart" data-chart-id="chartDirigentePorDia" data-chart-title="Gr√°fico Dirigente/Semana (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                                            <!-- Wrapper Adicionado -->
                                            <div class="chart-wrapper">
                                                <canvas id="chartDirigentePorDia"></canvas>
                                            </div>
                                          </div>`;
                }
                
                cardsPregacaoHtml += `<div class="stat-card">
                                        <h4>Locais Carrinhos</h4>
                                        <ul id="lista-locais-pessoa"></ul>
                                        <a href="#" id="link-mostrar-todos-locais-pessoa" class="mostrar-todos-link" style="display:none;">Mostrar mais</a>
                                     </div>`;
            }
            
            let allCardsHtml = '';

            const totalDesignacoes = designacoesFiltradas.length;
            allCardsHtml += `<div class="stat-card"><h4>Total de Designa√ß√µes</h4><span class="stat-value">${totalDesignacoes}</span><span class="stat-label">(Com filtro aplicado)</span></div>`;

            const contagemElementos = designacoesFiltradas.reduce((acc, d) => { acc[d.nome] = (acc[d.nome] || 0) + 1; return acc; }, {});
            
            const todosElementosRealizadosOriginal = Object.entries(contagemElementos).sort(([nomeA, countA], [nomeB, countB]) => countB - countA || nomeA.localeCompare(nomeB));

            allCardsHtml += `<div class="stat-card">
                                <h4>Elementos Mais Realizados</h4>
                                <ul id="lista-elementos-pessoa"></ul>
                                <a href="#" id="link-mostrar-todos-elementos-pessoa" class="mostrar-todos-link" style="display:none;">Mostrar mais</a>
                             </div>`;

            const contagemParceiros = designacoesFiltradas.reduce((acc, d) => {
                [d.pessoaA, d.pessoaB, d.pessoaC].filter(p => p && p !== pessoaSelecionadaAtual.nome).forEach(parceiro => acc[parceiro] = (acc[parceiro] || 0) + 1);
                return acc;
            }, {});
            const todosParceirosFrequentesOriginal = Object.entries(contagemParceiros).sort(([, a], [, b]) => b - a || (a[0] || '').localeCompare(b[0] || ''));

            allCardsHtml += `<div class="stat-card">
                                <h4>Parceiros Mais Frequentes</h4>
                                <ul id="lista-parceiros-pessoa"></ul>
                                <a href="#" id="link-mostrar-todos-parceiros-pessoa" class="mostrar-todos-link" style="display:none;">Mostrar mais</a>
                             </div>`;
            
            allCardsHtml += cardsPregacaoHtml;

            const pessoasDisponiveisParaConjunta = todasPessoas
                .filter(p => pessoaSelecionadaAtual && p.id !== pessoaSelecionadaAtual.id && p.estaVisivel !== false)
                .map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
            const elementosDisponiveisParaConjunta = [...new Set(todosElementos.map(el => el.designacao || el.nome))]
                .sort()
                .map(nomeEl => `<option value="${nomeEl}">${nomeEl}</option>`).join('');
            allCardsHtml += `<div class="stat-card" id="verificacao-conjunta-container">
                                <h4>Verificar Designa√ß√£o Conjunta</h4>
                                <label for="select-outra-pessoa">Com:</label>
                                <select id="select-outra-pessoa"><option value="">-- Selecione Pessoa --</option>${pessoasDisponiveisParaConjunta}</select>
                                <label for="select-elemento-verificacao">Elemento:</label>
                                <select id="select-elemento-verificacao"><option value="">-- Selecione Elemento --</option>${elementosDisponiveisParaConjunta}</select>
                                <button id="btn-verificar-conjunta">Verificar</button>
                                <div id="resultado-verificacao-conjunta"></div>
                             </div>`;

            let mediaGlobalDesignacoes = 0;
            let comparacaoStr = "N√£o foi poss√≠vel calcular a m√©dia global (dados globais de designa√ß√µes ou pessoas n√£o carregados).";
            const countPessoaAtual = designacoesFiltradas.length;

            const filtroMesVal = document.getElementById('filtro-mes')?.value || "";
            const filtroAnoVal = document.getElementById('filtro-ano')?.value || "";
            const filtroElementoVal = document.getElementById('filtro-elemento')?.value || "";
            const filtroSemanaVal = document.getElementById('filtro-semana')?.value || "";

            if (todasDesignacoesGlobaisCarregadas && todasPessoas.length > 0) {
                const designacoesParaMedia = todasDesignacoesGlobais.filter(d => {
                    const matchMes = !filtroMesVal || d.mes === filtroMesVal;
                    const matchAno = !filtroAnoVal || d.ano === filtroAnoVal;
                    const matchElemento = !filtroElementoVal || d.nome === filtroElementoVal;
                    const matchSemana = !filtroSemanaVal || (d.semana === filtroSemanaVal) || (!d.semana && d.semanaISO && `Semana ISO ${d.semanaISO} (${d.ano})` === filtroSemanaVal);
                    return matchMes && matchAno && matchElemento && matchSemana;
                });

                const participacoesContagemGlobal = {};
                designacoesParaMedia.forEach(desig => {
                    Object.keys(desig.participantes || {}).forEach(nomeP => {
                        if (desig.participantes[nomeP]) {
                            participacoesContagemGlobal[nomeP] = (participacoesContagemGlobal[nomeP] || 0) + 1;
                        }
                    });
                });

               const totalParticipacoesGlobal = Object.values(participacoesContagemGlobal).reduce((sum, val) => sum + val, 0);
                const numPessoasComParticipacaoGlobal = Object.keys(participacoesContagemGlobal).length;

                if (numPessoasComParticipacaoGlobal > 0) {
                    mediaGlobalDesignacoes = totalParticipacoesGlobal / numPessoasComParticipacaoGlobal;
                    const diferenca = countPessoaAtual - mediaGlobalDesignacoes;
                    let statusMedia = "";
                    if (diferenca > 0.01) statusMedia = `<strong style="color:green;">acima da m√©dia</strong> por ${diferenca.toFixed(1)}`;
                    else if (diferenca < -0.01) statusMedia = `<strong style="color:red;">abaixo da m√©dia</strong> por ${Math.abs(diferenca).toFixed(1)}`;
                    else statusMedia = `<strong style="color:orange;">na m√©dia</strong>`;

                    comparacaoStr = `Esta pessoa tem <strong>${countPessoaAtual}</strong> designa√ß√µes (com filtros atuais).<br>
                                     A m√©dia entre <strong>${numPessoasComParticipacaoGlobal}</strong> pessoas participantes (com os mesmos filtros) √© <strong>${mediaGlobalDesignacoes.toFixed(1)}</strong> designa√ß√µes.<br>
                                     Status: ${statusMedia}.`;
                } else {
                    comparacaoStr = "Nenhuma designa√ß√£o encontrada globalmente para calcular a m√©dia com os filtros atuais.";
                }
            }
            allCardsHtml += `
                <div class="stat-card">
                    <h4>M√©dia de Participa√ß√µes (vs Global)</h4>
                    <p style="font-size:0.9em; line-height:1.5;">${comparacaoStr}</p>
                </div>`;
            
            allCardsHtml += `<div class="stat-card" id="designacoesPorElementoChartContainer">
                                <h4>Designa√ß√µes por Elemento</h4>
                                <button class="btn-expand-chart" data-chart-id="designacoesPorElementoChart" data-chart-title="Designa√ß√µes por Elemento (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                                <!-- Wrapper Adicionado -->
                                <div class="chart-wrapper">
                                    <canvas id="designacoesPorElementoChart"></canvas>
                                </div>
                             </div>`;
            
            const desigPorMes = {};
            const desigPorSemana = {}; 
            const desigPorAno = {};

            designacoesFiltradas.forEach(d => {
                const mesAnoKey = `${d.ano}-${String(d.mes).padStart(2, '0')}`;
                desigPorMes[mesAnoKey] = (desigPorMes[mesAnoKey] || 0) + 1;
                const semanaLabel = d.semana || (d.semanaISO ? `ISO ${d.semanaISO} (${d.ano})` : "Semana Desconhecida");
                if (semanaLabel !== "Semana Desconhecida") {
                    desigPorSemana[semanaLabel] = (desigPorSemana[semanaLabel] || 0) + 1;
                }
                desigPorAno[d.ano.toString()] = (desigPorAno[d.ano.toString()] || 0) + 1;
            });

            allCardsHtml += `
                <div class="stat-card stats-chart-container-pessoa">
                    <h4>Designa√ß√µes por M√™s</h4>
                    <button class="btn-expand-chart" data-chart-id="chartDesigPorMes" data-chart-title="Designa√ß√µes por M√™s (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                    <!-- Wrapper Adicionado -->
                    <div class="chart-wrapper">
                        <canvas id="chartDesigPorMes"></canvas>
                    </div>
                </div>
                <div class="stat-card stats-chart-container-pessoa">
                    <h4>Designa√ß√µes por Semana</h4>
                    <button class="btn-expand-chart" data-chart-id="chartDesigPorSemana" data-chart-title="Designa√ß√µes por Semana (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                    <!-- Wrapper Adicionado -->
                    <div class="chart-wrapper">
                        <canvas id="chartDesigPorSemana"></canvas>
                    </div>
                </div>
                <div class="stat-card stats-chart-container-pessoa">
                    <h4>Designa√ß√µes por Ano</h4>
                    <button class="btn-expand-chart" data-chart-id="chartDesigPorAno" data-chart-title="Designa√ß√µes por Ano (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                    <!-- Wrapper Adicionado -->
                    <div class="chart-wrapper">
                        <canvas id="chartDesigPorAno"></canvas>
                    </div>
                </div>
            `;

            const designacoesOradorPublico = designacoesFiltradas.filter(d => d.nome === "Orador P√∫blico" && d.tema && d.tema.trim() !== '');
            let cardsOradorPublicoHtml = '';

            if (designacoesOradorPublico.length > 0) {
                
                if (todosDiscursos.length === 0) {
                    console.warn("A lista de discursos (com n√∫meros) n√£o foi carregada. N√£o √© poss√≠vel exibir os n√∫meros.");
                }

                const contagemTemas = designacoesOradorPublico.reduce((acc, desig) => {
                    if (desig.tema) {
                        acc[desig.tema] = (acc[desig.tema] || 0) + 1;
                    }
                    return acc;
                }, {});
                
                const temasCompletos = Object.entries(contagemTemas).map(([tema, count]) => {
                    const discursoInfo = todosDiscursos.find(d => d.nome.trim() === tema.trim());
                    return {
                        tema: tema,
                        count: count,
                        numero: discursoInfo ? discursoInfo.numero : Infinity
                    };
                }).sort((a, b) => a.numero - b.numero);

                let listaTemasHtml = temasCompletos.length > 0
                    ? `<ul>${temasCompletos.map(item => {
                        const numeroDisplay = item.numero === Infinity ? '?' : item.numero;
                        return `<li><strong>${numeroDisplay}</strong> - ${item.tema}: <span class="stat-value-inline">${item.count}</span></li>`;
                      }).join('')}</ul>`
                    : '<p>Nenhum tema de discurso encontrado para os filtros atuais.</p>';

                cardsOradorPublicoHtml += `
                    <div class="stat-card">
                        <h4>Discursos Realizados (Tema e Contagem)</h4>
                        ${listaTemasHtml}
                    </div>
                `;

                cardsOradorPublicoHtml += `
                    <div class="stat-card stats-chart-container-pessoa">
                        <h4>Discursos por Ano</h4>
                        <button class="btn-expand-chart" data-chart-id="chartDiscursosPorAno" data-chart-title="Discursos por Ano (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                        <!-- Wrapper Adicionado -->
                        <div class="chart-wrapper">
                            <canvas id="chartDiscursosPorAno"></canvas>
                        </div>
                    </div>
                `;

                cardsOradorPublicoHtml += `
                    <div class="stat-card stats-chart-container-pessoa">
                        <h4>Discursos por M√™s</h4>
                        <button class="btn-expand-chart" data-chart-id="chartTemasPorMes" data-chart-title="Discursos por M√™s (Pessoa: ${pessoaSelecionadaAtual.nome})"><i class="fas fa-expand"></i></button>
                        <!-- Wrapper Adicionado -->
                        <div class="chart-wrapper">
                            <canvas id="chartTemasPorMes"></canvas>
                        </div>
                    </div>
                `;
            }
            allCardsHtml += cardsOradorPublicoHtml;

            statsContent.innerHTML = allCardsHtml;
    



        function populateDiscursosFilters() {
            // Esta fun√ß√£o tamb√©m j√° n√£o precisa de prefixo
            const anoSelect = document.getElementById(`gs-discursos-filtro-ano`);
            const mesSelect = document.getElementById(`gs-discursos-filtro-mes`);
            const congregacaoSelect = document.getElementById(`gs-discursos-filtro-congregacao`);
            const numeroSelect = document.getElementById(`gs-discursos-filtro-numero`);

            if (!anoSelect || !mesSelect || !congregacaoSelect || !numeroSelect) return;

            const discursosPublicos = todasDesignacoesGlobais.filter(d => d.nome === "Orador P√∫blico");
            const anosUnicos = [...new Set(discursosPublicos.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));
            const mesesUnicos = [...new Set(discursosPublicos.map(d => d.mes).filter(Boolean))].sort((a,b) => parseInt(a) - parseInt(b));
            const congregacoesUnicas = [...new Set(discursosPublicos.map(d => d.congregacao).filter(Boolean))].sort();

            anoSelect.innerHTML = '<option value="">Todos</option>' + anosUnicos.map(ano => `<option value="${ano}">${ano}</option>`).join('');
            mesSelect.innerHTML = '<option value="">Todos</option>' + mesesUnicos.map(mes => `<option value="${String(mes).padStart(2, '0')}">${new Date(0, mes-1).toLocaleString('pt-BR', {month: 'long'})}</option>`).join('');
            congregacaoSelect.innerHTML = '<option value="">Todas</option>' + congregacoesUnicas.map(c => `<option value="${c}">${c}</option>`).join('');
            numeroSelect.innerHTML = '<option value="">Todos</option>' + todosDiscursos.sort((a,b) => a.numero - b.numero).map(d => `<option value="${d.numero}">${d.numero}</option>`).join('');
        }
        
        function getFilteredDiscursos() {
            // Esta fun√ß√£o agora l√™ sempre dos mesmos IDs de filtros
            const anoFiltro = document.getElementById(`gs-discursos-filtro-ano`).value;
            const mesFiltro = document.getElementById(`gs-discursos-filtro-mes`).value;
            const idiomaFiltro = document.getElementById(`gs-discursos-filtro-idioma`).value;
            const congregacaoFiltro = document.getElementById(`gs-discursos-filtro-congregacao`).value;
            const numeroFiltro = document.getElementById(`gs-discursos-filtro-numero`).value;
            
            let temaDoNumeroFiltrado = null;
            if (numeroFiltro && todosDiscursos.length > 0) {
                const discurso = todosDiscursos.find(d => d.numero == numeroFiltro);
                if (discurso) temaDoNumeroFiltrado = discurso.nome;
            }

            return todasDesignacoesGlobais.filter(d => {
                if (d.nome !== "Orador P√∫blico") return false;
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2, '0') === mesFiltro;
                const matchCongregacao = !congregacaoFiltro || d.congregacao === congregacaoFiltro;
                const matchNumero = !temaDoNumeroFiltrado || (d.tema && d.tema.trim() === temaDoNumeroFiltrado.trim());

                if (!matchAno || !matchMes || !matchCongregacao || !matchNumero) return false;

                if (idiomaFiltro) {
                    const orador = todasPessoas.find(p => p.nome === d.pessoaA);
                    return orador && orador.idioma === idiomaFiltro;
                }
                return true;
            });
        }

        function renderDiscursosRecentes() {
            const prefix = 'gs-discursos-recentes';
            setSectionLoadingState(prefix, true);
            const listUl = document.getElementById(`${prefix}-list`);
            const discursosFiltrados = getFilteredDiscursos();
            discursosFiltrados.sort((a, b) => new Date(b.ano, b.mes - 1, b.dia) - new Date(a.ano, a.mes - 1, a.dia));
            const ultimos20 = discursosFiltrados.slice(0, 20);
            listUl.innerHTML = '';
            if (ultimos20.length === 0) {
                setSectionLoadingState(prefix, false);
                return;
            }
            ultimos20.forEach(d => {
                const li = document.createElement('li');
                li.innerHTML = `(${d.data}) <strong>${d.tema || 'Tema n√£o registrado'}</strong> <span class="value">por ${d.pessoaA} (${d.congregacao || 'N/A'})</span>`;
                listUl.appendChild(li);
            });
            setSectionLoadingState(prefix, false);
        }

        function renderListaDiscursos() {
            const prefix = 'gs-discursos-lista';
            setSectionLoadingState(prefix, true);
            const listUl = document.getElementById(`${prefix}-list`);
            const discursosFiltrados = getFilteredDiscursos();
            const contagemTemas = discursosFiltrados.reduce((acc, d) => {
                if (d.tema) acc[d.tema.trim()] = (acc[d.tema.trim()] || 0) + 1;
                return acc;
            }, {});
            const temasCompletos = Object.entries(contagemTemas).map(([tema, count]) => {
                const discursoInfo = todosDiscursos.find(d => d.nome.trim() === tema);
                return { tema, count, numero: discursoInfo ? discursoInfo.numero : Infinity };
            }).sort((a, b) => a.numero - b.numero);
            listUl.innerHTML = '';
            if (temasCompletos.length === 0) {
                setSectionLoadingState(prefix, false);
                return;
            }
            temasCompletos.forEach(item => {
                const li = document.createElement('li');
                li.className = 'clickable';
                const numeroDisplay = item.numero === Infinity ? '?' : item.numero;
                li.innerHTML = `<strong>${numeroDisplay}</strong> - ${item.tema} <span class="count">${item.count}</span>`;
                li.onclick = () => abrirModalDiscursoInstancias(item.tema, discursosFiltrados);
                listUl.appendChild(li);
            });
            setSectionLoadingState(prefix, false);
        }

        function renderOradores() {
            const prefix = 'gs-discursos-oradores';
            setSectionLoadingState(prefix, true);
            const listUl = document.getElementById(`${prefix}-list`);
            const discursosFiltrados = getFilteredDiscursos();
            const contagemOradores = discursosFiltrados.reduce((acc, d) => {
                if (d.pessoaA) acc[d.pessoaA] = (acc[d.pessoaA] || 0) + 1;
                return acc;
            }, {});
            const oradoresOrdenados = Object.entries(contagemOradores).sort((a,b) => b[1] - a[1]);
            listUl.innerHTML = '';
            if (oradoresOrdenados.length === 0) {
                setSectionLoadingState(prefix, false);
                return;
            }
            oradoresOrdenados.forEach(([orador, count]) => {
                const li = document.createElement('li');
                li.className = 'clickable';
                li.innerHTML = `${orador} <span class="count">${count}</span>`;
                li.onclick = () => abrirModalOradorDiscursos(orador, discursosFiltrados);
                listUl.appendChild(li);
            });
            setSectionLoadingState(prefix, false);
        }

        function renderDiscursosNaoFeitos() {
            const prefix = 'gs-discursos-nao-feitos';
            setSectionLoadingState(prefix, true);
            const listUl = document.getElementById(`${prefix}-list`);
            const discursosFiltrados = getFilteredDiscursos();
            const temasFeitos = new Set(discursosFiltrados.map(d => d.tema.trim()));
            const discursosNaoFeitos = todosDiscursos
                .filter(d => !temasFeitos.has(d.nome.trim()))
                .sort((a, b) => a.numero - b.numero);
            listUl.innerHTML = '';
            if (discursosNaoFeitos.length === 0) {
                listUl.innerHTML = '<li>Todos os discursos da lista foram feitos no per√≠odo filtrado.</li>';
                setSectionLoadingState(prefix, false);
                return;
            }
            discursosNaoFeitos.forEach(d => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${d.numero}</strong> - ${d.nome}`;
                listUl.appendChild(li);
            });
            setSectionLoadingState(prefix, false);
        }
        


        function abrirModalOradorDiscursos(orador, discursosFiltrados) {
            const modal = document.getElementById('modal-orador-discursos');
            const titulo = document.getElementById('modal-orador-discursos-titulo');
            const listUl = document.getElementById('modal-orador-discursos-list');
            
            titulo.textContent = `Discursos de: ${orador}`;
            const instancias = discursosFiltrados.filter(d => d.pessoaA === orador);
            listUl.innerHTML = '';
            instancias.forEach(d => {
                const li = document.createElement('li');
                const discursoInfo = todosDiscursos.find(discurso => d.tema && discurso.nome.trim() === d.tema.trim());
                const numeroDisplay = discursoInfo ? `<strong>${discursoInfo.numero}</strong> - ` : '';
                li.innerHTML = `(${d.data}) ${numeroDisplay}${d.tema}`;
                listUl.appendChild(li);
            });
            abrirModal(modal);
        }








            function renderListaElementosPessoaInterna() {
                const listaUl = document.getElementById('lista-elementos-pessoa');
                const link = document.getElementById('link-mostrar-todos-elementos-pessoa');
                if (!listaUl || !link) {
                    return;
                }
                listaUl.innerHTML = '';
                const dadosParaRenderizar = mostrandoTodosElementosPessoa ? todosElementosRealizadosOriginal : todosElementosRealizadosOriginal.slice(0, 5);
                if (dadosParaRenderizar.length > 0) {
                    dadosParaRenderizar.forEach(([nome, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `${nome}: <span class="stat-value-inline">${count}</span>`;
                        listaUl.appendChild(li);
                    });
                } else {
                    listaUl.innerHTML = '<li>Nenhum dado de elemento.</li>';
                }
                if (todosElementosRealizadosOriginal.length > 5) {
                    link.style.display = 'inline-block';
                    link.textContent = mostrandoTodosElementosPessoa ? 'Mostrar menos' : `Mostrar todos (${todosElementosRealizadosOriginal.length})`;
                } else {
                    link.style.display = 'none';
                }
            }
            renderListaElementosPessoaInterna();
            const linkElementos = document.getElementById('link-mostrar-todos-elementos-pessoa');
            if (linkElementos) {
                linkElementos.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrandoTodosElementosPessoa = !mostrandoTodosElementosPessoa;
                    renderListaElementosPessoaInterna();
                });
            }

          function renderListaParceirosPessoaInterna() {
                const listaUl = document.getElementById('lista-parceiros-pessoa');
                const link = document.getElementById('link-mostrar-todos-parceiros-pessoa');
                if (!listaUl || !link) {
                    return;
                }
                listaUl.innerHTML = '';
                const dadosParaRenderizar = mostrandoTodosParceirosPessoa ? todosParceirosFrequentesOriginal : todosParceirosFrequentesOriginal.slice(0, 3);
                if (dadosParaRenderizar.length > 0) {
                    dadosParaRenderizar.forEach(([nome, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `${nome}: <span class="stat-value-inline">${count}</span>`;
                        listaUl.appendChild(li);
                    });
                } else {
                    listaUl.innerHTML = '<li>Nenhum parceiro frequente ou s√≥ fez designa√ß√µes sozinho(a).</li>';
                }
                if (todosParceirosFrequentesOriginal.length > 3) {
                    link.style.display = 'inline-block';
                    link.textContent = mostrandoTodosParceirosPessoa ? 'Mostrar menos' : `Mostrar todos (${todosParceirosFrequentesOriginal.length})`;
                } else {
                    link.style.display = 'none';
                }
            }
            renderListaParceirosPessoaInterna();
            const linkParceiros = document.getElementById('link-mostrar-todos-parceiros-pessoa');
            if(linkParceiros) {
                linkParceiros.addEventListener('click', (e) => {
                    e.preventDefault();
                    mostrandoTodosParceirosPessoa = !mostrandoTodosParceirosPessoa;
                    renderListaParceirosPessoaInterna();
                });
            }

            if (tipoFiltro === 'pregacao') {
                function renderListaLocaisPessoaInterna() {
                    const listaUl = document.getElementById('lista-locais-pessoa');
                    const link = document.getElementById('link-mostrar-todos-locais-pessoa');
                    if (!listaUl || !link) return;
                    
                    listaUl.innerHTML = '';
                    const dadosParaRenderizar = mostrandoTodosLocais ? todosLocaisUnicosOriginal : todosLocaisUnicosOriginal.slice(0, 5);
                    
                    if (dadosParaRenderizar.length > 0) {
                        dadosParaRenderizar.forEach(([local, count]) => {
                            const li = document.createElement('li');
                            li.innerHTML = `${local}: <span class="stat-value-inline">${count}</span>`;
                            listaUl.appendChild(li);
                        });
                    } else {
                        listaUl.innerHTML = '<li>Nenhum local registrado para esta pessoa.</li>';
                    }

                    if (todosLocaisUnicosOriginal.length > 5) {
                        link.style.display = 'inline-block';
                        link.textContent = mostrandoTodosLocais ? 'Mostrar menos' : `Mostrar todos (${todosLocaisUnicosOriginal.length})`;
                    } else {
                        link.style.display = 'none';
                    }
                }
                renderListaLocaisPessoaInterna();
                const linkLocais = document.getElementById('link-mostrar-todos-locais-pessoa');
                if (linkLocais) {
                    linkLocais.addEventListener('click', (e) => {
                        e.preventDefault();
                        mostrandoTodosLocais = !mostrandoTodosLocais;
                        renderListaLocaisPessoaInterna();
                    });
                }
            }
            
            const btnVerificar = document.getElementById('btn-verificar-conjunta');
            if (btnVerificar) btnVerificar.addEventListener('click', verificarDesignacaoConjunta);

            if (designacoesChart && typeof designacoesChart.destroy === 'function') designacoesChart.destroy();
            const labelsElementosChart = Object.keys(contagemElementos);
            const dataCountsElementosChart = Object.values(contagemElementos);
            if (labelsElementosChart.length > 0) {
                designacoesChart = renderChart(designacoesChart, 'designacoesPorElementoChart', 'bar',
                    { labels: labelsElementosChart, datasets: [{ label: 'N¬∫ de Designa√ß√µes', data: dataCountsElementosChart, backgroundColor: 'rgba(0, 123, 255, 0.6)', borderColor: 'rgba(0, 123, 255, 1)', borderWidth: 1 }] }
                );
            } else {
                const chartContainer = document.getElementById('designacoesPorElementoChartContainer');
                if (chartContainer) { const canvas = chartContainer.querySelector('canvas'); if (canvas) canvas.outerHTML = "<p style='text-align:center; color:#777; margin-top:20px;'>Sem dados para exibir gr√°fico de elementos.</p>"; }
            }

            if (tipoFiltro === 'pregacao' && Object.keys(contagemDirigentePorDia).length > 0) {
                const labelsDirigente = Object.keys(contagemDirigentePorDia);
                const dataDirigente = Object.values(contagemDirigentePorDia);
                dirigentePorDiaChart = renderChart(dirigentePorDiaChart, 'chartDirigentePorDia', 'bar', {
                    labels: labelsDirigente,
                    datasets: [{
                        label: 'N¬∫ de Vezes como Dirigente',
                        data: dataDirigente,
                        backgroundColor: 'rgba(40, 167, 69, 0.6)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 1
                    }]
                }, { 
                    layout: {
                        padding: {
                            bottom: 20
                        }
                    },
                    scales: { 
                        x: { 
                            ticks: { 
                                autoSkip: false, 
                                maxRotation: 0, 
                                minRotation: 0 
                            } 
                        } 
                    } 
                });
            }

            const labelsMes = Object.keys(desigPorMes).sort();
            if (labelsMes.length > 0) {
                designacoesPorMesChart = renderChart(designacoesPorMesChart, 'chartDesigPorMes', 'line', {
                    labels: labelsMes.map(l => { const [y,m] = l.split('-'); return `${m}/${y}`;}),
                    datasets: [{ label: 'N¬∫ Designa√ß√µes', data: labelsMes.map(k => desigPorMes[k]), backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgba(75, 192, 192, 1)', tension: 0.1 }]
                });
            } else { const el = document.getElementById('chartDesigPorMes'); if(el) el.outerHTML = "<p style='text-align:center; color:#777;'>Sem dados para gr√°fico mensal.</p>"; }
            
             const labelsSemana = Object.keys(desigPorSemana).sort((a, b) => {
                const parseWeekString = (weekStr) => {
                    if (weekStr.startsWith("ISO")) {
                        const isoParts = weekStr.match(/ISO\s*(\d+)\s*\((\d{4})\)/);
                        if (isoParts) return new Date(parseInt(isoParts[2]), 0, (parseInt(isoParts[1]) -1) * 7 + 1);
                        return new Date(0);
                    }
                    const descParts = weekStr.match(/^([a-zA-Z√ß√á√£√µ√É√ï√°√©√≠√≥√∫√Å√â√ç√ì√ö]+)\s+(\d{4})\s*\|\s*(\d{1,2})/i);
                     const monthMap = { 'janeiro':0,'fevereiro':1,'mar√ßo':2,'abril':3,'maio':4,'junho':5,'julho':6,'agosto':7,'setembro':8,'outubro':9,'novembro':10,'dezembro':11};
                    if (descParts) {
                        const monthNum = monthMap[descParts[1].toLowerCase()];
                        if (monthNum !== undefined) return new Date(parseInt(descParts[2]), monthNum, parseInt(descParts[3]));
                    }
                    return new Date(0);
                };
                return parseWeekString(a) - parseWeekString(b);
            });

           if (labelsSemana.length > 0) {
                 designacoesPorSemanaChart = renderChart(designacoesPorSemanaChart, 'chartDesigPorSemana', 'bar', {
                    labels: labelsSemana,
                    datasets: [{ label: 'N¬∫ Designa√ß√µes', data: labelsSemana.map(k => desigPorSemana[k]), backgroundColor: 'rgba(153, 102, 255, 0.2)', borderColor: 'rgba(153, 102, 255, 1)'}]
                }, { scales: { x: { ticks: { autoSkip: labelsSemana.length > 15, maxRotation: labelsSemana.length > 10 ? 90 : 0, minRotation: labelsSemana.length > 10 ? 45 : 0 } } } });
            } else { const el = document.getElementById('chartDesigPorSemana'); if(el) el.outerHTML = "<p style='text-align:center; color:#777;'>Sem dados para gr√°fico semanal.</p>"; }

            const labelsAno = Object.keys(desigPorAno).sort();
            if (labelsAno.length > 0) {
                designacoesPorAnoChart = renderChart(designacoesPorAnoChart, 'chartDesigPorAno', 'bar', {
                    labels: labelsAno,
                    datasets: [{ label: 'N¬∫ Designa√ß√µes', data: labelsAno.map(k => desigPorAno[k]), backgroundColor: 'rgba(255, 159, 64, 0.6)', borderColor: 'rgba(255, 159, 64, 1)' }]
                });
            } else { const el = document.getElementById('chartDesigPorAno'); if(el) el.outerHTML = "<p style='text-align:center; color:#777;'>Sem dados para gr√°fico anual.</p>"; }

            if (designacoesOradorPublico.length > 0) {
                const discursosPorAno = designacoesOradorPublico.reduce((acc, d) => {
                    if (d.ano) acc[d.ano] = (acc[d.ano] || 0) + 1;
                    return acc;
                }, {});
                const labelsAnoDiscursos = Object.keys(discursosPorAno).sort();
                if (labelsAnoDiscursos.length > 0) {
                    chartDiscursosPorAno = renderChart(chartDiscursosPorAno, 'chartDiscursosPorAno', 'bar', {
                        labels: labelsAnoDiscursos,
                        datasets: [{
                            label: 'N¬∫ de Discursos',
                            data: labelsAnoDiscursos.map(k => discursosPorAno[k]),
                            backgroundColor: 'rgba(21, 115, 71, 0.6)',
                            borderColor: 'rgba(21, 115, 71, 1)'
                        }]
                    });
                }

                const discursosPorMes = designacoesOradorPublico.reduce((acc, d) => {
                    if (d.ano && d.mes) {
                        const mesAnoKey = `${d.ano}-${String(d.mes).padStart(2, '0')}`;
                        if (!acc[mesAnoKey]) acc[mesAnoKey] = { count: 0, themes: [] };
                        acc[mesAnoKey].count++;
                        acc[mesAnoKey].themes.push(d.tema);
                    }
                    return acc;
                }, {});
                const labelsMesDiscursos = Object.keys(discursosPorMes).sort();
                if (labelsMesDiscursos.length > 0) {
                    chartTemasPorMes = renderChart(chartTemasPorMes, 'chartTemasPorMes', 'bar', {
                        labels: labelsMesDiscursos.map(l => { const [y,m] = l.split('-'); return `${m}/${y}`; }),
                        datasets: [{
                            label: 'N¬∫ de Discursos',
                            data: labelsMesDiscursos.map(k => discursosPorMes[k].count),
                            backgroundColor: 'rgba(108, 117, 125, 0.6)',
                            borderColor: 'rgba(108, 117, 125, 1)'
                        }]
                    }, {
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    footer: function(tooltipItems) {
                                        const label = tooltipItems[0].label;
                                        const [mes, ano] = label.split('/');
                                        const originalKey = `${ano}-${mes}`;
                                        const themesForMonth = discursosPorMes[originalKey]?.themes || [];
                                        if (themesForMonth.length > 0) {
                                            const footerLines = ['Temas:'];
                                            themesForMonth.forEach(theme => footerLines.push(`  ‚Ä¢ ${theme}`));
                                            return footerLines;
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    });
                }
            }
             document.querySelectorAll('.btn-expand-chart').forEach(button => {
                button.addEventListener('click', (e) => {
                    const target = e.currentTarget;
                    const chartId = target.dataset.chartId;
                    const chartTitle = target.dataset.chartTitle;
                    abrirModalGrafico(chartId, chartTitle);
                });
            });

            console.log("renderizarEstatisticas: Estat√≠sticas renderizadas com HTML √∫nico e listeners reatribu√≠dos.");
        }
        





        function verificarDesignacaoConjunta() {
            const selectOutraPessoaEl = document.getElementById('select-outra-pessoa');
            const selectElementoVerificacao = document.getElementById('select-elemento-verificacao');
            const resultadoDiv = document.getElementById('resultado-verificacao-conjunta');

            if (!selectOutraPessoaEl || !selectElementoVerificacao || !resultadoDiv) return;
            if (!pessoaSelecionadaAtual) {
                resultadoDiv.textContent = "Erro: Pessoa principal n√£o selecionada.";
                resultadoDiv.className = 'resultado-verificacao-conjunta error';
                return;
            }

            const idOutraPessoa = selectOutraPessoaEl.value;
            const nomeOutraPessoa = selectOutraPessoaEl.options[selectOutraPessoaEl.selectedIndex]?.text;
            const nomeElemento = selectElementoVerificacao.value;

            resultadoDiv.textContent = "";
            resultadoDiv.className = 'resultado-verificacao-conjunta';

            if (!idOutraPessoa) { resultadoDiv.textContent = "Selecione a outra pessoa."; resultadoDiv.classList.add('info'); return; }
            if (!nomeElemento) { resultadoDiv.textContent = "Selecione o elemento."; resultadoDiv.classList.add('info'); return; }

            const designacoesComAmbos = designacoesFiltradas.filter(d =>
                d.nome === nomeElemento &&
                (
                    (d.pessoaA === pessoaSelecionadaAtual.nome && (d.pessoaB === nomeOutraPessoa || d.pessoaC === nomeOutraPessoa)) ||
                    (d.pessoaB === pessoaSelecionadaAtual.nome && (d.pessoaA === nomeOutraPessoa || d.pessoaC === nomeOutraPessoa)) ||
                    (d.pessoaC === pessoaSelecionadaAtual.nome && (d.pessoaA === nomeOutraPessoa || d.pessoaB === nomeOutraPessoa)) ||
                    (d.pessoaA === nomeOutraPessoa && (d.pessoaB === pessoaSelecionadaAtual.nome || d.pessoaC === pessoaSelecionadaAtual.nome)) ||
                    (d.pessoaB === nomeOutraPessoa && (d.pessoaA === pessoaSelecionadaAtual.nome || d.pessoaC === pessoaSelecionadaAtual.nome)) ||
                    (d.pessoaC === nomeOutraPessoa && (d.pessoaA === pessoaSelecionadaAtual.nome || d.pessoaB === pessoaSelecionadaAtual.nome))
                )
            );

            if (designacoesComAmbos.length > 0) {
                resultadoDiv.textContent = `Sim, fizeram "${nomeElemento}" juntos ${designacoesComAmbos.length} vez(es) neste per√≠odo.`;
                resultadoDiv.classList.add('success');
            } else {
                resultadoDiv.textContent = `N√£o, n√£o fizeram "${nomeElemento}" juntos neste per√≠odo.`;
                resultadoDiv.classList.add('error');
            }
        }

        function abrirModalGrafico(chartId, chartTitle) {
            const modal = document.getElementById('modal-grafico-expandido');
            const modalTitle = document.getElementById('modal-grafico-titulo');
            if (!modal || !modalTitle) return;

            let originalChartInstance = null;
            // Identifica qual dos gr√°ficos da p√°gina principal deve ser usado como fonte
            switch (chartId) {
                case 'designacoesPorElementoChart': originalChartInstance = designacoesChart; break;
                case 'chartDesigPorMes': originalChartInstance = designacoesPorMesChart; break;
                case 'chartDesigPorSemana': originalChartInstance = designacoesPorSemanaChart; break;
                case 'chartDesigPorAno': originalChartInstance = designacoesPorAnoChart; break;
                case 'chartDirigentePorDia': originalChartInstance = dirigentePorDiaChart; break;
case 'chartDiscursosPorAno': originalChartInstance = chartDiscursosPorAno; break;
                case 'chartTemasPorMes': originalChartInstance = chartTemasPorMes; break;
            }

            if (!originalChartInstance) {
                alert("Erro: N√£o foi poss√≠vel encontrar os dados do gr√°fico para expandir.");
                return;
            }

            modalTitle.textContent = chartTitle;

            const canvasExpandido = document.getElementById('canvas-grafico-expandido');
            const ctx = canvasExpandido.getContext('2d');

            if (graficoExpandidoChart) {
                graficoExpandidoChart.destroy();
            }

            graficoExpandidoChart = new Chart(ctx, {
                type: originalChartInstance.config.type,
                data: originalChartInstance.config.data,
                options: {
                    ...originalChartInstance.config.options, 
                    maintainAspectRatio: false,
                    responsive: true
                }
            });

            abrirModal(modal);
        }


        // --- Modais e FAB ---
        function abrirModal(modalElement) {
            if (modalElement) modalElement.style.display = 'block';
            else console.error("abrirModal: Tentativa de abrir modal nulo.");
        }
        function fecharModal(modalElement) {
            if (modalElement) modalElement.style.display = 'none';
            else console.error("fecharModal: Tentativa de fechar modal nulo.");
        }

        if (fabMain) {
            fabMain.addEventListener('click', (event) => {
                event.stopPropagation();
                fabOptions.classList.toggle('show');
            });
        } else { console.warn("Elemento fabMain n√£o encontrado."); }

        document.addEventListener('click', (event) => {
            if (fabOptions && fabOptions.classList.contains('show')) {
                if (!fabMain.contains(event.target) && !fabOptions.contains(event.target)) {
                    fabOptions.classList.remove('show');
                }
            }
        });

        if (btnCriarPessoaFab) {
             btnCriarPessoaFab.addEventListener('click', () => {
                formCriarPessoa.reset();
                pessoaIdEditInput.value = '';
                modalPessoaTitulo.textContent = 'Criar Nova Pessoa';
                btnSubmitPessoa.textContent = 'Criar Pessoa';
                abrirModal(modalPessoa);
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnCriarPessoaFab n√£o encontrado.");}

        if (btnCriarElementoFab) {
            btnCriarElementoFab.addEventListener('click', () => {
                formCriarElemento.reset();
                abrirModal(modalElemento);
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnCriarElementoFab n√£o encontrado.");}

        if (btnCriarDesignacaoFab) {
             btnCriarDesignacaoFab.addEventListener('click', async () => {
                formCriarDesignacao.reset();
                popularDropdownsPessoasNosModais();
                abrirModal(modalDesignacao);
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnCriarDesignacaoFab n√£o encontrado.");}

        if (btnGerenciarPessoasFab) {
            btnGerenciarPessoasFab.addEventListener('click', () => {
                abrirModalGerenciarPessoas();
                fabOptions.classList.remove('show');
            });
        } else { console.warn("Elemento btnGerenciarPessoasFab n√£o encontrado.");}

        if(closeButtons.length > 0) {
            closeButtons.forEach(button => button.addEventListener('click', () => {
                const modalId = button.getAttribute('data-modal-id');
                if (modalId) {
                    const modalToClose = document.getElementById(modalId);
                    if (modalToClose) fecharModal(modalToClose);
                } else {
                    const parentModal = button.closest('.modal');
                    if (parentModal) fecharModal(parentModal);
                }
            }));
        } else { console.warn("Nenhum elemento '.close-button' encontrado."); }

        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                if (event.target.style.display === 'block') {
                    fecharModal(event.target);
                }
            }
        });

        // --- Formul√°rios ---
        if (formCriarPessoa) {
            formCriarPessoa.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nome = nomePessoaInput.value.trim();
                const idioma = idiomaPessoaSelect.value;
                const genero = generoPessoaSelect.value;
                const cargo = cargoPessoaSelect.value;
                const pregacao = pregacaoPessoaSelect.value;
                const editId = pessoaIdEditInput.value;
                if (!nome) { alert("O nome da pessoa √© obrigat√≥rio."); return; }

                const pessoaData = { nome, idioma, genero, cargo, pregacao, ultimaModificacao: serverTimestamp() };
                try {
                    if (editId) {
                        const docRef = doc(db, "pessoas", editId);
                        await updateDoc(docRef, pessoaData);
                        alert("Pessoa atualizada com sucesso!");
                    } else {
                        pessoaData.estaVisivel = true;
                        await addDoc(collection(db, "pessoas"), pessoaData);
                        alert("Pessoa criada com sucesso!");
                    }
                    formCriarPessoa.reset();
                    fecharModal(modalPessoa);
                    await carregarPessoas();
                    if (editId && pessoaSelecionadaAtual && pessoaSelecionadaAtual.id === editId) {
                        const pessoaAtualizada = todasPessoas.find(p => p.id === editId);
                        if (pessoaAtualizada) {
                            pessoaSelecionadaAtual = pessoaAtualizada;
                            carregarDesignacoesDaPessoa(pessoaAtualizada.id);
                        } else {
                             colunaDetalhesDiv.innerHTML = '';
                             colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                             colunaDetalhesContent.style.display = 'flex';
                        }
                    }
                } catch (error) { console.error("Erro ao salvar pessoa: ", error); alert("Erro: " + error.message); }
            });
        }

        if (formCriarElemento) {
    formCriarElemento.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nomeElemento = nomeElementoModalInput.value.trim();
        // --- LINHA ADICIONADA ---
        const emoji = document.getElementById('emoji-elemento-modal').value.trim(); // Pega o valor do emoji
        
        const tipo = tipoElementoSelect.value;
        const generoReuniao = generoElementoSelect.value;
        if (!nomeElemento) { alert("O nome do elemento √© obrigat√≥rio."); return; }
        
        const elementoData = {
            designacao: nomeElemento,
            // --- LINHA ADICIONADA ---
            emoji: emoji || null, // Adiciona o emoji ao objeto (salva null se estiver vazio)
            tipo: tipo,
            generoReuniao: tipo === 'reuniao' ? generoReuniao : null,
            criadoEm: serverTimestamp()
        };
        try {
            await addDoc(collection(db, "elementos"), elementoData);
            alert("Elemento criado com sucesso!");
            formCriarElemento.reset();
            fecharModal(modalElemento);
            await carregarTodosElementosParaEstatisticas();
            await carregarListaDiscursos();
        } catch (error) { console.error("Erro ao criar elemento: ", error); alert("Erro: " + error.message); }
    });
}

        if (formCriarDesignacao) {
            formCriarDesignacao.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nomeElemento = selectElementoDesignacao.value;
                const pA = selectPessoaA.value;
                const pB = selectPessoaB.value;
                const pC = selectPessoaC.value;
                const dataStr = dataDesignacaoInput.value;

                if (!nomeElemento) { alert("Selecione um elemento."); return; }
                 if (!pA && !pB && !pC && nomeElemento !== "Orador P√∫blico") {
                     alert("Selecione pelo menos uma pessoa para designa√ß√µes que n√£o sejam 'Orador P√∫blico'.");
                     return;
                }
                if (!dataStr.match(/\d{2}\/\d{2}\/\d{4}/)) { alert("Formato de data inv√°lido. Use DD/MM/AAAA."); return; }

                const [dia, mes, ano] = dataStr.split('/');
                const participantes = {};
                if (pA) participantes[pA] = true;
                if (pB) participantes[pB] = true;
                if (pC) participantes[pC] = true;

                const pessoasSelecionadasNomes = [pA, pB, pC].filter(pNome => pNome !== "");
                if (new Set(pessoasSelecionadasNomes).size !== pessoasSelecionadasNomes.length) {
                    alert("Pessoas duplicadas selecionadas. Cada pessoa deve ser √∫nica."); return;
                }
                const elementoOriginalObj = todosElementos.find(el => (el.designacao || el.nome) === nomeElemento);
                if (!elementoOriginalObj) {
                    alert("Elemento selecionado n√£o encontrado na base de dados de elementos.");
                    return;
                }

                const designacaoData = {
                    nome: nomeElemento,
                    elementoId: elementoOriginalObj.id,
                    pessoaA: pA || null, pessoaB: pB || null, pessoaC: pC || null,
                    participantes: participantes, data: dataStr, dia: dia.padStart(2, '0'),
                    mes: mes.padStart(2, '0'), ano: ano, criadoEm: serverTimestamp()
                };
                try {
                    const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                     if (!isNaN(dateObj.getTime())) {
                        designacaoData.semanaISO = getISOWeek(dateObj);
                     } else {
                        console.warn("Data inv√°lida ao criar designa√ß√£o, semanaISO n√£o ser√° definida:", dataStr);
                        designacaoData.semanaISO = null;
                     }
                } catch(error) {
                     console.warn("Erro ao calcular semanaISO na cria√ß√£o da designa√ß√£o:", error);
                     designacaoData.semanaISO = null;
                }

                try {
                    await addDoc(collection(db, "designacoes"), designacaoData);
                    alert("Designa√ß√£o criada com sucesso!");
                    formCriarDesignacao.reset();
                    fecharModal(modalDesignacao);
                    if (pessoaSelecionadaAtual && (pessoaSelecionadaAtual.nome === pA || pessoaSelecionadaAtual.nome === pB || pessoaSelecionadaAtual.nome === pC)) {
                        await carregarDesignacoesDaPessoa(pessoaSelecionadaAtual.id);
                    }
                    if (todasDesignacoesGlobaisCarregadas) todasDesignacoesGlobaisCarregadas = false;
                } catch (error) { console.error("Erro ao criar designa√ß√£o: ", error); alert("Erro: " + error.message); }
            });
        }

        // --- Gerenciar Pessoas ---
        async function abrirModalGerenciarPessoas() {
            if (!modalGerenciarPessoas) return;
            abrirModal(modalGerenciarPessoas);
            renderListaGerenciarPessoas();
        }

        function renderListaGerenciarPessoas() {
            if (!listaGerenciarPessoasUl) return;
            listaGerenciarPessoasUl.innerHTML = '';
            todasPessoas.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(pessoa => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="pessoa-nome">${pessoa.nome}</span>
                    <span class="pessoa-status-visivel ${pessoa.estaVisivel === false ? 'oculta' : ''}">
                        ${pessoa.estaVisivel === false ? '(Oculta)' : ''}
                    </span>
                    <div class="pessoa-actions">
                        <button class="btn-toggle-visibilidade ${pessoa.estaVisivel === false ? 'mostrar' : ''}" data-id="${pessoa.id}" data-visivel="${pessoa.estaVisivel !== false}">
                            ${pessoa.estaVisivel === false ? 'Mostrar' : 'Ocultar'}
                        </button>
                        <button class="btn-editar-pessoa" data-id="${pessoa.id}">Editar</button>
                        <button class="btn-remover-pessoa" data-id="${pessoa.id}">Remover</button>
                    </div>
                `;
                listaGerenciarPessoasUl.appendChild(li);
            });
            listaGerenciarPessoasUl.querySelectorAll('.btn-toggle-visibilidade').forEach(btn => btn.addEventListener('click', async (e) => {
                await toggleVisibilidadePessoa(e.target.dataset.id, !(e.target.dataset.visivel === 'true'));
            }));
            listaGerenciarPessoasUl.querySelectorAll('.btn-editar-pessoa').forEach(btn => btn.addEventListener('click', (e) => editarPessoa(e.target.dataset.id)));
            listaGerenciarPessoasUl.querySelectorAll('.btn-remover-pessoa').forEach(btn => btn.addEventListener('click', async (e) => {
                 if (confirm("Tem certeza? Remover√° a pessoa de futuras sele√ß√µes, mas n√£o de designa√ß√µes passadas.")) await removerPessoa(e.target.dataset.id);
            }));
        }

        async function toggleVisibilidadePessoa(pessoaId, novoEstadoVisibilidade) {
            try {
                await updateDoc(doc(db, "pessoas", pessoaId), { estaVisivel: novoEstadoVisibilidade });
                await carregarPessoas();
                renderListaGerenciarPessoas();
            } catch (error) { console.error("Erro ao alterar visibilidade: ", error); alert("Erro."); }
        }

        function resetarColunaDetalhes() {
            console.log("Resetando a coluna de detalhes para a vis√£o inicial.");
            const pessoasAtivas = document.querySelectorAll('#lista-pessoas li.active');
            pessoasAtivas.forEach(li => {
                li.classList.remove('active');
            });
            pessoaSelecionadaAtual = null;
            if (colunaDetalhesDiv && colunaDetalhesContent) {
                colunaDetalhesDiv.innerHTML = '';
                colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                colunaDetalhesContent.style.display = 'flex';
            }
        }

        const tituloPessoasH2 = document.querySelector('#coluna-pessoas h2');
        if (tituloPessoasH2) {
            tituloPessoasH2.addEventListener('click', resetarColunaDetalhes);
        }

        function editarPessoa(pessoaId) {
            const pessoa = todasPessoas.find(p => p.id === pessoaId);
            if (!pessoa) { alert("Pessoa n√£o encontrada."); return; }
            formCriarPessoa.reset();
            pessoaIdEditInput.value = pessoa.id;
            nomePessoaInput.value = pessoa.nome;
            idiomaPessoaSelect.value = pessoa.idioma || 'Portugu√™s';
            generoPessoaSelect.value = pessoa.genero || 'Masculino';
            cargoPessoaSelect.value = pessoa.cargo || 'Publicador';
            pregacaoPessoaSelect.value = pessoa.pregacao || '';
            modalPessoaTitulo.textContent = 'Editar Pessoa';
            btnSubmitPessoa.textContent = 'Salvar Altera√ß√µes';
            fecharModal(modalGerenciarPessoas);
            abrirModal(modalPessoa);
        }

        async function removerPessoa(pessoaId) {
            try {
                await deleteDoc(doc(db, "pessoas", pessoaId));
                alert("Pessoa removida.");
                await carregarPessoas();
                renderListaGerenciarPessoas();
                 if (pessoaSelecionadaAtual && pessoaSelecionadaAtual.id === pessoaId) {
                    pessoaSelecionadaAtual = null;
                    colunaDetalhesDiv.innerHTML = '';
                    colunaDetalhesDiv.appendChild(colunaDetalhesContent);
                    colunaDetalhesContent.style.display = 'flex';
                }
            } catch (error) { console.error("Erro ao remover pessoa: ", error); alert("Erro."); }
        }

        function initGsPessoasCustomMultiselect() {
            if (!gsPessoasSelectMulti || !gsPessoasSearchInputCustom || !gsPessoasDropdownCustomDiv || !gsSelectedPessoasAreaDiv) {
                console.warn("Elementos do custom multi-select de pessoas n√£o encontrados.");
                return;
            }
            if (gsPessoasSelectMulti.options.length === 0 && todasPessoas.length > 0) {
                popularDropdownsPessoasNosModais();
            }

            availablePessoasForCustomSelect = Array.from(gsPessoasSelectMulti.options).map(opt => ({
                id: opt.value,
                nome: opt.textContent
            }));

            gsPessoasSearchInputCustom.removeEventListener('input', handleGsPessoasSearch);
            gsPessoasSearchInputCustom.addEventListener('input', handleGsPessoasSearch);

            gsPessoasSearchInputCustom.removeEventListener('focus', openDropdownAndRender);
            gsPessoasSearchInputCustom.addEventListener('focus', openDropdownAndRender);
            
            updateSelectedPessoasTagsDisplay();
        }


  let availableElementosForTopSelect = [];

      

      

function initGsTopElementosCheckboxMultiselect() {
    // Valida√ß√µes b√°sicas
    if (!gsTopPessoasElementoMultiHidden || !gsTopElementosOptionsList || todosElementos.length === 0) return;

    // 1. Limpa e Re-popula a lista (Isso deve acontecer sempre para atualizar novos elementos)
    gsTopElementosOptionsList.innerHTML = '';
    gsTopPessoasElementoMultiHidden.innerHTML = '';

    todosElementos.forEach(el => {
        const elNome = el.designacao || el.nome;

        // Cria item visual da lista
        const listItem = document.createElement('li');
        listItem.className = 'dropdown-item';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `el-check-${el.id}`;
        checkbox.value = elNome;
        checkbox.checked = true; // Pr√©-selecionado por padr√£o

        const label = document.createElement('label');
        label.htmlFor = `el-check-${el.id}`;
        label.textContent = elNome;
        label.style.cursor = 'pointer'; // Melhora UX
        
        // Impede que clicar no checkbox/label feche o dropdown
        checkbox.addEventListener('click', (e) => e.stopPropagation());
        label.addEventListener('click', (e) => e.stopPropagation());

        listItem.appendChild(checkbox);
        listItem.appendChild(label);
        gsTopElementosOptionsList.appendChild(listItem);

        // Cria a op√ß√£o correspondente no select oculto (para l√≥gica interna)
        const option = new Option(elNome, elNome);
        option.selected = true; 
        gsTopPessoasElementoMultiHidden.appendChild(option);

        // Sincroniza checkbox visual com select oculto
        checkbox.addEventListener('change', () => {
            option.selected = checkbox.checked;
            updateGsTopElementosDisplayText();
        });
    });

    updateGsTopElementosDisplayText();

    // =========================================================
    //          ‚Üì‚Üì‚Üì CORRE√á√ÉO DO BUG ‚Üì‚Üì‚Üì
    // =========================================================
    // Verifica se os "Listeners" (eventos de clique) j√° foram adicionados.
    // Se sim, paramos aqui para n√£o adicionar de novo e quebrar o toggle.
    if (gsTopElementosCheckboxMultiselect.dataset.hasListeners === 'true') {
        return; 
    }

    // --- Eventos do Container (Abrir/Fechar) ---
    gsTopElementosCheckboxMultiselect.addEventListener('click', (e) => {
        // Se o clique foi DENTRO da lista de op√ß√µes (ex: scrollbar), n√£o faz toggle
        if (gsTopElementosOptions.contains(e.target)) return;
        
        gsTopElementosOptions.classList.toggle('visible');
    });

    // --- Fechar ao clicar fora ---
    document.addEventListener('click', (e) => {
        if (!gsTopElementosCheckboxMultiselect.contains(e.target)) {
            gsTopElementosOptions.classList.remove('visible');
        }
    });

    // --- Bot√µes de A√ß√£o (Selecionar Todos / Limpar) ---
    const btnSelectAll = document.getElementById('gs-top-elementos-select-all');
    const btnDeselectAll = document.getElementById('gs-top-elementos-deselect-all');

    if (btnSelectAll) {
        btnSelectAll.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation(); // Impede fechar o menu
            gsTopElementosOptionsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            Array.from(gsTopPessoasElementoMultiHidden.options).forEach(opt => opt.selected = true);
            updateGsTopElementosDisplayText();
        });
    }

    if (btnDeselectAll) {
        btnDeselectAll.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation(); // Impede fechar o menu
            gsTopElementosOptionsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            Array.from(gsTopPessoasElementoMultiHidden.options).forEach(opt => opt.selected = false);
            updateGsTopElementosDisplayText();
        });
    }

    // Marca o elemento para indicar que os eventos j√° foram configurados
    gsTopElementosCheckboxMultiselect.dataset.hasListeners = 'true';
}

        function updateGsTopElementosDisplayText() {
            if (!gsTopElementosDisplayText || !gsTopPessoasElementoMultiHidden) return;
            
            const selectedCount = gsTopPessoasElementoMultiHidden.selectedOptions.length;
            const totalCount = gsTopPessoasElementoMultiHidden.options.length;

            if (selectedCount === totalCount) {
                gsTopElementosDisplayText.textContent = 'Todos selecionados';
            } else if (selectedCount === 0) {
                gsTopElementosDisplayText.textContent = 'Nenhum selecionado';
            } else {
                gsTopElementosDisplayText.textContent = `${selectedCount} de ${totalCount} selecionados`;
            }
        }

      
function initGsIndivElementosCheckboxMultiselect() {
            if (!gsIndivElementoMultiHidden || !gsIndivElementosOptionsList || todosElementos.length === 0) return;

            gsIndivElementosOptionsList.innerHTML = '';
            gsIndivElementoMultiHidden.innerHTML = '';

            todosElementos.forEach(el => {
                const elNome = el.designacao || el.nome;

                const listItem = document.createElement('li');
                listItem.className = 'dropdown-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `el-indiv-check-${el.id}`;
                checkbox.value = elNome;
                checkbox.checked = true; // Pr√©-selecionado
                const label = document.createElement('label');
                label.htmlFor = `el-indiv-check-${el.id}`;
                label.textContent = elNome;
                
                listItem.appendChild(checkbox);
                listItem.appendChild(label);
                gsIndivElementosOptionsList.appendChild(listItem);

                const option = new Option(elNome, elNome);
                option.selected = true; // Pr√©-selecionado
                gsIndivElementoMultiHidden.appendChild(option);

                checkbox.addEventListener('change', () => {
                    option.selected = checkbox.checked;
                    updateGsIndivElementosDisplayText();
                });
            });

            updateGsIndivElementosDisplayText();

            gsIndivElementosCheckboxMultiselect.addEventListener('click', (e) => {
                if (!gsIndivElementosOptions.contains(e.target)) {
                    gsIndivElementosOptions.classList.toggle('visible');
                }
            });

            document.addEventListener('click', (e) => {
                if (!gsIndivElementosCheckboxMultiselect.contains(e.target)) {
                    gsIndivElementosOptions.classList.remove('visible');
                }
            });

            document.getElementById('gs-indiv-elementos-select-all').addEventListener('click', (e) => {
                e.stopPropagation();
                gsIndivElementosOptionsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                Array.from(gsIndivElementoMultiHidden.options).forEach(opt => opt.selected = true);
                updateGsIndivElementosDisplayText();
            });

            document.getElementById('gs-indiv-elementos-deselect-all').addEventListener('click', (e) => {
                e.stopPropagation();
                gsIndivElementosOptionsList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                Array.from(gsIndivElementoMultiHidden.options).forEach(opt => opt.selected = false);
                updateGsIndivElementosDisplayText();
            });
        }

        function updateGsIndivElementosDisplayText() {
            if (!gsIndivElementosDisplayText || !gsIndivElementoMultiHidden) return;
            
            const selectedCount = gsIndivElementoMultiHidden.selectedOptions.length;
            const totalCount = gsIndivElementoMultiHidden.options.length;

            if (selectedCount === totalCount) {
                gsIndivElementosDisplayText.textContent = 'Todos selecionados';
            } else if (selectedCount === 0) {
                gsIndivElementosDisplayText.textContent = 'Nenhum selecionado';
            } else {
                gsIndivElementosDisplayText.textContent = `${selectedCount} de ${totalCount} selecionados`;
            }
        }
      

      

        function openDropdownAndRender() {
            renderGsPessoasDropdown(gsPessoasSearchInputCustom.value);
            gsPessoasDropdownCustomDiv.style.display = 'block';
        }

        function handleGsPessoasSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            renderGsPessoasDropdown(searchTerm);
            gsPessoasDropdownCustomDiv.style.display = 'block';
        }

        function renderGsPessoasDropdown(searchTerm = "") {
            if (!gsPessoasDropdownCustomDiv) return;
            const selectedPessoaIds = Array.from(gsPessoasSelectMulti.selectedOptions).map(opt => opt.value);
            const filteredPessoas = availablePessoasForCustomSelect.filter(pessoa =>
                pessoa.nome.toLowerCase().includes(searchTerm)
            );
            gsPessoasDropdownCustomDiv.innerHTML = '';
            const ul = document.createElement('ul');
            if (filteredPessoas.length === 0) {
                const li = document.createElement('li');
                li.textContent = searchTerm ? 'Nenhuma pessoa encontrada.' : 'Nenhuma pessoa dispon√≠vel.';
                li.style.color = '#777';
                ul.appendChild(li);
            } else {
                 filteredPessoas.forEach(pessoa => {
                    const li = document.createElement('li');
                    li.textContent = pessoa.nome;
                    li.dataset.pessoaId = pessoa.id;
                    if (selectedPessoaIds.includes(pessoa.id)) {
                        li.classList.add('disabled');
                    } else {
                        li.addEventListener('click', () => selectPessoaForComparison(pessoa));
                    }
                    ul.appendChild(li);
                });
            }
            gsPessoasDropdownCustomDiv.appendChild(ul);
        }

        function selectPessoaForComparison(pessoa) {
            if (!gsPessoasSelectMulti) return;
            const option = Array.from(gsPessoasSelectMulti.options).find(opt => opt.value === pessoa.id);
            if (option) {
                option.selected = true;
            }
            updateSelectedPessoasTagsDisplay();
            gsPessoasSearchInputCustom.value = '';
            gsPessoasDropdownCustomDiv.style.display = 'none';
            gsPessoasSearchInputCustom.focus();
        }

        function removePessoaFromComparison(pessoaId) {
            if (!gsPessoasSelectMulti) return;
            const option = Array.from(gsPessoasSelectMulti.options).find(opt => opt.value === pessoaId);
            if (option) {
                option.selected = false;
            }
            updateSelectedPessoasTagsDisplay();
        }

        function updateSelectedPessoasTagsDisplay() {
            if (!gsSelectedPessoasAreaDiv || !gsPessoasSelectMulti) return;
            gsSelectedPessoasAreaDiv.innerHTML = '';
            const selectedOptions = Array.from(gsPessoasSelectMulti.selectedOptions);
            selectedOptions.forEach(option => {
                const tagDiv = document.createElement('div');
                tagDiv.className = 'pessoa-tag';
                tagDiv.textContent = option.textContent;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-tag-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.type = 'button';
                removeBtn.title = `Remover ${option.textContent}`;
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removePessoaFromComparison(option.value);
                });
                tagDiv.appendChild(removeBtn);
                gsSelectedPessoasAreaDiv.appendChild(tagDiv);
            });
        }


function setupGsPessoasSubmenu() {
            const gsPessoasContentDiv = document.getElementById('gs-pessoas-content');
            if (!gsPessoasContentDiv) {
                console.warn("Div gs-pessoas-content n√£o encontrada para configurar submenu.");
                return;
            }
            const submenuButtons = gsPessoasContentDiv.querySelectorAll('.gs-old-submenu-button');
            const submenuSections = gsPessoasContentDiv.querySelectorAll('#gs-pessoas-content > .stats-card-section');
            submenuButtons.forEach(button => {
                button.addEventListener('click', () => {
                    submenuButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const targetSectionId = button.dataset.submenuTarget;
                    submenuSections.forEach(section => {
                        section.classList.remove('active-submenu-section');
                        if (section.id === targetSectionId) {
                            section.classList.add('active-submenu-section');
                        }
                    });
                });
            });
            
            let activeSubmenuButton = gsPessoasContentDiv.querySelector('.gs-old-submenu-button.active');
            if (!activeSubmenuButton && submenuButtons.length > 0) {
                submenuButtons[0].classList.add('active');
                activeSubmenuButton = submenuButtons[0];
            }
            
            submenuSections.forEach(section => section.classList.remove('active-submenu-section'));
            
            if (activeSubmenuButton) {
                const targetId = activeSubmenuButton.dataset.submenuTarget;
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active-submenu-section');
                }
            }
        }


        function setupGsOldSubmenu() {
            const gsOldContentDiv = document.getElementById('gs-old-content');
            if (!gsOldContentDiv) {
                console.warn("Div gs-old-content n√£o encontrada para configurar submenu.");
                return;
            }
            const submenuButtons = gsOldContentDiv.querySelectorAll('.gs-old-submenu-button');
            const submenuSections = gsOldContentDiv.querySelectorAll('#gs-old-content > .stats-card-section');
            submenuButtons.forEach(button => {
                button.addEventListener('click', () => {
                    submenuButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const targetSectionId = button.dataset.submenuTarget;
                    submenuSections.forEach(section => {
                        section.classList.remove('active-submenu-section');
                        if (section.id === targetSectionId) {
                            section.classList.add('active-submenu-section');
                        }
                    });
                });
            });
            
            let activeSubmenuButton = gsOldContentDiv.querySelector('.gs-old-submenu-button.active');
            if (!activeSubmenuButton && submenuButtons.length > 0) {
                submenuButtons[0].classList.add('active');
                activeSubmenuButton = submenuButtons[0];
            }
            
            submenuSections.forEach(section => section.classList.remove('active-submenu-section'));
            
            if (activeSubmenuButton) {
                const targetId = activeSubmenuButton.dataset.submenuTarget;
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.classList.add('active-submenu-section');
                }
            }
        }

 globalStatsTabButtons.forEach(button => {
    button.addEventListener('click', () => {
        // L√≥gica padr√£o para alternar as abas principais (Vis√£o Geral, Top, Pessoas, etc.)
        globalStatsTabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        const targetContentId = button.dataset.tabTarget;
        globalStatsTabContents.forEach(content => {
            content.classList.remove('active');
            if (content.id === targetContentId) {
                content.classList.add('active');
            }
        });

        // Executa a l√≥gica espec√≠fica para a aba que foi clicada
        if (targetContentId === 'gs-total-content') {
            atualizarAbaTotalGlobalStats();
        } else if (targetContentId === 'gs-pessoas-content') {
            initGsPessoasCustomMultiselect();
            setupGsPessoasSubmenu();
        } else if (targetContentId === 'gs-designacoes-content') {
            popularListaElementosAbaDesignacoes();
        } else if (targetContentId === 'gs-old-content') {
            setupGsOldSubmenu();
        } 
        // =========================================================
        //          ‚Üì‚Üì‚Üì ESTE √â O BLOCO CORRIGIDO ‚Üì‚Üì‚Üì
        // =========================================================
        else if (targetContentId === 'gs-discursos-content') {
            const discursosContentDiv = document.getElementById('gs-discursos-content');
            const filtrosContainer = document.getElementById('gs-discursos-filtros-container');
            
            // 1. Gera os filtros na tela (s√≥ na primeira vez que a aba √© aberta)
            if (!filtrosContainer.querySelector('.filters-container')) {
                filtrosContainer.innerHTML = generateDiscursosFiltersHTML();
                populateDiscursosFilters();
                
                // Adiciona a funcionalidade ao bot√£o "Aplicar" dos filtros
                document.getElementById('btn-gs-discursos-aplicar').addEventListener('click', () => {
                    const activeSubmenu = discursosContentDiv.querySelector('.gs-old-submenu-button.active');
                    if (activeSubmenu) {
                        activeSubmenu.click(); // Simula um clique na sub-aba ativa para recarregar com os novos filtros
                    }
                });
            }
            
            // 2. Chama a fun√ß√£o que adiciona o clique √†s sub-abas
            setupGsDiscursosSubmenu();

            // 3. Carrega o conte√∫do da primeira sub-aba (ou da que j√° estiver ativa)
            const activeSubmenu = discursosContentDiv.querySelector('.gs-old-submenu-button.active');
            const submenuButtons = discursosContentDiv.querySelectorAll('.gs-old-submenu-button');

            if (activeSubmenu) {
                activeSubmenu.click();
            } else if (submenuButtons.length > 0) {
                // Se nenhuma estiver ativa, clica na primeira por padr√£o
                submenuButtons[0].click();
            }
        }
        // =========================================================
        //          ‚Üë‚Üë‚Üë FIM DO BLOCO CORRIGIDO ‚Üë‚Üë‚Üë
        // =========================================================
    });
});



        document.addEventListener('click', (e) => {
            if (gsPessoasCustomMultiselectDiv && !gsPessoasCustomMultiselectDiv.contains(e.target) && gsPessoasDropdownCustomDiv) {
                gsPessoasDropdownCustomDiv.style.display = 'none';
            }
        });

        async function carregarTodasDesignacoesParaStatsGlobais() {
            if (todasDesignacoesGlobaisCarregadas) {
                console.log("carregarTodasDesignacoesParaStatsGlobais: J√° carregadas.");
                return;
            }
            console.log("carregarTodasDesignacoesParaStatsGlobais: Iniciando.");
            try {
                const querySnapshot = await getDocs(collection(db, "designacoes"));
                todasDesignacoesGlobais = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (!data.semanaISO && data.data) {
                        try {
                            const [dia, mes, ano] = data.data.split('/');
                            const dateObj = new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia));
                             if (!isNaN(dateObj.getTime())) {
                                data.semanaISO = getISOWeek(dateObj);
                            } else {
                                data.semanaISO = null;
                            }
                        } catch (e) {
                            data.semanaISO = null;
                        }
                    }
                    todasDesignacoesGlobais.push({ id: docSnap.id, ...data });
                });
                todasDesignacoesGlobaisCarregadas = true;
                console.log(`carregarTodasDesignacoesParaStatsGlobais: ${todasDesignacoesGlobais.length} designa√ß√µes.`);
            } catch (error) {
                console.error("Erro ao carregar todas as designa√ß√µes globais: ", error);
                alert("Falha ao carregar dados para estat√≠sticas globais.");
                todasDesignacoesGlobaisCarregadas = false;
            }
        }

        function popularFiltrosStatsGlobais() {
            if (!todasDesignacoesGlobaisCarregadas || todasDesignacoesGlobais.length === 0) return;
            if (todosElementos.length === 0 && !document.getElementById('gs-total-filtro-elemento-tipo')) { }
            if (todasPessoas.length === 0 && !document.getElementById('gs-pessoa-esp-select')) { }

            const mesesUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.mes).filter(Boolean))].sort((a,b) => parseInt(a) - parseInt(b));
            const anosUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));
            const elementosNomes = todosElementos.length > 0 ? [...new Set(todosElementos.map(el => el.designacao || el.nome))].sort((a,b) => a.localeCompare(b)) : [];

            const getNomeMes = (numMes) => {
                if (!numMes) return "";
                try {
                    return new Date(2000, parseInt(numMes) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
                } catch(e) { return "";}
            }

            [gsTopPessoasMesSelect, gsTodasDesigMesSelect, gsPessoaEspMesFiltroSelect, gsTotalFiltroMesSelect, gsPessoasFiltroMesSelect, gsDesignacoesFiltroMesSelect].forEach(select => {
                if (!select) return;
                const currentVal = select.value;
                select.innerHTML = '<option value="">Todos</option>';
                mesesUnicos.forEach(mes => select.appendChild(new Option(getNomeMes(mes).replace(/^\w/, c => c.toUpperCase()), String(mes).padStart(2,'0'))));
                if (Array.from(select.options).some(opt => opt.value === currentVal)) select.value = currentVal; else select.value = "";
            });

            [gsTopPessoasAnoSelect, gsTodasDesigAnoSelect, gsPessoaEspAnoFiltroSelect, gsTotalFiltroAnoSelect, gsPessoasFiltroAnoSelect, gsDesignacoesFiltroAnoSelect].forEach(select => {
                if (!select) return;
                select.innerHTML = '<option value="">Todos</option>';
                anosUnicos.forEach(ano => select.appendChild(new Option(ano, ano)));
                if (anosUnicos.length > 0) {
                    select.value = anosUnicos[0];
                } else {
                    select.value = "";
                }
            });

            [gsTodasDesigElementoSelect, gsPessoaEspElementoFiltroSelect, gsTopPessoasElementoSelect].forEach(select => {
                if (!select) return;
                const currentVal = select.value;
                select.innerHTML = '<option value="">Todos Elementos</option>';
                elementosNomes.forEach(nomeEl => select.appendChild(new Option(nomeEl, nomeEl)));
                if (Array.from(select.options).some(opt => opt.value === currentVal)) select.value = currentVal; else select.value = "";
            });

            console.log("Filtros do modal de estat√≠sticas globais populados/atualizados.");
        }

        function getPessoaById(id) {
            return todasPessoas.find(p => p.id === id);
        }

        function getElementoByNome(nome) {
            return todosElementos.find(el => (el.designacao || el.nome) === nome);
        }



  async function atualizarAbaTotalGlobalStats() {
            if (!todasDesignacoesGlobaisCarregadas) {
                await carregarTodasDesignacoesParaStatsGlobais();
                if (!todasDesignacoesGlobaisCarregadas) {
                     gsTotalNumDesignacoesSpan.textContent = "-";
                    return;
                }
            }
            
            const anoFiltro = document.getElementById('gs-total-filtro-ano').value;
            const mesFiltro = document.getElementById('gs-total-filtro-mes').value;
            // --- LINHA CORRIGIDA ---
            const tipoElementoFiltro = document.getElementById('gs-total-filtro-tipo-elemento').value;
            // --- FIM DA CORRE√á√ÉO ---
            const generoReuniaoFiltro = document.getElementById('gs-total-filtro-genero-reuniao').value;
            const generoParticipanteFiltro = document.getElementById('gs-total-filtro-genero-participante').value;
            const idiomaParticipanteFiltro = document.getElementById('gs-total-filtro-idioma-participante').value;

            const designacoesFiltradas = todasDesignacoesGlobais.filter(d => {
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2, '0') === String(mesFiltro).padStart(2, '0');
                if (!matchAno || !matchMes) return false;

                const elementoObj = getElementoByNome(d.nome);
                const matchTipoElemento = !tipoElementoFiltro || (elementoObj && elementoObj.tipo === tipoElementoFiltro);
                const matchGeneroReuniao = !generoReuniaoFiltro || (elementoObj && elementoObj.generoReuniao === generoReuniaoFiltro);
                if (!matchTipoElemento || !matchGeneroReuniao) return false;

                if (!generoParticipanteFiltro && !idiomaParticipanteFiltro) {
                    return true;
                }
                
                if (d.participantes) {
                    return Object.keys(d.participantes).some(nomeParticipante => {
                        const pessoa = todasPessoas.find(p => p.nome === nomeParticipante);
                        if (pessoa) {
                            const matchGeneroParticipante = !generoParticipanteFiltro || pessoa.genero === generoParticipanteFiltro;
                            const matchIdiomaParticipante = !idiomaParticipanteFiltro || pessoa.idioma === idiomaParticipanteFiltro;
                            return matchGeneroParticipante && matchIdiomaParticipante;
                        }
                        return false;
                    });
                }
                
                return false;
            });
            // ... (o resto da fun√ß√£o continua igual)
            gsTotalNumDesignacoesSpan.textContent = designacoesFiltradas.length;
            let countMasc = 0, countFem = 0, countPt = 0, countIt = 0, countOutroIdioma = 0;

            designacoesFiltradas.forEach(desig => {
                Object.keys(desig.participantes || {}).forEach(nomeParticipante => {
                    const pessoa = todasPessoas.find(p => p.nome === nomeParticipante);
                    if (pessoa) {
                        if (pessoa.genero === 'Masculino') countMasc++;
                        if (pessoa.genero === 'Feminino') countFem++;
                        if (pessoa.idioma === 'Portugu√™s') countPt++;
                        else if (pessoa.idioma === 'Italiano') countIt++;
                        else if (pessoa.idioma === 'Outro') countOutroIdioma++;
                    }
                });
            });
            gsTotalNumDesigMascSpan.textContent = countMasc;
            gsTotalNumDesigFemSpan.textContent = countFem;
            gsTotalNumDesigPtSpan.textContent = countPt;
            gsTotalNumDesigItSpan.textContent = countIt;
            gsTotalNumDesigOutroIdiomaSpan.textContent = countOutroIdioma;
            
            const cardOutroIdioma = gsTotalNumDesigOutroIdiomaSpan.closest('.stats-kpi-card');
            if (cardOutroIdioma) {
                cardOutroIdioma.style.display = (countOutroIdioma === 0) ? 'none' : 'block';
            }

            const numMesesConsiderados = (Object.keys(designacoesFiltradas.reduce((acc, d) => { acc[`${d.ano}-${d.mes}`] = true; return acc; }, {})).length) || 1;
            gsTotalMediaDesignacoesSpan.textContent = (designacoesFiltradas.length / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigMascSpan.textContent = (countMasc / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigFemSpan.textContent = (countFem / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigPtSpan.textContent = (countPt / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigItSpan.textContent = (countIt / numMesesConsiderados).toFixed(1);
            gsTotalMediaDesigOutroSpan.textContent = (countOutroIdioma / numMesesConsiderados).toFixed(1);
            
            const cardMediaOutroIdioma = gsTotalMediaDesigOutroSpan.closest('.stats-kpi-card');
            if (cardMediaOutroIdioma) {
                cardMediaOutroIdioma.style.display = (countOutroIdioma === 0) ? 'none' : 'block';
            }

            const totalDesignacoesGlobal = todasDesignacoesGlobais.length;
            const totalParticipacoesFiltradas = countMasc + countFem;

            const percFiltradas = totalDesignacoesGlobal > 0 ? (designacoesFiltradas.length / totalDesignacoesGlobal) * 100 : 0;
            document.getElementById('gs-total-perc-filtradas').textContent = `${percFiltradas.toFixed(1)}%`;

            const percMasc = totalParticipacoesFiltradas > 0 ? (countMasc / totalParticipacoesFiltradas) * 100 : 0;
            document.getElementById('gs-total-perc-masc').textContent = `${percMasc.toFixed(1)}%`;

            const percFem = totalParticipacoesFiltradas > 0 ? (countFem / totalParticipacoesFiltradas) * 100 : 0;
            document.getElementById('gs-total-perc-fem').textContent = `${percFem.toFixed(1)}%`;

            if (totalParticipacoesFiltradas > 0) {
                const percPt = (countPt / totalParticipacoesFiltradas) * 100;
                const percIt = (countIt / totalParticipacoesFiltradas) * 100;
                const percOutro = (countOutroIdioma / totalParticipacoesFiltradas) * 100;

                document.getElementById('gs-total-perc-pt').textContent = `${percPt.toFixed(1)}%`;
                document.getElementById('gs-total-perc-it').textContent = `${percIt.toFixed(1)}%`;
                document.getElementById('gs-total-perc-outro').textContent = `${percOutro.toFixed(1)}%`;
            } else {
                document.getElementById('gs-total-perc-pt').textContent = "-";
                document.getElementById('gs-total-perc-it').textContent = "-";
                document.getElementById('gs-total-perc-outro').textContent = "-";
            }

            const cardPercOutroIdioma = document.getElementById('gs-total-perc-outro').closest('.stats-kpi-card');
            if (cardPercOutroIdioma) {
                cardPercOutroIdioma.style.display = (countOutroIdioma > 0) ? 'block' : 'none';
            }
            const dadosGraficoTotal = {};
            const dadosGraficoGenero = { Masculino: {}, Feminino: {} };
            const dadosGraficoIdioma = { Portugu√™s: {}, Italiano: {}, Outro: {} };

            designacoesFiltradas.forEach(d => {
                const chaveMesAno = `${d.ano}-${String(d.mes).padStart(2,'0')}`;
                dadosGraficoTotal[chaveMesAno] = (dadosGraficoTotal[chaveMesAno] || 0) + 1;

                Object.keys(d.participantes || {}).forEach(nomeParticipante => {
                     const pessoa = todasPessoas.find(p => p.nome === nomeParticipante);
                     if(pessoa){
                        if (pessoa.genero === 'Masculino') {
                            dadosGraficoGenero.Masculino[chaveMesAno] = (dadosGraficoGenero.Masculino[chaveMesAno] || 0) + 1;
                        } else if (pessoa.genero === 'Feminino') {
                            dadosGraficoGenero.Feminino[chaveMesAno] = (dadosGraficoGenero.Feminino[chaveMesAno] || 0) + 1;
                        }
                        if (pessoa.idioma === 'Portugu√™s') {
                            dadosGraficoIdioma.Portugu√™s[chaveMesAno] = (dadosGraficoIdioma.Portugu√™s[chaveMesAno] || 0) + 1;
                        } else if (pessoa.idioma === 'Italiano') {
                            dadosGraficoIdioma.Italiano[chaveMesAno] = (dadosGraficoIdioma.Italiano[chaveMesAno] || 0) + 1;
                        } else if (pessoa.idioma === 'Outro') {
                             dadosGraficoIdioma.Outro[chaveMesAno] = (dadosGraficoIdioma.Outro[chaveMesAno] || 0) + 1;
                        }
                     }
                });
            });

            const sortedLabels = Object.keys(dadosGraficoTotal).sort();

            gsTotalChartDesignacoesMes = renderChart(gsTotalChartDesignacoesMes, 'gs-total-chart-designacoes-mes', 'line',
                { labels: sortedLabels, datasets: [{ label: 'Total Designa√ß√µes/M√™s', data: sortedLabels.map(l => dadosGraficoTotal[l] || 0), tension: 0.1, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.1)'}] }
            );
            gsTotalChartDesignacoesGeneroMes = renderChart(gsTotalChartDesignacoesGeneroMes, 'gs-total-chart-designacoes-genero-mes', 'bar',
                { labels: sortedLabels, datasets: [
                    { label: 'Masculino', data: sortedLabels.map(l => dadosGraficoGenero.Masculino[l] || 0), backgroundColor: '#007bff' },
                    { label: 'Feminino', data: sortedLabels.map(l => dadosGraficoGenero.Feminino[l] || 0), backgroundColor: '#fd7e14' }
                ]}, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } } } }
            );
             gsTotalChartDesignacoesIdiomaMes = renderChart(gsTotalChartDesignacoesIdiomaMes, 'gs-total-chart-designacoes-idioma-mes', 'bar',
                { labels: sortedLabels, datasets: [
                    { label: 'Portugu√™s', data: sortedLabels.map(l => dadosGraficoIdioma.Portugu√™s[l] || 0), backgroundColor: '#28a745' },
                    { label: 'Italiano', data: sortedLabels.map(l => dadosGraficoIdioma.Italiano[l] || 0), backgroundColor: '#ffc107' },
                    { label: 'Outro', data: sortedLabels.map(l => dadosGraficoIdioma.Outro[l] || 0), backgroundColor: '#6c757d' }
                ]}, { scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { precision: 0 } } } }
            );
        }




    async function compararPessoasSelecionadas() {
            setSectionLoadingState('gs-pessoas', true, 'btn-gs-pessoas-comparar');
            if (!gsPessoasSelectMulti || !gsPessoasComparisonAreaDiv) {
                 setSectionLoadingState('gs-pessoas', false, 'btn-gs-pessoas-comparar');
                return;
            }

            const idsPessoasSelecionadas = Array.from(gsPessoasSelectMulti.selectedOptions).map(opt => opt.value);
            if (idsPessoasSelecionadas.length === 0) {
                gsPessoasComparisonAreaDiv.innerHTML = '<p style="text-align:center; color:#777;">Selecione pelo menos uma pessoa para comparar.</p>';
                setSectionLoadingState('gs-pessoas', false, 'btn-gs-pessoas-comparar');
                return;
            }

            // Usa os filtros corretos da aba "Pessoas"
            const anoFiltro = gsPessoasFiltroAnoSelect.value;
            const mesFiltro = gsPessoasFiltroMesSelect.value;
            const semanaFiltro = gsPessoasFiltroSemanaInput.value;
            const generoFiltro = gsPessoasFiltroGeneroSelect.value;
            const idiomaFiltro = gsPessoasFiltroIdiomaSelect.value;
            const tipoFiltro = document.getElementById('gs-pessoas-filtro-tipo').value;

            gsPessoasComparisonAreaDiv.innerHTML = '';

            for (const pessoaId of idsPessoasSelecionadas) {
                const pessoaObj = getPessoaById(pessoaId);
                if (!pessoaObj) continue;

                if (generoFiltro && pessoaObj.genero !== generoFiltro) continue;
                if (idiomaFiltro && pessoaObj.idioma !== idiomaFiltro) continue;

                let designacoesDaPessoaFiltradas = todasDesignacoesGlobais.filter(d => {
                    if (!d.participantes || !d.participantes[pessoaObj.nome]) return false;
                    const matchAno = !anoFiltro || d.ano === anoFiltro;
                    const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                    let matchSemana = true;
                    if (semanaFiltro) {
                         matchSemana = d.semanaISO === parseInt(semanaFiltro);
                    }
                    const elementoObj = getElementoByNome(d.nome);
                    const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                    return matchAno && matchMes && matchSemana && matchTipo;
                });

                const card = document.createElement('div');
                card.className = 'pessoa-comparison-card';
                let cardHTML = `<h5>${pessoaObj.nome} <small>(${pessoaObj.genero}, ${pessoaObj.idioma})</small></h5><ul>`;
                cardHTML += `<li>Total Designa√ß√µes (filt.): <span class="stat-value">${designacoesDaPessoaFiltradas.length}</span></li>`;
                const contagemElementosPessoa = designacoesDaPessoaFiltradas.reduce((acc, d) => {
                    acc[d.nome] = (acc[d.nome] || 0) + 1;
                    return acc;
                }, {});
                const top3Elementos = Object.entries(contagemElementosPessoa).sort((a,b) => b[1]-a[1]).slice(0,3);
                cardHTML += `<li>Top Elementos:</li><ul>`;
                if (top3Elementos.length > 0) {
                    top3Elementos.forEach(([elNome, count]) => cardHTML += `<li>${elNome}: ${count}</li>`);
                } else {
                    cardHTML += `<li>Nenhum com filtros atuais</li>`;
                }
                cardHTML += `</ul></ul>`;
                card.innerHTML = cardHTML;
                gsPessoasComparisonAreaDiv.appendChild(card);
            }
            if(gsPessoasComparisonAreaDiv.innerHTML === '') {
                 gsPessoasComparisonAreaDiv.innerHTML = '<p style="text-align:center; color:#777;">Nenhuma pessoa corresponde aos filtros de G√™nero/Idioma ou n√£o t√™m designa√ß√µes nos outros filtros.</p>';
            }

            setSectionLoadingState('gs-pessoas', false, 'btn-gs-pessoas-comparar');
        }

 function popularListaElementosAbaDesignacoes() {
            if (!todosElementos || !gsDesignacoesTiposListUl) {
                if(gsDesignacoesTiposListUl) gsDesignacoesTiposListUl.innerHTML = '<li>Nenhum elemento cadastrado ou lista n√£o encontrada.</li>';
                return;
            }
            setSectionLoadingState('gs-designacoes-tipos', true, 'btn-gs-designacoes-aplicar-filtros');
            gsDesignacoesTiposListUl.innerHTML = '';
            
            const diaFiltro = document.getElementById('gs-designacoes-filtro-dia').value;
            const mesFiltro = document.getElementById('gs-designacoes-filtro-mes').value;
            const anoFiltro = document.getElementById('gs-designacoes-filtro-ano').value;
            const semanaFiltro = document.getElementById('gs-designacoes-filtro-semana').value;
            const generoParticipanteFiltro = document.getElementById('gs-designacoes-filtro-genero').value;
            const idiomaParticipanteFiltro = document.getElementById('gs-designacoes-filtro-idioma').value;
            const tipoFiltro = document.getElementById('gs-designacoes-filtro-tipo').value;

            const designacoesParaContagem = todasDesignacoesGlobais.filter(d => {
                const matchDia = !diaFiltro || d.dia === String(diaFiltro).padStart(2, '0');
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchSemana = !semanaFiltro || (d.semanaISO === parseInt(semanaFiltro));
                
                const elementoObj = getElementoByNome(d.nome);
                const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                
                let atendeFiltroParticipante = true;
                if (generoParticipanteFiltro || idiomaParticipanteFiltro) {
                    atendeFiltroParticipante = false;
                    if (d.participantes) {
                        atendeFiltroParticipante = Object.keys(d.participantes).some(nomeP => {
                            const pessoa = todasPessoas.find(p => p.nome === nomeP);
                            if (pessoa) {
                                const matchGeneroEsteP = !generoParticipanteFiltro || pessoa.genero === generoParticipanteFiltro;
                                const matchIdiomaEsteP = !idiomaParticipanteFiltro || pessoa.idioma === idiomaParticipanteFiltro;
                                return matchGeneroEsteP && matchIdiomaEsteP;
                            }
                            return false;
                        });
                    }
                }
                return matchDia && matchMes && matchAno && matchSemana && matchTipo && atendeFiltroParticipante;
            });

            const contagemElementos = designacoesParaContagem.reduce((acc, d) => {
                if (d.nome) {
                    acc[d.nome] = (acc[d.nome] || 0) + 1;
                }
                return acc;
            }, {});

            const elementosOrdenados = Object.keys(contagemElementos).sort((a,b) => a.localeCompare(b));
            
            // --- LINHA ADICIONADA ABAIXO ---
            if (gsDesignacoesElementosCountSpan) gsDesignacoesElementosCountSpan.textContent = elementosOrdenados.length;

            if (elementosOrdenados.length === 0) {
                setSectionLoadingState('gs-designacoes-tipos', false, 'btn-gs-designacoes-aplicar-filtros');
                return;
            }
            
            elementosOrdenados.forEach(nomeEl => {
                const count = contagemElementos[nomeEl];
                const li = document.createElement('li');
                li.innerHTML = `${nomeEl} <span class="count">${count} ocorr√™ncias</span>`;
                li.classList.add('clickable');
                li.dataset.elementoNome = nomeEl;
                li.addEventListener('click', () => {
                    abrirModalInstancias(nomeEl, true);
                });
                gsDesignacoesTiposListUl.appendChild(li);
            });
            
             setSectionLoadingState('gs-designacoes-tipos', false, 'btn-gs-designacoes-aplicar-filtros');
        }

       function abrirModalInstancias(nomeElemento, aplicarFiltrosDaAbaDesignacoes = false) {
            if (!modalInstanciasDesignacao || !modalInstanciasTitulo || !modalInstanciasListUl) return;

            modalInstanciasTitulo.textContent = `Inst√¢ncias de: ${nomeElemento}`;
            modalInstanciasListUl.innerHTML = '<div class="loading-spinner" style="display:block;"></div>';
            abrirModal(modalInstanciasDesignacao);

            let instanciasFiltradas = todasDesignacoesGlobais.filter(d => d.nome === nomeElemento);

            if (aplicarFiltrosDaAbaDesignacoes) {
                const diaFiltro = gsDesignacoesFiltroDiaInput.value;
                const mesFiltro = gsDesignacoesFiltroMesSelect.value;
                const anoFiltro = gsDesignacoesFiltroAnoSelect.value;
                const semanaFiltro = gsDesignacoesFiltroSemanaInput.value;
                const generoFiltroParticipante = gsDesignacoesFiltroGeneroSelect.value;
                const idiomaFiltroParticipante = gsDesignacoesFiltroIdiomaSelect.value;
                // --- IN√çCIO DA ALTERA√á√ÉO ---
                // O filtro de tipo j√° foi aplicado na lista de elementos,
                // mas adicionamos aqui por seguran√ßa e consist√™ncia.
                const tipoFiltro = document.getElementById('gs-designacoes-filtro-tipo').value;
                // --- FIM DA ALTERA√á√ÉO ---

                instanciasFiltradas = instanciasFiltradas.filter(d => {
                    const matchDia = !diaFiltro || d.dia === String(diaFiltro).padStart(2, '0');
                    const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                    const matchAno = !anoFiltro || d.ano === anoFiltro;
                    let matchSemana = true;
                    if (semanaFiltro) {
                         matchSemana = d.semanaISO === parseInt(semanaFiltro);
                    }
                    
                    // --- IN√çCIO DA ALTERA√á√ÉO ---
                    const elementoObj = getElementoByNome(d.nome);
                    const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                    // --- FIM DA ALTERA√á√ÉO ---
                    
                    let atendeFiltroParticipante = true;
                    if (generoFiltroParticipante || idiomaFiltroParticipante) {
                        atendeFiltroParticipante = false;
                        if (d.participantes) {
                            for (const nomeP of Object.keys(d.participantes)) {
                                if (d.participantes[nomeP]) {
                                    const pessoa = todasPessoas.find(p => p.nome === nomeP);
                                    if (pessoa) {
                                        const matchGeneroEsteP = !generoFiltroParticipante || pessoa.genero === generoFiltroParticipante;
                                        const matchIdiomaEsteP = !idiomaFiltroParticipante || pessoa.idioma === idiomaFiltroParticipante;
                                        if(matchGeneroEsteP && matchIdiomaEsteP) {
                                            atendeFiltroParticipante = true;
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    return matchDia && matchMes && matchAno && matchSemana && atendeFiltroParticipante && matchTipo;
                });
            }

         instanciasFiltradas.sort((a, b) => {
                const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
                const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });

            modalInstanciasListUl.innerHTML = '';
            if (instanciasFiltradas.length === 0) {
                modalInstanciasListUl.innerHTML = '<li>Nenhuma inst√¢ncia encontrada com os filtros atuais.</li>';
            } else {
                instanciasFiltradas.forEach(d => {
                    const li = document.createElement('li');
                    const participantesStr = [d.pessoaA, d.pessoaB, d.pessoaC].filter(Boolean).join(', ') || 'N/A';
                    let textoDesig = `${d.data} - Participantes: ${participantesStr}`;
                    if (d.nome === "Orador P√∫blico" && (d.tema || d.congregacao)) {
                        textoDesig += ` (`;
                        if (d.tema) textoDesig += `Tema: ${d.tema}`;
                        if (d.tema && d.congregacao) textoDesig += `; `;
                        if (d.congregacao) textoDesig += `Cong: ${d.congregacao}`;
                        textoDesig += `)`;
                    }
                    li.textContent = textoDesig;
                    modalInstanciasListUl.appendChild(li);
                });
            }
        }

 async function calcularTopPessoas() {
            setSectionLoadingState('gs-top-pessoas', true, 'btn-gs-top-pessoas-aplicar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
            if (!gsTopPessoasListUl) { 
                 setSectionLoadingState('gs-top-pessoas', false, 'btn-gs-top-pessoas-aplicar');
                return;
            }

            const mesFiltro = gsTopPessoasMesSelect.value;
            const anoFiltro = gsTopPessoasAnoSelect.value;
            const tipoFiltro = document.getElementById('gs-top-pessoas-tipo').value;
            const elementosFiltro = Array.from(gsTopPessoasElementoMultiHidden.selectedOptions).map(opt => opt.value);
            const generoParticipanteFiltro = gsTopPessoasGeneroParticipante.value;
            const idiomaParticipanteFiltro = gsTopPessoasIdiomaParticipante.value;

            let designacoesFiltradasGlobal = todasDesignacoesGlobais.filter(d => {
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchElemento = elementosFiltro.length === 0 ? false : elementosFiltro.includes(d.nome);
                const elementoObj = getElementoByNome(d.nome);
                const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                return matchMes && matchAno && matchElemento && matchTipo;
            });

            const contagemPessoas = {};
            designacoesFiltradasGlobal.forEach(d => {
                // =========================================================
                //          ‚Üì‚Üì‚Üì CORRE√á√ÉO APLICADA AQUI ‚Üì‚Üì‚Üì
                // =========================================================
                // 1. Ignora o campo 'participantes' e cria uma lista fi√°vel a partir de pessoaA/B/C.
                const participantesReais = [d.pessoaA, d.pessoaB, d.pessoaC].filter(Boolean); // 'filter(Boolean)' remove nomes nulos ou vazios.
                
                // 2. Itera sobre a lista de participantes reais.
                participantesReais.forEach(nomePessoa => {
                    const pessoaObj = todasPessoas.find(p => p.nome === nomePessoa);
                    
                    if (pessoaObj) {
                        const matchGenero = !generoParticipanteFiltro || pessoaObj.genero === generoParticipanteFiltro;
                        const matchIdioma = !idiomaParticipanteFiltro || pessoaObj.idioma === idiomaParticipanteFiltro;
                        
                        if (matchGenero && matchIdioma) {
                            contagemPessoas[nomePessoa] = (contagemPessoas[nomePessoa] || 0) + 1;
                        }
                    }
                });
                // =========================================================
            });

            topPessoasDadosCompletos = Object.entries(contagemPessoas)
                .map(([nome, count]) => ({ nome, count }))
                .sort((a, b) => b.count - a.count || a.nome.localeCompare(b.nome));

            gsTopPessoasMostrandoApenasTop5 = true;
            renderTopPessoasList();
            setSectionLoadingState('gs-top-pessoas', false, 'btn-gs-top-pessoas-aplicar');
        }


 function renderTopPessoasList() {
            if (!gsTopPessoasListUl || !gsTopPessoasMostrarTodosLink) return;
            gsTopPessoasListUl.innerHTML = '';

            const dadosParaRenderizar = gsTopPessoasMostrandoApenasTop5 ? topPessoasDadosCompletos.slice(0, 5) : topPessoasDadosCompletos;

            if (dadosParaRenderizar.length > 0) {
                dadosParaRenderizar.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `${item.nome} <span class="count">${item.count}</span>`;
                    gsTopPessoasListUl.appendChild(li);
                });
            }

            if (topPessoasDadosCompletos.length > 5) {
                gsTopPessoasMostrarTodosLink.style.display = 'inline-block';
                gsTopPessoasMostrarTodosLink.textContent = gsTopPessoasMostrandoApenasTop5 ? `Mostrar lista completa (${topPessoasDadosCompletos.length})` : 'Mostrar apenas Top 5';
            } else {
                gsTopPessoasMostrarTodosLink.style.display = 'none';
            }
        }



        async function exibirTodasDesignacoes() {
            setSectionLoadingState('gs-todas-desig', true, 'btn-gs-todas-desig-aplicar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
            if (!gsTodasDesigListUl) {
                 setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-aplicar');
                return;
            }

            const mesFiltro = gsTodasDesigMesSelect.value;
            const anoFiltro = gsTodasDesigAnoSelect.value;
            const elementoFiltro = gsTodasDesigElementoSelect.value;
            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const tipoFiltro = document.getElementById('gs-todas-desig-tipo').value;
            // --- FIM DA ALTERA√á√ÉO ---

            let designacoesFiltradasGlobal = todasDesignacoesGlobais.filter(d => {
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchElemento = !elementoFiltro || d.nome === elementoFiltro;
                // --- IN√çCIO DA ALTERA√á√ÉO ---
                const elementoObj = getElementoByNome(d.nome);
                const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                // --- FIM DA ALTERA√á√ÉO ---
                return matchMes && matchAno && matchElemento && matchTipo;
            }).sort((a, b) => {
                const dateA = new Date(parseInt(a.ano), parseInt(a.mes) - 1, parseInt(a.dia));
                const dateB = new Date(parseInt(b.ano), parseInt(b.mes) - 1, parseInt(b.dia));
                if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                return dateB - dateA;
            });

          gsTodasDesigListUl.innerHTML = '';
            if (gsTodasDesigAgrupadoContainerDiv) gsTodasDesigAgrupadoContainerDiv.style.display = 'none';

            if (designacoesFiltradasGlobal.length > 0) {
                designacoesFiltradasGlobal.forEach(d => {
                    const li = document.createElement('li');
                    const participantesStr = [d.pessoaA, d.pessoaB, d.pessoaC].filter(Boolean).join(', ');
                    let textoDesig = `${d.data} - ${d.nome}: ${participantesStr || 'N/A'}`;
                     if (d.nome === "Orador P√∫blico" && (d.tema || d.congregacao)) {
                        textoDesig += ` (`;
                        if (d.tema) textoDesig += `Tema: ${d.tema}`;
                        if (d.tema && d.congregacao) textoDesig += `; `;
                        if (d.congregacao) textoDesig += `Cong: ${d.congregacao}`;
                        textoDesig += `)`;
                    }
                    li.textContent = textoDesig;
                    gsTodasDesigListUl.appendChild(li);
                });
            }
            setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-aplicar');
        }

      async function agruparDesignacoesPorElemento() {
            setSectionLoadingState('gs-todas-desig', true, 'btn-gs-todas-desig-agrupar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
             if (!gsTodasDesigAgrupadoListUl || !gsTodasDesigAgrupadoContainerDiv) {
                 setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-agrupar');
                return;
            }

            const mesFiltro = gsTodasDesigMesSelect.value;
            const anoFiltro = gsTodasDesigAnoSelect.value;
            const elementoFiltro = gsTodasDesigElementoSelect.value;
            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const tipoFiltro = document.getElementById('gs-todas-desig-tipo').value;
            // --- FIM DA ALTERA√á√ÉO ---

            let designacoesParaAgrupar = todasDesignacoesGlobais.filter(d => {
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchElemento = !elementoFiltro || d.nome === elementoFiltro;
                // --- IN√çCIO DA ALTERA√á√ÉO ---
                const elementoObj = getElementoByNome(d.nome);
                const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                // --- FIM DA ALTERA√á√ÉO ---
                return matchMes && matchAno && matchElemento && matchTipo;
            });

            const contagemElementos = designacoesParaAgrupar.reduce((acc, d) => {
                 acc[d.nome] = (acc[d.nome] || 0) + 1; return acc;
            }, {});

            topElementosAgrupadosDadosCompletos = Object.entries(contagemElementos)
                .map(([nome, count]) => ({ nome, count }))
                .sort((a, b) => b.count - a.count || a.nome.localeCompare(b.nome));

            if (gsTodasDesigListUl) gsTodasDesigListUl.innerHTML = '';
            gsTodasDesigAgrupadoContainerDiv.style.display = 'block';
            gsTopElementosAgrupadosMostrandoApenasTop5 = true;
            renderTopElementosAgrupadosList();
            setSectionLoadingState('gs-todas-desig', false, 'btn-gs-todas-desig-agrupar');
        }

        function renderTopElementosAgrupadosList() {
            if (!gsTodasDesigAgrupadoListUl || !gsTodasDesigAgrupadoMostrarTodosLink) return;
            gsTodasDesigAgrupadoListUl.innerHTML = '';

            const dadosParaRenderizar = gsTopElementosAgrupadosMostrandoApenasTop5 ? topElementosAgrupadosDadosCompletos.slice(0, 5) : topElementosAgrupadosDadosCompletos;

            if (dadosParaRenderizar.length > 0) {
                dadosParaRenderizar.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `${item.nome} <span class="count">${item.count}</span>`;
                    gsTodasDesigAgrupadoListUl.appendChild(li);
                });
            }
            gsTodasDesigAgrupadoMostrarTodosLink.style.display = topElementosAgrupadosDadosCompletos.length > 5 ? 'inline-block' : 'none';
            gsTodasDesigAgrupadoMostrarTodosLink.textContent = gsTopElementosAgrupadosMostrandoApenasTop5 ? `Mostrar lista completa (${topElementosAgrupadosDadosCompletos.length})` : 'Mostrar apenas Top 5';
        }

     async function analisarDesempenhoPessoa() {
            setSectionLoadingState('gs-pessoa-esp', true, 'btn-gs-pessoa-esp-aplicar');
            if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();
            if (todasPessoas.length === 0) await carregarPessoas();
            if (!gsPessoaEspResultsDiv || !gsPessoaEspSelect) {
                 setSectionLoadingState('gs-pessoa-esp', false, 'btn-gs-pessoa-esp-aplicar');
                return;
            }

            const pessoaIdSelecionada = gsPessoaEspSelect.value;
            const pessoaObj = getPessoaById(pessoaIdSelecionada);
            const nomePessoaSelecionada = pessoaObj ? pessoaObj.nome : null;

            // --- IN√çCIO DA ALTERA√á√ÉO ---
            const anoFiltro = gsPessoaEspAnoFiltroSelect.value;
            const mesFiltro = gsPessoaEspMesFiltroSelect.value;
            const tipoFiltro = document.getElementById('gs-pessoa-esp-tipo-filtro').value;
            // L√™ os valores do novo seletor m√∫ltiplo
            const elementosFiltro = Array.from(gsIndivElementoMultiHidden.selectedOptions).map(opt => opt.value);
            // --- FIM DA ALTERA√á√ÉO ---

            if (!nomePessoaSelecionada) {
                gsPessoaEspResultsDiv.innerHTML = "<p>Por favor, selecione uma pessoa para analisar.</p>";
                setSectionLoadingState('gs-pessoa-esp', false, 'btn-gs-pessoa-esp-aplicar');
                return;
            }

            let designacoesFiltradas = todasDesignacoesGlobais.filter(d => {
                // --- L√ìGICA DE FILTRO ATUALIZADA ---
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2,'0') === String(mesFiltro).padStart(2,'0');
                const elementoObj = getElementoByNome(d.nome);
                const matchTipo = !tipoFiltro || (elementoObj && elementoObj.tipo === tipoFiltro);
                const matchElemento = elementosFiltro.length === 0 ? false : elementosFiltro.includes(d.nome);
                
                return matchElemento && matchAno && matchMes && matchTipo;
            });

            // O resto da fun√ß√£o continua exatamente igual...
            const designacoesDaPessoa = designacoesFiltradas.filter(d => d.participantes && d.participantes[nomePessoaSelecionada]);
            const totalDesigPessoa = designacoesDaPessoa.length;
            let mediaGeral = 0;

            if (todasPessoas.length > 1) {
                const outrasPessoasVisiveis = todasPessoas.filter(p => p.nome !== nomePessoaSelecionada && p.estaVisivel !== false);
                let somaDesigOutrasPessoas = 0;
                let countPessoasComDesig = 0;
                outrasPessoasVisiveis.forEach(outraPessoa => {
                    const desigDestaOutra = designacoesFiltradas.filter(d => d.participantes && d.participantes[outraPessoa.nome]).length;
                    if (desigDestaOutra > 0) { somaDesigOutrasPessoas += desigDestaOutra; countPessoasComDesig++; }
                });
                if (countPessoasComDesig > 0) mediaGeral = somaDesigOutrasPessoas / countPessoasComDesig;
            }

            let htmlResultado = `<p><strong>${nomePessoaSelecionada}</strong> teve <strong>${totalDesigPessoa}</strong> designa√ß√µes no per√≠odo.</p>`;
            if (mediaGeral > 0) {
                 htmlResultado += `<p>M√©dia para outras pessoas: <strong>${mediaGeral.toFixed(1)}</strong>.</p>`;
                if (totalDesigPessoa > mediaGeral) htmlResultado += `<p>Desempenho: <span class="acima-media">Acima da m√©dia</span>.</p>`;
                else if (totalDesigPessoa < mediaGeral) htmlResultado += `<p>Desempenho: <span class="abaixo-media">Abaixo da m√©dia</span>.</p>`;
                else htmlResultado += `<p>Desempenho: <span class="na-media">Na m√©dia</span>.</p>`;
            } 

            const desigPessoaPorElemento = designacoesDaPessoa.reduce((acc, d) => { acc[d.nome] = (acc[d.nome] || 0) + 1; return acc; }, {});
            const sortedDesigPessoaPorElemento = Object.entries(desigPessoaPorElemento).sort((a,b) => b[1] - a[1]);
            if(sortedDesigPessoaPorElemento.length > 0){
                htmlResultado += `<p><strong>Detalhes por elemento para ${nomePessoaSelecionada}:</strong></p><ul>`;
                sortedDesigPessoaPorElemento.forEach(([elNome, count]) => htmlResultado += `<li>${elNome}: ${count}</li>`);
                htmlResultado += `</ul>`;
            } else {
                htmlResultado += `<p>Nenhum detalhe por elemento para ${nomePessoaSelecionada} com os filtros atuais.</p>`;
            }
            gsPessoaEspResultsDiv.innerHTML = htmlResultado;
            setSectionLoadingState('gs-pessoa-esp', false, 'btn-gs-pessoa-esp-aplicar');
        }



        function renderChart(chartInstance, canvasId, type, data, options = {}) {
            const canvasEl = document.getElementById(canvasId);
            if (!canvasEl) { console.error(`Canvas ${canvasId} n√£o encontrado.`); return null; }
            const ctx = canvasEl.getContext('2d');
            if (chartInstance && typeof chartInstance.destroy === 'function') {
                chartInstance.destroy();
            }
            const defaultOptions = {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
            };
            const finalOptions = {...defaultOptions, ...options};
            try {
                return new Chart(ctx, { type, data, options: finalOptions });
            } catch (e) {
                console.error("Erro ao renderizar gr√°fico:", canvasId, e);
                if(canvasEl.parentElement) canvasEl.parentElement.innerHTML = `<p style="text-align:center; color: red;">Erro ao gerar gr√°fico.</p>`;
                return null;
            }
        }

     if (btnGlobalStats) {
            btnGlobalStats.addEventListener('click', async () => {
                console.log("Bot√£o de Estat√≠sticas Globais clicado.");
                abrirModal(modalGlobalStats);

                document.querySelectorAll('#modal-global-stats .loading-spinner').forEach(s => s.style.display = 'block');
                document.querySelectorAll('#modal-global-stats .stats-apply-button, #modal-global-stats .stats-filters select, #modal-global-stats .stats-filters input').forEach(b => b.disabled = true);

                if (todosElementos.length === 0) await carregarTodosElementosParaEstatisticas();
                if (todasPessoas.length === 0) await carregarPessoas(); 
                if (!todasDesignacoesGlobaisCarregadas) await carregarTodasDesignacoesParaStatsGlobais();

                popularFiltrosStatsGlobais();
                popularDropdownsPessoasNosModais(); 
                initGsTopElementosCheckboxMultiselect(); 
                initGsIndivElementosCheckboxMultiselect();

                const activeTab = document.querySelector('#modal-global-stats .global-stats-tab-button.active');
                 if (activeTab) {
                    const activeTabTargetId = activeTab.dataset.tabTarget;
                    // Simula um clique na aba ativa para for√ßar o carregamento do seu conte√∫do
                    activeTab.click(); 
                } else {
                    // Se nenhuma aba estiver ativa (caso raro), clica na primeira
                    const firstTabButton = document.querySelector('#modal-global-stats .global-stats-tab-button');
                    if(firstTabButton) {
                        firstTabButton.click();
                    }
                }

                document.querySelectorAll('#modal-global-stats .loading-spinner').forEach(s => s.style.display = 'none');
                document.querySelectorAll('#modal-global-stats .stats-apply-button, #modal-global-stats .stats-filters select, #modal-global-stats .stats-filters input').forEach(b => b.disabled = false);

                if(gsTopPessoasListUl) gsTopPessoasListUl.innerHTML = '';
                if(gsTopPessoasMostrarTodosLink) gsTopPessoasMostrarTodosLink.style.display = 'none';
                if(gsTodasDesigListUl) gsTodasDesigListUl.innerHTML = '';
                if(gsTodasDesigAgrupadoContainerDiv) gsTodasDesigAgrupadoContainerDiv.style.display = 'none';
                if(gsTodasDesigAgrupadoListUl) gsTodasDesigAgrupadoListUl.innerHTML = '';
                if(gsTodasDesigAgrupadoMostrarTodosLink) gsTodasDesigAgrupadoMostrarTodosLink.style.display = 'none';
                if(gsPessoaEspResultsDiv) gsPessoaEspResultsDiv.innerHTML = '';
                if(gsPessoasComparisonAreaDiv) gsPessoasComparisonAreaDiv.innerHTML = ''; 
            });
        }

        if(btnGsTotalAplicarFiltros) btnGsTotalAplicarFiltros.addEventListener('click', atualizarAbaTotalGlobalStats);
        if(btnGsPessoasComparar) btnGsPessoasComparar.addEventListener('click', compararPessoasSelecionadas);
        if(btnGsDesignacoesAplicarFiltros) {
             btnGsDesignacoesAplicarFiltros.addEventListener('click', () => {
                popularListaElementosAbaDesignacoes();
            });
        }

        if (btnGsTopPessoasAplicar) btnGsTopPessoasAplicar.addEventListener('click', calcularTopPessoas);
        if (gsTopPessoasMostrarTodosLink) {
            gsTopPessoasMostrarTodosLink.addEventListener('click', (e) => {
                e.preventDefault();
                gsTopPessoasMostrandoApenasTop5 = !gsTopPessoasMostrandoApenasTop5;
                renderTopPessoasList();
            });
        }
        if (btnGsTodasDesigAplicar) btnGsTodasDesigAplicar.addEventListener('click', exibirTodasDesignacoes);
        if (btnGsTodasDesigAgrupar) btnGsTodasDesigAgrupar.addEventListener('click', agruparDesignacoesPorElemento);
        if (gsTodasDesigAgrupadoMostrarTodosLink) {
            gsTodasDesigAgrupadoMostrarTodosLink.addEventListener('click', (e) => {
                e.preventDefault();
                gsTopElementosAgrupadosMostrandoApenasTop5 = !gsTopElementosAgrupadosMostrandoApenasTop5;
                renderTopElementosAgrupadosList();
            });
        }
        if (btnGsPessoaEspAplicar) btnGsPessoaEspAplicar.addEventListener('click', analisarDesempenhoPessoa);

        function getNomeMesRanking(numMes) {
            if (!numMes || isNaN(parseInt(numMes))) return "";
            try {
                return new Date(2000, parseInt(numMes) - 1, 1).toLocaleString('pt-BR', { month: 'long' });
            } catch (e) {
                console.error("Erro em getNomeMesRanking:", e);
                return "";
            }
        }

        async function abrirModalRanking() {
            if (!modalRanking) {
                console.error("Modal de Ranking n√£o encontrado.");
                return;
            }
            const rankingFiltersContainer = document.getElementById('ranking-filters-container');
            if (rankingFiltersContainer) rankingFiltersContainer.style.opacity = "0.5";

            if (!todasDesignacoesGlobaisCarregadas) {
                console.log("Modal Ranking: Carregando todas as designa√ß√µes globais...");
                await carregarTodasDesignacoesParaStatsGlobais();
                if (!todasDesignacoesGlobaisCarregadas) {
                    alert("N√£o foi poss√≠vel carregar os dados das designa√ß√µes para o ranking. Tente novamente.");
                    if (rankingFiltersContainer) rankingFiltersContainer.style.opacity = "1";
                    return;
                }
            }
            if (todosElementos.length === 0) {
                console.log("Modal Ranking: Carregando todos os elementos...");
                await carregarTodosElementosParaEstatisticas();
            }

            if (rankingFiltersContainer) rankingFiltersContainer.style.opacity = "1";

            popularFiltrosRankingPopup();
            setDefaultRankingFilters();
            ordemAtualElementosRanking = [...ORDEM_PADRAO_ELEMENTOS_RANKING];
            renderRankingList();
            abrirModal(modalRanking);
        }

 function popularFiltrosRankingPopup() {
    if (!rankingFiltroMesSelect || !rankingFiltroAnoSelect || !rankingFiltroSemanaSelect) {
        console.error("Elementos de filtro do modal de ranking n√£o encontrados.");
        return;
    }

    // 1. Verifica se h√° dados
    if (!todasDesignacoesGlobaisCarregadas || todasDesignacoesGlobais.length === 0) {
        rankingFiltroMesSelect.innerHTML = '<option value="">Todos</option>';
        rankingFiltroAnoSelect.innerHTML = '<option value="">Todos</option>';
        rankingFiltroSemanaSelect.innerHTML = '<option value="">Todas</option>';
        return;
    }

    // 2. Salva sele√ß√£o atual para tentar manter ap√≥s repopular
    const currentMesVal = rankingFiltroMesSelect.value;
    const currentAnoVal = rankingFiltroAnoSelect.value;

    // 3. Extrai Meses e Anos √∫nicos baseados nos campos num√©ricos 'mes' e 'ano' do documento
    // Isso popula os dropdowns superiores corretamente
    const mesesUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.mes).filter(Boolean))].sort((a, b) => parseInt(a) - parseInt(b));
    const anosUnicos = [...new Set(todasDesignacoesGlobais.map(d => d.ano).filter(Boolean))].sort((a, b) => parseInt(b) - parseInt(a));

    // 4. Popula Select de M√™s
    rankingFiltroMesSelect.innerHTML = '<option value="">Todos</option>';
    mesesUnicos.forEach(mes => {
        // getNomeMesRanking deve retornar "Janeiro", "Fevereiro", etc.
        rankingFiltroMesSelect.appendChild(new Option(getNomeMesRanking(mes).replace(/^\w/, c => c.toUpperCase()), String(mes).padStart(2, '0')));
    });
    rankingFiltroMesSelect.value = currentMesVal;

    // 5. Popula Select de Ano
    rankingFiltroAnoSelect.innerHTML = '<option value="">Todos</option>';
    anosUnicos.forEach(ano => {
        rankingFiltroAnoSelect.appendChild(new Option(ano, ano));
    });
    rankingFiltroAnoSelect.value = currentAnoVal;

    // 6. Adiciona os "Ouvintes" (Listeners)
    // Quando mudar o M√™s ou Ano, atualiza a lista de Semanas
    rankingFiltroMesSelect.onchange = atualizarDropdownSemanasRanking;
    rankingFiltroAnoSelect.onchange = atualizarDropdownSemanasRanking;

    // 7. Chama a fun√ß√£o para filtrar as semanas pela primeira vez
    atualizarDropdownSemanasRanking();
}



        function setDefaultRankingFilters() {
             if (!rankingFiltroAnoSelect || !rankingFiltroMesSelect || !rankingFiltroSemanaSelect) return;
            if (todasDesignacoesGlobais.length === 0) {
                 rankingFiltroAnoSelect.value = "";
                 rankingFiltroMesSelect.value = "";
                 rankingFiltroSemanaSelect.value = "";
                return;
            }

            let maisRecente = null;
            todasDesignacoesGlobais.forEach(d => {
                if (d.data && d.ano && d.mes && d.dia) {
                    try {
                        const [day, month, year] = d.data.split('/');
                        const dataAtual = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                        if (!isNaN(dataAtual.getTime())) {
                            if (!maisRecente || dataAtual > maisRecente.dataObj) {
                                maisRecente = { ...d, dataObj: dataAtual };
                            }
                        }
                    } catch (e) { }
                }
            });

            if (maisRecente) {
                rankingFiltroAnoSelect.value = maisRecente.ano || "";
                rankingFiltroMesSelect.value = String(maisRecente.mes).padStart(2,'0') || "";
                if (maisRecente.semana && typeof maisRecente.semana === 'string') {
                    const semanaOptionExists = Array.from(rankingFiltroSemanaSelect.options).some(opt => opt.value === maisRecente.semana);
                    if (semanaOptionExists) {
                        rankingFiltroSemanaSelect.value = maisRecente.semana;
                    } else {
                         rankingFiltroSemanaSelect.value = "";
                    }
                } else {
                    rankingFiltroSemanaSelect.value = "";
                }
            } else {
                rankingFiltroAnoSelect.value = "";
                rankingFiltroMesSelect.value = "";
                rankingFiltroSemanaSelect.value = "";
            }
        }

        function renderRankingList() {
            if (!listaRankingDesignacoesUl) return;
            listaRankingDesignacoesUl.innerHTML = '<div class="loading-spinner" style="margin: 10px auto; display: block;"></div>';

            const mesFiltro = rankingFiltroMesSelect ? rankingFiltroMesSelect.value : "";
            const anoFiltro = rankingFiltroAnoSelect ? rankingFiltroAnoSelect.value : "";
            const semanaFiltroValor = rankingFiltroSemanaSelect ? rankingFiltroSemanaSelect.value : "";

            const designacoesDaSemanaSelecionada = todasDesignacoesGlobais.filter(d => {
                if (semanaFiltroValor) {
                    return d.semana === semanaFiltroValor;
                }
                const matchAno = !anoFiltro || d.ano === anoFiltro;
                const matchMes = !mesFiltro || String(d.mes).padStart(2, '0') === String(mesFiltro).padStart(2, '0');
                return matchAno && matchMes;
            });

            listaRankingDesignacoesUl.innerHTML = '';

            if (designacoesDaSemanaSelecionada.length === 0) {
                const msg = (anoFiltro || mesFiltro || semanaFiltroValor) 
                    ? 'Nenhuma designa√ß√£o encontrada para os filtros selecionados.' 
                    : 'Selecione filtros para ver o ranking.';
                listaRankingDesignacoesUl.innerHTML = `<li>${msg}</li>`;
                return;
            }

            const designacoesAgrupadasPorNome = designacoesDaSemanaSelecionada.reduce((acc, desig) => {
                const nomeElementoBase = desig.nome && desig.nome.startsWith("Discurso") ? "Discurso" : desig.nome;
                if (!nomeElementoBase) return acc;
                if (!acc[nomeElementoBase]) {
                    acc[nomeElementoBase] = [];
                }
                acc[nomeElementoBase].push(desig);
                return acc;
            }, {});

            ordemAtualElementosRanking.forEach((nomeElemento, index) => {
                if (nomeElemento.startsWith("---")) {
                    const separator = document.createElement(nomeElemento === "---SEP---" ? 'hr' : 'li');
                    separator.className = nomeElemento === "---SEP---" ? 'ranking-section-separator' : 'ranking-paragraph-separator';
                    listaRankingDesignacoesUl.appendChild(separator);
                    return;
                }

                const designacoesParaEsteElemento = designacoesAgrupadasPorNome[nomeElemento] || [];
                
                if (designacoesParaEsteElemento.length > 0) {
                    designacoesParaEsteElemento.forEach((designacaoEspecifica, itemIndex) => {
                        const li = document.createElement('li');
                        li.dataset.elementoNome = nomeElemento;

                        const nomeSpan = document.createElement('span');
                        nomeSpan.className = 'designacao-nome';
                        nomeSpan.textContent = (itemIndex === 0) ? nomeElemento : '';

                        const participantesContainer = document.createElement('span');
                        participantesContainer.className = 'designacao-participantes';
                        
                        const participantesNomes = [designacaoEspecifica.pessoaA, designacaoEspecifica.pessoaB, designacaoEspecifica.pessoaC].filter(Boolean);

                        if (participantesNomes.length > 0) {
                            participantesNomes.forEach((nome, idx) => {
                                let posicao = '';
                                if (designacaoEspecifica.pessoaA === nome) posicao = 'pessoaA';
                                else if (designacaoEspecifica.pessoaB === nome) posicao = 'pessoaB';
                                else if (designacaoEspecifica.pessoaC === nome) posicao = 'pessoaC';

                                if (posicao) {
                                    const nomeEditavelSpan = document.createElement('span');
                                    nomeEditavelSpan.className = 'participante-editavel';
                                    nomeEditavelSpan.textContent = nome;
                                    nomeEditavelSpan.dataset.designacaoId = designacaoEspecifica.id;
                                    nomeEditavelSpan.dataset.originalNome = nome;
                                    nomeEditavelSpan.dataset.posicao = posicao;
                                    nomeEditavelSpan.onclick = iniciarEdicaoParticipante;
                                    
                                    participantesContainer.appendChild(nomeEditavelSpan);

                                    if (idx < participantesNomes.length - 1) {
                                        participantesContainer.append(' & ');
                                    }
                                }
                            });
                        } else {
                            participantesContainer.textContent = "Ningu√©m designado";
                            participantesContainer.classList.add('ninguem');
                        }

                        const reorderDiv = document.createElement('div');
                        reorderDiv.className = 'reorder-buttons';
                        
                        if (itemIndex === 0) {
                            const btnUp = document.createElement('button');
                            btnUp.innerHTML = '<i class="fas fa-arrow-up"></i>';
                            btnUp.disabled = index === 0 || ordemAtualElementosRanking[index - 1].startsWith("---");
                            btnUp.onclick = () => moverElementoRanking(index, 'up');

                            const btnDown = document.createElement('button');
                            btnDown.innerHTML = '<i class="fas fa-arrow-down"></i>';
                            const nextElementIsSeparator = (index + 1 < ordemAtualElementosRanking.length) && ordemAtualElementosRanking[index + 1].startsWith("---");
                            btnDown.disabled = index === ordemAtualElementosRanking.length - 1 || nextElementIsSeparator;
                            btnDown.onclick = () => moverElementoRanking(index, 'down');
                            reorderDiv.appendChild(btnUp);
                            reorderDiv.appendChild(btnDown);
                        }

                        li.appendChild(nomeSpan);
                        li.appendChild(participantesContainer);
                        li.appendChild(reorderDiv);
                        listaRankingDesignacoesUl.appendChild(li);
                    });
                }
            });
        }

        function iniciarEdicaoParticipante(event) {
            const spanElement = event.target;
            const { designacaoId, originalNome, posicao } = spanElement.dataset;

            const select = document.createElement('select');
            
            const cancelOption = new Option("‚Äî Cancelar Edi√ß√£o ‚Äî", "");
            select.appendChild(cancelOption);

            todasPessoas
                .filter(p => p.estaVisivel !== false)
                .forEach(pessoa => {
                    const option = new Option(pessoa.nome, pessoa.nome);
                    if (pessoa.nome === originalNome) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });

            const reverterParaSpan = () => {
                select.replaceWith(spanElement);
            };
            
            select.onchange = () => {
                const novoNome = select.value;
                if (novoNome && novoNome !== originalNome) {
                    atualizarParticipanteDaDesignacao(designacaoId, posicao, novoNome, originalNome);
                } else {
                    reverterParaSpan();
                }
            };

            select.onblur = reverterParaSpan;

            spanElement.replaceWith(select);
            select.focus();
        }

        async function atualizarParticipanteDaDesignacao(designacaoId, posicao, novoNome, nomeAntigo) {
            console.log(`Atualizando designa√ß√£o ${designacaoId}: Trocando ${nomeAntigo} por ${novoNome} na posi√ß√£o ${posicao}.`);

            const designacaoRef = doc(db, "designacoes", designacaoId);

            try {
                const docSnap = await getDoc(designacaoRef);
                if (!docSnap.exists()) {
                    throw new Error("Documento da designa√ß√£o n√£o foi encontrado!");
                }

                const designacaoAtual = docSnap.data();
                const participantesAtuais = { ...designacaoAtual.participantes };

                delete participantesAtuais[nomeAntigo];
                participantesAtuais[novoNome] = true;

                const updateData = {
                    [posicao]: novoNome,
                    participantes: participantesAtuais,
                    ultimaModificacao: serverTimestamp()
                };

                await updateDoc(designacaoRef, updateData);

                const index = todasDesignacoesGlobais.findIndex(d => d.id === designacaoId);
                if (index > -1) {
                    todasDesignacoesGlobais[index][posicao] = novoNome;
                    todasDesignacoesGlobais[index].participantes = participantesAtuais;
                }
                
                renderRankingList();
                
                alert(`Designa√ß√£o atualizada com sucesso!`);

            } catch (error) {
                console.error("Erro ao atualizar participante da designa√ß√£o:", error);
                alert("Falha ao atualizar a designa√ß√£o. Verifique o console para mais detalhes.");
                renderRankingList();
            }
        }

        if (btnRankingPopup) {
            btnRankingPopup.addEventListener('click', abrirModalRanking);
        }

        if (btnRankingAplicarFiltros) {
            btnRankingAplicarFiltros.addEventListener('click', renderRankingList);
        }

       window.onload = async () => {
            console.log("Window onload: Iniciando aplica√ß√£o.");
            if (!listaPessoasUl || !colunaDetalhesDiv || !colunaDetalhesContent || !modalGlobalStats) {
                console.error("ERRO CR√çTICO: Elementos DOM essenciais n√£o encontrados. A aplica√ß√£o pode n√£o funcionar.");
                alert("Erro cr√≠tico ao carregar. Verifique o console.");
                return;
            }

            await carregarPessoas();
            await carregarTodosElementosParaEstatisticas();
            
            // --- IN√çCIO DA CORRE√á√ÉO ---
            await carregarListaDiscursos(); // LINHA QUE FALTA
            // --- FIM DA CORRE√á√ÉO ---

            popularDropdownsPessoasNosModais(); 

            if (colunaDetalhesDiv && colunaDetalhesContent) {
                colunaDetalhesDiv.innerHTML = ''; 
                colunaDetalhesDiv.appendChild(colunaDetalhesContent); 
                colunaDetalhesContent.style.display = 'flex'; 
            }
            
            const primeiraAbaBtnGlobal = document.querySelector('.modal-global-stats-tabs .global-stats-tab-button');
            if (primeiraAbaBtnGlobal && !document.querySelector('.modal-global-stats-tabs .global-stats-tab-button.active')) {
                primeiraAbaBtnGlobal.classList.add('active');
                const targetContentId = primeiraAbaBtnGlobal.dataset.tabTarget;
                const targetContent = document.getElementById(targetContentId);
                if (targetContent) targetContent.classList.add('active');
                
                if (targetContentId === 'gs-total-content') await carregarTodasDesignacoesParaStatsGlobais().then(atualizarAbaTotalGlobalStats);
                else if (targetContentId === 'gs-pessoas-content') initGsPessoasCustomMultiselect();
                else if (targetContentId === 'gs-designacoes-content') popularListaElementosAbaDesignacoes();
                else if (targetContentId === 'gs-old-content') { 
                    setupGsOldSubmenu();
                }
            } else {
                const activeMainTab = document.querySelector('.modal-global-stats-tabs .global-stats-tab-button.active');
                if (activeMainTab && activeMainTab.dataset.tabTarget === 'gs-old-content') {
                    setupGsOldSubmenu();
                }
            }

            if (btnRankingPopup) {
                btnRankingPopup.addEventListener('click', abrirModalRanking);
            }
            if (btnRankingAplicarFiltros) {
                btnRankingAplicarFiltros.addEventListener('click', renderRankingList);
            }
            
            console.log("Inicializa√ß√£o conclu√≠da.");
        };

        function moverElementoRanking(currentIndex, direction) {
            const newIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;

            if (newIndex < 0 || newIndex >= ordemAtualElementosRanking.length) return;
            if (ordemAtualElementosRanking[newIndex].startsWith("---")) {
                 if (direction === 'up' && newIndex > 0 && ordemAtualElementosRanking[newIndex-1] && !ordemAtualElementosRanking[newIndex-1].startsWith("---")) {
                    [ordemAtualElementosRanking[currentIndex], ordemAtualElementosRanking[newIndex-1]] = [ordemAtualElementosRanking[newIndex-1], ordemAtualElementosRanking[currentIndex]];
                 } else if (direction === 'down' && newIndex < ordemAtualElementosRanking.length - 1 && ordemAtualElementosRanking[newIndex+1] && !ordemAtualElementosRanking[newIndex+1].startsWith("---")) {
                     [ordemAtualElementosRanking[currentIndex], ordemAtualElementosRanking[newIndex+1]] = [ordemAtualElementosRanking[newIndex+1], ordemAtualElementosRanking[currentIndex]];
                 } else {
                    return;
                 }
            } else {
                 [ordemAtualElementosRanking[currentIndex], ordemAtualElementosRanking[newIndex]] = [ordemAtualElementosRanking[newIndex], ordemAtualElementosRanking[currentIndex]];
            }
            renderRankingList();
        }


function atualizarDropdownSemanasRanking() {
    console.log("--- IN√çCIO DEBUG: atualizarDropdownSemanasRanking ---");

    if (!rankingFiltroSemanaSelect) {
        console.error("Erro: Select de semana n√£o encontrado no DOM.");
        return;
    }

    // 1. Pega o valor dos filtros superiores
    const mesSelecionado = rankingFiltroMesSelect.value; 
    const anoSelecionado = rankingFiltroAnoSelect.value; 
    const semanaSelecionadaAtual = rankingFiltroSemanaSelect.value;

    console.log(`1. Filtros Atuais -> M√™s Selecionado: "${mesSelecionado}" | Ano Selecionado: "${anoSelecionado}"`);

    // 2. Mapa para converter o texto da string 'semana' em n√∫mero
    const monthMap = { 
        'janeiro': 1, 'fevereiro': 2, 'mar√ßo': 3, 'abril': 4, 'maio': 5, 'junho': 6, 
        'julho': 7, 'agosto': 8, 'setembro': 9, 'outubro': 10, 'novembro': 11, 'dezembro': 12 
    };

    // 3. Filtra e processa as designa√ß√µes
    let contadorProcessados = 0;
    
    const listaSemanasProcessada = todasDesignacoesGlobais
        .filter(d => d.semana && typeof d.semana === 'string') 
        .map(d => {
            // Regex: Captura (M√™s) (Ano) | (Dia)
            const regex = /^([a-zA-Z√ß√á√£√µ√É√ï√°√©√≠√≥√∫√Å√â√ç√ì√ö]+)\s+(\d{4})\s*\|\s*(\d{1,2})/i;
            const parts = d.semana.match(regex);

            if (parts) {
                const nomeMesTexto = parts[1].toLowerCase(); // ex: "dezembro"
                const anoTexto = parts[2];                 // ex: "2025"
                const diaInicio = parseInt(parts[3]);      // ex: 29
                
                const numeroMes = monthMap[nomeMesTexto];  // Converte "dezembro" para 12

                // LOG DE AMOSTRA (mostra os 3 primeiros para n√£o poluir demais)
                if (contadorProcessados < 3) {
                    console.log(`   > Processando string: "${d.semana}" -> Detectado M√™s: "${nomeMesTexto}" (${numeroMes}), Ano: "${anoTexto}"`);
                    contadorProcessados++;
                }

                if (numeroMes) {
                    const sortDate = new Date(parseInt(anoTexto), numeroMes - 1, diaInicio);
                    return {
                        originalString: d.semana, 
                        monthNum: numeroMes,      
                        yearStr: anoTexto,        
                        sortDate: sortDate        
                    };
                } else {
                    console.warn(`   ! Aviso: M√™s "${nomeMesTexto}" n√£o encontrado no mapa monthMap.`);
                }
            }
            return null;
        })
        .filter(item => item !== null) 
        .filter(item => {
            // --- AQUI ACONTECE O FILTRO ---
            
            const matchAno = !anoSelecionado || item.yearStr === anoSelecionado;
            
            // Logica do M√™s
            const mesDropdownNumerico = parseInt(mesSelecionado);
            const matchMes = !mesSelecionado || item.monthNum === mesDropdownNumerico;

            // Se tiver um m√™s selecionado, vamos logar por que passou ou falhou
            if (mesSelecionado && item.yearStr === (anoSelecionado || "2025")) { 
                // Loga apenas se o ano bater (para reduzir barulho), √∫til para debug
               // console.log(`   ? Comparando: Item M√™s ${item.monthNum} === Filtro ${mesDropdownNumerico}? ${matchMes}`);
            }
            
            return matchAno && matchMes;
        });

    console.log(`2. Total de itens compat√≠veis encontrados: ${listaSemanasProcessada.length}`);

    // 4. Remove duplicatas
    const semanasUnicas = [];
    const stringsVistas = new Set();

    listaSemanasProcessada.forEach(item => {
        if (!stringsVistas.has(item.originalString)) {
            stringsVistas.add(item.originalString);
            semanasUnicas.push(item);
        }
    });

    console.log(`3. Total de Semanas √önicas para exibir: ${semanasUnicas.length}`);

    // 5. Ordena
    semanasUnicas.sort((a, b) => b.sortDate - a.sortDate);

    // 6. Monta o HTML
    rankingFiltroSemanaSelect.innerHTML = '<option value="">Todas</option>';
    
    let currentYearGroup = null;
    let optgroup = null;

    semanasUnicas.forEach(item => {
        if (item.yearStr !== currentYearGroup) {
            currentYearGroup = item.yearStr;
            optgroup = document.createElement('optgroup');
            optgroup.label = item.yearStr;
            rankingFiltroSemanaSelect.appendChild(optgroup);
        }
        
        const option = document.createElement('option');
        option.value = item.originalString;
        option.textContent = item.originalString;

        if (optgroup) {
            optgroup.appendChild(option);
        } else {
            rankingFiltroSemanaSelect.appendChild(option);
        }
    });

    // 7. Restaura sele√ß√£o
    if (semanaSelecionadaAtual && stringsVistas.has(semanaSelecionadaAtual)) {
        console.log("4. Mantendo a sele√ß√£o anterior da semana.");
        rankingFiltroSemanaSelect.value = semanaSelecionadaAtual;
    } else {
        rankingFiltroSemanaSelect.value = "";
    }

    console.log("--- FIM DEBUG ---");
}


    </script>
</body>
</html>
